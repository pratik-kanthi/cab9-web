function formatUrl(e,r){return window.formatImage(e,r)}function formatAddress(e){var r="";return e.Address1&&e.Address1.replace(" ","").length>0&&(r+=e.Address1+", "),e.Address2&&e.Address2.replace(" ","").length>0&&(r+=e.Address2+", "),e.Area&&e.Area.length>0&&(r+=e.Area+", "),e.TownCity&&e.TownCity.replace(" ","").length>0&&(r+=e.TownCity+", "),e.Postcode&&e.Postcode.replace(" ","").length>0&&(r+=e.Postcode+", "),e.County&&e.County.replace(" ","").length>0&&(r+=e.County+", "),e.Country&&e.Country.replace(" ","").length>0&&(r+=e.Country+", "),", "==r.substring(r.length-2,r.length)?r.substring(0,r.length-2):r}function secondsToHms(e){e=Number(e);var r=Math.floor(e/3600),t=Math.floor(e%3600/60),o=Math.floor(e%3600%60),n=r>0?r+":":"",s=t<10?"0"+t+":":t+":",l=o<10?"0"+o:o;return n+s+l}window.$utilities={formatUrl:formatUrl,formatAddress:formatAddress,secondsToHms:secondsToHms},String.prototype.replaceAll=function(e,r){var t=this;return t.replace(new RegExp(e,"g"),r)};;;;
!function(e,t){function a(e){e.reportFilters={from:moment().startOf("isoweek").toISOString(),to:moment().endOf("isoweek").toISOString()}}function r(e){e.interceptors.push("TemplateCacheBuster")}var i=t.module("cab9.common",["ngMessages","ngAnimate","ngtweet","ngLocale","ui.router","ui.router.tabs","ui.bootstrap","ui.select","ui.sortable","ui-notification","angular.filter","angular-flot","uiGmapgoogle-maps","google.places","tmh.dynamicLocale","timer","gavruk.card","framework.services.auth.persist","framework.services.menu","framework.services.data","framework.services.logging","framework.services.storage","framework.services.images","framework.services.csv","framework.services.google","framework.services.signalr","framework.directives.utils","framework.directives.UI","framework.services.currency","framework.filters.utility","framework.UI.structure","framework.UI.breadcrumb","framework.UI.module","framework.UI","framework.module.documents","cab9.models","cab9.reports","cab9.layout","cab9.widgets"]);i.constant("$tenantConfig",{defaultVehicleType:"80e4cd2c-411e-41e0-9939-679ef65797cc",defaultVehicleClass:"80e4cd2c-411e-41e0-9939-679ef65797cc",officeLocation:{latitude:51.471507,longitude:-.487904}}),e.$config={API_ENDPOINT:e.endpoint,SIGNALR_ENDPOINT:e.signalREndpoint,RESOURCE_ENDPOINT:e.resourceEndpoint,WEBBOOKER_ENDPOINT:e.webbookerEndpoint,VERSION:e.version,GMAPS_STATIC_URL:"https://maps.googleapis.com/maps/api/staticmap?size=249x249&style=feature:landscape|visibility:off&style=feature:poi|visibility:off&style=feature:transit|visibility:off&style=feature:road.highway|element:geometry|lightness:39&style=feature:road.local|element:geometry|gamma:1.45&style=feature:road|element:labels|gamma:1.22&style=feature:administrative|visibility:off&style=feature:administrative.locality|visibility:on&style=feature:landscape.natural|visibility:on&scale=2",LOGIN_URL:"/index.html",DEFAULT_LOCALE:"en-gb",GMAPS_STYLE:[{featureType:"landscape",stylers:[{hue:"#FFBB00"},{saturation:43.400000000000006},{lightness:37.599999999999994},{gamma:1}]},{featureType:"road.highway",stylers:[{hue:"#FFC200"},{saturation:-61.8},{lightness:45.599999999999994},{gamma:1}]},{featureType:"road.arterial",stylers:[{hue:"#FF0300"},{saturation:-100},{lightness:51.19999999999999},{gamma:1}]},{featureType:"road.local",stylers:[{hue:"#FF0300"},{saturation:-100},{lightness:52},{gamma:1}]},{featureType:"water",stylers:[{hue:"#0078FF"},{saturation:-13.200000000000003},{lightness:2.4000000000000057},{gamma:1}]},{featureType:"poi",stylers:[{hue:"#00FF6A"},{saturation:-1.0989010989011234},{lightness:11.200000000000017},{gamma:1}]}]},i.run(a),a.$inject=["$rootScope"],i.config(r),r.$inject=["$httpProvider"],i.constant("$config",e.$config),i.constant("$utilities",e.$utilities),i.constant("LookupCache",{}),i.constant("ViewerCache",{}),i.factory("TemplateCacheBuster",["$config","$templateCache",function(e,t){return{request:function(a){if(a&&a.url&&a.url.indexOf(".html")>=0){if(t.get(a.url))return a;a.url.indexOf("?")==-1?a.url+="?ver="+e.VERSION:a.url+="&ver="+e.VERSION}return a}}}])}(window,angular);;;;
!function(e,n){function t(e,n,t,o,i,a,l,c){e.menu=t,o.USER=i.getSession();var r=o.USER.Name;o.USER.Name.indexOf(" ")&&(r=o.USER.Name.split(" ")[0]),o.USER.ImageUrl=e.formatImage(o.USER.ImageUrl,r),$(".mobile #navigation").click(function(){$("#application-layout").removeClass("sidebar-visible")}),e.logout=function(){o.$broadcast(a.LOGOUT)},o.$on("$stateChangeSuccess",function(n,t,o,i,a){e.menu.menuItems.filter(function(e){})})}var o=n.module("cab9.layout",[]);o.controller("SidebarController",t),t.$inject=["$scope","$interval","MenuService","$rootScope","Auth","AUTH_EVENTS","$http","$utilities"]}(window,angular);;;;
!function(e,n){function t(e,n,t,i,o,a,l,u,r){e.menu=t,i.USER=o.getSession();var c=i.USER.Name,s=i.USER.Claims.ClientId[0];r.Client.query().where("Id","==","guid'"+s+"'").execute().then(function(n){e.CLIENT=n[0]}),i.USER.Name.indexOf(" ")&&(c=i.USER.Name.split(" ")[0]),i.USER._ImageUrl=u.formatUrl(i.USER.ImageUrl,c),$(".mobile #navigation").click(function(){$("#application-layout").removeClass("sidebar-visible")}),e.logout=function(){i.$broadcast(a.LOGOUT)},i.$on("$stateChangeSuccess",function(n,t,i,o,a){e.menu.menuItems.filter(function(e){})})}var i=n.module("cab9.layout");i.controller("ClientSidebarController",t),t.$inject=["$scope","$interval","MenuService","$rootScope","Auth","AUTH_EVENTS","$http","$utilities","Model"]}(window,angular);;;;
!function(o,a){function n(o,a,n,e,i,t){function c(){var a=n.open({templateUrl:"/webapp/common/modals/quick-booking/partial.html",controller:"QuickBookingCreateController",windowClass:"quick-booking",backdropClass:"quick-booking-backdrop"});o.quickBookingAvailable=!1,a.result.then(function(){o.quickBookingAvailable=!0},function(){o.quickBookingAvailable=!0})}function u(a){for(var n=a.split("."),e=[],i=0;i<n.length;i++){var t=n[i];"root"!==t&&e.push(n[i])}o.pageName=e[0]}function r(){e.showQuickNav=!0}o.pageName="",o.quickNavigateInit=r,o.username="",o.quickBookingAvailable=!0,e.$on("$stateChangeSuccess",function(o,a,n,e,i){u(a.name)}),e.addQuickBooking=c,e.$on(t.LOGIN_SUCCESS,function(){var a=i.getSession();o.username=a.UserName});var l=i.getSession();l&&(o.username=l.UserName),u(a.current.name),o.logout=function(){e.$broadcast(t.LOGOUT)};var k=32;$(document).on("keydown",function(o){e.quickNavAvailable&&(o.metaKey||o.ctrlKey)&&o.keyCode==k&&(o.preventDefault(),o.stopPropagation(),e.showQuickNav=!0,e.$apply())})}var e=a.module("cab9.layout");e.controller("TopBarController",n),n.$inject=["$scope","$state","$modal","$rootScope","Auth","AUTH_EVENTS"]}(window,angular);;;;
!function(e,t){function a(t,a,n,o,i,r){function s(){a.showQuickNav=!1,$(document).off("keyup",l)}function l(e){27==e.keyCode&&(a.showQuickNav=!1,a.$apply())}t.quickNavigateRemove=s,t.searchValue="",t.searching=!1,t.results=null,t.choosen={group:null},t.groups={},t.visibleResults=[],t.localResults=[],t.chose=function(e){t.choosen.item=e,e.$data||("Driver"==e.Type?r.Driver.query().where("Id","eq","guid'"+e.Id+"'").select("Id, Firstname, Surname, Callsign, Mobile, Email, Address1, Area, TownCity, County, Postcode, ScoreOverall, ImageUrl").execute().then(function(t){e.$data=t[0]}):"Client"==e.Type?r.Client.query().where("Id","eq","guid'"+e.Id+"'").select("Id, Name, AccountNo, Phone, Email, Address1, Area, TownCity, County, Postcode, ScoreOverall, ImageUrl").execute().then(function(t){e.$data=t[0]}):"ClientStaff"==e.Type?r.ClientStaff.query().where("Id","eq","guid'"+e.Id+"'").select("Id, Firstname, Surname, Client/Name, Mobile, Email, ClientId, ImageUrl").include("Client").execute().then(function(t){e.$data=t[0]}):"Passenger"==e.Type?r.Passenger.query().where("Id","eq","guid'"+e.Id+"'").select("Id, Firstname, Surname, Client/Name, Mobile, Email, Addresses, ScoreOverall, ImageUrl").include("Client").include("Addresses").execute().then(function(t){e.$data=t[0]}):"Vehicle"==e.Type?r.Vehicle.query().where("Id","eq","guid'"+e.Id+"'").select("Id, Registration, Type/Name, Driver/Firstname, Driver/Surname, Driver/Callsign, Make, Model, Colour, RegYear, ScoreOverall, ImageUrl").include("Type").include("Driver").execute().then(function(t){e.$data=t[0]}):"Booking"==e.Type?r.Booking.query().where("Id","eq","guid'"+e.Id+"'").select("Id, LocalId, ClientId, BookingStatus, BookedDateTime, EstimatedDistance, Client/Name, Client/AccountNo, LeadPassenger/Firstname, LeadPassenger/Surname, BookingStops/StopOrder, BookingStops/StopSummary, ImageUrl").include("LeadPassenger").include("Client").include("BookingStops").execute().then(function(t){e.$data=t[0]}):"Invoice"==e.Type&&r.Invoice.query().where("Id","eq","guid'"+e.Id+"'").include("Client").execute().then(function(t){e.$data=t[0]}))},t.openBooking=function(t){e.open("/webapp/common/modals/bookings/edit-booking/window.html#?id="+t.Id+"&clientId="+t.$data.ClientId,"EDIT:"+t.Id,"height=870,width=1000,left=0,top=0")},t.$watch("choosen.group",function(e){e?t.visibleResults=t.groups[e]:t.visibleResults=t.results}),t.getScoreClass=function(e){return e>=4?"text-success":e>=2.5?"text-warning":"text-danger"},t.formatImage=function(e){if(e){var t=e.$data?e.$data.ImageUrl:e.ImageUrl,a="";if("Vehicle"==e.Type?a=e.$data?e.$data.Registration:e.Name:"Driver"==e.Type?a=e.$data?e.$data.Callsign:e.Name:"Client"==e.Type?a=e.$data?e.$data.AccountNo:e.Name:"Passenger"==e.Type?a=e.$data?e.$data.Firstname:e.Name:"ClientStaff"==e.Type?a=e.$data?e.$data.Firstname:e.Name:"Booking"==e.Type?a=e.$data?e.$data.LocalId:e.Name:"Invoice"==e.Type&&(a=e.$data?e.$data.Reference:e.Name),t)return"http"==t.slice(0,4)?t:(o.RESOURCE_ENDPOINT||o.API_ENDPOINT)+t;if(a){var n=a,i=a.indexOf(" ");return i!=-1&&(n=a.substring(0,i)),o.API_ENDPOINT+"api/imagegen?text="+n}}},t.goTo=function(e){i.go(e.state)},t.$watch("searchValue",function(e){if(t.results=null,t.groups={},t.choosen.group=null,t.visibleResults=[],t.localResults=[],e&&e.length>2){t.searching=!0,n.get(o.API_ENDPOINT+"api/globalsearch?searchtext="+encodeURIComponent(e)).success(function(e){t.visibleResults=t.results=e,t.groups={};for(var a=0;a<e.length;a++){var n=e[a],o=n.Type;t.groups[o]||(t.groups[o]=[],t.groups[o].limit=6),t.groups[o].push(n)}t.searching=!1});for(var a=i.get(),r=0;r<a.length;r++){var s=a[r],l=s.searchText;l&&l.indexOf(e.toLowerCase())>=0&&t.localResults.push({icon:s.searchIcon,name:s.searchName,state:s["default"]||s.name,Type:"Local"})}}}),a.$watch("showQuickNav",function(e){e&&setTimeout(function(){$("#search-box").focus(),$(document).on("keyup",l)},100)})}var n=t.module("cab9.layout");n.controller("QuickNavController",a),a.$inject=["$scope","$rootScope","$http","$config","$state","Model"]}(window,angular);;;;
!function(e){function r(e,r,o,t,s,a,n,u){function c(){swal("Smart Scores are Coming Soon","They say a picture is worth a 1000 words. We say that Cab 9 Smart Scores are worth over 1000 assements a week. Yes, that's how many times Cab9 assesses the performance of your Driver, Clients, Passengers and Controllers. Cab9 compares them in the real time with each other to conclude a simple score that gives you an exact idea of how they have been performing.")}e.rawItems=r,e.accessors=t,e.rNavTo=o,e.showScore=c,e.chosenGroup=null,e.cardLimit=2,e.choosen={group:null},e.groups={},r=r.sort(function(e,r){var o=t.Title(e),s=t.Title(r);return o<s?-1:o>s?1:0});var l,i=0;for(l=0;l<r.length;l++){var h=t.Group(r[l]);e.groups[h]?e.groups[h].push(r[l]):(e.groups[h]=[r[l]],i++)}e.selectGroups=i>5,r.pullMore&&r.pullMore.execute().then(function(r){e.rawItems=r,e.groups={},r=r.sort(function(e,r){var o=t.Title(e),s=t.Title(r);return o<s?-1:o>s?1:0});var o,s=0;for(o=0;o<r.length;o++){var a=t.Group(r[o]);e.groups[a]?e.groups[a].push(r[o]):(e.groups[a]=[r[o]],s++)}e.selectGroups=s>5}),n(function(){e.showSearch=!0,setTimeout(function(){$("#searchTerm").focus()},500)},500),e.$watchGroup(["searchTerm.$","chosenGroup","rawItems.length"],function(){var r=u("filter")(e.rawItems,e.searchTerm);e.chosenGroup?e.filteredItems=r.filter(function(r){return t.Group(r)==e.chosenGroup}):e.filteredItems=r})}var o=e.module("framework.UI.module");o.controller("ModuleNumPlateController",r),r.$inject=["$scope","rData","rNavTo","rAccessors","$state","$interval","$timeout","$filter"]}(angular);;;;
!function(e){function r(e,r,o,a,t,s,n){function c(){swal("Smart Scores are Coming Soon","They say a picture is worth a 1000 words. We say that Cab 9 Smart Scores are worth over 1000 assements a week. Yes, that's how many times Cab9 assesses the performance of your Driver, Clients, Passengers and Controllers. Cab9 compares them in the real time with each other to conclude a simple score that gives you an exact idea of how they have been performing.")}e.rawItems=r,e.accessors=a,e.rNavTo=o,e.showScore=c,e.chosenGroup=null,e.cardLimit=2,e.groups={},r=r.sort(function(e,r){var o=a.Title(e),t=a.Title(r);return o<t?-1:o>t?1:0});var i;for(i=0;i<r.length;i++){var u=a.Group(r[i]);e.groups[u]?e.groups[u].push(r[i]):e.groups[u]=[r[i]]}}var o=e.module("framework.UI.module");o.controller("ModuleNumPlateSecondaryController",r),r.$inject=["$scope","rData","rNavTo","rAccessors","$state","$interval","$timeout"]}(angular);;;;
!function(){function e(e,t,n,o,r,a,i,m,l,c){e.payments=[],e.start=(new moment).subtract(4,"year"),e.end=(new moment).endOf("month"),e.searchTerm={},e.hideOptions=!0,e.paging={currentPage:1,totalItems:0,maxPerPage:100};var d=null;e.selected={from:(new moment).startOf("day"),to:(new moment).endOf("day"),span:"day"},e.$watch("selected",function(n,r){n&&r&&(d&&a.cancel(d),d=a(function(){o.DriverPayment.query().include("Driver").include("PaymentModel").include("Invoice").include("Bill").filter("DriverId","eq","guid'"+t.Id+"'").filter("CreationTime","ge","datetimeoffset'"+e.selected.from.format()+"'").filter("CreationTime","le","datetimeoffset'"+e.selected.to.format()+"'").execute().then(function(t){e.payments=t,d=null})},250))},!0),e.viewItem=function(e){r.go("root.driverpayments.viewer.summary",{Id:e.Id})}}var t=angular.module("cab9.common");t.controller("DriverPaymentsController",e),e.$inject=["$scope","$stateParams","$modal","Model","$state","$timeout","$http","$config","$UI","CSV"]}();;;;
!function(){function e(e,t,r,n,o,u,s,l){function d(){e.adjustments=angular.copy(u),e.filters.Approved&&""!=e.filters.Approved&&("Approved"==e.filters.Approved&&(e.adjustments=e.adjustments.filter(function(e){return e.Approved})),"UnApproved"==e.filters.Approved&&(e.adjustments=e.adjustments.filter(function(e){return!e.Approved}))),e.filters.Type&&""!=e.filters.Type&&(e.adjustments=e.adjustments.filter(function(t){return t.Type==e.filters.Type}))}function i(e){swal({title:"Are you sure?",text:"Adjustment will be deleted",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, delete it!",closeOnConfirm:!1},function(){new s.DriverAdjustment(e).$delete().then(function(e){swal({title:"Adjustment deleted",text:"Changes have been updated.",type:"success",confirmButtonColor:t.COLOURS.brandSecondary}),r.go(r.current,n,{reload:!0})},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:t.COLOURS.brandSecondary})})})}function c(){var e=o.open({templateUrl:"/webapp/common/views/drivers/adjustments/modal/modal.html",controller:"DriverItemAdjustmentCreateController",resolve:{rDriverId:function(){return n.Id},rTaxes:function(){return s.Tax.query().execute()},rVehicleTypes:function(){return s.VehicleType.query().select("Id, Name").execute()}}});e.result.then(function(e){r.go(r.current,n,{reload:!0})},function(){})}function a(t){var u=(e.adjustments.indexOf(t),o.open({templateUrl:"/webapp/common/views/drivers/adjustments/modal/modal.html",controller:"DriverItemAdjustmentEditController",size:"lg",resolve:{rAdjustment:function(){return s.DriverAdjustment.query().where("Id eq guid'"+t.Id+"'").trackingEnabled().execute()},rTaxes:function(){return s.Tax.query().execute()},rVehicleTypes:function(){return s.VehicleType.query().select("Id, Name").execute()}}}));u.result.then(function(e){r.go(r.current,n,{reload:!0})},function(){})}e.adjustments=angular.copy(u),e.recurring=!1,e.openAdjustmentCreate=c,e.deleteAdjustment=i,e.recurring=l,e.schema="DriverAdjustment",e.showFilters=!1,e.filters={Approved:null,Type:null,Source:null},e.filterAdjustments=d,e.openAdjustmentEdit=a}var t=angular.module("cab9.common");t.controller("DriverItemAdjustmentsController",e),e.$inject=["$scope","$UI","$state","$stateParams","$modal","rAdjustments","Model","rRecurring"]}();;;;
!function(e){function t(e,t,n,u,l,a,s,d,r,i,c,o,m){function p(t){e.adjustment.$VehicleTypes.push(t);var n=e.unlinkedVehicleTypes.filter(function(e){return e.Id==t.Id});n[0]&&e.unlinkedVehicleTypes.splice(e.unlinkedVehicleTypes.indexOf(n[0]),1),e.selectedVehicleType=null}function y(t){e.unlinkedVehicleTypes.push(t);var n=e.adjustment.$VehicleTypes.filter(function(e){return e.Id==t.Id});n[0]&&e.adjustment.$VehicleTypes.splice(e.adjustment.$VehicleTypes.indexOf(n[0]),1)}function f(e){e.selected=!e.selected}function T(){try{"Recurring"!=e.adjustment.Recurring&&(e.adjustment.AppliesToBooking=!1,e.adjustment.DaysOfWeek=null,e.adjustment.StartTime=null,e.adjustment.EndTime=null,e.adjustment.VehicleTypes=null),e.adjustment.AppliesToBooking?(e.adjustment.DaysOfWeek=h(e.week),e.adjustment.StartTime=j(e.adjustment.$StartTime),e.adjustment.EndTime=j(e.adjustment.$EndTime),e.adjustment.VehicleTypes=v(e.adjustment.$VehicleTypes)):(e.adjustment.DaysOfWeek=null,e.adjustment.StartTime=null,e.adjustment.EndTime=null,e.adjustment.VehicleTypes=null),e.adjustment.AppliesToBooking&&(e.adjustment.Recurring="Recurring"),e.adjustment.$save().then(function(e){swal({title:"Adjustment Model Saved!",text:"Changes have been updated.",type:"success",confirmButtonColor:d.COLOURS.brandSecondary}),n.close(e)},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:d.COLOURS.brandSecondary})})}catch(t){swal({title:"Some Error Occured.",text:t.message,type:"error",confirmButtonColor:d.COLOURS.brandSecondary})}}function h(e){var t=0;return e.map(function(e){1==e.selected&&(t+=e.value)}),t>0?t:null}function j(e){if(e&&e.length>0){if(2==e.split(":").length)return parseFloat(60*e.split(":")[0])+parseFloat(e.split(":")[1]);throw{message:"Time is not in correct format. Please check your input and try again."}}return null}function v(e){if(e.length>0){var t=e.map(function(e){return e.Id});return t.join(",")}return null}e.adjustment=new i.DriverAdjustment,e.adjustment.TaxId=e.COMPANY.DefaultTaxId,e.adjustment.DriverId=c,e.adjustment.Approved=!0,e.viewMode="CREATE",e.save=T,e.taxes=o,e.adjustment.Approved=!0,e.adjustment.Recurring="Recurring",e.adjustment.AmountType="Fixed",e.adjustment.$VehicleTypes=[],e.unlinkedVehicleTypes=m,e.addVehicleType=p,e.removeVehicleType=y,e.toggleDay=f,e.week=[{day:"Su",value:1,selected:!1,full:"Sunday"},{day:"Mo",value:2,selected:!1,full:"Monday"},{day:"Tu",value:4,selected:!1,full:"Tuesday"},{day:"We",value:8,selected:!1,full:"Wednesday"},{day:"Th",value:16,selected:!1,full:"Thursday"},{day:"Fr",value:32,selected:!1,full:"Friday"},{day:"Sa",value:64,selected:!1,full:"Saturday"}]}function n(e,t,n,u,l,a,s,d,r,i,c,o,m){function p(t){e.adjustment.$VehicleTypes.push(t);var n=e.unlinkedVehicleTypes.filter(function(e){return e.Id==t.Id});n[0]&&e.unlinkedVehicleTypes.splice(e.unlinkedVehicleTypes.indexOf(n[0]),1),e.selectedVehicleType=null}function y(t){e.unlinkedVehicleTypes.push(t);var n=e.adjustment.$VehicleTypes.filter(function(e){return e.Id==t.Id});n[0]&&e.adjustment.$VehicleTypes.splice(e.adjustment.$VehicleTypes.indexOf(n[0]),1)}function f(e){e.selected=!e.selected}function T(){try{"Recurring"!=e.adjustment.Recurring&&(e.adjustment.AppliesToBooking=!1,e.adjustment.DaysOfWeek=null,e.adjustment.StartTime=null,e.adjustment.EndTime=null,e.adjustment.VehicleTypes=null),e.adjustment.AppliesToBooking?(e.adjustment.DaysOfWeek=v(e.week),e.adjustment.StartTime=g(e.adjustment.$StartTime),e.adjustment.EndTime=g(e.adjustment.$EndTime),e.adjustment.VehicleTypes=V(e.adjustment.$VehicleTypes)):(e.adjustment.DaysOfWeek=null,e.adjustment.StartTime=null,e.adjustment.EndTime=null,e.adjustment.VehicleTypes=null),e.adjustment.AppliesToBooking&&(e.adjustment.Recurring="Recurring"),e.adjustment.$patch().then(function(e){swal({title:"Adjustment Updated!",text:"Changes have been updated.",type:"success",confirmButtonColor:d.COLOURS.brandSecondary}),n.close(e)},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:d.COLOURS.brandSecondary})})}catch(t){swal({title:"Some Error Occured.",text:t.message,type:"error",confirmButtonColor:d.COLOURS.brandSecondary})}}function h(){if(j(),e.adjustment.$StartTime=$(e.adjustment.StartTime),e.adjustment.$EndTime=$(e.adjustment.EndTime),e.adjustment.$VehicleTypes=[],e.adjustment.VehicleTypes){var t=e.adjustment.VehicleTypes.split(",");e.unlinkedVehicleTypes.map(function(n){t.indexOf(n.Id)>-1&&(e.adjustment.$VehicleTypes.push(n),n.$assigned=!0)}),e.unlinkedVehicleTypes=e.unlinkedVehicleTypes.filter(function(e){return!e.$assigned})}}function j(){e.adjustment.DaysOfWeek&&e.adjustment.DaysOfWeek.length>0&&e.week.map(function(t){e.adjustment.DaysOfWeek.indexOf(t.full)>-1&&(t.selected=!0)})}function v(e){var t=0;return e.map(function(e){1==e.selected&&(t+=e.value)}),t>0?t:null}function g(e){if(e&&e.length>0){if(2==e.split(":").length)return parseFloat(60*e.split(":")[0])+parseFloat(e.split(":")[1]);throw{message:"Time is not in correct format. Please check your input and try again."}}return null}function $(e){if(e){if("number"==typeof e){var t=Math.floor(e/60)<10?"0"+Math.floor(e/60):Math.floor(e/60),e=e%60<10?"0"+e%60:e%60;return t+":"+e}throw{message:"Time is not in correct format. Please check your input and try again."}}return null}function V(e){if(e.length>0){var t=e.map(function(e){return e.Id});return t.join(",")}return null}e.taxes=o,e.adjustment=c[0],e.viewMode="EDIT",e.save=T,e.recurring=!1,e.addVehicleType=p,e.removeVehicleType=y,e.toggleDay=f,e.unlinkedVehicleTypes=m,e.week=[{day:"Su",value:1,selected:!1,full:"Sunday"},{day:"Mo",value:2,selected:!1,full:"Monday"},{day:"Tu",value:4,selected:!1,full:"Tuesday"},{day:"We",value:8,selected:!1,full:"Wednesday"},{day:"Th",value:16,selected:!1,full:"Thursday"},{day:"Fr",value:32,selected:!1,full:"Friday"},{day:"Sa",value:64,selected:!1,full:"Saturday"}],h()}var u=e.module("cab9.common");u.controller("DriverItemAdjustmentCreateController",t),t.$inject=["$scope","$stateParams","$modalInstance","$rootScope","$state","$q","$config","$UI","$http","Model","rDriverId","rTaxes","rVehicleTypes"],u.controller("DriverItemAdjustmentEditController",n),n.$inject=["$scope","$stateParams","$modalInstance","$rootScope","$state","$q","$config","$UI","$http","Model","rAdjustment","rTaxes","rVehicleTypes"]}(angular);;;;
!function(e){function r(r,t,o,n,l,a,i,s,m,c,u){function d(){var e=m.open({templateUrl:"/webapp/common/modals/user/modal.html",controller:"UserModalController",resolve:{rUser:function(){return{Id:r.User.Id,UserName:r.User.UserName,Email:r.User.Email}},resetPassword:function(){return!0}}});e.result.then(function(e){r.User=e},function(){})}function U(){swal({title:"Are you sure?",text:"User Account will be deleted!",type:"warning",showCancelButton:!0,confirmButtonColor:i.COLOURS.brandSecondary,confirmButtonText:"Confirm Delete!",closeOnConfirm:!0},function(){s["delete"](a.API_ENDPOINT+"api/accountUser?UserName="+r.User.UserName).then(function(e){r.User=null},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:i.COLOURS.brandSecondary})})})}function f(){function e(e){return!!/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(e)}if(r.item.Email&&r.item.Firstname&&r.item.Firstname.trim().length>0&&e(r.item.Email)){var t=m.open({templateUrl:"/webapp/common/modals/user/modal.html",controller:"UserModalController",resolve:{rUser:function(){return{UserName:r.item.Email,Email:r.item.Email,Name:r.item._Fullname,ImageUrl:r.item.ImageUrl,DriverId:r.item.Id}},rClaim:function(){return{type:"Driver",value:r.item.Id}},resetPassword:function(){return!1}}});t.result.then(function(e){r.User=e},function(){})}else swal({title:"Driver details(email,firstname) Invalid",text:"Please add details correctly",type:"warning",confirmButtonColor:i.COLOURS.brandSecondary})}"User Not Found"==u.Message?r.User=null:r.User=e.copy(u),r.displayMode="VIEW",r.openUserModal=f,r.deleteUserAccount=U,r.resetPassword=d}var t=e.module("cab9.common");t.controller("DriverUserController",r),r.$inject=["$scope","$stateParams","$rootScope","$state","$q","$config","$UI","$http","$modal","Model","rUser"]}(angular);;;;
!function(){function e(e,t,a,n,o,s){function i(){l(1)}function r(){e.showSearch=!0}function r(){e.showSearch=!e.showSearch,e.showSearch?setTimeout(function(){$("#searchTerm").focus()},500):e.searchTerm.$=""}function l(t){e.paging.currentPage=t;var a=angular.copy(e.invoices);if(e.searchTerm.$)var a=e.invoices.filter(function(t){var a=t.Client.Name+t.Reference+t.Status+t.NoOfBookings+t.DueDate+t._AmountDue;return a.toLowerCase().indexOf(e.searchTerm.$.toLowerCase())>-1});e.paging.totalResults=a.length,e.paging.maxPages=Math.ceil(e.paging.totalResults/e.paging.resultsPerPage);var n=(t-1)*e.paging.resultsPerPage;e.pageInvoices=a.slice(n,n+e.paging.resultsPerPage),e.loading=!1}e.invoices=[],e.searchTerm={},e.toggleSearch=r,e.filterInvoices=i,e.showSearch=!1,e.loading=!0,e.hideOptions=!0,e.start=(new moment).subtract(1,"year"),e.end=(new moment).add(1,"year");e.paging={currentPage:1,resultsPerPage:20,totalResults:null,maxPages:null},e.setPage=l,e.selected={from:(new moment).startOf("day"),to:(new moment).endOf("day"),span:"day",status:"Show All"},e.toggleSearch=r,e.$watchGroup(["selected.span","selected.status","selected.from.format()","selected.to.format()"],function(t,n){e.loading=!0;var s=o.Invoice.query().include("Payments,Client").filter("ClientId","eq","guid'"+a.Id+"'").filter("InvoiceType","eq","'Client'").filter("DueDate","ge","datetimeoffset'"+e.selected.from.format()+"'").filter("DueDate","le","datetimeoffset'"+e.selected.to.format()+"'");"Show All"!=e.selected.status&&s.filter("Status","eq","'"+e.selected.status+"'"),s.select("Id,Reference,Payments/AmountPaid,Client/Name,Client/AccountNo,CreationTime,DueDate,NoOfBookings,Status,AdjustmentsTaxAmount,TotalAmount,AdjustmentsSubTotal,ExtrasTaxAmount,BookingsSubTotal,ExtrasSubTotal,WaitingSubTotal").orderBy("Reference").execute().then(function(t){e.paging.totalResults=t.length,e.paging.maxPages=Math.ceil(e.paging.totalResults/e.paging.resultsPerPage),e.invoices=t,e.loading=!1,l(1)})}),e.viewItem=function(e){n.go("root.invoices.viewer",{Id:e.Id})}}var t=angular.module("cab9.common");t.controller("ClientInvoicesController",e),e.$inject=["$scope","$modal","$stateParams","$state","Model","$timeout"]}();;;;
!function(){function e(e,t,a,o,r,n){function s(){l(1)}function i(){e.showSearch=!0}function i(){e.showSearch=!e.showSearch,e.showSearch?setTimeout(function(){$("#searchTerm").focus()},500):e.searchTerm.$=""}function l(t){e.paging.currentPage=t;var a=angular.copy(e.creditNotes);e.searchTerm.$&&(a=e.creditNotes.filter(function(t){var a=t.Client.Name+t.Reference+t.Status+t.NoOfBookings+t.DueDate+t._AmountDue;return a.toLowerCase().indexOf(e.searchTerm.$.toLowerCase())>-1})),e.paging.totalResults=a.length,e.paging.maxPages=Math.ceil(e.paging.totalResults/e.paging.resultsPerPage);var o=(t-1)*e.paging.resultsPerPage;e.pageCreditNotes=a.slice(o,o+e.paging.resultsPerPage),e.loading=!1}e.creditNotes=[],e.searchTerm={},e.toggleSearch=i,e.filterCreditNotes=s,e.showSearch=!1,e.loading=!0,e.hideOptions=!0,e.start=(new moment).subtract(1,"year"),e.end=(new moment).add(1,"year");e.paging={currentPage:1,resultsPerPage:20,totalResults:null,maxPages:null},e.setPage=l,e.selected={from:(new moment).startOf("day"),to:(new moment).endOf("day"),span:"day"},e.toggleSearch=i,e.$watchGroup(["selected.span","selected.status","selected.from.format()","selected.to.format()"],function(t,o){e.loading=!0;r.CreditNote.query().include("Client").filter("ClientId","eq","guid'"+a.Id+"'").filter("TaxDate","ge","datetimeoffset'"+e.selected.from.format()+"'").filter("TaxDate","le","datetimeoffset'"+e.selected.to.format()+"'").select("Id,Reference,Description,CreationTime,TaxDate,Amount,Tax").orderBy("Reference").execute().then(function(t){e.paging.totalResults=t.length,e.paging.maxPages=Math.ceil(e.paging.totalResults/e.paging.resultsPerPage),e.creditNotes=t,e.loading=!1,l(1)})}),e.viewItem=function(e){o.go("root.creditnotes.viewer",{Id:e.Id})}}var t=angular.module("cab9.common");t.controller("ClientCreditNotesController",e),e.$inject=["$scope","$modal","$stateParams","$state","Model","$timeout"]}();;;;
!function(e){function r(e,r,a,o,t,c,n,s,h,f,i,l,m,d){function u(){e.showSearch=!e.showSearch,e.showSearch?!e.showSearch&&e.serverSearchTerm?e.serverSearchTerm.$="":setTimeout(function(){$("#searchTerm").focus()},500):e.searchTerm.$=""}function S(e){"SuperAdmin"==e?a.go(l,{Id:r.Id,superAdmin:!0}):a.go(l,{Id:r.Id})}e.staff=f,e.openStaffCreate=S,e.toggleSearch=u,e.navCards=m,e.navTable=d}var a=e.module("cab9.common");a.controller("ClientStaffOptionsController",r),r.$inject=["$scope","$stateParams","$state","$q","$config","$modal","$UI","$http","Model","rData","rAccessors","rCreateState","rNavCards","rNavTable"]}(angular);;;;
!function(e){function t(e,t,o,r,a,n,s,f,d,i){function c(){e.staff.ClientId=r.Id?r.Id:t.CLIENTID,e.staff.$save().then(function(e){swal({title:"Staff Saved",text:"Changes have been updated.",type:"success",confirmButtonColor:s.COLOURS.brandSecondary}),r.Id?o.go("root.clients.viewer.staff.viewer.details",{sId:e.data.Id}):o.go("root.staff.viewer.details",{sId:e.data.Id})},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:s.COLOURS.brandSecondary})})}function l(){r.Id?o.go("root.clients.viewer.staff.cards",{Id:r.Id}):o.go("root.staff.cards")}e.staff=new d.ClientStaff,e.viewMode="CREATE",r.superAdmin?(e.staff.AllPassengers=!0,e.superAdmin=!0,e.roles=i.filter(function(e){return"Super Admin"==e.Name}),e.roles[0]?e.staff.ClientStaffRoleId=e.roles[0].Id:new d.ClientStaffRole({Name:"Super Admin",Description:"May Administer a clients account."}).$save().then(function(t){e.roles.push(t.data),e.staff.ClientStaffRoleId=t.data.Id},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:s.COLOURS.brandSecondary})})):e.roles=i.filter(function(e){return"Super Admin"!=e.Name}),e.cancelEdit=l,e.save=c,t.backAvailable=r.Id?"root.clients.viewer.staff.cards({Id:'"+r.Id+"'})":"root.staff.cards"}var o=e.module("cab9.common");o.controller("ClientStaffItemCreateController",t),t.$inject=["$scope","$rootScope","$state","$stateParams","$q","$config","$UI","$http","Model","rRoles"]}(angular);;;;
!function(t){function e(t,e,o,a,n,r,c,f,l,s,i,d){function u(){t.staff.$rollback(!0),t.viewMode="VIEW"}function m(){s.openPicker({type:"staff",id:t.staff.Id,searchTerm:t.staff._Fullname}).then(function(e){t.staff.ImageUrl=e,p()},function(t){})}function I(){t.viewMode="EDIT"}function p(){var e=[];e.push(t.staff.$patch(!0)),n.all(e).then(function(){swal({title:"Staff Saved.",text:"Changes have been updated.",type:"success",confirmButtonColor:c.COLOURS.brandSecondary}),a.go(a.current,null,{reload:!0})},function(){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:c.COLOURS.brandSecondary})})}t.staff=i[0],t.roles=d,o.backAvailable=e.Id?"root.clients.viewer.staff.cards({Id:'"+e.Id+"'})":"root.staff.cards",t.viewMode="VIEW",t.chooseImage=m,t.startEditing=I,t.save=p,t.cancelEdit=u}var o=t.module("cab9.common");o.controller("ClientStaffItemDetailController",e),e.$inject=["$scope","$stateParams","$rootScope","$state","$q","$config","$UI","$http","Model","ImageUpload","rData","rRoles"]}(angular);;;;
!function(t){function e(t,e,n,i,r,c,f,o){var a=(new moment).subtract(2,"week");e.recentStaff=f.filter(function(t){return new moment(t.CreationTime).isAfter(a)}),t.CLIENTID?e.clientId=t.CLIENTID:e.clientId=o.Id,i.ClientStaff.query().filter("ClientId eq guid'"+e.clientId+"'").select("Id,Active,CreationTime").execute().then(function(t){e.recentStaff=t.filter(function(t){return new moment(t.CreationTime).isAfter(a)}),e.quickStats={total:t.length,active:t.filter(function(t){return t.Active}).length,recent:e.recentStaff.length}}),e.quickStats={total:f.length,active:f.filter(function(t){return t.Active}).length,recent:e.recentStaff.length},e.Staff=[]}var n=t.module("cab9.common");n.controller("ClientStaffModuleStatsController",e),e.$inject=["$rootScope","$scope","$UI","Model","$config","$http","rData","$stateParams"]}(angular);;;;
!function(e){function n(n,s,a,t,r,o,i,a,f,s,c,d){function g(e){e&&(n.loadingPassengers=!0,s.get(a.API_ENDPOINT+"api/Passengers/Search",{params:{searchText:e,clientId:n.clientId,lite:!0}}).then(function(e){n.passengers=e.data,n.passengers=n.passengers.map(function(e){return new c.Passenger(e)}),n.passengerIds=n.staff.Passengers.map(function(e){return e.Id}),n.unlinkedPassengers=n.passengers.filter(function(e){return n.passengerIds.indexOf(e.Id)==-1}),n.loadingPassengers=!1}))}function u(){n.viewMode="VIEW",n.staff=e.copy(d[0]),n.staff.Passengers=n.staff.Passengers.map(function(e){return new c.Passenger(e)}),n.selected={Passenger:null}}function l(e){n.staff.Passengers.push(e);var s=n.unlinkedPassengers.filter(function(n){return n.Id==e.Id});s[0]&&n.unlinkedPassengers.splice(n.unlinkedPassengers.indexOf(s[0]),1)}function P(e){var s=n.staff.Passengers.filter(function(n){return n.Id==e.Id});s[0]&&n.staff.Passengers.splice(n.staff.Passengers.indexOf(s[0]),1)}function I(){s.post(a.API_ENDPOINT+"api/ClientStaff/ManagePassengers",n.staff).then(function(e){swal({title:"Staff Passengers Updated",text:"Changes have been updated.",type:"success",confirmButtonColor:f.COLOURS.brandSecondary}),o.go(o.current,{Id:t.Id},{reload:!0})},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:f.COLOURS.brandSecondary})})}function p(){u()}function m(){n.viewMode="EDIT"}u(),n.startEdit=m,n.cancelEdit=p,n.addPassenger=l,n.removePassenger=P,n.saveChanges=I,r.CLIENTID?n.clientId=r.CLIENTID:n.clientId=t.Id,n.searchPassengers=g,n.passengers=[],n.unlinkedPassengers=[]}var s=e.module("cab9.common");s.controller("ClientStaffItemPassengerController",n),n.$inject=["$scope","$http","$config","$stateParams","$rootScope","$state","$q","$config","$UI","$http","Model","rData"]}(angular);;;;
!function(e){function r(e,r,o,t,a,n,s,c,l,m,h){function i(){e.showSearch=!e.showSearch,e.showSearch?!e.showSearch&&e.serverSearchTerm?e.serverSearchTerm.$="":setTimeout(function(){$("#searchTerm").focus()},500):e.searchTerm.$=""}function u(){n.open({templateUrl:"/webapp/common/modals/passenger/create.modal.html",controller:"PassengerItemCreateModalController",resolve:{rClientId:function(){return r.Id},rNavigateAfterSave:function(){return!0}}})}e.staff=m,e.toggleSearch=i,e.newPassenger=u}var o=e.module("cab9.common");o.controller("ClientPassengersOptionsController",r),r.$inject=["$scope","$stateParams","$state","$q","$config","$modal","$UI","$http","Model","rData","rAccessors"]}(angular);;;;
!function(e){function t(e,t,n,r,i,c,a){var o=(new moment).subtract(2,"week");e.recentPassenger=c.filter(function(e){return new moment(e.CreationTime).isAfter(o)}),e.clientId=a.Id,n.Passenger.query().select("Id,Active,CreationTime").where("ClientId eq guid'"+a.Id+"'").execute().then(function(t){e.recentPassenger=t.filter(function(e){return new moment(e.CreationTime).isAfter(o)}),e.quickStats={total:t.length,active:t.filter(function(e){return e.Active}).length,recent:e.recentPassenger.length}}),e.quickStats={total:c.length,active:c.filter(function(e){return e.Active}).length,recent:e.recentPassenger.length},e.Passenger=[]}var n=e.module("cab9.common");n.controller("ClientPassengerModuleStatsController",t),t.$inject=["$scope","$UI","Model","$config","$http","rData","$stateParams"]}(angular);;;;
!function(e){function t(t,r,n,o,a,l,f,s,i,u,c,m){function d(){var e=i.open({templateUrl:"/webapp/common/modals/user/modal.html",controller:"UserModalController",resolve:{rUser:function(){return{Id:t.User.Id,UserName:t.User.UserName,Email:t.User.Email}},rClaim:function(){return{type:"ClientStaff",value:t.staff.Id}},rStaffRole:function(){return t.staff.StaffRole},resetPassword:function(){return!0}}});e.result.then(function(e){t.User=e},function(){})}function U(){swal({title:"Are you sure?",text:"User Account will be deleted!",type:"warning",showCancelButton:!0,confirmButtonColor:f.COLOURS.brandSecondary,confirmButtonText:"Confirm Delete!",closeOnConfirm:!0},function(){s["delete"](l.API_ENDPOINT+"api/accountUser?UserName="+t.User.UserName).then(function(e){t.User=null},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:f.COLOURS.brandSecondary})})})}function p(){function e(e){return!!/^\w+([\.+-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,10})+$/.test(e)}if(t.staff.Email&&t.staff.Firstname&&t.staff.Firstname.trim().length>0&&e(t.staff.Email)){var r=i.open({templateUrl:"/webapp/common/modals/user/modal.html",controller:"UserModalController",resolve:{rUser:function(){return{UserName:t.staff.Email,Email:t.staff.Email,Name:t.staff._Fullname,ImageUrl:t.staff.ImageUrl,ClientId:t.staff.ClientId,ClientStaffId:t.staff.Id}},rClaim:function(){return{type:"ClientStaff",value:t.staff.Id}},rStaffRole:function(){return t.staff.StaffRole},resetPassword:function(){return!1}}});r.result.then(function(e){t.User=e},function(){})}else swal({title:"Staff details(email,firstname) Invalid",text:"Please add details correctly",type:"warning",confirmButtonColor:f.COLOURS.brandSecondary})}function C(){var e=i.open({templateUrl:"/webapp/common/modals/user/link-modal.html",controller:"LinkUserModalController",resolve:{rData:function(){return{ClientId:t.staff.ClientId,StaffId:t.staff.Id}}}});e.result.then(function(e){t.User=e},function(){})}"User Not Found"==c.Message?t.User=null:t.User=e.copy(c),t.staff=m[0],t.displayMode="VIEW",t.openUserModal=p,t.deleteUserAccount=U,t.resetPassword=d,t.openLinkUserModal=C}var r=e.module("cab9.common");r.controller("ClientStaffItemUserController",t),t.$inject=["$scope","$stateParams","$rootScope","$state","$q","$config","$UI","$http","$modal","Model","rUser","rData"]}(angular);;;;
!function(e){function n(e,n,t,r,o,c,l,i,f,a,u){function d(n){swal({title:"Are you sure?",text:"Reference will be deleted",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, delete it!",closeOnConfirm:!1},function(){e.references.indexOf(n);new a.ClientReference(n).$delete().then(function(e){swal({title:"Client Reference deleted",text:"Changes have been updated.",type:"success",confirmButtonColor:i.COLOURS.brandSecondary}),C()},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:i.COLOURS.brandSecondary})})})}function s(){var e=t.open({templateUrl:"/webapp/common/views/clients/references/modal/modal.html",controller:"ClientItemReferenceCreateController"});e.result.then(function(e){C()})}function m(e){var n=t.open({templateUrl:"/webapp/common/views/clients/references/modal/modal.html",controller:"ClientItemReferenceEditController",size:"lg",resolve:{rReference:function(){return a.ClientReference.query().where("Id eq guid'"+e.Id+"'").trackingEnabled().execute()}}});n.result.then(function(e){C()})}function C(){a.ClientReference.query().where("ClientId eq guid'"+n.Id+"'").execute().then(function(n){e.references=n})}e.references=u,e.openReferenceCreate=s,e.deleteReference=d,e.openReferenceEdit=m}var t=e.module("cab9.common");t.controller("ClientItemReferencesController",n),n.$inject=["$scope","$stateParams","$modal","$rootScope","$state","$q","$config","$UI","$http","Model","rReferences"]}(angular);;;;
!function(e){function r(e,r,t,n,o,a,c,l,s,i){function d(r){try{e.reference.$testReg=u(r)}catch(t){return!0}return!1}function u(e){for(var r="[a-z]",t="[A-Z]",n="[0-9]",o="^",a=0,c=!1,l=!1,s=0;s<e.length;s++){var i=e[s];if("'"===i)o+=l?")":"(",l=!l;else if(l)["."].indexOf(i)!=-1&&(i="\\"+i),o+=i;else if(">"===i){if(a++,a>1)throw"Bad Mask - Case blocks have consecutive > without ending previous block"}else if("<"===i){if(a--,a<-1)throw"Bad Mask - Case blocks have consecutive < without ending previous block"}else"0"===i?(c=!0,o+="("+n+")"):"9"===i?o+="("+n+"?)":1===a?"A"===i?(c=!0,o+="("+t+"|"+n+")"):"a"===i?o+="("+t+"?|"+n+"?)":"L"===i?(c=!0,o+="("+t+")"):"l"===i&&(o+="("+t+"?)"):0===a?"A"===i?(c=!0,o+="("+r+"|"+t+"|"+n+")"):"a"===i?o+="("+r+"?|"+t+"?|"+n+"?)":"L"===i?(c=!0,o+="("+r+"|"+t+")"):"l"===i&&(o+="("+r+"?|"+t+"?)"):a===-1&&("A"===i?(c=!0,o+="("+r+"|"+n+")"):"a"===i?o+="("+r+"?|"+n+"?)":"L"===i?(c=!0,o+="("+r+")"):"l"===i&&(o+="("+r+"?)"))}if(l)throw"Bad Mask - Quoted section not terminated";if(!c)throw"Bad Mask - Must contain at least 1 mandatory symbol (A, L, 0)";return o+="$",new RegExp(o)}function f(){var o=r.Id?r.Id:n.CLIENTID;e.reference.ClientId=o,"List"!=e.reference.ReferenceType||e.reference.$manualEntry?e.reference.$save().success(function(){t.close(),swal({title:"Client Reference Created.",text:"Changes have been updated.",type:"success",confirmButtonColor:l.COLOURS.brandSecondary})}).error(function(){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:l.COLOURS.brandSecondary})}):p()}function p(){var a=r.Id?r.Id:n.CLIENTID;if(e.reference.$file){e.progress=0;var s=new FormData;s.append("file",e.reference.$file);var i=new XMLHttpRequest;i.upload.onprogress=function(r){r.lengthComputable&&(e.progress=Math.round(r.loaded/r.total*100),"$apply"!=e.$$phase&&"$digest"!=e.$$phase&&e.$apply())},i.onload=function(r){4==r.target.readyState&&(200==r.target.status?(t.close(),swal({title:"Client Reference Created.",text:"Changes have been updated.",type:"success",confirmButtonColor:l.COLOURS.brandSecondary}),o.go(o.current,{Id:a},{reload:!0})):(e.progress=null,swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:l.COLOURS.brandSecondary})))},i.onerror=function(r){e.progress=null,swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:l.COLOURS.brandSecondary})},i.onabort=function(r){e.progress=null,swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:l.COLOURS.brandSecondary})},i.open("POST",c.API_ENDPOINT+"api/clientreferences?ClientId="+a+"&ReferenceName="+e.reference.ReferenceName+"&Mandatory="+e.reference.Mandatory,!0),i.setRequestHeader("Authorization","Bearer "+n.$$access_token),i.setRequestHeader("Accept-Type","application/json"),i.send(s)}else swal({title:"File not available.",text:"Please upload a csv file.",type:"warning",confirmButtonColor:l.COLOURS.brandSecondary})}e.reference=new i.ClientReference,e.reference.$File=null,e.reference.$data=null,e.reference.$KnownValues="",e.upload=p,e.save=f,e.viewMode="CREATE",e.testMask=d,e.progress=null}function t(e,r,t,n,o,a,c,l,s,d,u){function f(){var r=e.reference.$KnownValues.replace(/\r\n/g,",").replace(/\n/g,",");s.post(c.API_ENDPOINT+"/api/clientreferences/add?ClientReferenceId="+e.reference.Id+"&ClientReferenceKnownValue="+r).then(function(e){t.close(),swal({title:"Client Reference Updated.",text:"Changes have been updated.",type:"success",confirmButtonColor:l.COLOURS.brandSecondary})},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:l.COLOURS.brandSecondary})})}function p(){var r=e.reference.$KnownValues.replace("\r\n",",").replace("\n",",");s.post(c.API_ENDPOINT+"/api/clientreferences/delete?ClientReferenceId="+e.reference.Id+"&ClientReferenceKnownValue="+r).then(function(e){t.close();var r=0,n=0;for(i=0,len=e.data.length;i<len;i++)"Deleted"==e.data[i].Status?r++:n++;swal({title:"Client Reference Updated.",text:"Deleted:"+r+" Not Found:"+n,type:"success",showConfirmButton:!0,confirmButtonColor:l.COLOURS.brandSecondary})},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:l.COLOURS.brandSecondary})})}function C(){var o=r.Id?r.Id:n.CLIENTID;e.reference.ClientId=o,e.reference.$patch().success(function(){"List"==e.reference.ReferenceType?O():(t.close(),swal({title:"Client Reference Updated.",text:"Changes have been updated.",type:"success",confirmButtonColor:l.COLOURS.brandSecondary}))}).error(function(){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:l.COLOURS.brandSecondary})})}function S(){s.post(c.API_ENDPOINT+"/api/clientreferences/validate?ClientReferenceId="+e.reference.Id+"&ReferenceValue="+e.reference.$KnownValues).then(function(r){e.valid="valid"},function(r){return 404==r.status?void(e.valid="invalid"):void swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:l.COLOURS.brandSecondary})})}function m(r){try{e.reference.$testReg=h(r)}catch(t){return!0}return!1}function h(e){for(var r="[a-z]",t="[A-Z]",n="[0-9]",o="^",a=0,c=!1,l=!1,s=0;s<e.length;s++){var i=e[s];if("'"===i)o+=l?")":"(",l=!l;else if(l)["."].indexOf(i)!=-1&&(i="\\"+i),o+=i;else if(">"===i){if(a++,a>1)throw"Bad Mask - Case blocks have consecutive > without ending previous block"}else if("<"===i){if(a--,a<-1)throw"Bad Mask - Case blocks have consecutive < without ending previous block"}else"0"===i?(c=!0,o+="("+n+")"):"9"===i?o+="("+n+"?)":1===a?"A"===i?(c=!0,o+="("+t+"|"+n+")"):"a"===i?o+="("+t+"?|"+n+"?)":"L"===i?(c=!0,o+="("+t+")"):"l"===i&&(o+="("+t+"?)"):0===a?"A"===i?(c=!0,o+="("+r+"|"+t+"|"+n+")"):"a"===i?o+="("+r+"?|"+t+"?|"+n+"?)":"L"===i?(c=!0,o+="("+r+"|"+t+")"):"l"===i&&(o+="("+r+"?|"+t+"?)"):a===-1&&("A"===i?(c=!0,o+="("+r+"|"+n+")"):"a"===i?o+="("+r+"?|"+n+"?)":"L"===i?(c=!0,o+="("+r+")"):"l"===i&&(o+="("+r+"?)"))}if(l)throw"Bad Mask - Quoted section not terminated";if(!c)throw"Bad Mask - Must contain at least 1 mandatory symbol (A, L, 0)";return o+="$",new RegExp(o)}function O(a,s){var i=r.Id?r.Id:n.CLIENTID;if("Add Known Values"==e.selected.action)return void f();if("Delete Known Values"==e.selected.action)return void p();if(!e.reference.$file&&"Replace CSV"==e.selected.action)return void swal({title:"Please upload a file",text:"Or Select different action",type:"warning",confirmButtonColor:l.COLOURS.brandSecondary});if("Replace CSV"==e.selected.action){e.progress=0;var d=new FormData;d.append("file",e.reference.$file);var u=new XMLHttpRequest;u.upload.onprogress=function(r){r.lengthComputable&&(e.progress=Math.round(r.loaded/r.total*100),"$apply"!=e.$$phase&&"$digest"!=e.$$phase&&e.$apply())},u.onload=function(n){4==n.target.readyState&&(200==n.target.status?(t.close(),swal({title:"Client Reference Updated.",text:"Changes have been updated.",type:"success",confirmButtonColor:l.COLOURS.brandSecondary}),o.go(o.current,{Id:r.Id},{reload:!0})):(e.progress=null,swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:l.COLOURS.brandSecondary})))},u.onerror=function(r){e.progress=null,swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:l.COLOURS.brandSecondary})},u.onabort=function(r){e.progress=null,swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:l.COLOURS.brandSecondary})},u.open("POST",c.API_ENDPOINT+"api/clientreferences?ClientId="+i+"&ReferenceName="+e.reference.ReferenceName+"&ClientReferenceId="+e.reference.Id,!0),u.setRequestHeader("Authorization","Bearer "+n.$$access_token),u.setRequestHeader("Accept-Type","application/json"),u.send(d)}else t.close(),swal({title:"Client Reference Updated.",text:"Changes have been updated.",type:"success",confirmButtonColor:l.COLOURS.brandSecondary})}e.reference=u[0],e.selected={action:""},e.actions=["Replace CSV","Add Known Values","Delete Known Values","Validate Known Value"],e.reference.$File=null,e.reference.$data=null,e.progress=null,e.reference.$KnownValues="",e.viewMode="EDIT",e.upload=O,e.validate=S,e.valid="",e.testMask=m,e.save=C}var n=e.module("cab9.common");n.controller("ClientItemReferenceCreateController",r),r.$inject=["$scope","$stateParams","$modalInstance","$rootScope","$state","$q","$config","$UI","$http","Model"],n.controller("ClientItemReferenceEditController",t),t.$inject=["$scope","$stateParams","$modalInstance","$rootScope","$state","$q","$config","$UI","$http","Model","rReference"]}(angular);;;;
!function(e){function r(r,n,t,o,d,a,c,t,l,n,s,v){function u(e){e&&(r.loadingDrivers=!0,n.get(t.API_ENDPOINT+"api/Drivers/Search",{params:{searchText:e,lite:!0}}).then(function(e){r.drivers=e.data,r.drivers=r.drivers.map(function(e){return new s.Driver(e)}),r.driverIds=r.client.BannedDrivers.map(function(e){return e.Id}),r.unlinkedDrivers=r.drivers.filter(function(e){return r.driverIds.indexOf(e.Id)==-1}),r.loadingDrivers=!1}))}function D(){r.viewMode="VIEW",r.client=e.copy(v[0]),r.client.BannedDrivers=r.client.BannedDrivers.map(function(e){return new s.Driver(e)}),r.selected={Driver:null}}function f(e){for(r.client.BannedDrivers.push(e),i=0,len=r.unlinkedDrivers.length;i<len;i++)if(r.unlinkedDrivers[i].Id==e.Id){r.unlinkedDrivers.splice(i,1);break}r.selected.Driver=null}function p(e){for(i=0,len=r.client.BannedDrivers.length;i<len;i++)if(r.client.BannedDrivers[i].Id==e.Id){r.client.BannedDrivers.splice(i,1);break}}function I(){n.post(t.API_ENDPOINT+"api/Client/ManageDrivers",r.client).then(function(e){swal({title:"Client Banned Drivers Updated",text:"Changes have been updated.",type:"success",confirmButtonColor:l.COLOURS.brandSecondary}),a.go(a.current,{Id:o.Id},{reload:!0})},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:l.COLOURS.brandSecondary})})}function h(){D()}function m(){r.viewMode="EDIT"}D(),r.startEdit=m,r.cancelEdit=h,r.addDriver=f,r.removeDriver=p,r.saveChanges=I,r.searchDrivers=u,r.drivers=[],r.unlinkedDrivers=[]}var n=e.module("cab9.common");n.controller("ClientItemBannedDriversController",r),r.$inject=["$scope","$http","$config","$stateParams","$rootScope","$state","$q","$config","$UI","$http","Model","rData"]}(angular);;;;
!function(e){function r(e,r,a,t,d,n,c,s,o,l,u,p){function f(r){e.view.current=r}function m(r,d){e.showLoader=!0,r.DefaultCard=d;var c=r.ExpirationMonth;e.cardList.some(function(e){return e.CardNumber.split(" ")[3]==r.CardNumber.split(" ")[3]})?(e.card.ExpirationMonth=c,e.showLoader=!1,e.card=null,swal("Error","Card details entered already exists. Please check saved cards.","error")):(r.ExpirationYear=r.ExpirationMonth.split("/")[1].trim().slice(-2),r.ExpirationMonth=r.ExpirationMonth.split("/")[0].trim(),r.Type=j(r.CardNumber),void 0!=u?r.ClientId=n.Id:void 0!=l&&(r.PassengerId=n.Id),a.post(t.API_ENDPOINT+"api/Payments/addcard",r).then(function(r){if(swal("Success","Card added successfully","success"),d)for(i=0;i<e.cardList.length;i++)e.cardList[i].DefaultCard=!1;e.cardList.push(r.data.Card),e.showLoader=!1,e.card=null},function(r){void 0!=r.data&&void 0!=r.data.Message?swal("Error",r.data.Message,"error"):swal("Error","Something didn't work, please try again","error"),e.card.ExpirationMonth=c,e.showLoader=!1}))}function h(r){swal({title:"Confirm Delete",text:"Are you sure you want to delete this card?",type:"warning",showCancelButton:!0,confirmButtonText:"Confirm Delete!"},function(){a["delete"](t.API_ENDPOINT+"api/Payments/deletecard?cardId="+r).then(function(a){swal("Success","Card deleted successfully","success"),e.cardList=e.cardList.filter(function(e){return e.Id!=r})},function(e){void 0!=e.ExceptionMessage?swal("Error",e.ExceptionMessage,"error"):swal("Error","Something didn't work, please try again","error")})})}function w(r){swal({title:"Are you sure?",text:"Are you sure you want to make this card as default card?",type:"warning",showCancelButton:!0,confirmButtonText:"Confirm!"},function(){a.patch(t.API_ENDPOINT+"api/Payments/makedefault",r).then(function(a){for(swal("Success","Card made as your default card successfully","success"),i=0;i<e.cardList.length;i++)e.cardList[i].Id==r.Id?e.cardList[i].DefaultCard=!0:e.cardList[i].DefaultCard=!1},function(e){swal("Error","Something didn't work, please try again","error")})})}function j(e){var r=new RegExp("^4");return null!=e.match(r)?"visa":/^(5[1-5][0-9]{14}|2(22[1-9][0-9]{12}|2[3-9][0-9]{13}|[3-6][0-9]{14}|7[0-1][0-9]{13}|720[0-9]{12}))$/.test(e)?"mastercard":/^(5[1-5]\d{2})[\s\-]?(\d{4})[\s\-]?(\d{4})[\s\-]?(\d{4})$/.test(e)?"mastercard":(r=new RegExp("^3[47]"),null!=e.match(r)?"amex":(r=new RegExp("^(6011|622(12[6-9]|1[3-9][0-9]|[2-8][0-9]{2}|9[0-1][0-9]|92[0-5]|64[4-9])|65)"),null!=e.match(r)?"discover":(r=new RegExp("^36"),null!=e.match(r)?"diners":(r=new RegExp("^30[0-5]"),null!=e.match(r)?"diners-carteblanche":(r=new RegExp("^35(2[89]|[3-8][0-9])"),null!=e.match(r)?"jcb":(r=new RegExp("^(4026|417500|4508|4844|491(3|7))"),null!=e.match(r)?"visaelectron":(r=new RegExp("^(40117[8-9]|431274|438935|451416|457393|45763[1-2]|506(699|7[0-6][0-9]|77[0-8])|509d{3}|504175|627780|636297|636368|65003[1-3]|6500(3[5-9]|4[0-9]|5[0-1])|6504(0[5-9]|[1-3][0-9])|650(4[8-9][0-9]|5[0-2][0-9]|53[0-8])|6505(4[1-9]|[5-8][0-9]|9[0-8])|6507(0[0-9]|1[0-8])|65072[0-7]|6509(0[1-9]|1[0-9]|20)|6516(5[2-9]|[6-7][0-9])|6550([0-1][0-9]|2[1-9]|[3-4][0-9]|5[0-8]))"),null!=e.match(r)?"elo":(r=new RegExp("^(5018|5020|5038|6304|6759|6761|6763)[0-9]{8,15}$"),null!=e.match(r)?"maestro":""))))))))}function C(e){var r=e.toLowerCase().replace(/\s/g,"");return"mastercard"==r?"jp-card jp-card-identified jp-card-mastercard":"visa"==r?"jp-card jp-card-identified jp-card-visa":"visaelectron"==r?"jp-card jp-card-identified jp-card-visaelectron":"discover"==r?"jp-card jp-card-identified jp-card-discover":"amex"==r?"jp-card jp-card-identified jp-card-amex":"diners"==r||"diners-carteblanche"==r?"jp-card jp-card-identified jp-card-dinersclub":"jcb"==r?"jp-card jp-card-identified jp-card-jcb":"elo"==r?"jp-card jp-card-identified jp-card-elo":"maestro"==r?"jp-card jp-card-identified jp-card-maestro":"jp-card jp-card-identified"}e.showLoader=!1,e.cardList=s,e.view={current:"SAVED",switchTo:f},e.addCard=m,e.deleteCard=h,e.makeDefault=w,e.getCardTypeClass=C}var a=e.module("cab9.common");a.controller("ClientItemCreditCardController",r),r.$inject=["$scope","$state","$http","$config","Model","$stateParams","$q","rSavedCards","rData","rPassenger","rClient","CSV"]}(angular);;;;
!function(e){function r(e,r,a,d,t,n,c,s,o,l,p,u){function f(){var r=p.open({templateUrl:"/webapp/common/modals/add-payment-card/partial.html",controller:"AddPaymentCardController",windowClass:"add-payment-card-modal-wrapper",resolve:{rPassengerId:function(){return e.passengerId},rClientId:function(){return e.clientId},rDriverId:function(){return e.driverId}}});r.result.then(function(r){e.cards.push(r)})}function m(r){swal({title:"Confirm Delete",text:"Are you sure you want to delete this card?",type:"warning",showCancelButton:!0,confirmButtonText:"Confirm Delete?",closeOnConfirm:!1},function(){a["delete"](d.API_ENDPOINT+"api/Payments/deletecard?CardId="+r).then(function(a){swal("Success","Card deleted successfully","success"),e.cards=e.cards.filter(function(e){return e.Id!=r})},function(e){e.data&&e.data.ExceptionMessage?swal("Error",e.data.ExceptionMessage,"error"):swal("Error","Something didn't work, please try again","error")})})}function j(r){swal({title:"Are you sure?",text:"Are you sure you want to make this card as default card?",type:"warning",showCancelButton:!0,confirmButtonText:"Confirm",closeOnConfirm:!1},function(){a.patch(d.API_ENDPOINT+"api/Payments/makedefault",r).then(function(a){for(swal("Success","Card made as your default card successfully","success"),i=0;i<e.cards.length;i++)e.cards[i].Id==r.Id?e.cards[i].DefaultCard=!0:e.cards[i].DefaultCard=!1},function(e){swal("Error","Something didn't work, please try again","error")})})}function C(e){var r=e.toLowerCase().replace(/\s/g,"");return"mastercard"==r?"jp-card jp-card-identified jp-card-mastercard":"visa"==r?"jp-card jp-card-identified jp-card-visa":"visaelectron"==r?"jp-card jp-card-identified jp-card-visaelectron":"discover"==r?"jp-card jp-card-identified jp-card-discover":"amex"==r?"jp-card jp-card-identified jp-card-amex":"diners"==r||"diners-carteblanche"==r?"jp-card jp-card-identified jp-card-dinersclub":"jcb"==r?"jp-card jp-card-identified jp-card-jcb":"elo"==r?"jp-card jp-card-identified jp-card-elo":"maestro"==r?"jp-card jp-card-identified jp-card-maestro":"jp-card jp-card-identified"}e.cards=s,e.deleteCard=m,e.makeDefault=j,e.getCardTypeClass=C,e.addCard=f,e.clientId=o,e.passengerId=l,e.driverId=u}var a=e.module("cab9.common");a.controller("CreditCardsCardsController",r),r.$inject=["$scope","$state","$http","$config","Model","$stateParams","$q","rCards","rClientId","rPassengerId","$modal","rDriverId"]}(angular);;;;
!function(n){function e(n,e,s,a,t,r,o,i,c,d){function l(){n.fetching=!0;var e=a.API_ENDPOINT+"api/Transactions/DetailedTransactions";n.clientId&&!n.passengerId?e+="?clientId="+n.clientId:!n.clientId&&n.passengerId?e+="?passengerId="+n.passengerId:(n.clientId||n.passengerId)&&swal("Conflict in Query","Transactions are being requested for both a client and passenger which is not possible.","error"),s({method:"GET",url:e}).then(function(e){n.transactions=e.data},function(n){console.log(n)})}function p(n){n.$expanded=!0,n.Request=JSON.parse(n.Request),n.Response=JSON.parse(n.Response)}n.transactions=[],n.fetchTransactions=l,n.clientId=i,n.passengerId=c,n.expandTransaction=p,n.fetchTransactions()}var s=n.module("cab9.common");s.controller("CreditCardsTransactionsController",e),e.$inject=["$scope","$state","$http","$config","Model","$stateParams","$q","rClientId","rPassengerId","$modal"]}(angular);;;;
!function(e){function o(e,o,t,n,a,i,l,s,r){function c(){return r.open({templateUrl:"/webapp/common/views/clients/webBookerSettings/modal/modal.html",controller:"ImageModalController",backdrop:"static",resolve:{rSetting:function(){return e.setting}}}).result.then(function(o){e.setting.WelcomeHeroImage=o,e.counter++},function(e){})}function d(){e.displayMode="EDIT"}function u(){e.setting.$rollback(!1),e.displayMode="VIEW"}function p(){e.setting&&!e.setting.Id?(e.setting.ClientId=o.Id,e.setting.$save().success(function(){swal({title:"Web Booker Settings Saved.",text:"Changes have been saved.",type:"success",confirmButtonColor:i.COLOURS.brandSecondary}),t.go("root.clients.viewer.webbookersettings",null,{reload:!0})})):e.setting.$patch().success(function(){swal({title:"Web Booker Settings Saved.",text:"Changes have been updated.",type:"success",confirmButtonColor:i.COLOURS.brandSecondary}),e.displayMode="VIEW"})}e.setting=s[0]?s[0]:new l.ClientWebBookerSetting,e.chooseImage=c,e.startEdit=d,e.cancelEdit=u,e.saveEdits=p,e.displayMode="VIEW",e.counter=1}function t(o,t,n,a,i,l){o.upload={choosen:null,src:null,dimensions:null,minWidth:1024,minHeight:768,uploadFull:function(){var s=new FormData;s.append("file",o.upload.choosen),t.post(n.API_ENDPOINT+"api/ClientWebBookerSettings",s,{transformRequest:e.identity,headers:{"Content-Type":void 0},params:{id:i.Id}}).success(function(e){swal({title:"Web Booker Image Uploaded",text:"The web booker image has been uploaded and will be displayed on your company's login page. You may have to refresh the page to view the changes.",type:"success",confirmButtonColor:l.COLOURS.brandSecondary}),a.close(e)}).error(function(e){swal({title:"Image Upload Error",text:"There was some error while trying to upload the image.",type:"error"}),console.log(arguments)})}},o.$watch("upload.choosen.name + upload.choosen.size",function(e){if(o.upload.src=null,e){var t=new Image,n=new FileReader;t.onload=function(){return o.upload.minWidth&&(t.width<o.upload.minWidth||t.height<o.upload.minHeight)?void swal("Warning","Image Size not optimised. Minimum 1024 x 768px","warning"):(n.onload=function(e){o.upload.src=e.target.result,o.$apply()},void n.readAsDataURL(o.upload.choosen))},t.src=window.URL.createObjectURL(o.upload.choosen)}else o.upload.src=null},!0)}var n=e.module("cab9.common");n.controller("ClientItemWebBookerSettingsController",o),n.controller("ImageModalController",t),o.$inject=["$scope","$stateParams","$state","$q","$config","$UI","Model","rSettings","$modal"],t.$inject=["$scope","$http","$config","$modalInstance","rSetting","$UI"]}(angular);;;;
!function(e){function n(n,i,t,c,l,r,o,u,d,s){function a(){n.viewMode="VIEW",n.client=e.copy(s[0]),n.client.VehicleTypes=n.client.VehicleTypes.map(function(e){return new d.VehicleType(e)});var i=n.client.VehicleTypes.map(function(e){return e.Id});n.selected={VehicleType:null},n.unlinkedVehicleTypes=t.filter(function(e){return i.indexOf(e.Id)==-1})}function p(e){n.client.VehicleTypes.push(e);var i=n.unlinkedVehicleTypes.filter(function(n){return n.Id==e.Id});i[0]&&n.unlinkedVehicleTypes.splice(n.unlinkedVehicleTypes.indexOf(i[0]),1),n.selected.VehicleType=null}function h(e){n.unlinkedVehicleTypes.push(e);var i=n.client.VehicleTypes.filter(function(n){return n.Id==e.Id});i[0]&&n.client.VehicleTypes.splice(n.client.VehicleTypes.indexOf(i[0]),1)}function f(){u.post(r.API_ENDPOINT+"api/client/ManageVehicleTypes",n.client).then(function(e){swal({title:"Client Vehicle Types Updated",text:"Changes have been updated.",type:"success",confirmButtonColor:o.COLOURS.brandSecondary}),c.go(c.current,{Id:i.Id},{reload:!0})},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:o.COLOURS.brandSecondary})})}function y(){a()}function V(){n.viewMode="EDIT"}a(),n.startEdit=V,n.cancelEdit=y,n.addVehicle=p,n.removeVehicle=h,n.saveChanges=f}var i=e.module("cab9.common");i.controller("ClientItemVehicleTypesController",n),n.$inject=["$scope","$stateParams","rVehicleTypes","$state","$q","$config","$UI","$http","Model","rData"]}(angular);;;;
!function(){function e(e,n,o,s,r,t,a){function g(n){return n.Sender.UserName==e.session.UserName}function c(){r.Conversation.query().filter("BookingId","==","guid'"+e.booking.Id+"'").filter("Type eq '"+a+"'").include("Sender/Claims,Booking/"+a).trackingEnabled().execute().then(function(n){e.booking.Conversations=n,e.booking.Conversations=e.booking.Conversations.map(function(n){for(i=0,len=e.roles.length;i<len;i++)if(e.roles[i].Id==n.Booking[a][a+"TypeId"]){n.Booking[a][a+"Type"]=e.roles[i];break}return n}),e.fetched=1,setTimeout(function(){$(".conversation").scrollTop($(".conversations-wrapper").height())},100)})}function d(){e.newMessage.Body.length>0&&e.newMessage.$save().success(function(){e.newMessage=new r.Conversation,e.newMessage.BookingId=e.booking.Id,e.newMessage.SenderId=t.getSession().UserId,e.newMessage.Body=""}).error(function(){})}e.booking=s,e.fetched=0,r[a+"Type"].query().execute().then(function(n){e.roles=n,c()},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:$UI.COLOURS.brandSecondary})}),e.session=t.getSession(),e.isItAUserMessage=g,e.newMessage=new r.Conversation,e.newMessage.BookingId=e.booking.Id,e.newMessage.SenderId=t.getSession().UserId,console.log(t.getSession()),e.newMessage.Type=a,e.newMessage.Body="",e.sendMessage=d,e.$on("SIGNALR_newMessage",function(n,o){e.booking.Conversations||(e.booking.Conversations=[]),e.booking.Conversations.push(new r.Conversation(o[0])),e.$apply()})}var n=angular.module("cab9.common");n.controller("ConversationsModalController",e),e.$inject=["$scope","$config","$http","rBooking","Model","Auth","rType"]}();;;;
!function(){function e(e,n,t,l){function o(){var t=n.open({templateUrl:"/webapp/common/modals/driver-payment-create.modal.html",controller:"DriverPaymentModelCreateController",size:"lg"});t.result.then(function(n){e.paymentModels.push(n)},function(){})}function c(n){e.selected=n}function a(e){swal({title:"Are you sure?",text:"Payment Model will be deleted",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, delete it!",closeOnConfirm:!1},function(){e.$delete().success(function(){swal("Success","Payment Model Deleted.","success"),d()})})}function s(n){n.Name.length>0&&(n.$patch().success(function(){swal("Success","Payment Model Updated","success"),d()}),e.selected=null)}function d(){l.DriverPaymentModel.query().trackingEnabled().execute().then(function(n){e.paymentModels=n})}e.paymentModels=t,e.newPayment=null,e.selected=null,e.openPaymentModal=o,e.selectPaymentModel=c,e.deletePaymentModel=a,e.updatePaymentModel=s,e.viewMode="VIEW"}var n=angular.module("cab9.common");n.controller("DriverPaymentModelsController",e),e.$inject=["$scope","$modal","rPaymentModels","Model"]}();;;;
!function(e){function r(r,i,n,t,o,d,l,a){function s(e){return 0==r.selectedOverride.$overrides.filter(function(r){return e.Id==r.VehicleTypeId}).length}function c(){r.viewMode="EDIT"}function u(e,r,i){var n=null;n=e.Id?e.$patch():e.$save(),n.then(function(e){swal("Success!","Saved.","success")})}function m(e,i,n){e.$rollback(),r.viewMode="VIEW"}function C(e,i,n){if(e.Id)swal({title:"Are you sure?",text:"This Override will be deleted permanentaly",type:"warning",showCancelButton:!0,confirmButtonText:"Yes, delete it!",closeOnConfirm:!0},function(){e.Cash&&e.Cash.Id&&e.Cash.$delete().then(function(){e.Cash=null}),e.Card&&e.Card.Id&&e.Card.$delete().then(function(){e.Card=null}),e.$delete().then(function(){swal("Success","Pricing Model deleted.","success");var t=null;e.Id&&(t=e.$delete()),t.then(function(){if(swal("Success!","Removed.","success"),i)if(n)i[n]=null;else{var t=i.$overrides.indexOf(e);i.$overrides.splice(t,1)}else{var t=r.clientOverrides.indexOf(i);r.clientOverrides.splice(t,1),r.selectedOverride=r.item}})},function(e){swal("Error","Error on deleting pricing model.","error")})});else if(i)if(n)i[n]=null;else{var t=i.$overrides.indexOf(e);i.$overrides.splice(t,1)}else{var t=r.clientOverrides.indexOf(i);r.clientOverrides.splice(t,1),r.selectedOverride=r.item}}function v(e,i){var n=new a.DriverPaymentModelOverride;n.DriverPaymentModelId=r.item.Id,n.ClientId=i.ClientId,n.VehicleTypeId=i.VehicleTypeId,n.OwnCarPerMileSteps=i.OwnCarPerMileSteps,n.CompanyCarPerMileSteps=i.CompanyCarPerMileSteps,n.OwnCarCommission=i.OwnCarCommission,n.CompanyCarCommission=i.CompanyCarCommission,n.WeeklyRent=i.WeeklyRent,n.PerHour=i.PerHour,n.PerBooking=i.PerBooking,n.ChauffeurCommision=i.ChauffeurCommision,n.ChauffeurPerHour=i.ChauffeurPerHour,n.WaitingPerHour=i.WaitingPerHour,n.Type=i.Type,n.PaymentType=e,i[e]=n}function f(e,i){var n=new a.DriverPaymentModelOverride;n.DriverPaymentModelId=r.item.Id,n.ClientId=i.ClientId,n.VehicleTypeId=e,n.OwnCarPerMileSteps=i.OwnCarPerMileSteps,n.CompanyCarPerMileSteps=i.CompanyCarPerMileSteps,n.OwnCarCommission=i.OwnCarCommission,n.CompanyCarCommission=i.CompanyCarCommission,n.WeeklyRent=i.WeeklyRent,n.PerHour=i.PerHour,n.PerBooking=i.PerBooking,n.Type=i.Type,n.ChauffeurCommision=i.ChauffeurCommision,n.WaitingPerHour=i.WaitingPerHour,n.ChauffeurPerHour=i.ChauffeurPerHour,i.$overrides.push(n),r["new"]={}}function p(){r.selectedOverride.$patch().then(function(e){swal({title:"Client Override Updated.",text:"Changes have been updated.",type:"success",confirmButtonColor:t.COLOURS.brandSecondary}),r.selectedOverride.$commit()},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:t.COLOURS.brandSecondary})})}function O(e){r.selectedOverride=e}function y(){r.newOverride=null}function h(){r.newOverride.$save().then(function(e){swal({title:"Client Override Added.",text:"Changes have been updated.",type:"success",confirmButtonColor:t.COLOURS.brandSecondary}),r.newOverride=null,e.data.Client=r.clients.filter(function(r){return r.Id==e.data.ClientId})[0],r.selectedOverride=new a.DriverPaymentModelOverride(e.data),r.selectedOverride.$overrides=[],r.clientOverrides.push(r.selectedOverride)},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:t.COLOURS.brandSecondary})})}function P(){r.newOverride=new a.DriverPaymentModelOverride,r.newOverride.DriverPaymentModelId=r.item.Id,r.newOverride.OwnCarPerMileSteps=r.item.OwnCarPerMileSteps,r.newOverride.Type=r.item.Type,r.newOverride.CompanyCarPerMileSteps=r.item.CompanyCarPerMileSteps,r.newOverride.OwnCarCommission=r.item.OwnCarCommission,r.newOverride.CompanyCarCommission=r.item.CompanyCarCommission,r.newOverride.WeeklyRent=r.item.WeeklyRent,r.newOverride.PerHour=r.item.PerHour,r.newOverride.PerBooking=r.item.PerBooking,r.newOverride.ChauffeurCommision=r.item.ChauffeurCommision,r.newOverride.ChauffeurPerHour=r.item.ChauffeurPerHour,r.newOverride.WaitingPerHour=r.item.WaitingPerHour}r.item=d[0];var w=r.item.Overrides.map(function(e){return new a.DriverPaymentModelOverride(e)});r.item.Overrides=[],r.vehicleTypes=l,r.clientOverrides=[],r.selectedOverride=r.item,r.item.$overrides=[],r["new"]={},r.orphans=[],e.forEach(w,function(e){!e.ClientId||e.VehicleTypeId||e.PaymentType||(e.$overrides=[],r.clientOverrides.push(e))}),e.forEach(w,function(e){if(e.VehicleTypeId&&!e.PaymentType)if(e.ClientId){var i=r.clientOverrides.filter(function(r){return r.ClientId==e.ClientId})[0];i?(i.$overrides=i.$overrides||[],i.$overrides.push(e)):r.orphans.push(e)}else r.item.$overrides=r.item.$overrides||[],r.item.$overrides.push(e)}),e.forEach(w,function(e){if(e.PaymentType)if(e.ClientId){var i=r.clientOverrides.filter(function(r){return r.ClientId==e.ClientId})[0];i?e.VehicleTypeId?(i=i.$overrides.filter(function(r){return r.VehicleTypeId==e.VehicleTypeId})[0],i?i[e.PaymentType]=e:r.orphans.push(e)):i[e.PaymentType]=e:r.orphans.push(e)}else if(e.VehicleTypeId){var i=r.item.$overrides.filter(function(r){return r.VehicleTypeId==e.VehicleTypeId})[0];i?i[e.PaymentType]=e:r.orphans.push(e)}else r.item[e.PaymentType]=e}),a.Client.query().execute().then(function(e){r.clients=e},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:t.COLOURS.brandSecondary})}),r.viewMode="EDIT",r.save=u,r.reset=m,r.remove=C,r.addOverride=f,r.addNewPaymentOverride=v,r.alreadyOverriding=s,r.startEdit=c,r.newClientOverride=P,r.addClientOverride=h,r.canceAddOverride=y,r.selectOverride=O,r.saveOverrideEdit=p,r.getVehicleType=function(e){return l.filter(function(r){return e.VehicleTypeId==r.Id})[0].Name}}var i=e.module("cab9.common");i.controller("DriverPaymentModelDetailsController",r),r.$inject=["$scope","$state","$q","$UI","$modal","rData","rVehicleTypes","Model"]}(angular);;;;
!function(e){function t(t,s,n,o,i){function r(){t.viewMode="VIEW",t.item=o[0],t.item.$bonus=t.item.BonusParameters?JSON.parse(t.item.BonusParameters):{}}function u(e){var s=t.item.$bonus.steps.indexOf(e);return s<=0?0:t.item.$bonus.steps[s-1].max+1}function a(e){var s=t.item.$bonus.steps.indexOf(e);t.item.$bonus.steps.splice(s,1)}function m(){if(t.item.$bonus.steps&&t.item.$bonus.steps.length>0){var s=e.copy(t.item.$bonus.steps[t.item.$bonus.steps.length-1]);s.max=t.item.$bonus.steps[t.item.$bonus.steps.length-1].max+1,t.item.$bonus.steps.push(s)}else t.item.$bonus.steps||(t.item.$bonus.steps=[]),t.item.$bonus.steps.push({max:1,bonus:1})}function c(){t.viewMode="EDIT"}function p(){t.item.BonusParameters=JSON.stringify(t.item.$bonus),t.item.$patch().then(function(e){t.item=new i.DriverPaymentModel(e.data),swal({title:"Bonus Structure Updated Successfully.",text:"Changes have been updated.",type:"success",confirmButtonColor:s.COLOURS.brandSecondary}),t.viewMode="VIEW",t.item.$bonus=t.item.BonusParameters?JSON.parse(t.item.BonusParameters):{}},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:s.COLOURS.brandSecondary})})}r(),t.DependsUpon=["Booking","Revenue"],t.Types=["Fixed","Percentage"],t.startEdit=c,t.cancelEdit=r,t.saveEdits=p,t.addLevel=m,t.getPrevious=u,t.remove=a}var s=e.module("cab9.common");s.controller("DriverPaymentModelBonusController",t),t.$inject=["$scope","$UI","$modal","rData","Model"]}(angular);;;;
!function(){function e(e,t,a,n,o,s,r,i,c){function d(){if(e.fetchingTransactions=!0,c.CLIENTID)var t=$config.API_ENDPOINT+"api/Transactions/TransactionsBetweenDate?startDate="+moment(e.filters.from).format("YYYY-MM-DD")+"&endDate="+moment(e.filters.to).format("YYYY-MM-DD")+"&clientId="+c.CLIENTID;else var t=$config.API_ENDPOINT+"api/Transactions/TransactionsBetweenDate?startDate="+moment(e.filters.from).format("YYYY-MM-DD")+"&endDate="+moment(e.filters.to).format("YYYY-MM-DD");s({method:"GET",url:t}).then(function(t){e.transactions=t.data,e.bTransactions=[],e.iTransactions=[],e.transactions.map(function(t){"Collection"==t.TransactionType||"Payment"==t.TransactionType?t._TransactionType="Payment":t._TransactionType="Preauth",null!=t.BookingId?e.bTransactions.push(t):e.iTransactions.push(t)}),e.fetchingTransactions=!1},function(t){e.fetchingTransactions=!1,t&&t.data&&t.data.Message?swal("Invalid Date",t.data.Message,"error"):swal("Error","Unknown Error Occured","error")})}function l(){var t=moment(e.filters.from),a=moment(e.filters.to);return t>a?void swal("Invalid Date","Start Date can not be after End Date.","error"):a.diff(t,"days")>30?void swal("Invalid Date","Requested days can not be more than 7 days apart.","error"):(e.transactions=[],void d())}function p(){var t=angular.copy(e.transactions);t=i("filter")(t,{_TransactionType:e.filters.type,Success:e.filters.result,$:e.searchText}),t.map(function(e){if(1==e.Success){switch(e.Provider){case"Judopay":try{e.ReceiptId=JSON.parse(e.Response).ReceiptId,null==e.ReceiptId&&(e.ReceiptId=JSON.parse(e.Response).Response.ReceiptId)}catch(t){}break;case"Stripe":try{e.ReceiptId=JSON.parse(e.Response).id}catch(t){}}e.Status="SUCCESS"}else e.Status="FAIL";e.Booking=e.LocalId,e.CreatedAt=moment(e.CreatedAt).format("DD/MM/YYYY HH:mm"),delete e.LocalId,delete e.Request,delete e.Response,delete e.Success,delete e.TenantId,delete e.Id,delete e.BookingId,delete e.PaymentCardId,delete e.InvoiceId}),r.download(t,"Transactions")}function f(e){e.$expanded=!0,e.Request=JSON.parse(e.Request),e.Response=JSON.parse(e.Response)}e.dateChanged=l,e.transactions=[],e.filters={from:(new moment).add(-7,"days").toDate(),to:(new moment).toDate(),type:void 0,result:void 0},e.opened={},e.fetchTransactions=d,e.expandTransaction=f,e.exportTransactions=p,e.fetchTransactions(),e.openCalendar=function(t,a){e.opened[a]=!0,t.preventDefault(),t.stopPropagation()}}var t=angular.module("cab9.common");t.controller("InvoiceCardTransactionsController",e),e.$inject=["$scope","$modal","$state","Model","$timeout","$http","CSV","$filter","$rootScope"]}();;;;
!function(e){function s(e,s,t,o,a){function c(){e.savingDetails=!0,e.googleMapsDetails.Id?swal({title:"Are you sure?",text:"Are you sure you want to update your Google map keys?",type:"warning",showCancelButton:!0,confirmButtonText:"Confirm",closeOnConfirm:!1},function(){e.googleMapsDetails.$patch().success(function(){e.savingDetails=!1,swal("Details Saved","Your keys have been updated to the database.","success")})}):e.telephonyData.$save().success(function(){e.savingDetails=!1,swal("Details Saved","Your keys have been saved to the database.","success")})}e.savingDetails=!1,e.googleMapsDetails=new o.GoogleMapsConfig(t[0]),null==e.googleMapsDetails&&(e.googleMapsDetails=new o.GoogleMapsConfig),e.saveDetails=c,e.instructionsObj={heading:"Google Maps Setup Instructions",subHeading:"Please follow these simple instructions to setup your google maps API keys, this will allow for our mapping system to use googles machines to process our mapping related requests",instructions:[{src:"/includes/images/gm-step1.png",desc:"Log into Google",cap:"If you already have an google account for your business, awesome. Move to Step 9!<br />If you have a personal account, please dont use this.<br />We need to create an account for your business. <br />Go to <a href='https://console.developers.google.com'>https://console.developers.google.com</a><br />And select Create Account."},{src:"/includes/images/gm-step2.png",desc:"Create an account",cap:"Create an account to manage your business."},{src:"/includes/images/gm-step3.png",desc:"Account Details",cap:"Enter your details and Click Next."},{src:"/includes/images/gm-step4.png",desc:"Verification",cap:"You may be asked to verify your number, enter your details and click next."},{src:"/includes/images/gm-step5.png",desc:"Enter Code",cap:"Enter the code sent by text to your phone and click next."},{src:"/includes/images/gm-step6.png",desc:"More details",cap:"Enter the recovery email address as shown, so we are notified of any issues with your API Keys. Then your date of birth and gender. (This is required by google for their statistics) and click NEXT."},{src:"/includes/images/gm-step7.png",desc:"Proceed",cap:"Skip the next page.  "},{src:"/includes/images/gm-step8.png",desc:"Create your account",cap:"And select create your account."},{src:"/includes/images/gm-step9.png",desc:"Terms and Conditions acceptance",cap:"Agree the terms and conditions."},{src:"/includes/images/gm-step10.png",desc:"Creating a project",cap:"Now, to create a project. Select the top right create a project."},{src:"/includes/images/gm-step11.png",desc:"Naming your project",cap:"Give your new project the name cab9 and select create."},{src:"/includes/images/gm-step12.png",desc:"Enable APIs",cap:"Now you must enable APIs and services. So click on the API library."},{src:"/includes/images/gm-step13.png",desc:"Select mapping APIs",cap:"You are now presented with the range of Google APIs available. We only need those to do with mapping, so in the search box type MAP."},{src:"/includes/images/gm-step14.png",desc:"Select APIs",cap:"You will. Now have a page of just the mapping APIs. So select the top one"},{src:"/includes/images/gm-step15.png",desc:"Activating more APIs",cap:"This will then enable that API. And move it into the activate API section of the screen.<br /><br />You will need to activate the following API by clicking on them in the list beneath.<br /><br />Maps SDK for Android<br />Maps SDK for iOS<br />Maps Javascript API<br />Maps Static API<br />Roads API<br />Geocoding API<br />Distance Matrix API<br />Directions API<br />Places SDK for iOS<br />Places SDK for Android<br />Places API<br /><br />You can activate more, no harm will come. But these are the ones we currently use."},{src:"/includes/images/gm-step16.png",desc:"Select Credentials",cap:"When you have completed activation, click into any of the selected APIs and you will be presented with this. Click Credentials."},{src:"/includes/images/gm-step17.png",desc:"Credentials",cap:"And then, on the window, click create credentials."},{src:"/includes/images/gm-step18.png",desc:"API key generation",cap:"Then select the first option API Key."},{src:"/includes/images/gm-step19.png",desc:"Copy API key",cap:"This will create an API key for you. Select copy to copy to your computer clipboard."},{src:"/includes/images/gm-step20.png",desc:"Repeat these steps",cap:"Paste the key into the matching API name in your Cab9 system. Repeat this for the keys required : <br /><br />Android API KEY<br />Server KEY<br />Broswer KEY<br />IOS API KEY"},{src:"/includes/images/gm-step21.png",desc:"Account Activation",cap:"Now to activate your google account click activate in the top right hand of your screen."},{src:"/includes/images/gm-step22.png",desc:"Terms & Conditions",cap:"Accept the terms of service."},{src:"/includes/images/gm-step23.png",desc:"Start your free trial",cap:"Select start my free trial and you have completed your google API key set up."}]}}var t=e.module("cab9.common");t.controller("GoogleMapsConfigController",s),s.$inject=["$scope","$http","rIntegration","Model","$rootScope"]}(angular);;;;
!function(e){function t(t,o,n,a,r,s,d){return{scope:!0,templateUrl:"/webapp/common/directives/stopedit/template.html",link:function(o,d,c){function i(t){var n=r.open({templateUrl:"/webapp/common/modals/bookings/stop-address/modal.html",controller:"BookingStopEditModalController",resolve:{rStop:function(){return e.copy(g(o))}}});n.result.then(function(e){e.$source=null,o.selected.value=e},function(){})}function l(e){return T.indexOf(e.$source)}function u(t){if(o.fetchedLocations=[],w&&o.fetchedLocations.push(w),"VIEW"!=o.viewMode){if(y){var r=y(o),d=C($(r,t),5);e.forEach(d,function(e){if(e.Id=null,e.BookingId=null,e.$source="Historic Locations",!e.StopSummary){var t="";e.Address1&&e.Address1.length>1&&(t+=e.Address1),e.TownCity?(t.length>0&&(t+=", "),t+=e.TownCity):e.Area&&(t.length>0&&(t+=", "),t+=e.Area),e.Postcode&&(t.length>0&&(t+=", "),t+=e.Postcode),e.StopSummary=t}o.fetchedLocations.push(e),o.fetchedLocations=s("orderBy")(o.fetchedLocations,l)})}if(A){var c=A(o),i=C($(c,t),5);e.forEach(i,function(e){if(e.Id=null,e.BookingId=null,e.$source="Known Locations",!e.StopSummary){var t="";e.Address1&&e.Address1.length>1&&(t+=e.Address1),e.TownCity?(t.length>0&&(t+=", "),t+=e.TownCity):e.Area&&(t.length>0&&(t+=", "),t+=e.Area),e.Postcode&&(t.length>0&&(t+=", "),t+=e.Postcode),e.StopSummary=t}o.fetchedLocations.push(e),o.fetchedLocations=s("orderBy")(o.fetchedLocations,l)})}if(t&&t.length>3)if(I.test(t)&&n.get(a.API_ENDPOINT+"api/LocationSearch/what-3-words/suggestions",{params:{searchTerm:t}}).then(function(t){var n=t.data.suggestions;e.forEach(n,function(e){o.fetchedLocations.push({StopSummary:"///"+e.words+" ("+e.nearestPlace+")",$source:"What3Words",$w3w:e.words})}),o.fetchedLocations=s("orderBy")(o.fetchedLocations,l)}),_.test(t)){var u=t;n.get(a.API_ENDPOINT+"api/LocationSearch/postcodeSearch",{params:{postcode:t}}).then(function(t){var n=t.data.Addresses?t.data.Addresses:[];e.forEach(n,function(e){var n="";e[0]&&(n=e[0]),e[1]&&(n=n?n+", "+e[1]:e[1]),e[2]&&(n=n?n+", "+e[2]:e[2]),o.fetchedLocations.push({Latitude:t.data.Latitude,Longitude:t.data.Longitude,StopSummary:n+", "+u.toUpperCase(),Address1:e[0],Address2:e[1],Area:e[2],TownCity:e[3],Postcode:u.toUpperCase(),County:e[4],$source:"Postcode Search"})}),o.fetchedLocations=s("orderBy")(o.fetchedLocations,l)})}else n.get(a.API_ENDPOINT+"api/LocationSearch",{params:{Id:{},SearchTerm:t}}).then(function(t){var n=t.data?t.data:[];e.forEach(n,function(e){o.fetchedLocations.push({Latitude:e.Latitude,Longitude:e.Longitude,Postcode:e.Postcode,StopSummary:e.Name,Address1:e.Name,$source:"Location Search"})}),o.fetchedLocations=s("orderBy")(o.fetchedLocations,l)}),L.getPlacePredictions({input:t,bounds:new google.maps.LatLngBounds({lat:49.173624,lng:-11.184082},{lat:59.326885,lng:2.790527})},function(t,n){var a=t||[];e.forEach(a,function(e){o.fetchedLocations.push({StopSummary:e.description,description:e.description,place_id:e.place_id,$source:"Google Search"})}),o.fetchedLocations=s("orderBy")(o.fetchedLocations,l),o.$apply()})}}function h(e){o.locationSet=!0,o.showLocation=!1,P=!0,n.get(a.API_ENDPOINT+"api/LocationSearch/what-3-words/select",{params:{value:e.$w3w}}).then(function(t){var n=t.data,a=g(o);a.Address1=n.Address1,a.Address2=n.Address2,(!a.Address1||a.Address1.length<3)&&(a.Address1=(a.Address1||"")+" "+a.Address2,a.Address2=""),a.Area=n.Area,a.TownCity=n.TownCity,a.County=n.County,a.Postcode=n.Postcode,a.Country=n.Country,a.Latitude=n.Latitude,a.Longitude=n.Longitude,a.StopSummary=e.StopSummary})}function p(e){m(),o.locationSet=!0,o.showLocation=!1,P=!0,S.getDetails({placeId:e.place_id},function(t,n){o.value=e.description;var a=g(o),r=t.address_components.filter(function(e){return e.types.indexOf("street_number")!=-1}),s=t.address_components.filter(function(e){return e.types.indexOf("route")!=-1});a.Address1=(r.length?r[0].long_name+" ":"")+(s.length?s[0].long_name:""),a.Address1||(a.Address1=t.name);var d=t.address_components.filter(function(e){return e.types.indexOf("locality")!=-1});a.Area=d.length?d[0].long_name:null;var c=t.address_components.filter(function(e){return e.types.indexOf("postal_town")!=-1});a.TownCity=c.length?c[0].long_name:null;var i=t.address_components.filter(function(e){return e.types.indexOf("administrative_area_level_2")!=-1});a.County=i.length?i[0].long_name:null;var l=t.address_components.filter(function(e){return e.types.indexOf("postal_code")!=-1});a.Postcode=l.length?l[0].long_name:null;var u=t.address_components.filter(function(e){return e.types.indexOf("country")!=-1});a.Country=u.length?u[0].long_name:null,a.StopSummary=e.description,a.Latitude=t.geometry&&t.geometry.location?t.geometry.location.lat():null,a.Longitude=t.geometry&&t.geometry.location?t.geometry.location.lng():null,o.safeApply()})}function f(t){o.locationSet=!0,o.showLocation=!1,P=!0;var n=g(o);if(n){delete t.WaitTime,delete t.WaitTimeChargable,e.extend(n,t);var a="";n.StopSummary?a=n.StopSummary:(n.Address1&&n.Address1.length>1&&(a+=n.Address1),n.TownCity?(a.length>0&&(a+=", "),a+=n.TownCity):n.Area&&(a.length>0&&(a+=", "),a+=n.Area),n.Postcode&&(a.length>0&&(a+=", "),a+=n.Postcode),n.StopSummary=a),o.value=a}}function m(){o.postcodeMode=!1;var e=g(o);e&&(e.Address1=null,e.Address2=null,e.TownCity=null,e.Area=null,e.Postcode=null,e.County=null,e.Country=null,e.StopSummary=null,e.Latitude=null,e.Longitude=null)}var g=t(c.model),y=null,A=null;o.tI=parseInt(c.tabIndex),o.hideEdit=!!c.hideEdit,c.external&&(y=t(c.external)),c.known&&(A=t(c.known));var L=new google.maps.places.AutocompleteService,S=new google.maps.places.PlacesService(document.getElementById("mapsDiv")),w=null,v=g(o);v.StopSummary?(w=e.copy(v||{}),w.$source="Previous",o.fetchedLocations=[w]):o.fetchedLocations=[],o.selected={value:w},o.locationSet=!1;var P=!1,$=s("filter"),C=s("limitTo");o.editStop=i,o.searchLocations=u,o.safeApply=function(e){var t=this.$root.$$phase;"$apply"==t||"$digest"==t?e&&"function"==typeof e&&e():this.$apply(e)};var _=/^(([gG][iI][rR] {0,}0[aA]{2})|((([a-pr-uwyzA-PR-UWYZ][a-hk-yA-HK-Y]?[0-9][0-9]?)|(([a-pr-uwyzA-PR-UWYZ][0-9][a-hjkstuwA-HJKSTUW])|([a-pr-uwyzA-PR-UWYZ][a-hk-yA-HK-Y][0-9][abehmnprv-yABEHMNPRV-Y]))) {0,}[0-9][abd-hjlnp-uw-zABD-HJLNP-UW-Z]{2}))$/,I=/^(\/\/\/)?\w+[\s\.]\w+[\s\.]\w+$/,T=["What3Words","Historic Locations","Known Locations","Postcode Search","Location Search","Google Search"];o.$watch("selected.value",function(e){e&&"Google Search"==e.$source?p(e):e&&"Previous"==e.$source?f(e):e&&"What3Words"==e.$source?(m(),h(e)):e?(m(),f(e)):m()}),o.$watch(function(){return y&&y(o)},function(t){var n=t;o.fetchedLocations=o.fetchedLocations.filter(function(e){return"Historic Locations"!=e.$source}),e.forEach(n,function(e){if(e.Id=null,e.BookingId=null,e.$source="Historic Locations",!e.StopSummary){var t="";e.Address1&&e.Address1.length>1&&(t+=e.Address1),e.Address2&&e.Address2.length>1&&(t+=", "+e.Address2),e.TownCity?(t.length>0&&(t+=", "),t+=e.TownCity):e.Area&&(t.length>0&&(t+=", "),t+=e.Area),e.Postcode&&(t.length>0&&(t+=", "),t+=e.Postcode),e.StopSummary=t}o.fetchedLocations.push(e)})},!0),o.$watch(function(){return A&&A(o)},function(t){var n=t;o.fetchedLocations=o.fetchedLocations.filter(function(e){return"Known Locations"!=e.$source}),e.forEach(n,function(e){if(e.Id=null,e.BookingId=null,e.$source="Known Locations",!e.StopSummary){var t="";e.Address1&&e.Address1.length>1&&(t+=e.Address1),e.TownCity?(t.length>0&&(t+=", "),t+=e.TownCity):e.Area&&(t.length>0&&(t+=", "),t+=e.Area),e.Postcode&&(t.length>0&&(t+=", "),t+=e.Postcode),e.StopSummary=t}o.fetchedLocations.push(e)})},!0)}}}var o=e.module("framework.directives.UI");o.directive("stopEdit",t),t.$inject=["$parse","$UI","$http","$config","$modal","$filter","$timeout"]}(angular);;;;
!function(e){function r(e,r,t){return{restrict:"E",transclude:!0,replace:!0,scope:!0,template:function(e,r){var t="";return t+='<div class="numplate"><a class="numplate-container"',"false"!=r.allowClick&&(t+=' ng-href="{{getLinkUrl()}}"'),t+='><svg holder class="logo holderjs" style="background-image:url(\'{{accessors.LogoUrl(item)}}\')" viewBox="0 0 150 40"><line x1="0" y1="0" x2="0" y2="0" fill="transparent" stroke-width="7" stroke-linecap="round" ng-show="showScore==true" stroke-location="outside"></line></svg>',"false"!=r.showTitle&&(t+='<strong ng-bind-html="accessors.Title(item)"></strong>'),"false"!=r.showSubtitle&&(t+='<small bind-html-compile="accessors.SubTitle(item)"></small>'),t+="</a></div>"},link:function(r,s,o,a,i){function l(){return e.href(r.rNavTo||o.rNavTo,{Id:r.item.Id})}function n(t){e.get(r.rNavTo)&&e.go(r.rNavTo,{Id:t.Id})}if(o.item){var c=t(o.item);r.item=c(r)}if(o.accessors){var u=t(o.accessors);r.accessors=u(r)}if(r.viewItem=n,r.getLinkUrl=l,r.accessors.Score){var m=150*r.accessors.Score(r.item),d=m<37.5?"red":m>=37.5&&m<75?"orange":"rgb(25, 195, 45)";s.find("line").attr("stroke",d).attr("x2",m)}}}}var t=e.module("framework.directives.UI");t.directive("numplate",r),r.$inject=["$state","$interval","$parse"]}(angular);;;;
!function(o,n){var i=n.module("cab9.common");i.directive("promiseShadow",["$timeout","$rootScope",function(o,n){return{scope:{promise:"="},link:function(i,t,e){function a(){n.$broadcast("Data Loading"),o(function(){g.show(),m.counter=0,f.text("Loading...").show(),t.addClass("still-loading"),t.find(".shadow img").attr("src","/includes/images/preloader.gif"),r()},0)}function s(){n.$emit("Data Loaded"),l(),g.hide(),f.hide(),t.removeClass("still-loading")}function c(o){n.$emit("Data Loaded"),t.find(".shadow img").attr("src","includes/images/exclaim.png"),console.log(o),l(),g.show(),t.removeClass("still-loading"),f.text(o).show()}function d(o){l(),g.show(),t.removeClass("still-loading"),f.text(o).show()}function l(){u&&(o.cancel(u),u=null)}function r(){u=o(function(){0==i.promise.$$state.status&&(f.text(m[m.counter]),m.counter<m.length-1&&(m.counter++,r()))},h[m.counter])}var u=null;t.css("position","relative"),t.append('<div class="shadow"><img src="/includes/images/preloader.gif" /><div class="shadow-text">Loading ...</div></div>');var g=t.find(".shadow"),f=t.find(".shadow-text"),m=["Loading ...","Fetching Data ...","Just a Little Longer ..."],h=[1e3,3e3,1e4];m.counter=0,i.$watch("promise",function(o,n){o&&(a(),i.promise.then(function(o){s()},function(o){c(o)},function(o){d(o)}))})}}}])}(window,angular);;;;
!function(e){function t(e,t,a,r,l,d,n){return{scope:{data:"=",selected:"=",type:"@"},templateUrl:"/webapp/common/directives/editmodal/template.html",link:function(e,a,r){function l(){if("Passenger"==e.type){var a=t.open({templateUrl:"/webapp/common/modals/passenger/create.modal.html",controller:"PassengerItemEditModalController",resolve:{rPassenger:function(){var t=e.data?e.data.Id:e.selected.Id;return n.Passenger.query().filter("Id eq guid'"+t+"'").trackingEnabled().execute()},rNotes:["$stateParams","Model","$q",function(t,a,r){var l=e.data?e.data.Id:e.selected.Id;return a.Note.query().where("OwnerType eq 'PASSENGER'").where("OwnerId eq guid'"+l+"'").execute()}],rStaff:["Model",function(e){return e.Staff.query().select("Id, Firstname, Surname").parseAs(function(e){this.Name=e.Firstname+" "+e.Surname,this.Id=e.Id}).execute()}],rUsers:["Model",function(e){return e.User.query().include("Claims").execute()}]}});a.result.then(function(t){e.data&&(e.data.Name=t.Firstname+" "+t.Surname,e.data.Description=e.data.Client&&e.data.Client.Name?e.data.Client.Name:"No Client",e.data.Mobile=t.Mobile,e.data.Addresses=t.Addresses,e.data.ImageUrl=d.formatUrl(t.ImageUrl,t.Firstname),e.data.Notes=t.Notes),e.selected&&(e.selected.Name=t.Firstname+" "+t.Surname,e.selected.Description=e.data.Client&&e.data.Client.Name?e.data.Client.Name:"No Client",e.selected.Mobile=t.Mobile,e.selected.Addresses=t.Addresses,e.selected.ImageUrl=d.formatUrl(t.ImageUrl,t.Firstname),e.selected.Notes=t.Notes)})}else if("Booker"==e.type){var a=t.open({templateUrl:"/webapp/common/modals/booker/modal.html",controller:"BookerEditController",resolve:{rBooker:function(){var t=e.data?e.data.Id:e.selected.Id;return n.ClientStaff.query().filter("Id eq guid'"+t+"'").trackingEnabled().execute()}}});a.result.then(function(t){e.data&&(e.data.Name=t.Firstname+" "+t.Surname,e.data.Description=t.Email?t.Email:"",e.data.Mobile=t.Mobile,e.data.ImageUrl=d.formatUrl(t.ImageUrl,t.Name)),e.selected&&(e.selected.Name=t.Firstname+" "+t.Surname,e.selected.Description=t.Email?t.Email:"",e.selected.Mobile=t.Mobile,e.selected.ImageUrl=d.formatUrl(t.ImageUrl,t.Name))})}}e.openEditModal=l}}}var a=e.module("framework.directives.UI");a.directive("editModal",t),t.$inject=["$parse","$modal","$http","$config","$filter","$utilities","Model"]}(angular);;;;
!function(e){function t(t,n){var i='<div class="input-dropdown"><input type="text"name="{{::inputName}}"placeholder="{{::inputPlaceholder}}"autocomplete="off"ng-model="inputValue"class="{{::inputClassName}}"ng-required="inputRequired"ng-change="inputChange()"ng-focus="inputFocus()"ng-blur="inputBlur($event,  isFrom, isTo, fixed)"ng-click="SaveChanges(fixed)"><ul ng-if="dropdownVisible" style="line-height: 18px;border: 1px solid #ddd;overflow-y: auto;overflow-x: hidden;max-height: 200px;"><li ng-repeat="item in dropdownItems track by $index"ng-click="selectItem(item,  isFrom, isTo, fixed)"ng-mouseenter="setActive($index)"ng-mousedown="dropdownPressed()"style="font-family: inherit;font-size: 13px;border-bottom: 1px solid #ddd; padding: 10px !important;" ng-class="{\'activetab\': activeItemIndex === $index}"><span ng-show="item.Name">{{item.Name}}</span><span ng-show="!item.Name">{{item}}</span></li></ul></div>';return{restrict:"E",replace:!0,scope:{defaultDropdownItems:"=",selectedItem:"=",inputRequired:"=",inputName:"@",inputClassName:"@",inputPlaceholder:"@",filterListMethod:"&",itemSelectedMethod:"&",fixed:"=",isFrom:"=",isTo:"=",saveChanges:"&"},template:i,controller:["$scope","$http",function(e,t){this.getSelectedItem=function(){return e.selectedItem},this.isRequired=function(){return e.inputRequired},this.getInput=function(){return e.inputValue}}],link:function(n,i,o){var d=!1;i.find("input").isolateScope();n.activeItemIndex=0,n.inputValue="",n.dropdownVisible=!1,n.dropdownItems=n.defaultDropdownItems||[],n.$watch("dropdownItems",function(t,i){e.equals(t,i)||n.setInputActive()}),n.$watch("selectedItem",function(e,t){e&&("string"==typeof e?n.inputValue=e:(n.inputValue=e.Name,n.inputId=e.Id))},!0),n.SaveChanges=function(e){},n.setInputActive=function(){n.setActive(-1)},n.setActive=function(e){n.activeItemIndex=e},n.inputChange=function(){if(n.selectedItem=null,c(),!n.inputValue)return void(n.dropdownItems=n.defaultDropdownItems||[]);if(n.filterListMethod){var e=n.filterListMethod({userInput:n.inputValue});e&&e.then(function(e){n.dropdownItems=e})}},n.inputFocus=function(){n.setInputActive(),c()},n.inputBlur=function(e,i,c,u){return void 0==n.inputId||null==n.inputId?(i&&(u.FromPostcode=n.inputValue),c&&(u.ToPostcode=n.inputValue),"true"==o.client?null!=u.Id&&void 0!=u.Id&&t.post($config.API_ENDPOINT+"api/PricingModels/updateclientfixed",u).then(function(){},function(){console.log("Error occured")}):null!=u.Id&&void 0!=u.Id&&t.post($config.API_ENDPOINT+"api/PricingModels/updatefixed",u).then(function(){},function(){console.log("Error occured")})):(i&&(u.FromId=n.inputId),c&&(u.ToId=n.inputId)),d?void(d=!1):void r()},n.dropdownPressed=function(){d=!0},n.selectItem=function(e,i,d,c){n.selectedItem=e,r(),n.dropdownItems=[e],n.itemSelectedMethod&&n.itemSelectedMethod({item:e}),i&&(c.FromId=e.Id),d&&(c.ToId=e.Id),null!=c.Id&&void 0!=c.Id&&("clientpricingfixeds"==o.modelType?t.post($config.API_ENDPOINT+"api/PricingModels/updateclientfixed",c).then(function(){},function(){console.log("Error occured")}):"DriverPaymentModelFixeds"==o.modelType?t.post($config.API_ENDPOINT+"api/DriverPayments/updateDriverfixed",c).then(function(){},function(){console.log("Error occured")}):(o.modelType="pricingfixeds")&&t.post($config.API_ENDPOINT+"api/PricingModels/updatefixed",c).then(function(){},function(){console.log("Error occured")}))};var c=function(){n.dropdownVisible=!0},r=function(){n.dropdownVisible=!1},u=function(){var e=n.activeItemIndex-1;e>=0?n.setActive(e):n.setInputActive()},p=function(){var e=n.activeItemIndex+1;e<n.dropdownItems.length&&n.setActive(e)},s=function(){n.activeItemIndex>=0&&n.activeItemIndex<n.dropdownItems.length&&n.selectItem(n.dropdownItems[n.activeItemIndex])};i.bind("keydown keypress",function(e){switch(e.which){case 38:n.$apply(u);break;case 40:n.$apply(p);break;case 13:n.dropdownVisible&&n.dropdownItems&&n.dropdownItems.length>0&&n.activeItemIndex!==-1&&(e.preventDefault(),n.$apply(s));break;case 9:n.dropdownVisible&&n.dropdownItems&&n.dropdownItems.length>0&&n.activeItemIndex!==-1&&n.$apply(s)}})}}}var n=e.module("cab9.common");n.directive("inputDropdown",t),t.$inject=["$http","$parse"],e.module("cab9.common").directive("context",function(){return{restrict:"A",scope:"@&",compile:function(e,t,n){return{post:function(e,t,n,i){var o=$("#"+n.context),d=null;o.css({display:"none"}),$(t).bind("contextmenu",function(e){e.preventDefault(),o.css({position:"fixed",display:"inline-block",left:e.clientX+"px",top:e.clientY+"px"}),d=e.timeStamp}),$(document).click(function(e){var t=$(e.target);if(!t.is(".popover")&&!t.parents().is(".popover")){if(d===e.timeStamp)return;o.css({display:"none"})}})}}}}})}(angular);;;;
!function(r){function e(){}function n(){}var t=r.module("cab9.reports",[]);t.config(e),t.run(n),e.$inject=[],t.constant("$UI",{COLOURS:{brandPrimary:"#68B8F6",brandSecondary:"#3D799B",blue:"#032b5a",red:"#F55753",yellow:"#F8D053",cyan:"#10CFBD",sky:"#48B0F7",green:"#64c458",purple:"#6D5CAE",brandGrey:"#3B4752",darkGrey:"#2B303B",lightGrey:"rgba(100,100,100,0.1)",grey:"#788195",lighterGrey:"rgba(0,0,0,0.2)"}}),t.factory("reports",["$http","$rootScope",function(r,e){var n={};return n.getQuery=function(){var r="";for(var n in e.filters)e.filters.hasOwnProperty(n)&&e.filters[n]&&("From"==n||"To"==n?r+=n+"="+moment(e.filters[n]).format("YYYY-MM-DD")+"&":e.filters[n].length>0&&(r+="DriverIds"==n||"ClientIds"==n||"PassengerIds"==n||"VehicleTypeIds"==n||"VehicleClassIds"==n||"CurrencyIds"==n?n+"="+e.filters[n].map(function(r){return"'"+r.replace(/ /g,"")+"'"})+"&":n+"="+e.filters[n]+"&"));return r},n}]),n.$inject=[]}(angular);;;;
!function(){var o=angular.module("cab9.reports");o.filter("periodFormatFilter",["$filter",function(o){return function(t,e){return t?"Q YYYY"==e?"Q"+moment(t).format(e):"DD/MM"==e?o("date")(moment(t).toDate(),"shortDate"):moment(t).format(e):""}}]),o.directive("bookingStats",["$q","$parse","$timeout","$http","$rootScope","$UI","reports","CSV","$filter",function(o,t,e,r,n,a,i,s,u){return{templateUrl:"/webapp/common/reports/bookings-report/report.bookings.html",scope:!0,link:function(t,e,n){function c(){t.deferred=o.defer(),k.data.length=0,h=i.getQuery(),h=h.substr(0,h.length-1),console.log(h),b=r.get($config.API_ENDPOINT+"api/reports/booking?"+h),b.success(m(b)),b.error(g)}function l(){s.download(t.bookingsGroupData.map(function(o){return{Period:moment(o.Period).format("DD/MM/YYYY"),Bookings:o.ActualCost,ActualCost:o.Cost,InvoiceCost:o.InvoiceCost,CashBookingsCount:o.CashBookingsCount,CashBookingsCost:o.CashBookingsCost,AccountBookingsCount:o.AccountBookingsCount,AccountBookingsCost:o.AccountBookingsCost,CancelledBookingsCount:o.CancelBookingsCount,CancelledBookingsCost:o.CancelBookingsCost}}),"BookingsReport")}function m(o){var e=o;return function(o){e===b&&(t.bookingsOptions=p,k.data.length=0,angular.forEach(o.Grouped,function(o,t){k.data.push([new moment(o.Period.slice(0,10)).valueOf(),o.Bookings])}),t.periodFormat=d(o.Parameters.PeriodLength),t.bookingsGroupData=o.Grouped,t.totals=o.Totals,t.deferred.resolve(!0))}}function d(o){return"yy"==o?"YYYY":"mm"==o?"MMM YY":"qq"==o?"Q YYYY":"hh"==o?"HH:mm":"DD/MM"}function g(o){t.deferred.reject("An Error Occured")}var f=t.DATETIME_FORMAT.replace(/[.|/|-][y|Y][y|Y]*/g,"");t.deferred=null;var b=null;t.refresh=c,t.bookingsDownload=l;var h="",k={label:"Bookings",data:[]};t.bookingsData=[k],t.bookingsOptions=null;var p={series:{shadowSize:0,bars:{show:"true"},stack:!0},bars:{align:"center",fill:1,barWidth:5184e4},legend:{margin:[0,-60]},grid:{backgroundColor:{colors:["#fff","#fff"]},borderWidth:0,hoverable:!0,color:"#bbb"},tooltip:!0,tooltipOpts:{content:function(o,t,e){return"<small>"+u("date")(moment(t).toDate(),"shortDate")+"</small><br /> <strong>%s</strong> %y"},defaultTheme:!1},colors:[a.COLOURS.brandPrimary],xaxis:{show:!0,mode:"time",minTickSize:[1,"hour"],tickFormatter:function(o,e){if("DD/MM"==t.periodFormat){var r=u("date")(moment(o).toDate(),f);return r}var r=moment(o).format(t.periodFormat);return"Q YYYY"==t.periodFormat&&(r="Q"+r),r}},yaxis:{minTickSize:1,show:!0,tickFormatter:function(o,t){return Math.abs(Number(o))>=1e9?Math.abs(Number(o))/1e9+"b":Math.abs(Number(o))>=1e6?Math.abs(Number(o))/1e6+"m":Math.abs(Number(o))>=1e3?Math.abs(Number(o))/1e3+"k":Math.abs(Number(o))}}};c(),t.$on("fetchData",function(){c()}),t.data=[]}}}])}();;;;
!function(){var o=angular.module("cab9.reports");o.filter("periodFormatFilter",["$filter",function(o){return function(t,e){return t?"Q YYYY"==e?"Q"+moment(t).format(e):"DD/MM"==e?o("date")(moment(t).toDate(),"shortDate"):moment(t).format(e):""}}]),o.directive("clientBookingStats",["$q","$parse","$timeout","$http","$rootScope","$UI","reports","CSV","$filter",function(o,t,e,r,n,a,i,s,u){return{templateUrl:"/webapp/common/reports/client-bookings-report/report.bookings.html",scope:!0,link:function(t,e,n){function c(){t.deferred=o.defer(),k.data.length=0,h=i.getQuery(),h=h.substr(0,h.length-1),console.log(h),b=r.get($config.API_ENDPOINT+"api/reports/booking?"+h),b.success(m(b)),b.error(g)}function l(){s.download(t.bookingsGroupData.map(function(o){return{Period:moment(o.Period).format("DD/MM/YYYY"),Bookings:o.ActualCost,ActualCost:o.Cost,InvoiceCost:o.InvoiceCost,CashBookingsCount:o.CashBookingsCount,CashBookingsCost:o.CashBookingsCost,AccountBookingsCount:o.AccountBookingsCount,AccountBookingsCost:o.AccountBookingsCost,CancelledBookingsCount:o.CancelBookingsCount,CancelledBookingsCost:o.CancelBookingsCost}}),"BookingsReport")}function m(o){var e=o;return function(o){e===b&&(t.bookingsOptions=p,k.data.length=0,angular.forEach(o.Grouped,function(o,t){k.data.push([new moment(o.Period.slice(0,10)).valueOf(),o.Bookings])}),t.periodFormat=d(o.Parameters.PeriodLength),t.bookingsGroupData=o.Grouped,t.totals=o.Totals,t.deferred.resolve(!0))}}function d(o){return"yy"==o?"YYYY":"mm"==o?"MMM YY":"qq"==o?"Q YYYY":"hh"==o?"HH:mm":"DD/MM"}function g(o){t.deferred.reject("An Error Occured")}var f=t.DATETIME_FORMAT.replace(/[.|/|-][y|Y][y|Y]*/g,"");t.deferred=null;var b=null;t.refresh=c,t.bookingsDownload=l;var h="",k={label:"Bookings",data:[]};t.bookingsData=[k],t.bookingsOptions=null;var p={series:{shadowSize:0,bars:{show:"true"},stack:!0},bars:{align:"center",fill:1,barWidth:5184e4},legend:{margin:[0,-60]},grid:{backgroundColor:{colors:["#fff","#fff"]},borderWidth:0,hoverable:!0,color:"#bbb"},tooltip:!0,tooltipOpts:{content:function(o,t,e){return"<small>"+u("date")(moment(t).toDate(),"shortDate")+"</small><br /> <strong>%s</strong> %y"},defaultTheme:!1},colors:[a.COLOURS.brandPrimary],xaxis:{show:!0,mode:"time",minTickSize:[1,"hour"],tickFormatter:function(o,e){if("DD/MM"==t.periodFormat){var r=u("date")(moment(o).toDate(),f);return r}var r=moment(o).format(t.periodFormat);return"Q YYYY"==t.periodFormat&&(r="Q"+r),r}},yaxis:{minTickSize:1,show:!0,tickFormatter:function(o,t){return Math.abs(Number(o))>=1e9?Math.abs(Number(o))/1e9+"b":Math.abs(Number(o))>=1e6?Math.abs(Number(o))/1e6+"m":Math.abs(Number(o))>=1e3?Math.abs(Number(o))/1e3+"k":Math.abs(Number(o))}}};c(),t.$on("fetchData",function(){c()}),t.data=[]}}}])}();;;;
!function(){var o=angular.module("cab9.reports");o.directive("bookingsourceStats",["$q","$parse","$timeout","$http","$rootScope","$UI","reports","CSV","$config",function(o,r,e,t,n,a,i,u,c){return{templateUrl:"/webapp/common/reports/bookingSource-report/report.bookingSource.html",link:function(r,e,n){function l(o,e,t,n){var a=r.company.Currency,i=r.bookingSourceGroupData.filter(function(r){return r.Name==o})[0],u=0;return i?(u=i.ActualCost,"<div style='font-size:9pt; text-align:center; padding:2px; color:white;'>"+o+"<br/>"+t.toString()+" Bookings<br/><strong>"+u+" "+a+" </strong></div>"):""}function s(){r.deferred=o.defer(),k.data=null,r.total=0,r.bookingSourceChartOptions=S,b=i.getQuery(),b=b.substr(0,b.length-1),f=t.get(c.API_ENDPOINT+"api/reports/booking?"+b+"&GroupByEntity=BookingSource"),f.success(p(f)),f.error(d)}function g(){u.download(r.bookingSourceGroupData.map(function(o){return{Name:o.Name,Bookings:o.Bookings,ActualCost:o.ActualCost,InvoiceCost:o.InvoiceCost}}),"BookingSourceReport")}function p(o){var e=o;return function(o){e===f&&(r.bookingSourceChartOptions=S,k.data=null,r.bookingSourceData=[],angular.forEach(o.Grouped,function(o,e){r.bookingSourceData.push({label:o.Name,data:o.Bookings})}),r.bookingSourceGroupData=o.Grouped,r.company=o.Company,r.total+=parseInt(o.Totals.TotalBookings),r.deferred.resolve(!0))}}function d(o){r.deferred.reject("An Error Occured")}r.deferred=null;var f=null;r.refresh=s,r.bookingSourceDownload=g;var b="",k={label:"Bookings",data:null};r.bookingSourceData=[],r.showDriverTable=!0;var S={series:{pie:{show:!0,combine:{color:"#999",threshold:.1}}},colors:[a.COLOURS.brandPrimary,a.COLOURS.brandSecondary],tooltip:{show:!0,content:l,shifts:{x:25,y:0},defaultTheme:!1},grid:{hoverable:!0}};r.$on("fetchData",function(){s()}),s()}}}])}();;;;
!function(){var t=angular.module("cab9.reports");t.directive("clientStats",["$q","$parse","$timeout","$http","$rootScope","$UI","reports","CSV","$config",function(t,e,o,r,n,a,i,l,c){return{templateUrl:"/webapp/common/reports/client-report/report.client.html",link:function(e,o,n){function s(t,o,r,n){var a=e.company.Currency,i=e.clientGroupData.filter(function(e){return e.Name==t})[0],l=0;return i?(l=i.ActualCost,"<div style='font-size:9pt; text-align:center; padding:2px; color:white;'>"+t+"<br/>"+r.toString()+" Bookings<br/><strong>"+l+" "+a+" </strong></div>"):""}function u(){e.deferred=t.defer(),m.data=null,e.total=0,e.clientChartOptions=b,g=i.getQuery(),g=g.substr(0,g.length-1),h=r.get(c.API_ENDPOINT+"api/reports/booking?"+g+"&GroupByEntity=ClientId"),h.success(p(h)),h.error(f)}function d(){l.download(e.clientGroupData.map(function(t){return{Name:t.Name,Bookings:t.Bookings,ActualCost:t.ActualCost,InvoiceCost:t.InvoiceCost}}),"ClientReport")}function p(t){var o=t;return function(t){o===h&&(e.clientChartOptions=b,m.data=null,e.clientData=[],angular.forEach(t.Grouped,function(t,o){e.clientData.push({label:t.Name,data:t.Bookings})}),e.clientGroupData=t.Grouped,e.company=t.Company,e.total+=parseInt(t.Totals.TotalBookings),e.deferred.resolve(!0))}}function f(t){e.deferred.reject("An Error Occured")}e.deferred=null;var h=null;e.refresh=u,e.clientDownload=d;var g="",m={label:"Bookings",data:null};e.clientData=[],e.showDriverTable=!0;var b={series:{pie:{show:!0,combine:{color:"#999",threshold:.03},label:{threshold:.03}}},colors:[a.COLOURS.brandPrimary,a.COLOURS.brandSecondary],tooltip:{show:!0,content:s,shifts:{x:25,y:0},defaultTheme:!1},grid:{hoverable:!0}};e.$on("fetchData",function(){u()}),u()}}}])}();;;;
!function(){var r=angular.module("cab9.reports");r.directive("currencyStats",["$q","$parse","$timeout","$http","$rootScope","$UI","reports","CSV","$config",function(r,e,o,t,n,a,c,u,i){return{templateUrl:"/webapp/common/reports/currency-report/report.currency.html",link:function(e,o,n){function l(r,o,t,n){var a=e.company.Currency,c=e.currencyGroupData.filter(function(e){return e.Name==r})[0],u=0;return c?(u=c.ActualCost,"<div style='font-size:9pt; text-align:center; padding:2px; color:white;'>"+r+"<br/>"+t.toString()+" Bookings<br/><strong>"+u+" "+a+" </strong></div>"):""}function s(){e.deferred=r.defer(),h.data=null,e.total=0,e.currencyChartOptions=m,g=c.getQuery(),g=g.substr(0,g.length-1),y=t.get(i.API_ENDPOINT+"api/reports/booking?"+g+"&GroupByEntity=CurrencyId"),y.success(d(y)),y.error(f)}function p(){u.download(e.currencyGroupData.map(function(r){return{Name:r.Name,Bookings:r.Bookings,ActualCost:r.ActualCost,InvoiceCost:r.InvoiceCost}}),"CurrencyReport")}function d(r){var o=r;return function(r){o===y&&(e.currencyChartOptions=m,h.data=null,e.currencyData=[],angular.forEach(r.Grouped,function(r,o){e.currencyData.push({label:r.Name,data:r.Bookings})}),e.currencyGroupData=r.Grouped,e.company=r.Company,e.total+=parseInt(r.Totals.TotalBookings),e.deferred.resolve(!0))}}function f(r){e.deferred.reject("An Error Occured")}e.deferred=null;var y=null;e.refresh=s,e.currencyDownload=p;var g="",h={label:"Bookings",data:null};e.currencyData=[],e.showDriverTable=!0;var m={series:{pie:{show:!0,combine:{color:"#999",threshold:.1}}},colors:[a.COLOURS.brandPrimary,a.COLOURS.brandSecondary],tooltip:{show:!0,content:l,shifts:{x:25,y:0},defaultTheme:!1},grid:{hoverable:!0}};e.$on("fetchData",function(){s()}),s()}}}])}();;;;
!function(){var r=angular.module("cab9.reports");r.directive("driverStats",["$q","$parse","$timeout","$http","$rootScope","$UI","reports","CSV","$config",function(r,e,o,t,n,a,i,l,d){return{templateUrl:"/webapp/common/reports/driver-report/report.driver.html",link:function(e,o,n){function s(r,o,t,n){var a=e.company.Currency,i=e.driverGroupData.filter(function(e){return e.Name==r})[0],l=0;return i?(l=i.ActualCost,"<div style='font-size:9pt; text-align:center; padding:2px; color:white;'>"+r+"<br/>"+t.toString()+" Bookings<br/><strong>"+l+" "+a+" </strong></div>"):""}function u(){e.deferred=r.defer(),g.data=null,e.total=0,e.driverChartOptions=m,h=i.getQuery(),h=h.substr(0,h.length-1),f=t.get(d.API_ENDPOINT+"api/reports/booking?"+h+"&GroupByEntity=DriverId"),f.success(p(f)),f.error(v)}function c(){l.download(e.driverGroupData.map(function(r){return{Name:r.Name,Bookings:r.Bookings,ActualCost:r.ActualCost,InvoiceCost:r.InvoiceCost}}),"DriverReport")}function p(r){var o=r;return function(r){o===f&&(e.driverChartOptions=m,g.data=null,e.driverData=[],angular.forEach(r.Grouped,function(r,o){e.driverData.push({label:r.Name,data:r.Bookings})}),e.driverGroupData=r.Grouped,e.company=r.Company,e.total+=parseInt(r.Totals.TotalBookings),e.deferred.resolve(!0))}}function v(r){e.deferred.reject("An Error Occured")}e.deferred=null;var f=null;e.refresh=u,e.driverDownload=c;var h="",g={label:"Bookings",data:null};e.driverData=[],e.showDriverTable=!0;var m={series:{pie:{show:!0,combine:{color:"#999",threshold:.025},label:{threshold:.025}}},colors:[a.COLOURS.brandPrimary,a.COLOURS.brandSecondary],tooltip:{show:!0,content:s,shifts:{x:25,y:0},defaultTheme:!1},grid:{hoverable:!0}};e.$on("fetchData",function(){u()}),u()}}}])}();;;;
!function(){var e=angular.module("cab9.reports");e.directive("passengerStats",["$q","$parse","$timeout","$http","$rootScope","$UI","reports","CSV","$config",function(e,r,o,t,n,a,s,i,l){return{templateUrl:"/webapp/common/reports/passenger-report/report.passenger.html",link:function(r,o,n){function p(e,o,t,n){var a=r.company.Currency,s=r.passengerGroupData.filter(function(r){return r.Name==e})[0],i=0;return s?(i=s.ActualCost,"<div style='font-size:9pt; text-align:center; padding:2px; color:white;'>"+e+"<br/>"+t.toString()+" Bookings<br/><strong>"+i+" "+a+" </strong></div>"):""}function u(){r.deferred=e.defer(),m.data=null,r.total=0,r.passengerChartOptions=b,h=s.getQuery(),h=h.substr(0,h.length-1),f=t.get(l.API_ENDPOINT+"api/reports/booking?"+h+"&GroupByEntity=LeadPassengerId&Top=50&OrderBy=Bookings"),f.success(d(f)),f.error(g)}function c(){i.download(r.passengerGroupData.map(function(e){return{Name:e.Name,Bookings:e.Bookings,ActualCost:e.ActualCost,InvoiceCost:e.InvoiceCost}}),"PassengerReport")}function d(e){var o=e;return function(e){o===f&&(r.passengerChartOptions=b,m.data=null,r.passengerData=[],angular.forEach(e.Grouped,function(e,o){r.passengerData.push({label:e.Name,data:e.Bookings})}),r.passengerGroupData=e.Grouped,r.company=e.Company,r.total+=parseInt(e.Totals.TotalBookings),r.deferred.resolve(!0))}}function g(e){r.deferred.reject("An Error Occured")}r.deferred=null;var f=null;r.refresh=u,r.passengerDownload=c;var h="",m={label:"Bookings",data:null};r.passengerData=[],r.showDriverTable=!0;var b={series:{pie:{show:!0,combine:{color:"#999",threshold:.06},label:{threshold:.06}}},colors:[a.COLOURS.brandPrimary,a.COLOURS.brandSecondary],tooltip:{show:!0,content:p,shifts:{x:25,y:0},defaultTheme:!1},grid:{hoverable:!0}};r.$on("fetchData",function(){u()}),u()}}}])}();;;;
!function(){var e=angular.module("cab9.reports");e.directive("paymenttypeStats",["$q","$parse","$timeout","$http","$rootScope","$UI","reports","CSV","$config",function(e,t,o,n,r,a,p,i,l){return{templateUrl:"/webapp/common/reports/paymentType-report/report.paymentType.html",link:function(t,o,r){function u(e,o,n,r){var a=t.company.Currency,p=t.paymentTypeGroupData.filter(function(t){return t.Name==e})[0],i=0;return p?(i=p.ActualCost,"<div style='font-size:9pt; text-align:center; padding:2px; color:white;'>"+e+"<br/>"+n.toString()+" Bookings<br/><strong>"+i+" "+a+" </strong></div>"):""}function s(){t.deferred=e.defer(),g.data=null,t.total=0,t.paymentTypeChartOptions=h,f=p.getQuery(),f=f.substr(0,f.length-1),m=n.get(l.API_ENDPOINT+"api/reports/booking?"+f+"&GroupByEntity=PaymentMethod"),m.success(y(m)),m.error(d)}function c(){i.download(t.paymentTypeGroupData.map(function(e){return{Name:e.Name,Bookings:e.Bookings,ActualCost:e.ActualCost,InvoiceCost:e.InvoiceCost}}),"PaymentTypeReport")}function y(e){var o=e;return function(e){o===m&&(t.paymentTypeChartOptions=h,g.data=null,t.paymentTypeData=[],angular.forEach(e.Grouped,function(e,o){t.paymentTypeData.push({label:e.Name,data:e.Bookings})}),t.paymentTypeGroupData=e.Grouped,t.company=e.Company,t.total+=parseInt(e.Totals.TotalBookings),t.deferred.resolve(!0))}}function d(e){t.deferred.reject("An Error Occured")}t.deferred=null;var m=null;t.refresh=s,t.paymentTypeDownload=c;var f="",g={label:"Bookings",data:null};t.paymentTypeData=[],t.showDriverTable=!0;var h={series:{pie:{show:!0,combine:{color:"#999",threshold:.1}}},colors:[a.COLOURS.brandPrimary,a.COLOURS.brandSecondary],tooltip:{show:!0,content:u,shifts:{x:25,y:0},defaultTheme:!1},grid:{hoverable:!0}};t.$on("fetchData",function(){s()}),s()}}}])}();;;;
!function(){var e=angular.module("cab9.reports");e.directive("vehicletypeStats",["$q","$parse","$timeout","$http","$rootScope","$UI","reports","CSV","$config",function(e,t,o,r,n,a,i,l,c){return{templateUrl:"/webapp/common/reports/vehicleType-report/report.vehicleType.html",link:function(t,o,n){function p(e,o,r,n){var a=t.company.Currency,i=t.vehicleTypeGroupData.filter(function(t){return t.Name==e})[0],l=0;return i?(l=i.ActualCost,"<div style='font-size:9pt; text-align:center; padding:2px; color:white;'>"+e+"<br/>"+r.toString()+" Bookings<br/><strong>"+l+" "+a+" </strong></div>"):""}function s(){t.deferred=e.defer(),y.data=null,t.total=0,t.vehicleTypeChartOptions=g,v=i.getQuery(),v=v.substr(0,v.length-1),f=r.get(c.API_ENDPOINT+"api/reports/booking?"+v+"&GroupByEntity=VehicleTypeId"),f.success(h(f)),f.error(d)}function u(){l.download(t.vehicleTypeGroupData.map(function(e){return{Name:e.Name,Bookings:e.Bookings,ActualCost:e.ActualCost,InvoiceCost:e.InvoiceCost}}),"VehicleTypeReport")}function h(e){var o=e;return function(e){o===f&&(t.vehicleTypeChartOptions=g,y.data=null,t.vehicleTypeData=[],angular.forEach(e.Grouped,function(e,o){t.vehicleTypeData.push({label:e.Name,data:e.Bookings})}),t.vehicleTypeGroupData=e.Grouped,t.company=e.Company,t.total+=parseInt(e.Totals.TotalBookings),t.deferred.resolve(!0))}}function d(e){t.deferred.reject("An Error Occured")}t.deferred=null;var f=null;t.refresh=s,t.vehicleTypeDownload=u;var v="",y={label:"Bookings",data:null};t.vehicleTypeData=[],t.showDriverTable=!0;var g={series:{pie:{show:!0,combine:{color:"#999",threshold:.03},label:{threshold:.03}}},colors:[a.COLOURS.brandPrimary,a.COLOURS.brandSecondary],tooltip:{show:!0,content:p,shifts:{x:25,y:0},defaultTheme:!1},grid:{hoverable:!0}};t.$on("fetchData",function(){s()}),s()}}}])}();;;;
!function(){var e=angular.module("cab9.reports");e.directive("vehicleclassStats",["$q","$parse","$timeout","$http","$rootScope","$UI","reports","CSV","$config",function(e,o,t,r,a,n,l,s,i){return{templateUrl:"/webapp/common/reports/vehicleClass-report/report.vehicleClass.html",link:function(o,t,a){function c(e,t,r,a){var n=o.company.Currency,l=o.vehicleClassGroupData.filter(function(o){return o.Name==e})[0],s=0;return l?(s=l.ActualCost,"<div style='font-size:9pt; text-align:center; padding:2px; color:white;'>"+e+"<br/>"+r.toString()+" Bookings<br/><strong>"+s+" "+n+" </strong></div>"):""}function u(){o.deferred=e.defer(),C.data=null,o.total=0,o.vehicleClassChartOptions=g,v=l.getQuery(),v=v.substr(0,v.length-1),f=r.get(i.API_ENDPOINT+"api/reports/booking?"+v+"&GroupByEntity=VehicleClassId"),f.success(d(f)),f.error(h)}function p(){s.download(o.vehicleClassGroupData.map(function(e){return{Name:e.Name,Bookings:e.Bookings,ActualCost:e.ActualCost,InvoiceCost:e.InvoiceCost}}),"VehicleClassReport")}function d(e){var t=e;return function(e){t===f&&(o.vehicleClassChartOptions=g,C.data=null,o.vehicleClassData=[],angular.forEach(e.Grouped,function(e,t){o.vehicleClassData.push({label:e.Name,data:e.Bookings})}),o.vehicleClassGroupData=e.Grouped,o.company=e.Company,o.total+=parseInt(e.Totals.TotalBookings),o.deferred.resolve(!0))}}function h(e){o.deferred.reject("An Error Occured")}o.deferred=null;var f=null;o.refresh=u,o.vehicleClassDownload=p;var v="",C={label:"Bookings",data:null};o.vehicleClassData=[],o.showDriverTable=!0;var g={series:{pie:{show:!0,combine:{color:"#999",threshold:.1}}},colors:[n.COLOURS.brandPrimary,n.COLOURS.brandSecondary],tooltip:{show:!0,content:c,shifts:{x:25,y:0},defaultTheme:!1},grid:{hoverable:!0}};o.$on("fetchData",function(){u()}),u()}}}])}();;;;
!function(e){function t(e,t,o,n,r,a,c){function l(){e.note.Subject="Note:",e.note.OwnerType=c,e.note.OwnerId=r.Id;var n=[];n.push(e.note.$save()),o.all(n).then(function(e){swal({title:"Note Saved.",text:"The note has been saved..",type:"success",confirmButtonColor:t.COLOURS.brandSecondary}),a.close(e[0].data)},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error"})})}e.note=new n.Note,e.displayMode="CREATE",e.save=l}function o(e,t,o,n,r,a){function c(){var o=[];o.push(e.note.$patch()),r.all(o).then(function(e){swal({title:"Note Updated.",text:"The note has been updated.",type:"success",confirmButtonColor:t.COLOURS.brandSecondary}),a.close(e[0].data)},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:t.COLOURS.brandSecondary})})}e.note=n,e.displayMode="EDIT",e.save=c}var n=e.module("cab9.common");n.controller("NoteCreateController",t),n.controller("NoteEditController",o),t.$inject=["$scope","$UI","$q","Model","$stateParams","$modalInstance","rOwner"],o.$inject=["$scope","$UI","$http","rNote","$q","$modalInstance"]}(angular);;;;
!function(e){function o(o,n,t,a,s,r,u,l,a,c,d,g,m){function p(){var e=o._qbooking=new s.Booking;o.displayMode="CREATE",e.BookingStops=[],e.BookingStops.push(new s.BookingStop),e.BookingStops.push(new s.BookingStop),e.Pax=1,e.Bax=0,e.TaxId=o.COMPANY.DefaultTaxId;var n=new moment.tz(c.timeZone().getTimeZone());e.BookedDateTime=n.toDate(),e.Time=n.startOf("minute").add(15,"minutes").toDate(),e.CurrencyId=o.COMPANY.DefaultCurrencyId,e.EstimatedCost=0}function k(){o.quickmap=new google.maps.Map(document.getElementById("map-div"),{center:new google.maps.LatLng(o.COMPANY.BaseLatitude,o.COMPANY.BaseLongitude),zoom:9,disableDefaultUI:!0,styles:t.GMAPS_STYLE})}function f(){var e=[];o.dataReady=!1;var n=s.Client.query().select("Id,Name,DefaultCurrencyId,ImageUrl,ClientType/Name").include("ClientType").parseAs(function(e){this.Id=e.Id,this.Name=e.Name,this.DefaultCurrencyId=e.DefaultCurrencyId,this.Description=e.ClientType.Name,this.ImageUrl=d.formatUrl(e.ImageUrl,e.Name)}).execute().then(function(e){o.filteredClients=o.clients=e}),t=s.Passenger.query().select("Id,Firstname,Surname,ImageUrl,Mobile,ClientId,Client/Name").include("Client").parseAs(function(e){this.Id=e.Id,this.ClientId=e.ClientId,this.Name=e.Firstname+" "+e.Surname,this.Description=e.Client&&e.Client.Name?e.Client.Name:"No Client",this.Mobile=e.Mobile,this.ImageUrl=d.formatUrl(e.ImageUrl,e.Name)}).execute().then(function(e){o.filteredPassengers=o.passengers=e}),i=s.VehicleType.query().execute().then(function(e){o.vehicleTypes=e});e.push(n),e.push(t),e.push(i),a.all(e).then(function(){o.dataReady=!0})}function C(){var e=[],t=o._qbooking;if(o.paxMode.value){if(!t._LeadPassenger)return void swal("Invalid","Please add passenger details.","error");var i=t._LeadPassenger.split(" ");o._qbooking.LeadPassenger={Firstname:i[0],Surname:i.slice(1).join(" "),Mobile:t._LeadPassengerNumber,ClientId:t.ClientId}}var s=new moment(o._qbooking.Time).tz(c.timeZone().getTimeZone()),r=new moment(o._qbooking.BookedDateTime).format("YYYY-MM-DD")+"T"+s.format("HH:mm")+moment.tz(c.timeZone().getTimeZone()).format("Z");o._qbooking.BookedDateTime=r,e.push(o._qbooking.$save()),a.all(e).then(function(e){swal({title:"Booking Saved.",text:"The booking has been saved..",type:"success",confirmButtonColor:n.COLOURS.brandSecondary}),u.close(e[0].data)},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error"})})}function I(e){o.dataReady=!1;g.post(t.API_ENDPOINT+"api/quote",e).success(function(n){e.EstimatedCost=n.FinalCost,e.ActualCost=n.FinalCost,o.dataReady=!0,o.currentTab="JOURNEY",o.directions=n.Directions;var t=google.maps.geometry.encoding.decodePath(n.Directions.paths[0].points),a=(new google.maps.Polyline({map:o.quickmap,path:t,geodesic:!0,strokeColor:"#63C4E1",strokeOpacity:.8,strokeWeight:6}),new google.maps.LatLngBounds);for(i=0;i<t.length;i++)a.extend(t[i]);m(function(){o.quickmap.fitBounds(a)},500)}).error(function(e){console.log(e),o.dataReady=!0})}function h(n){o.journeyCopied=!1,o._qbooking.BookingStops=[],o._qbooking.BookingStops=e.copy(n.BookingStops).map(function(e){return e.Id=null,e.BookingId=null,e.Booking=null,e}),o.journeyCopied=!0}function q(){u.close()}p(),f(),setTimeout(function(){k()},10),o.paxMode={value:!1},o.save=C,o.close=q,o.repeatBooking=h,o.currentTab="JOURNEY",o.$watch("_qbooking.LeadPassengerId",function(e){var n=o._qbooking;e?(n.ClientId=o.passengers.filter(function(o){return o.Id==e})[0].ClientId,s.Booking.query().where("LeadPassengerId","eq","guid'"+e+"'").include("BookingStops").orderBy("BookedDateTime desc").top(5).execute().then(function(e){o.paxHistory=e,o.currentTab="HISTORY"})):(n.ClientId=null,o.filteredPassengers=o.passengers)});var b=!0;o.$watch("_qbooking.ClientId",function(e){if(b?setTimeout(function(){b=!1},0):e&&(o.filteredPassengers=o.passengers.filter(function(o){return o.ClientId==e})),o._qbooking.ClientId){var n=o.clients.filter(function(e){return e.Id==o._qbooking.ClientId})[0];n&&(o._qbooking.CurrencyId=n.DefaultCurrencyId)}else o._qbooking.CurrencyId=o.COMPANY.DefaultCurrencyId},!0),o.$watch("_qbooking.BookingStops",function(n){o.canQuote=!1;var t=[];e.forEach(n,function(e,n){if(e.Latitude&&e.Longitude){o.canQuote=!0;var i=new google.maps.LatLng(e.Latitude,e.Longitude);t[n]?t[n].setPosition(i):t[n]=new google.maps.Marker({position:i,visible:!0,icon:0==n?"/includes/images/user.png":"/includes/images/userTo.png",map:o.quickmap,zIndex:1e3}),0==n&&o._qbooking.BookingStops.length<3&&(o.quickmap.panTo(i),o.quickmap.setZoom(15))}else o.canQuote=!1}),o.canQuote?I(o._qbooking):(o._qbooking.EstimatedCost=0,o._qbooking.ActualCost=0)},!0),o.$watch("_qbooking.VehicleTypeId",function(n){o.canQuote=!1;var t=[];e.forEach(o._qbooking.BookingStops,function(e,n){if(e.Latitude&&e.Longitude){o.canQuote=!0;var i=new google.maps.LatLng(e.Latitude,e.Longitude);t[n]?t[n].setPosition(i):t[n]=new google.maps.Marker({position:i,visible:!0,icon:0==n?"/includes/images/user.png":"/includes/images/userTo.png",map:o.quickmap,zIndex:1e3}),0==n&&o._qbooking.BookingStops.length<3&&(o.quickmap.panTo(i),o.quickmap.setZoom(15))}else o.canQuote=!1}),o.canQuote?I(o._qbooking):(o._qbooking.EstimatedCost=0,o._qbooking.ActualCost=0)}),o.$watch("paxMode.value",function(e){e===!0&&(o._qbooking.LeadPassengerId=null)})}var n=e.module("cab9.common");n.controller("QuickBookingCreateController",o),o.$inject=["$scope","$UI","$config","$q","Model","$stateParams","$modalInstance","$rootScope","$q","Localisation","$utilities","$http","$timeout"]}(angular);;;;
!function(e){function o(e,o,t,a,n,r){function l(){var a=[];a.push(e.paymentModel.$save()),t.all(a).then(function(e){swal({title:"Payment Model Saved.",text:"Changes have been updated",type:"success",confirmButtonColor:o.COLOURS.brandSecondary}),r.close(e[0].data)},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error"})})}e.paymentModel=new a.DriverPaymentModel,e.displayMode="CREATE",e.save=l}var t=e.module("cab9.common");t.controller("DriverPaymentModelCreateController",o),o.$inject=["$scope","$UI","$q","Model","$stateParams","$modalInstance"]}(angular);;;;
!function(e){function r(e,r,s,a,o,n,t,c,u,d,i){function l(){n.post(a.API_ENDPOINT+"api/account/SetPassword",{Id:e.user.Id,NewPassword:e.user.Password,ConfirmPassword:e.user.Password}).then(function(e){swal("Success","Password changed successfully.","success"),c.close(),s.go(s.current,t,{reload:!0})},function(e){swal("An error has occurred.",e.data.ExceptionMessage?e.data.ExceptionMessage:"There was an error processing your request. Please check your field values and try again.","error")})}function f(e){for(var r="abcdefghijklmnopqrstuvwxyz",s="ABCDEFGHIJKLMNOPQRSTUVWXYZ",a="1234567890",o=r+s+a,n="",t=0;t<5;t++)n+=o.charAt(Math.floor(62*Math.random()));n+=s.charAt(Math.floor(26*Math.random())),n+=r.charAt(Math.floor(26*Math.random())),n+=a.charAt(Math.floor(10*Math.random()));var c=n.split("").sort(function(){return.5-Math.random()}).join("");return c}function h(){e.user.PasswordRepeat=e.user.Password,n.post(a.API_ENDPOINT+"api/account",e.user).success(function(){swal("User Created","User has been created.","success"),c.close(),s.go(s.current,t,{reload:!0})}).error(function(e){swal("An error has occurred.",e.ExceptionMessage?e.ExceptionMessage:"There was an error processing your request. Please check your field values and try again.","error")})}e.user=d,e.user.Password=f(8),e.save=h,e.reset=l,e.displayMode="CREATE",e.resetPassword=i}function s(e,r,s,a,o,n,t,c,u,d){function i(r){e.fetchedUsers.length=0,n.get(a.API_ENDPOINT+"api/account/SearchClientUsers",{params:{searchText:r,clientId:e.info.ClientId}}).then(function(r){[].push.apply(e.fetchedUsers,r.data)})}function l(){n.post(a.API_ENDPOINT+"api/account/LinkUser",null,{params:{userId:e.info.Id,clientId:e.info.ClientId,staffId:e.info.StaffId}}).success(function(){swal("User Linked","User has been linked.","success"),c.close(),s.go(s.current,t,{reload:!0})}).error(function(e){swal("An error has occurred.",e.ExceptionMessage?e.ExceptionMessage:"There was an error processing your request. Please check your field values and try again.","error")})}e.fetchedUsers=[],e.info=d,e.searchUsers=i,e.save=l}var a=e.module("cab9.common");a.controller("UserModalController",r),a.controller("LinkUserModalController",s),r.$inject=["$scope","$rootScope","$state","$config","$UI","$http","$stateParams","$modalInstance","Model","rUser","resetPassword"],s.$inject=["$scope","$rootScope","$state","$config","$UI","$http","$stateParams","$modalInstance","Model","rData"]}(angular);;;;
!function(e){function a(e,a,r,t,n,o,d,i,s,l,c,m,p,u){function h(){x=new Card({form:document.querySelector("form"),container:".card-wrapper",width:350,messages:{validDate:"valid\ndate",monthYear:"mm/yy"},masks:{cardNumber:""},debug:!1})}function w(r){e.showLoader=!0,r.ExpirationYear=r.$Expiry.split("/")[1].trim(),4==r.ExpirationYear.length&&(r.ExpirationYear=r.ExpirationYear[2]+r.ExpirationYear[3]),r.ExpirationMonth=r.$Expiry.split("/")[0].trim();var n=parseInt(moment().format("YY"));return r.ExpirationYear<n?(e.showLoader=!1,void swal("Error","Invalid Date","error")):r.ExpirationYear==n&&r.ExpirationMonth<moment().month()+1?(e.showLoader=!1,void swal("Error","Invalid Date","error")):(r.DefaultCard=!1,r.Type=E(r.CardNumber),m&&(r.PassengerId=m),p&&(r.ClientId=p),u&&(r.DriverId=u),void o.post(i.API_ENDPOINT+"api/Payments/addcard",r).then(function(r){swal({title:"Card Saved",text:"Changes have been updated.",type:"success",confirmButtonColor:a.COLOURS.brandSecondary}),t.close(r.data.Card),e.showLoader=!1},function(a){void 0!=a.data&&void 0!=a.data.Message?swal("Error",a.data.Message,"error"):swal("Error","Something didn't work, please try again","error"),e.showLoader=!1}))}function E(e){var a=new RegExp("^4");return null!=e.match(a)?"visa":/^(5[1-5][0-9]{14}|2(22[1-9][0-9]{12}|2[3-9][0-9]{13}|[3-6][0-9]{14}|7[0-1][0-9]{13}|720[0-9]{12}))$/.test(e)?"mastercard":/^(5[1-5]\d{2})[\s\-]?(\d{4})[\s\-]?(\d{4})[\s\-]?(\d{4})$/.test(e)?"mastercard":(a=new RegExp("^3[47]"),null!=e.match(a)?"amex":(a=new RegExp("^(6011|622(12[6-9]|1[3-9][0-9]|[2-8][0-9]{2}|9[0-1][0-9]|92[0-5]|64[4-9])|65)"),null!=e.match(a)?"discover":(a=new RegExp("^36"),null!=e.match(a)?"diners":(a=new RegExp("^30[0-5]"),null!=e.match(a)?"diners-carteblanche":(a=new RegExp("^35(2[89]|[3-8][0-9])"),null!=e.match(a)?"jcb":(a=new RegExp("^(4026|417500|4508|4844|491(3|7))"),null!=e.match(a)?"visaelectron":(a=new RegExp("^(40117[8-9]|431274|438935|451416|457393|45763[1-2]|506(699|7[0-6][0-9]|77[0-8])|509d{3}|504175|627780|636297|636368|65003[1-3]|6500(3[5-9]|4[0-9]|5[0-1])|6504(0[5-9]|[1-3][0-9])|650(4[8-9][0-9]|5[0-2][0-9]|53[0-8])|6505(4[1-9]|[5-8][0-9]|9[0-8])|6507(0[0-9]|1[0-8])|65072[0-7]|6509(0[1-9]|1[0-9]|20)|6516(5[2-9]|[6-7][0-9])|6550([0-1][0-9]|2[1-9]|[3-4][0-9]|5[0-8]))"),null!=e.match(a)?"elo":(a=new RegExp("^(5018|5020|5038|6304|6759|6761|6763)[0-9]{8,15}$"),null!=e.match(a)?"maestro":""))))))))}e.addCard=w,e.showLoader=!1;var x;e.card=new d.PaymentCard,setTimeout(function(){h()},0)}var r=e.module("cab9.common");r.controller("AddPaymentCardController",a),a.$inject=["$scope","$UI","$modal","$modalInstance","$state","$http","Model","$config","$stateParams","$q","CSV","rPassengerId","rClientId","rDriverId"]}(angular);;;;
!function(e){function n(e,n,t,a,r,s,o,c,i,l,d){function u(n){n&&(e.loadingClients=!0,d.get(s.API_ENDPOINT+"api/Clients/Search",{params:{searchText:n,lite:!0}}).then(function(n){e.clients=[];for(var t=0;t<n.data.length;t++){var a=n.data[t];e.clients.push({Id:a.Id,Name:"("+a.AccountNo+") "+a.Name,Description:a.ClientType&&a.ClientType.Name?a.ClientType.Name:""})}e.loadingClients=!1}))}function p(e){o.close(e)}function g(){e.saving=!0;var t=[];t.push(e.passenger.$save()),r.all(t).then(function(e){swal({title:"Passenger Saved.",text:"New Passenger has been added.",type:"success",confirmButtonColor:a.COLOURS.brandSecondary}),o.close(e[0].data),i&&n.go("root.passengers.viewer.dashboard",{Id:e[0].data.Id})},function(){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:a.COLOURS.brandSecondary})})}e.showClients=!0,e.passenger=new t.Passenger,e.saveEdits=g,e.duplicates=[],e.useExisting=p,e.searchClients=u,c?(e.showClients=!1,e.passenger.ClientId=c):e.clients=[];var f=null;e.$watch("passenger",function(){f&&(l.cancel(f),f=null),e.duplicates=[],(e.passenger.Firstname||e.passenger.Surname||e.passenger.Phone||e.passenger.Mobile||e.passenger.Email)&&(f=l(function(){d.post(s.API_ENDPOINT+"api/client/duplicates",e.passenger).then(function(n){e.duplicates=n.data})},500))},!0)}function t(e,n,t,a,r,s,o,c,i,l,d){function u(){var n=new t.Note;n.OwnerType="Passenger",n.OwnerId=e.passenger.Id,n.Content=e["new"].Note,n.$save().then(function(n){e.notes.push(n.data),swal({title:"Note Saved.",text:"The note has been saved.",type:"success",confirmButtonColor:a.COLOURS.brandSecondary})},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error"})})}function p(){e.passenger.$patch().then(function(e){o.close(e.data)},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:a.COLOURS.brandSecondary})})}function g(e){var n=null,t=d.filter(function(n){return n.Id==e})[0];return t?t.Name:n}e.passenger=c[0],e.saveEdits=p,e.showClients=!1,e.edit=!0,e.notes=i,e.getUserName=g,e.addNote=u,e["new"]={Note:""}}var a=e.module("cab9.common");a.controller("PassengerItemCreateModalController",n),a.controller("PassengerItemEditModalController",t),n.$inject=["$scope","$state","Model","$UI","$q","$config","$modalInstance","rClientId","rNavigateAfterSave","$timeout","$http"],t.$inject=["$scope","$state","Model","$UI","$q","$config","$modalInstance","rPassenger","rNotes","rStaff","rUsers"]}(angular);;;;
!function(e){function t(e,t,o,r,n,a,l,i,c){function s(e){for(var t="abcdefghijklmnopqrstuvwxyz",o="ABCDEFGHIJKLMNOPQRSTUVWXYZ",r="1234567890",n=t+o+r,a="",l=0;l<e;l++)a+=n.charAt(Math.floor(62*Math.random()));a+=o.charAt(Math.floor(26*Math.random())),a+=t.charAt(Math.floor(26*Math.random())),a+=r.charAt(Math.floor(10*Math.random()));var i=a.split("").sort(function(){return.5-Math.random()}).join("");return i}function d(t){t&&t.length>2?e.fetchedClients=l("filter")(e.clients,{Name:t}):e.fetchedClients=[]}function f(t){t&&t.length>2?e.fetchedBookers=l("filter")(e.bookers,{Firstname:t}):e.fetchedBookers=[]}function h(){e.webbooker.TenantId=n.getSession().TenantId.toUpperCase(),e.webbooker.BrandColors.Light=i.COLOURS.light,e.webbooker.BrandColors.Dark=i.COLOURS.dark,e.webbooker.BrandColors.Grey=i.COLOURS.grey,e.webbooker.RequestUrl=t.API_ENDPOINT,o.post(t.WEBBOOKER_ENDPOINT+"api/tenant",e.webbooker).then(function(e){swal({title:"Saved",text:"Web Booker Settings have been saved",type:"success",confirmButtonColor:i.COLOURS.brandSecondary}),c.close(e.data)},function(e){swal({title:"Error",text:e.data?e.data:"Error occurred while saving WebBooker Data",type:"error",confirmButtonColor:i.COLOURS.brandSecondary})})}e.webbooker={},e.webbooker.SecretKey=s(16),e.fetchedClients=[],e.fetchedBookers=[],e.searchClients=d,e.searchBookers=f,e.save=h,e.clients=[],e.bookers=[],e.templates=[],o.get(t.WEBBOOKER_ENDPOINT+"getTemplates").then(function(t){e.templates=t.data},function(){swal({title:"Error",text:"Error occurred while fetching WebBooker Templates",type:"error",confirmButtonColor:i.COLOURS.brandSecondary})}),a.Client.query().select("Id,Name,ImageUrl").orderBy("Name").trackingEnabled().execute().then(function(t){e.clients=t}),e.$watch("webbooker",function(t,o){t&&t.DefaultClientId&&t.DefaultClientId!==o.DefaultClientId&&a.ClientStaff.query().filter("ClientId eq guid'"+t.DefaultClientId+"'").select("Id,Active,Firstname, Surname, Phone,ClientStaffRole/Name").include("ClientStaffRole").orderBy("Firstname").execute().then(function(t){e.bookers=t})},!0)}var o=e.module("cab9.common");o.controller("CreateWebBookerController",t),t.$inject=["$scope","$config","$http","$q","Auth","Model","$filter","$UI","$modalInstance"]}(angular);;;;
!function(e){function s(e,s,d){function o(){e.address.StopSummary=window.$utilities.formatAddress(e.address),s.close(e.address)}e.address=d,e.address.StopSummary="",e.displayMode="CREATE",e.save=o}var d=e.module("cab9.common");d.controller("WebBookerAddressCreateController",s),s.$inject=["$scope","$modalInstance","rAddress"]}(angular);;;;
!function(d){function e(d,e,s){function o(){d.address.StopSummary=window.$utilities.formatAddress(d.address),e.close({address:d.address,editIndex:s.editIndex})}d.address=s.address,d.save=o,d.displayMode="EDIT"}var s=d.module("cab9.common");s.controller("WebBookerAddressEditController",e),e.$inject=["$scope","$modalInstance","rAddress"]}(angular);;;;
!function(e){function s(e,s,r,n,d,t,o,l,a){function c(s){var r=e.addresses.indexOf(s),d=n.open({templateUrl:"/webapp/common/modals/address/modal.html",controller:"AddressEditController",resolve:{rAddress:function(){return new o.PassengerAddress(s)}}});d.result.then(function(s){e.addresses[r]=new o.PassengerAddress(s)},function(){})}function i(){var s=n.open({templateUrl:"/webapp/common/modals/address/modal.html",controller:"AddressCreateController",size:"lg",resolve:{rAddress:function(){var e=new o.PassengerAddress;return e.PassengerId=d.Id,e}}});s.result.then(function(s){e.addresses.push(new o.PassengerAddress(s))},function(){})}function u(s){swal({title:"Are you sure?",text:"Address will be deleted",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, delete it!",closeOnConfirm:!1},function(){var r=e.addresses.indexOf(s);new o.PassengerAddress(s).$delete().then(function(s){swal({title:"Address Deleted.",text:"Address has been deleted.",type:"success",confirmButtonColor:a.COLOURS.brandSecondary}),e.addresses.splice(r,1)})},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:a.COLOURS.brandSecondary})})}e.addresses=s,e.displayMode="VIEW",e.newAddress=i,e.editAddress=c,e.deleteAddress=u}var r=e.module("cab9.common");r.controller("PassengerItemAddressesController",s),s.$inject=["$scope","rAddresses","$state","$modal","$stateParams","$q","Model","$config","$UI"]}(angular);;;;
!function(e){function r(e,r,o,d,s,t,a,n){function c(){var r=[];e.address.StopSummary=window.$utilities.formatAddress(e.address),r.push(e.address.$save()),s.all(r).then(function(e){swal({title:"Address Saved.",text:"New Address has been added.",type:"success",confirmButtonColor:d.COLOURS.brandSecondary}),n.close(e[0].data)},function(){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:d.COLOURS.brandSecondary})})}e.address=a,e.save=c,e.displayMode="CREATE"}var o=e.module("cab9.common");o.controller("AddressCreateController",r),r.$inject=["$scope","$state","Model","$UI","$q","$config","rAddress","$modalInstance"]}(angular);;;;
!function(e){function o(e,o,r,t,d,a,s,n){function c(){var o=[];e.address.StopSummary=window.$utilities.formatAddress(e.address),o.push(e.address.$patch()),d.all(o).then(function(e){swal({title:"Address Saved.",text:"Changes have been updated",type:"success",confirmButtonColor:t.COLOURS.brandSecondary}),n.close(e[0].data)},function(){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:t.COLOURS.brandSecondary})})}e.address=s,e.save=c,e.displayMode="EDIT"}var r=e.module("cab9.common");r.controller("AddressEditController",o),o.$inject=["$scope","$state","Model","$UI","$q","$config","rAddress","$modalInstance"]}(angular);;;;
!function(o){function n(o,n,e){o.item=e,o.fetchingBreakdown=!0,n.get($config.API_ENDPOINT+"api/driverpayments/breakdown?bookingId="+o.item.Booking.Id).then(function(n){if(o.fetchingBreakdown=!1,o.item.$breakDown=n.data,"Mileage"==o.item.$breakDown.PaymentModelUsed.Type)for(o.item.$breakDown.$totalCommission=0,i=0,len=o.item.$breakDown.Workings.length;i<len;i++)o.item.$breakDown.$totalCommission+=o.item.$breakDown.Workings[i].Cost},function(n){o.fetchingBreakdown=!1,o.error=n})}var e=o.module("cab9.common");e.controller("BookingDriverPaymentCalculationController",n),n.$inject=["$scope","$http","rBooking"]}(angular);;;;
!function(e){function t(t,i,n,o,r,s,a,d,u,l,m,g,c,f,p,k,h,I,B){function v(){"EDIT"==t.viewMode&&(t.item.ChauffeurMode=!0,t.item.EstimatedMins=60)}function T(){"EDIT"==t.viewMode&&(t.item.ChauffeurMode=!1,t.item.EstimatedMins=null)}function D(i){var n=10,o=(i-1)*n;r.get(s.API_ENDPOINT+"api/Audit/ForBooking",{params:{bookingId:t.item.Id,top:n,skip:o}}).success(function(o){1==i&&0==o.length&&(t.noHistory=!0),(o.length<n||"Booking Created"==o[o.length-1].BookingEvent)&&(t.noMoreHistory=!0),e.forEach(o,function(e){var i=moment(e.Timestamp).format("DD MMM");t.events[i]||(t.events[i]=[]),t.events[i].push(new u.AuditRecord(e))})})}function S(){t.historyPage++,D(t.historyPage)}function P(e){var i=h.timeZone().getTimeZone()||"Europe/London",n=moment(e).toDate(),o=n.getTimezoneOffset(),r=moment.tz.zone(i).offset(n),s=new moment.tz(e,i).add(o-r,"minutes");t.item.FlightInfo?t.item.Date=new moment(t.item.FlightInfo.ScheduledArrivalTime).toDate():t.item.Date=s.toDate(),t.item.Time=s.toDate()}function C(i){e.forEach(i,function(e){var i=t.unlinkedTags.find(function(t){return t.Id==e.TagId});i&&(i.Type=e.Type),t.Tags.push(i),t.unlinkedTags.splice(t.unlinkedTags.indexOf(i),1)})}function E(e){var i=t.Tags.find(function(t){return t.Id==e.Id});if(!i){t.Tags.push(e);var n=t.unlinkedTags.find(function(t){return t.Id==e.Id});if(n){var o={BookingId:t.item.Id,TagId:e.Id,Type:e.Type};t.item.BookingTags.push(o),t.unlinkedTags.splice(t.unlinkedTags.indexOf(n),1)}t.item.$selectedTag=null}}function y(e){t.unlinkedTags.push(e);var i=t.Tags.find(function(t){return t.Id==e.Id});i&&(t.Tags.splice(t.Tags.indexOf(i),1),t.item.BookingTags=t.item.BookingTags.filter(function(e){return e.TagId!=i.Id})),t.item.$selectedTag=null}function b(){t.item.FlightInfo=null,t.item.FlightInfoId=null,t.flightData.Number=null}function w(e){t.item.BookingRequirements.push(e);var i=t.unlinkedRequirements.filter(function(t){return t.Id==e.Id});i[0]&&t.unlinkedRequirements.splice(t.unlinkedRequirements.indexOf(i[0]),1),t.item.$selectedRequirement=null}function A(e,t,i){function n(e,t){var i="000000000"+e;return i.substr(i.length-t)}var o=e.getFullYear(),r=e.getMonth(),s=e.getDate(),a=t.getHours(),d=t.getMinutes(),u=n(o,4)+"-"+n(r+1,2)+"-"+n(s,2)+"T"+n(a,2)+":"+n(d,2)+":00",l=moment.tz(u,"YYYY-MM-DDTHH:mm:ss",h.timeZone().getTimeZone()).subtract(i||0,"minutes").format();return l}function x(){t.flightData.Number.length>0?r({url:s.API_ENDPOINT+"/api/flightinfo/getflightinfo",method:"GET",params:{flightno:t.flightData.Number,flightDate:A(t.item.Date,t.item.Time)}}).then(function(e){if(e.data){if(e.data.Id=null,e.data.BookingId=null,e.data.TenantId=null,e.data.MinsAfterLanding=t.flightData.MinsAfterLanding,t.item.FlightInfo=new u.FlightInfo(e.data),"Completed"!==t.item.BookingStatus&&"Cancelled"!==t.item.BookingStatus&&"COA"!==t.item.BookingStatus){var i=h.timeZone().getTimeZone()||"Europe/London",n=moment(t.item.FlightInfo.ArrivalTime).toDate(),o=n.getTimezoneOffset(),r=moment.tz.zone(i).offset(n),s=new moment.tz(t.item.FlightInfo.ArrivalTime,i).add(o-r,"minutes");if(t.flightData.DateTime=s,t.item.Time=s.toDate(),t.timeSet=!0,e.data.SuggestedAddressId&&t.item.BookingStops[0].$$Id!=e.data.SuggestedAddressId){var a=e.data.SuggestedAddressId;u.Location.query().where("Id eq guid'"+e.data.SuggestedAddressId+"'").execute().then(function(e){var i=new u.BookingStop;i.Address1=e[0].Name?e[0].Name:"",i.StopSummary=e[0].Name?e[0].Name:"",i.Latitude=e[0].Latitude?e[0].Latitude:null,i.Longitude=e[0].Longitude?e[0].Longitude:null,i.$$Id=a,i.WaitTime=t.item.BookingStops[0].WaitTime,center_moved=!1,t.item.BookingStops[0]=i})}}}else t.item.FlightInfo=null,swal("Flight Not Found","Please check flight number.","warning")},function(e){t.item.FlightInfo=null,swal("Incorrect Flight Number","Please check flight number.","warning")}):(t.item.FlightInfo=null,swal("Incorrect Flight Number","Please check flight number.","warning"))}function N(e){var t=c.filter(function(t){return t.Id==e})[0];if(t)return t.Name}function L(e){var t=g.filter(function(t){return t.Id==e})[0];if(t)return t._TaxRate}function R(){t.expenses.adding=new u.BookingExpense}function O(e){t.expenses.editing=e}function q(e){var i=t.item.BookingExpense.indexOf(e);t.item.BookingExpense.splice(i,1)}function F(){t.expenses.editing=null}function M(){t.expenses.editing.$rollback(),t.expenses.editing=null}function _(){t.expenses.adding.BookingId=t.item.Id,t.item.BookingExpense.push(t.expenses.adding),t.expenses.adding=null}function V(){t.expenses.adding=null}function U(e){t.unlinkedRequirements.push(e);var i=t.item.BookingRequirements.filter(function(t){return t.Id==e.Id});i[0]&&t.item.BookingRequirements.splice(t.item.BookingRequirements.indexOf(i[0]),1)}function Q(e,t){t?r({method:"GET",url:s.API_ENDPOINT+"/api/ClientReferences/suggest?ClientReferenceId="+e.Id+"&Value="+t}).then(function(t){e.$suggested=t.data.map(function(e){return{custom:!1,text:e}}),e.$originalValue&&e.$suggested.unshift(e.$originalValue),e.AllowAddToList&&e.$suggested.push({custom:!0,text:"Add '{{$select.search}}' to References"})},function(t){e.$suggested=[e.$originalValue]}):e.$suggested=[e.$originalValue]}function W(e){for(var t="[a-z]",i="[A-Z]",n="[0-9]",o="^",r=0,s=!1,a=!1,d=0;d<e.length;d++){var u=e[d];if("'"===u)o+=a?")":"(",a=!a;else if(a)["."].indexOf(u)!=-1&&(u="\\"+u),o+=u;else if(">"===u){if(r++,r>1)throw"Bad Mask - Case blocks have consecutive > without ending previous block"}else if("<"===u){if(r--,r<-1)throw"Bad Mask - Case blocks have consecutive < without ending previous block"}else"0"===u?(s=!0,o+="("+n+")"):"9"===u?o+="("+n+"?)":1===r?"A"===u?(s=!0,o+="("+i+"|"+n+")"):"a"===u?o+="("+i+"?|"+n+"?)":"L"===u?(s=!0,o+="("+i+")"):"l"===u&&(o+="("+i+"?)"):0===r?"A"===u?(s=!0,o+="("+t+"|"+i+"|"+n+")"):"a"===u?o+="("+t+"?|"+i+"?|"+n+"?)":"L"===u?(s=!0,o+="("+t+"|"+i+")"):"l"===u&&(o+="("+t+"?|"+i+"?)"):r===-1&&("A"===u?(s=!0,o+="("+t+"|"+n+")"):"a"===u?o+="("+t+"?|"+n+"?)":"L"===u?(s=!0,o+="("+t+")"):"l"===u&&(o+="("+t+"?)"))}if(a)throw"Bad Mask - Quoted section not terminated";if(!s)throw"Bad Mask - Must contain at least 1 mandatory symbol (A, L, 0)";return o+="$",new RegExp(o)}function z(){if(t.clientReferences.length>0)for(var e=0;e<t.clientReferences.length;e++){var i=t.clientReferences[e];if("Mask"==i.ReferenceType)return!(i.$testReg.test(i.$knownValue)||!(i.$knownValue||i.Mandatory&&i.Active))}return!1}function G(){window.close()}function H(){var e=t.item.BookingStops[0];t.item.BookingStops[0]=t.item.BookingStops[1],t.item.BookingStops[1]=e}function Z(i){t.passengers.length=0,r.get(s.API_ENDPOINT+"api/Passengers/Search",{params:{searchText:i,clientId:t.item.ClientId}}).success(function(i){e.forEach(i,function(e){e.Client&&(e.Client.ImageUrl=$utilities.formatUrl(e.Client.ImageUrl,e.Client.Name)),t.passengers.push({Id:e.Id,ClientId:e.ClientId,Name:e.Firstname+" "+e.Surname,Description:e.Client&&e.Client.Name?e.Client.Name:"No Client",Mobile:e.Mobile,Addresses:e.Addresses,ImageUrl:$utilities.formatUrl(e.ImageUrl,e.Firstname)})}),t.passengers.push({Id:"add-passenger",Name:"Add Passenger",Description:"Create New Passenger",ImageUrl:"/includes/images/add-icon.png"})})}function Y(i){t.item.ClientId&&(t.bookers.length=0,r.get(s.API_ENDPOINT+"api/Bookers/Search",{params:{searchText:i,clientId:t.item.ClientId}}).success(function(i){e.forEach(i,function(e){e.Client&&(e.Client.ImageUrl=$utilities.formatUrl(e.Client.ImageUrl,e.Client.Name)),t.bookers.push({Id:e.Id,ClientId:e.ClientId,Name:e.Firstname+" "+e.Surname,Description:e.Client&&e.Client.Name?e.Client.Name:"No Client",Mobile:e.Mobile,ImageUrl:$utilities.formatUrl(e.ImageUrl,e.Firstname)})}),t.bookers.push({Id:"add-booker",Name:"Add Booker",Description:"Create New Booker",ImageUrl:"/includes/images/add-icon.png"})}))}function j(e){if("VIEW"!=t.viewMode){t.quoting.inprogress=!0,e.BookedDateTime=A(t.item.Date,t.item.Time);for(var i=0;i<t.item.BookingStops.length;i++)t.item.BookingStops[i].StopOrder=i+1;re=!0,r.post(s.API_ENDPOINT+"api/quote",e).success(function(i){re=!1,t.quote=i,i.Error?e.OneTransportReference||e.CityFleetReference||(t.directions=null,"Client"==t.mode&&(e.ActualCost=null)):e.OneTransportReference||e.CityFleetReference||(e.EstimatedCost=i.FinalCost,e.EstimatedDistance=i.EstimatedDistance.toFixed(2),e.EstimatedDuration=i.EstimatedMins,e.WaitingCost=i.WaitingCharge,"Client"==t.mode&&(e.ActualCost=i.FinalCost),t.directions=i.Directions,i.Directions?e.EncodedRoute=i.Directions.EncodedRoute:e.EncodedRoute="",e._AutoDispatchOffset=Math.max(15,i.DispatchOffset||15)),t.quoting.inprogress=!1}).error(function(e){t.quoting.inprogress=!1,swal("Could not quote","Could not quote, please manually price and set driver payment amount for this booking.","warning"),re=!1})}}function K(){t.item.ActualCost=t.quote.FinalCost}function X(){t.item.Coupon=t.item.$Coupon,j(t.item)}function J(e){t.item.WaitAndReturn&&t.item.BookingStops.length<4?swal("Cannot remove via Stop","WaitAndReturn booking should have a via stop","warning"):t.item.BookingStops.splice(e,1),t.item.BookingStops.length<3&&(t.sortableOptions.disabled=!0)}function ee(e){var i=new u.BookingStop;i.id=idCounter++,t.item.WaitAndReturn?t.item.BookingStops.splice(e,0,i):t.item.BookingStops.splice(e+1,0,i),t.item.BookingStops.length>2&&(t.sortableOptions.disabled=!1)}function te(e,i){var n=h.timeZone().getTimeZone(),o=(new Date).getTimezoneOffset(),r=moment.tz.zone(n).offset(new Date),s=new moment.tz(n).add(o-r,"minutes");"day"==i?t.item.Date=s.add(e,"minutes").toDate():"time"==i&&(t.item.Time=s.startOf("minute").add(e,"minutes").toDate())}function ie(){t.item.BookingStops.reverse()}function ne(){if($("#bookingsave").prop("disabled",!0),t.item.FlightInfo){t.item.FlightInfo.MinsAfterLanding=t.flightData.MinsAfterLanding;var n=t.flightData.GetDate().toDate();t.item.BookedDateTime=A(n,n)}else t.item.BookedDateTime=A(t.item.Date,t.item.Time);t.item.AutoDispatch&&(t.item.DispatchDateTime=A(t.item.Date,t.item.Time,t.item._AutoDispatchOffset)),t.item.AsDirected&&(t.item.BookingStops=[t.item.BookingStops[0]]);var o=e.copy(t.item);if(o.Currency=void 0,o.Client=void 0,o.Time=void 0,o.Vehicle=void 0,o.Driver=void 0,o.LeadPassenger=void 0,o.VehicleType=void 0,o.BookingValidations=[],t.clientReferences.length>0)for(var a=0;a<t.clientReferences.length;a++){var d=t.clientReferences[a],l=new u.BookingValidation;l.ClientReferenceId=d.Id,l.BookingId=o.Id,l.Id=d.$id,"List"==d.ReferenceType?l.Value=d.$knownValue&&d.$knownValue.text:l.Value=d.$knownValue,l.Value&&o.BookingValidations.push(l)}e.forEach(o.BookingStops,function(e,i){e.BookingId=t.item.Id,e.Id=ae[i],e.StopOrder=i+1}),o.BookingTags.map(function(e){var i=t.Tags.find(function(t){return t.Id==e.TagId});return i&&(e.Type=i.Type),e}),t.lock.saved=!0,r.put(s.API_ENDPOINT+"api/bookings",o,{params:{Id:o.Id}}).then(function(e){swal({title:"Booking Updated",text:"Changes have been updated.",type:"success",confirmButtonColor:i.COLOURS.brandSecondary});var n=[];n.push("(EntityType eq 'Booking' and EntityId eq guid'"+t.item.Id+"')"),n.push("(BookingId eq guid'"+t.item.Id+"')");for(var o=0;o<t.item.BookingStops.length;o++){var a=t.item.BookingStops[o];n.push("(EntityType eq 'BookingStop' and EntityId eq guid'"+a.Id+"')")}t.events={},D(1),t.viewMode="VIEW",t.lock.current=null,r.get(s.API_ENDPOINT+"api/DriverPayments/breakdown",{params:{bookingId:t.item.Id}}).success(function(e){t.driverPayment=e,$("#bookingsave").prop("disabled",!1)})},function(e){t.lock.saved=!0,swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:i.COLOURS.brandSecondary})})}if(t.item=l[0],t.item.BookingStops=t.item.BookingStops.sort(function(e,t){return e.StopOrder-t.StopOrder}),t.bookingTags=t.unlinkedTags=B,t.Tags=[],C(t.item.BookingTags),t.item.Priority){var oe=["P1","P2","P3","P4","P5"].indexOf("P"+t.item.Priority)+1;t.item.Priority=oe.toFixed(0)}else t.item.Priority="P1";r.get(s.API_ENDPOINT+"api/DispatchSettings").then(function(e){e.data[0]&&(t.dispatchSettings=e.data[0])}),t.item.DispatchDateTime?t.item._AutoDispatchOffset=moment(t.item.BookedDateTime).diff(moment(t.item.DispatchDateTime),"minutes"):t.item._AutoDispatchOffset=15,t.mode=m,t.showInactiveReferences=!1;var re=!1;t.lock={current:null},t.quoting={},t.events={},t.noHistory=!1,t.noMoreHistory=!1,t.historyPage=1,t.fetchMoreHistory=S,t.enableChauffering=v,t.disableChauffering=T,t.updateCost=K,t.applyCoupon=X,t.iconsIndex={"N/A":"assignment","Booking Offer Sent":"assignment","Booking Created":"assignment",FlightTrackingStarted:"flight_land",FlightTrackingStopped:"flight_land","SMS Confirmation":"insert_comment","Email Client Confirmation":"email","Email Booker Confirmation":"email","SMS Driver Arrived":"insert_comment","Call Driver Arrived":"phone","Email Manual Confirmation":"email","Driver Read Offer":"person_pin","Driver Accepted":"person_pin",DriverUpdate:"person_pin","Driver Rejected":"person_pin","Driver Allocated":"person_pin","Booking Offered To Driver":"person_pin","Booking Pre Allocated To Driver":"person_pin","Booking Patched":"assignment","Booking Edited":"assignment",DriverPaymentIssued:"account_balance_wallet",DriverPaymentGenerated:"account_balance_wallet",DriverPaymentCancelled:"account_balance_wallet",ClientInvoiceIssued:"check_circle",ClientInvoiceCancelled:"check_circle","Flight Update":"flight_land",Repricing:"border_color"},t.coloursIndex={"N/A":"orange-bg","Booking Offer Sent":"green-bg","Booking Created":"green-bg",FlightTrackingStarted:"green-bg",FlightTrackingStopped:"red-bg","SMS Confirmation":"green-bg","Email Client Confirmation":"green-bg","Email Booker Confirmation":"green-bg","SMS Driver Arrived":"green-bg","Call Driver Arrived":"green-bg","Email Manual Confirmation":"orange-bg","Driver Read Offer":"green-bg","Driver Accepted":"green-bg",DriverUpdate:"green-bg","Driver Rejected":"orange-bg","Driver Allocated":"green-bg","Booking Offered To Driver":"green-bg","Booking Pre Allocated To Driver":"green-bg","Booking Patched":"orange-bg","Booking Edited":"orange-bg",DriverPaymentIssued:"green-bg",DriverPaymentGenerated:"green-bg",DriverPaymentCancelled:"red-bg",ClientInvoiceIssued:"green-bg",ClientInvoiceCancelled:"red-bg","Flight Update":"orange-bg",Repricing:"orange-bg"},t.item.BookingExpense=t.item.BookingExpense.map(function(e){return new u.BookingExpense(e)}),D(1);var se=d.getSession(),ae=t.item.BookingStops.map(function(e){return e.Id});r.get(s.API_ENDPOINT+"api/bookings/IsLocked",{params:{bookingId:t.item.Id}}).success(function(e){"LockOwned"==e.status?(t.viewMode="EDIT",t.lock.current={self:!0,expires:e.expires}):"Locked"==e.status?t.lock.current={self:!1,user:e.user,expires:e.expires}:t.lock.current=null}).error(function(){swal("Error!","Unknown error occured.","error")}),t.$on("SIGNALR_updateBooking",function(e,i){var n=i[0];t.item.BookingStatus=n.BookingStatus,t.$apply()}),t.$on("SIGNALR_lockCleared",function(e,i){var n=i[0];t.lock.saved?(t.lock.saved=!1,t.lock.current=null):n.BookingId==t.item.Id&&(t.lock.current=null,"EDIT"==t.viewMode?(t.viewMode="VIEW",swal("Lock Expired!","Booking Lock has expired.","error"),u.Booking.query().include("Driver,Client,Vehicle,FlightInfo,BookingStops,Invoice,BookingStops/PassengerStops,Passengers,BookingValidations,LeadPassenger,Currency,BookingRequirements,BookingExpense,BookingExpense/BookingExpenseType,BookingExpense/Tax").where("Id eq guid'"+t.item.Id+"'").trackingEnabled().execute().then(function(e){if(t.item=e[0],t.item.BookingStops=t.item.BookingStops.sort(function(e,t){return e.StopOrder-t.StopOrder}),t.item.BookingExpense=t.item.BookingExpense.map(function(e){return new u.BookingExpense(e)}),P(t.item.BookedDateTime),t.item.FlightInfo&&(t.flightData.Number=t.item.FlightInfo.FlightNumber),t.item.Priority){var i=["P1","P2","P3","P4","P5"].indexOf("P"+t.item.Priority)+1;t.item.Priority=i.toFixed(0)}else t.item.Priority="P1";t.item.DispatchDateTime?t.item._AutoDispatchOffset=moment(t.item.BookedDateTime).diff(moment(t.item.DispatchDateTime),"minutes"):t.item._AutoDispatchOffset=15})):u.Booking.query().include("Driver,Client,Vehicle,FlightInfo,BookingStops,Invoice,BookingStops/PassengerStops,Passengers,BookingValidations,LeadPassenger,Currency,BookingRequirements,BookingExpense,BookingExpense/BookingExpenseType,BookingExpense/Tax").where("Id eq guid'"+t.item.Id+"'").trackingEnabled().execute().then(function(e){if(t.item=e[0],t.item.BookingStops=t.item.BookingStops.sort(function(e,t){return e.StopOrder-t.StopOrder}),t.item.BookingExpense=t.item.BookingExpense.map(function(e){return new u.BookingExpense(e)}),P(t.item.BookedDateTime),t.item.FlightInfo&&(t.flightData.Number=t.item.FlightInfo.FlightNumber),t.item.Priority){var i=["P1","P2","P3","P4","P5"].indexOf("P"+t.item.Priority)+1;t.item.Priority=i.toFixed(0)}else t.item.Priority="P1";t.item.DispatchDateTime?t.item._AutoDispatchOffset=moment(t.item.BookedDateTime).diff(moment(t.item.DispatchDateTime),"minutes"):t.item._AutoDispatchOffset=15})),t.$apply()}),t.$on("SIGNALR_bookingLocked",function(e,i){var n=i[0];n.BookingId==t.item.Id&&(n.UserId==se.UserId?t.lock.current={self:!0,expires:n.LockTime}:t.lock.current={self:!1,user:n.User.Name,expires:n.LockTime}),t.$apply()}),t.startEditing=function(){r.get(s.API_ENDPOINT+"api/bookings/RequestLock",{params:{bookingId:t.item.Id}}).success(function(e){"LockGranted"==e.status?u.Booking.query().include("Driver,Client,Vehicle,FlightInfo,BookingStops,Invoice,BookingStops/PassengerStops,Passengers,BookingValidations,BookingTags,LeadPassenger,Currency,BookingRequirements,BookingExpense,BookingExpense/BookingExpenseType,BookingExpense/Tax").where("Id eq guid'"+t.item.Id+"'").trackingEnabled().execute().then(function(e){if(t.item=e[0],t.item.$Coupon=t.item.Coupon,t.item.BookingStops=t.item.BookingStops.sort(function(e,t){return e.StopOrder-t.StopOrder}),t.item.BookingExpense=t.item.BookingExpense.map(function(e){return new u.BookingExpense(e)}),P(t.item.BookedDateTime),t.item.FlightInfo&&(t.flightData.Number=t.item.FlightInfo.FlightNumber),t.item.Priority){var i=["P1","P2","P3","P4","P5"].indexOf("P"+t.item.Priority)+1;t.item.Priority=i.toFixed(0)}else t.item.Priority="P1";t.item.DispatchDateTime?t.item._AutoDispatchOffset=moment(t.item.BookedDateTime).diff(moment(t.item.DispatchDateTime),"minutes"):t.item._AutoDispatchOffset=15,t.viewMode="EDIT"}):swal("Booking Locked!","This booking is currently being edited by: "+e.user,"error")}).error(function(){swal("Error!","Unknown error occured.","error")})},t.cancelEditing=function(){t.lock.saved=!0,t.expenses.editing&&M(),t.expenses.adding&&V(),r.get(s.API_ENDPOINT+"api/bookings/RemoveLock",{params:{bookingId:t.item.Id}}).success(function(i){var n=e.copy(t.Tags);u.Booking.query().include("Driver,Client,Vehicle,FlightInfo,BookingStops,Invoice,BookingStops/PassengerStops,Passengers,BookingValidations,LeadPassenger,Currency,BookingRequirements,BookingTags,BookingExpense,BookingExpense/BookingExpenseType,BookingExpense/Tax").where("Id eq guid'"+t.item.Id+"'").trackingEnabled().execute().then(function(e){if(t.item=e[0],t.item.BookingStops=t.item.BookingStops.sort(function(e,t){return e.StopOrder-t.StopOrder}),t.item.BookingExpense=t.item.BookingExpense.map(function(e){return new u.BookingExpense(e)}),t.item.Tags=n,t.viewMode="VIEW",P(t.item.BookedDateTime),t.tags=n,t.item.FlightInfo&&(t.flightData.Number=t.item.FlightInfo.FlightNumber),t.item.Priority){var i=["P1","P2","P3","P4","P5"].indexOf("P"+t.item.Priority)+1;t.item.Priority=i.toFixed(0)}else t.item.Priority="P1";t.item.DispatchDateTime?t.item._AutoDispatchOffset=moment(t.item.BookedDateTime).diff(moment(t.item.DispatchDateTime),"minutes"):t.item._AutoDispatchOffset=15});var o=[];o.push("(EntityType eq 'Booking' and EntityId eq guid'"+t.item.Id+"')"),o.push("(BookingId eq guid'"+t.item.Id+"')");for(var r=0;r<t.item.BookingStops.length;r++){var s=t.item.BookingStops[r];o.push("(EntityType eq 'BookingStop' and EntityId eq guid'"+s.Id+"')")}}).error(function(){swal("Error!","Unknown error occured.","error")})},window.onbeforeunload=function(){t.lock.saved=!0;var e=new XMLHttpRequest;e.open("GET",s.API_ENDPOINT+"api/bookings/RemoveLock?bookingId="+t.item.Id,!1),e.setRequestHeader("Content-type","application/json"),e.setRequestHeader("Authorization","bearer "+d.getSession().access_token),e.send()},"true"==I.search().editnow&&t.startEditing(),t.canQuote=!0,t.item.BookingExpense=t.item.BookingExpense.map(function(e){return new u.BookingExpense(e)}),t.bookingInfo=!0,t.externalLocations={knownLocations:f[0]&&f[0].KnownLocations?f[0].KnownLocations:[],historic:[]},t.sortableOptions={stop:function(e,t){},ondragstart:function(e,t){},disabled:!(t.item.BookingStops.length>2)},t.bookers=[],t.save=ne,t.close=G,t.formFor={},t.testMaskReferences=z,t.reverseStops=ie,t.suggestReferences=Q,t.addRequirement=w,t.removeRequirement=U,t.clients=f,t.openInvoice=function(e){(window.opener||window).open("/webapp/management/index.html#/invoices/"+e,"_blank")},P(t.item.BookedDateTime),t.client=f[0],t.client&&(t.client.Name=t.client.AccountNo+" "+t.client.Name),t.clientReferences=[],t.booking=l,t.expenseTypes=c,t.taxes=g,t.searchBookers=Y,t.searchPassengers=Z,t.fetchFlightInformation=x,t.removeFlightInfo=b,t.expenses={editing:null},t.addTag=E,t.removeTag=y,t.flightData={Number:"",DateTime:null,MinsAfterLanding:0,GetDate:function(e){var t=this.DateTime&&new moment(this.DateTime).add(this.MinsAfterLanding||0,"minute");return e?t.format(e):t}},t.item.FlightInfo&&(t.flightData.Number=t.item.FlightInfo.FlightNumber,t.flightData.DateTime=new moment(t.item.FlightInfo.ScheduledArrivalTime),t.flightData.MinsAfterLanding=t.item.FlightInfo.MinsAfterLanding||0),t.driverPayment=null,r.get(s.API_ENDPOINT+"api/DriverPayments/breakdown",{params:{bookingId:t.item.Id}}).success(function(e){t.driverPayment=e}),f[0]&&e.forEach(f[0].ClientReferences,function(i){if(e.forEach(t.item.BookingValidations,function(e){if(i.Id==e.ClientReferenceId&&(i.$knownValue=e.Value,i.$id=e.Id,"List"==i.ReferenceType)){var t={custom:!1,text:e.Value};i.$knownValue=t,i.$originalValue=t,i.$suggested=[t]}}),"Mask"==i.ReferenceType&&(i.$testReg=W(i.Value)),"List"==i.ReferenceType&&i.ShowList){var n=i;r({method:"GET",url:s.API_ENDPOINT+"/api/ClientReferences/list?ClientReferenceId="+i.Id}).then(function(e){n.$list=e.data.map(function(e){return{custom:!1,text:e}}),n.AllowAddToList&&n.$list.push({custom:!0,text:"Add '{{$select.search}}' to References"})})}t.clientReferences.push(i)}),!t.client||t.client.AllVehicleTypeAccess?u.VehicleType.query().parseAs(function(e){this.Id=e.Id,this.Name=e.Name,this.Description=e.Description,this.IsDefault=e.IsDefault,this.Priority=e.Priority,this.Order=e.Order,this.IsDefault=e.IsDefault,this.ImageUrl=null}).execute().then(function(e){t.vehicleTypes=t.vehicleTypes=e.sort(function(e,t){return(e.Order||99)-(t.Order||99)})}):t.vehicleTypes=t.client.VehicleTypes.sort(function(e,t){return(e.Order||99)-(t.Order||99)}),u.BookingRequirement.query().execute().then(function(i){t.bookingRequirements=t.unlinkedRequirements=i,e.forEach(t.item.BookingRequirements,function(e){var i=t.unlinkedRequirements.filter(function(t){return t.Id==e.Id});i[0]&&t.unlinkedRequirements.splice(t.unlinkedRequirements.indexOf(i[0]),1)})}),t.$watch("item.Date",function(e,i){return t.dateSet?void(t.dateSet=!1):void(t.flightData.Number&&e&&e!=i&&x())}),t.addExpense=R,t.editExpense=O,t.removeExpense=q,t.saveEditedExpense=F,t.cancelEditedExpense=M,t.saveNewExpense=_,t.cancelNewExpense=V,t.getExpenseTypeName=N,t.getTaxName=L,t.flipAddress=H,t.passengers=p,t.passengers.push({Id:"add-passenger",Name:"Add Passenger",Description:"Create New Passenger",ImageUrl:"/includes/images/add-icon.png"}),t.bookers=k,t.bookers.push({Id:"add-booker",Name:"Add Booker",Description:"Create New Booker",ImageUrl:"/includes/images/add-icon.png"}),t.addTime=te,t.addStop=ee,t.removeStop=J,t.$watch("item.BookingStops[0]",function(i,n){if(void 0!==n&&i!==n&&t.item.WaitAndReturn){var o=new u.BookingStop(e.copy(t.item.BookingStops[0]));o.id=idCounter++,o.Id=null,o.WaitTime=null,t.item.BookingStops.splice(t.item.BookingStops.length-1,1,o)}},!0),t.$watch("item.WaitAndReturn",function(i,n){if(void 0!==n&&i!==n){if(i===!1)t.item.BookingStops.splice(t.item.BookingStops.length-1,1);else if(i===!0){var o=new u.BookingStop(e.copy(t.item.BookingStops[0]));o.id=idCounter++,o.Id=null,o.WaitTime=null,t.item.BookingStops.push(o)}t.canQuote=!0,t.item.AsDirected?t.canQuote=t.item.BookingStops[0].Latitude&&t.item.BookingStops[0].Longitude:e.forEach(t.item.BookingStops,function(e,i){e.Latitude&&e.Longitude||(t.canQuote=!1)})}}),t.$watch(function(){return(t.item.BookingStops||[]).map(function(e){return{Address1:e.Address1,Address2:e.Address2,Area:e.Area,TownCity:e.TownCity,Postcode:e.Postcode,Latitude:e.Latitude,Longitude:e.Longitude}})},function(i,n){if(void 0!==n){if(re)return void(re=!1);t.canQuote=!0,t.item.AsDirected?t.canQuote=t.item.BookingStops[0].Latitude&&t.item.BookingStops[0].Longitude:e.forEach(t.item.BookingStops,function(e,i){e.Latitude&&e.Longitude||(t.canQuote=!1)}),t.canQuote?j(t.item):(t.item.EstimatedCost=0,t.quote=null,t.directions=null)}},!0),t.$watchGroup(["item.Date","item.Time"],function(i){var n=A(i[0],i[1]);new moment(n).isSame(t.item.BookedDateTime)||(t.item.BookedDateTime=n,t.canQuote=!0,t.timeSet=!1,e.forEach(t.item.BookingStops,function(e,i){e.Latitude&&e.Longitude||(t.canQuote=!1)}),t.canQuote?j(t.item):(t.item.EstimatedCost=0,t.quote=null,t.directions=null))}),t.$watch("item.ClientStaffId",function(e){if("add-booker"===e){var i=n.open({templateUrl:"/webapp/common/modals/booker/modal.html",controller:"BookerCreateController",resolve:{rBooker:function(){var e=new u.ClientStaff;return e.Phone=t.clients.filter(function(e){return e.Id==t.item.ClientId})[0].Phone,e.ClientId=t.item.ClientId,e}}});i.result.then(function(e){var i={Id:e.Id,ClientId:e.ClientId,Name:e.Firstname+" "+e.Surname,Description:e.Email?e.Email:"",Mobile:e.Mobile,ImageUrl:$utilities.formatUrl(e.ImageUrl,e.Name)};t.newBooker=e,t.bookers.push(i),t.item.ClientStaffId=e.Id},function(){t.item.ClientStaffId=null})}}),t.$watchGroup(["item.AsDirected","item.ChauffeurMode","item.EstimatedMins","item.ActualDistance","item.BookingStops.length"],function(i,n){if(void 0!==n[0]&&"VIEW"!=t.viewMode){if(t.item.AsDirected===!0)t.item.BookingStops.length=1;else if(1==t.item.BookingStops.length){var o=new u.BookingStop;o.id=idCounter++,t.item.BookingStops.push(o)}t.canQuote=!0,t.item.AsDirected?t.canQuote=t.item.BookingStops[0].Latitude&&t.item.BookingStops[0].Longitude:e.forEach(t.item.BookingStops,function(e,i){e.Latitude&&e.Longitude||(t.canQuote=!1)}),t.item.EstimatedCost=0,t.quote=null,t.directions=null,t.canQuote&&j(t.item)}}),t.$watch("selectedPassenger.Mobile",function(e,i){e!=i&&void 0!==i&&(t.item.PassengerNotificationPhone=e)}),t.$watch("item.LeadPassengerId",function(i,o){function r(){u.Passenger.query().where("Id","eq","guid'"+i+"'").include("Tags").select("Tags").execute().then(function(e){d.Tags=e[0].Tags;for(var t=0;t<d.Tags.length;t++)E(d.Tags[t])})}if("add-passenger"===i){t.item.LeadPassengerId=null;var s=n.open({templateUrl:"/webapp/common/modals/passenger/create.modal.html",controller:"PassengerItemCreateModalController",resolve:{rClientId:function(){return t.item.ClientId},rNavigateAfterSave:function(){return!1}}});return void s.result.then(function(e){var i={Id:e.Id,ClientId:e.ClientId,Name:e.Firstname+" "+e.Surname,Description:e.Email?e.Email:"",Mobile:e.Mobile,ImageUrl:$utilities.formatUrl(e.ImageUrl,e.Name)};t.passengers.push(i),t.item.ClientId=e.ClientId,t.item.LeadPassengerId=e.Id},function(){})}var a=t.item;if(i){var d=t.passengers.filter(function(e){return e.Id==i})[0];t.selectedPassenger=d,a.ClientId=d.ClientId,i!==o&&(a.PassengerNotificationPhone=d.Mobile),e.forEach(d.Addresses,function(e){if(e.Latitude&&e.Longitude){var i="";e.Address1&&e.Address1.length>1&&(i+=e.Address1),e.TownCity?(i.length>0&&(i+=", "),i+=e.TownCity):e.Area&&(i.length>0&&(i+=", "),i+=e.Area),e.Postcode&&(i.length>0&&(i+=", "),i+=e.Postcode),t.externalLocations.knownLocations.push({Address1:e.Address1,Address2:e.Address2,Area:e.Area,TownCity:e.TownCity,County:e.County,Postcode:e.Postcode,Country:e.Country,Latitude:e.Latitude,Longitude:e.Longitude,Name:e.Name,StopSummary:e.StopSummary||i,LocationType:"Passenger Address"})}});var l=t.clients.filter(function(e){return e.Id==d.ClientId})[0];l?t.fetchedClients=[l]:t.fetchedClients=[],u.Booking.query().where("LeadPassengerId","eq","guid'"+i+"'").include("BookingStops").orderBy("BookedDateTime desc").top(5).execute().then(function(e){t.paxHistory=e,t.currentTab="HISTORY"}),t.externalLocations.historic.length=0,u.BookingStop.query().where("Booking/LeadPassengerId","eq","guid'"+i+"'").top(10).execute().then(function(e){var i={};uniqueResults=e.filter(function(e){return!i[e.Address1]&&(i[e.Address1]=!0,!0)}),[].push.apply(t.externalLocations.historic,uniqueResults)}),d.Tags||r()}else watchPassenger||(watchPassenger=!0,t.filteredPassengers=t.passengers),a.PassengerNotificationPhone=null}),t.$watch("item.VehicleTypeId",function(i,n){void 0!==n&&i!==n&&(t.canQuote=!0,t.item.AsDirected?t.canQuote=t.item.BookingStops[0].Latitude&&t.item.BookingStops[0].Longitude:e.forEach(t.item.BookingStops,function(e,i){e.Latitude&&e.Longitude||(t.canQuote=!1)}),t.canQuote?j(t.item):(t.item.EstimatedCost=0,t.quote=null,t.directions=null))})}var i=e.module("cab9.common");i.controller("BookingEditModalController",t),t.$inject=["$scope","$UI","$modal","$modalInstance","$http","$config","$rootScope","Auth","Model","rBooking","rMode","rTaxes","rExpenseTypes","rClients","rPassengers","rClientStaff","Localisation","$location","rTags"]}(angular);;;;
!function(o){function e(o,e,r,t,n,c,a){function l(){o.booker.$patch().then(function(o){r.close(o.data)},function(o){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:e.COLOURS.brandSecondary})})}o.booker=a[0],o.save=l,o.edit=!0}function r(o,e,r,t,n,c,a,l,i){function u(o){r.close(o)}function d(){o.booker.$save().then(function(o){swal({title:"Booker Saved",text:"Changes have been updated.",type:"success",confirmButtonColor:e.COLOURS.brandSecondary}),r.close(o.data)},function(o){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:e.COLOURS.brandSecondary})})}o.booker=a,o.save=d,o.duplicates=[],o.useExisting=u,o.booker.AllPassengers=!1,c.ClientStaffRole.query().select("Id").filter("Name eq 'Booker'").execute().then(function(e){o.booker.ClientStaffRoleId=e[0].Id},function(o){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:e.COLOURS.brandSecondary})});var s=null;o.$watch("booker",function(){s&&(i.cancel(s),s=null),o.duplicates=[],(o.booker.Firstname||o.booker.Surname||o.booker.Phone||o.booker.Mobile||o.booker.Email)&&(s=i(function(){l.post(t.API_ENDPOINT+"api/client/bookerduplicates",o.booker).then(function(e){o.duplicates=e.data})},500))},!0)}var t=o.module("cab9.common");t.controller("BookerCreateController",r),t.controller("BookerEditController",e),r.$inject=["$scope","$UI","$modalInstance","$config","$q","Model","rBooker","$http","$timeout"],e.$inject=["$scope","$UI","$modalInstance","$config","$q","Model","rBooker"]}(angular);;;;
!function(e){function t(t,n,o,s,a,l,r,d,u,c,m,g,f,h){function p(){"EDIT"==t.viewMode&&(t.item.ChauffeurMode=!0,t.item.EstimatedMins=60)}function C(){"EDIT"==t.viewMode&&(t.item.ChauffeurMode=!1,t.item.EstimatedMins=null)}function I(e){var n=f.timeZone().getTimeZone()||"Europe/London",i=moment(e).toDate(),o=i.getTimezoneOffset(),s=moment.tz.zone(n).offset(i),a=new moment.tz(e,"YYYY-MM-DDTHH:mm",n).add(o-s,"minutes");t.item.Date=a.toDate(),t.item.Time=a.toDate()}function k(){t.item.FlightInfo=null,t.item.FlightInfoId=null,t.flightData.Number=null}function A(){t.item.FlightInfo=null,t.flightData.Number.length>0?l({url:r.API_ENDPOINT+"/api/flightinfo/getflightinfo",method:"GET",params:{flightno:t.flightData.Number,flightDate:M(t.item.Date,t.item.Time)}}).then(function(e){if(e.data){e.data.Id=null,e.data.BookingId=null,e.data.TenantId=null,t.item.FlightInfo=new d.FlightInfo(e.data);var n=f.timeZone().getTimeZone(),i=moment(t.item.FlightInfo.ArrivalTime).toDate(),o=i.getTimezoneOffset(),s=moment.tz.zone(n).offset(i),a=new moment.tz(t.item.FlightInfo.ArrivalTime,n).add(o-s,"minutes");if(t.item.Time=a.toDate(),t.timeSet=!0,e.data.SuggestedAddressId&&t.item.BookingStops[0].$$Id!=e.data.SuggestedAddressId){var l=e.data.SuggestedAddressId;d.Location.query().where("Id eq guid'"+e.data.SuggestedAddressId+"'").execute().then(function(e){var n=new d.BookingStop;n.Address1=e[0].Name?e[0].Name:"",n.StopSummary=e[0].Name?e[0].Name:"",n.Latitude=e[0].Latitude?e[0].Latitude:null,n.Longitude=e[0].Longitude?e[0].Longitude:null,n.$$Id=l,n.WaitTime=t.item.BookingStops[0].WaitTime,center_moved=!1,t.item.BookingStops[0]=n})}}else swal("Flight Not Found","Please check flight number.","warning")},function(e){swal("Incorrect Flight Number","Please check flight number.","warning")}):swal("Incorrect Flight Number","Please check flight number.","warning")}function w(e){t.item.WaitAndReturn&&t.item.BookingStops.length<4?swal("Cannot remove via Stop","WaitAndReturn booking should have a via stop","warning"):t.item.BookingStops.splice(e,1),t.item.BookingStops.length<3&&(t.sortableOptions.disabled=!0)}function B(){if(d.Client.query().select("Id,Name,AccountNo,AccountPassword,DefaultCurrencyId,ImageUrl,ClientType/Name,ClientReferences,AllVehicleTypeAccess,Phone").include("ClientType,ClientReferences").parseAs(function(e){this.Id=e.Id,this.Name=(e.AccountNo?e.AccountNo+" - ":"")+e.Name,this.DefaultCurrencyId=e.DefaultCurrencyId,this.Description=e.ClientType.Name,this.Phone=e.Phone,this.AccountPassword=e.AccountPassword,this.ImageUrl=$utilities.formatUrl(e.ImageUrl,e.Name),this.AllVehicleTypeAccess=e.AllVehicleTypeAccess,this.ClientReferences=e.ClientReferences.map(function(e){return{Id:e.Id,ReferenceName:e.ReferenceName,Mandatory:e.Mandatory,AllowAddToList:e.AllowAddToList,Value:e.Value,ReferenceType:e.ReferenceType}})}).execute().then(function(e){t.clients=e}),d.VehicleType.query().parseAs(function(e){this.Id=e.Id,this.Name=e.Name,this.Description=e.Description,this.IsDefault=e.IsDefault,this.ImageUrl=null}).execute().then(function(e){t.client.AllVehicleTypeAccess?t.vehicleTypes=t._vehicleTypes=e:t.vehicleTypes=t.client.VehicleTypes}),d.BookingRequirement.query().execute().then(function(n){t.bookingRequirements=t.unlinkedRequirements=n,e.forEach(t.item.BookingRequirements,function(e){var n=t.unlinkedRequirements.filter(function(t){return t.Id==e.Id});n[0]&&t.unlinkedRequirements.splice(t.unlinkedRequirements.indexOf(n[0]),1)})}),d.ClientStaff.query().filter("ClientId eq guid'"+t.item.ClientId+"'").parseAs(function(e){this.Id=e.Id,this.ClientId=e.ClientId,this.Name=e.Firstname+" "+e.Surname,this.Mobile=e.Mobile,this.ImageUrl=$utilities.formatUrl(e.ImageUrl,e.Name)}).execute().then(function(e){t.bookers=e,t.bookers.push({Id:"add-booker",Name:"Add Booker",Description:"Create New Booker",ImageUrl:"/includes/images/add-icon.png"})}),[].push.apply(t.externalLocations.knownLocations,t.client.KnownLocations),t.client.Latitude&&t.client.Longitude){var n="";t.client.Address1&&t.client.Address1.length>1&&(n+=t.client.Address1),t.client.TownCity?(n.length>0&&(n+=", "),n+=t.client.TownCity):t.client.Area&&(n.length>0&&(n+=", "),n+=t.client.Area),t.client.Postcode&&(n.length>0&&(n+=", "),n+=t.client.Postcode),t.externalLocations.knownLocations.push({Address1:t.client.Address1,Address2:t.client.Address2,Area:t.client.Area,TownCity:t.client.TownCity,County:t.client.County,Postcode:t.client.Postcode,Country:t.client.Country,Latitude:t.client.Latitude,Longitude:t.client.Longitude,Name:"Office Address",StopSummary:n,LocationType:"OFFICE"})}t.item.CurrencyId=t.client.DefaultCurrencyId,e.forEach(t.item.LeadPassenger.Addresses,function(e){if(e.Latitude&&e.Longitude){var n="";e.Address1&&e.Address1.length>1&&(n+=e.Address1),e.TownCity?(n.length>0&&(n+=", "),n+=e.TownCity):e.Area&&(n.length>0&&(n+=", "),n+=e.Area),e.Postcode&&(n.length>0&&(n+=", "),n+=e.Postcode),t.externalLocations.knownLocations.push({Address1:e.Address1,Address2:e.Address2,Area:e.Area,TownCity:e.TownCity,County:e.County,Postcode:e.Postcode,Country:e.Country,Latitude:e.Latitude,Longitude:e.Longitude,Name:e.Name,StopSummary:e.StopSummary||n,LocationType:"Passenger Address"})}})}function y(e){t.item.BookingRequirements.push(e);var n=t.unlinkedRequirements.filter(function(t){return t.Id==e.Id});n[0]&&t.unlinkedRequirements.splice(t.unlinkedRequirements.indexOf(n[0]),1),t.item.$selectedRequirement=null}function L(e){e?t.fetchedClients=h("filter")(t.clients,{Name:e}):t.fetchedClients=[]}function T(e){var t=c.filter(function(t){return t.Id==e})[0];if(t)return t.Name}function v(e){t.unlinkedRequirements.push(e);var n=t.item.BookingRequirements.filter(function(t){return t.Id==e.Id});n[0]&&t.item.BookingRequirements.splice(t.item.BookingRequirements.indexOf(n[0]),1)}function S(e,t){t?l({method:"GET",url:r.API_ENDPOINT+"/api/ClientReferences/suggest?ClientReferenceId="+e.Id+"&Value="+t}).then(function(t){e.$suggested=t.data.map(function(e){return{custom:!1,text:e}}),e.$originalValue&&e.$suggested.unshift(e.$originalValue),e.AllowAddToList&&e.$suggested.push({custom:!0,text:"Add '{{$select.search}}' to References"})},function(t){e.$suggested=[e.$originalValue]}):e.$suggested=[e.$originalValue]}function P(e){for(var t="[a-z]",n="[A-Z]",i="[0-9]",o="^",s=0,a=!1,l=!1,r=0;r<e.length;r++){var d=e[r];if("'"===d)o+=l?")":"(",l=!l;else if(l)["."].indexOf(d)!=-1&&(d="\\"+d),o+=d;else if(">"===d){if(s++,s>1)throw"Bad Mask - Case blocks have consecutive > without ending previous block"}else if("<"===d){if(s--,s<-1)throw"Bad Mask - Case blocks have consecutive < without ending previous block"}else"0"===d?(a=!0,o+="("+i+")"):"9"===d?o+="("+i+"?)":1===s?"A"===d?(a=!0,o+="("+n+"|"+i+")"):"a"===d?o+="("+n+"?|"+i+"?)":"L"===d?(a=!0,o+="("+n+")"):"l"===d&&(o+="("+n+"?)"):0===s?"A"===d?(a=!0,o+="("+t+"|"+n+"|"+i+")"):"a"===d?o+="("+t+"?|"+n+"?|"+i+"?)":"L"===d?(a=!0,o+="("+t+"|"+n+")"):"l"===d&&(o+="("+t+"?|"+n+"?)"):s===-1&&("A"===d?(a=!0,o+="("+t+"|"+i+")"):"a"===d?o+="("+t+"?|"+i+"?)":"L"===d?(a=!0,o+="("+t+")"):"l"===d&&(o+="("+t+"?)"))}if(l)throw"Bad Mask - Quoted section not terminated";if(!a)throw"Bad Mask - Must contain at least 1 mandatory symbol (A, L, 0)";return o+="$",new RegExp(o)}function R(){if(t.clientReferences.length>0)for(var e=0;e<t.clientReferences.length;e++){var n=t.clientReferences[e];if("Mask"==n.ReferenceType)return!(n.$testReg.test(n.$knownValue)||!n.$knownValue&&!n.Mandatory)}return!1}function N(){window.close()}function D(){var e=t.item.BookingStops[0];t.item.BookingStops[0]=t.item.BookingStops[1],t.item.BookingStops[1]=e}function b(n){t.passengers.length=0,l.get(r.API_ENDPOINT+"api/Passengers/Search",{params:{searchText:n,clientId:t.item.ClientId}}).success(function(n){e.forEach(n,function(e){e.Client&&(e.Client.ImageUrl=$utilities.formatUrl(e.Client.ImageUrl,e.Client.Name)),t.passengers.push({Id:e.Id,ClientId:e.ClientId,Name:e.Firstname+" "+e.Surname,Description:e.Client&&e.Client.Name?e.Client.Name:"No Client",Mobile:e.Mobile,Addresses:e.Addresses,ImageUrl:$utilities.formatUrl(e.ImageUrl,e.Firstname)})}),t.passengers.push({Id:"add-passenger",Name:"Add Passenger",Description:"Create New Passenger",ImageUrl:"/includes/images/add-icon.png"})})}function E(n){t.item.ClientId&&(t.bookers.length=0,l.get(r.API_ENDPOINT+"api/Bookers/Search",{params:{searchText:n,clientId:t.item.ClientId}}).success(function(n){e.forEach(n,function(e){e.Client&&(e.Client.ImageUrl=$utilities.formatUrl(e.Client.ImageUrl,e.Client.Name)),t.bookers.push({Id:e.Id,ClientId:e.ClientId,Name:e.Firstname+" "+e.Surname,Description:e.Client&&e.Client.Name?e.Client.Name:"No Client",Mobile:e.Mobile,ImageUrl:$utilities.formatUrl(e.ImageUrl,e.Firstname)})}),t.bookers.push({Id:"add-booker",Name:"Add Booker",Description:"Create New Booker",ImageUrl:"/includes/images/add-icon.png"})}))}function M(e,t){function n(e,t){var n="000000000"+e;return n.substr(n.length-t)}var i=e.getFullYear(),o=e.getMonth(),s=e.getDate(),a=t.getHours(),l=t.getMinutes(),r=n(i,4)+"-"+n(o+1,2)+"-"+n(s,2)+"T"+n(a,2)+":"+n(l,2)+":00",d=moment.tz(r,"YYYY-MM-DDTHH:mm:ss",f.timeZone().getTimeZone()).format();return d}function V(e){e.BookedDateTime=M(t.item.Date,t.item.Time),e.BookingStatus="Incoming",t.quoting.inprogress=!0;for(var n=0;n<t.item.BookingStops.length;n++)t.item.BookingStops[n].StopOrder=n+1;Q=!0,l.post(r.API_ENDPOINT+"api/quote",e).success(function(n){n.Error?(e.EstimatedCost=0,e.EstimatedDistance=0,e.EstimatedDuration=0,e.ActualCost=0,t.directions=null,e.EncodedRoute=""):(e.EstimatedCost=n.FinalCost,e.EstimatedDistance=n.EstimatedDistance.toFixed(2),e.EstimatedDuration=n.EstimatedMins,e.ActualCost=n.FinalCost,n.Directions?e.EncodedRoute=n.Directions.EncodedRoute:e.EncodedRoute="",t.directions=n.Directions),t.quote=n,t.quoting.inprogress=!1}).error(function(e){t.quoting.inprogress=!1,console.log(e),swal("Could not quote","Could not quote, please manually price and set driver payment amount for this booking.","warning")})}function q(e){var n=new d.BookingStop;n.id=idCounter++,t.item.WaitAndReturn?t.item.BookingStops.splice(e,0,n):t.item.BookingStops.splice(e+1,0,n),t.item.BookingStops.length>2&&(t.sortableOptions.disabled=!1)}function x(e,n){var i=f.timeZone().getTimeZone(),o=(new Date).getTimezoneOffset(),s=moment.tz.zone(i).offset(new Date),a=new moment.tz(i).add(o-s,"minutes");"day"==n?t.item.Date=a.add(e,"minutes").toDate():"time"==n&&(t.item.Time=a.startOf("minute").add(e,"minutes").toDate())}function U(){t.item.BookingStops.reverse()}function F(){$("#bookingsave").prop("disabled",!0);var e=[];t.newBooker&&t.newBooker.Id==t.item.ClientStaffId&&(t.newBooker.Passengers=[],t.newBooker.Passengers.push(t.item.LeadPassenger),l.post(r.API_ENDPOINT+"api/ClientStaff/ManagePassengers",t.newBooker).then(function(e){},function(e){swal({title:"Error adding passenger to booker",text:"Some error has occured.",type:"error",confirmButtonColor:n.COLOURS.brandSecondary})}));var i=t.item;if(t.paxMode.value){if(!i._LeadPassenger)return void swal("Invalid","Please add passenger details.","error");var s=i._LeadPassenger.split(" ");t.item.LeadPassenger={Firstname:s[0],Surname:s.slice(1).join(" "),Mobile:i._LeadPassengerNumber,ClientId:i.ClientId}}if(t.item.BookingValidations=[],t.clientReferences.length>0)for(var a=0;a<t.clientReferences.length;a++){var u=t.clientReferences[a],c=new d.BookingValidation;c.ClientReferenceId=u.Id,"List"==u.ReferenceType?c.Value=u.$knownValue&&u.$knownValue.text:c.Value=u.$knownValue,c.Value&&t.item.BookingValidations.push(c)}t.item.BookedDateTime=M(t.item.Date,t.item.Time),t.item.LeadPassenger=void 0,t.item.Client=void 0,t.item.Driver=void 0,t.item.VehicleType=void 0,t.item.Currency=void 0,e.push(t.item.$save()),o.all(e).then(function(e){var t=e[e.length-1].data.LocalId;swal({title:"Booking Saved.",text:"Booking Reference: #"+t,type:"success",showCancelButton:!1,confirmButtonColor:n.COLOURS.brandPrimary,confirmButtonText:"Okay",closeOnConfirm:!0},function(){window.close()})},function(e){t.dataReady=!0,swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error"})})}var O=[];t.viewMode="EDIT",t.repeat=!0,t.item=e.copy(u[0]),t.item.Id=null,t.item.FlightInfoId=null,t.flightData={Number:""},t.showInactiveReferences=!1;var Q=!1;for(t.item.LocalId=null,t.item.DriverId=null,t.item.VehicleId=null,t.item.DriverPaymentId=null,t.item.BookingStops=t.item.BookingStops.sort(function(e,t){return e.StopOrder-t.StopOrder}),t.item.BookingStops=t.item.BookingStops.map(function(e){return e.Id=null,e.BookingId=null,e}),t.canQuote=!0,t.item.BookingValidations=t.item.BookingValidations.map(function(e){return e.Id=null,e.BookingId=null,e}),t.newBooker=null,t.bookers=[],t.externalLocations={knownLocations:g[0].KnownLocations?g[0].KnownLocations:[]},t.quoting={},t.paxMode={value:!1},t.sortableOptions={stop:function(e,t){},ondragstart:function(e,t){},disabled:!(t.item.BookingStops.length>2)},t.removeStop=w,t.bookingInfo=!0,t.save=F,t.close=N,t.formFor={},t.testMaskReferences=R,t.reverseStops=U,t.suggestReferences=S,t.addRequirement=y,t.removeRequirement=v,t.fetchedClients=[t.item.Client],t.clientReferences=[],t.client=t.item.Client,t.taxes=c,t.searchBookers=E,t.searchPassengers=b,t.searchClients=L,t.flipAddress=D,I(moment().add(15,"minutes").format("YYYY-MM-DDTHH:mm")),t.fetchFlightInformation=A,t.removeFlightInfo=k,t.enableChauffering=p,t.disableChauffering=C,t.item.FlightInfo&&(t.flightData.Number=t.item.FlightInfo.FlightNumber,t.item.FlightInfo.Id=null,A()),t.$watch("item.Date",function(e,n){t.flightData.Number&&e&&e!=n&&A()}),j=0,leng=t.client.ClientReferences.length;j<leng;j++){for(i=0,len=t.item.BookingValidations.length;i<len;i++)if(t.client.ClientReferences[j].Id==t.item.BookingValidations[i].ClientReferenceId&&(t.client.ClientReferences[j].$knownValue=t.item.BookingValidations[i].Value,t.client.ClientReferences[j].$id=t.item.BookingValidations[i].Id,"List"==t.client.ClientReferences[j].ReferenceType)){var Y={custom:!1,text:t.item.BookingValidations[i].Value};t.client.ClientReferences[j].$knownValue=Y,t.client.ClientReferences[j].$originalValue=Y,t.client.ClientReferences[j].$suggested=[Y]}if("Mask"==t.client.ClientReferences[j].ReferenceType&&(t.client.ClientReferences[j].$testReg=P(t.client.ClientReferences[j].Value)),"List"==t.client.ClientReferences[j].ReferenceType&&t.client.ClientReferences[j].ShowList){var z=t.client.ClientReferences[j];l({method:"GET",url:r.API_ENDPOINT+"/api/ClientReferences/list?ClientReferenceId="+t.client.ClientReferences[j].Id}).then(function(e){z.$list=e.data.map(function(e){return{custom:!1,text:e}}),z.AllowAddToList&&z.$list.push({custom:!0,text:"Add '{{$select.search}}' to References"})})}t.clientReferences.push(t.client.ClientReferences[j])}B(),t.getTaxName=T,t.addTime=x,t.addStop=q,t.$watch("item.BookingStops[0]",function(n,i){if(void 0!==i&&n!==i&&t.item.WaitAndReturn){var o=new d.BookingStop(e.copy(t.item.BookingStops[0]));o.id=idCounter++,o.Id=null,t.item.BookingStops.splice(t.item.BookingStops.length-1,1,o)}},!0),t.$watch("item.WaitAndReturn",function(n,i){if(void 0!==i&&n!==i){if(n===!1){t.item.BookingStops.splice(t.item.BookingStops.length-1,1);var o=new d.BookingStop;o.id=idCounter++,t.item.BookingStops.push(o)}else if(n===!0){var o=new d.BookingStop(e.copy(t.item.BookingStops[0]));o.id=idCounter++,o.Id=null,t.item.BookingStops.push(o)}t.canQuote=!0,e.forEach(t.item.BookingStops,function(e,n){e.Latitude&&e.Longitude||(t.canQuote=!1)})}}),t.$watch("item.Date",function(e,n){t.flightData.Number&&e&&e!=n&&A()}),t.$watch("item.BookingStops",function(n,i){void 0!==i&&n!==i&&(t.canQuote=!0,e.forEach(n,function(e,n){e.Latitude&&e.Longitude||(t.canQuote=!1)}),t.canQuote?V(t.item):(t.item.EstimatedCost=0,t.item.ActualCost=0,t.quote=null,t.directions=null))},!0),t.$watchGroup(["item.Date","item.Time"],function(n){var i=M(n[0],n[1]);new moment(i).isSame(t.item.BookedDateTime)||(t.item.BookedDateTime=i,t.canQuote=!0,t.timeSet||(t.item.FlightInfo=null),t.timeSet=!1,e.forEach(t.item.BookingStops,function(e,n){e.Latitude&&e.Longitude||(t.canQuote=!1)}),t.canQuote?V(t.item):(t.item.EstimatedCost=0,t.item.ActualCost=0,t.quote=null,t.directions=null))}),t.$watch("item.ClientStaffId",function(e){if("add-booker"===e){var n=s.open({templateUrl:"/webapp/common/modals/booker/modal.html",controller:"BookerCreateController",resolve:{rBooker:function(){var e=new d.ClientStaff;return e.Phone=t.clients.filter(function(e){return e.Id==t.item.ClientId})[0].Phone,e.ClientId=t.item.ClientId,e}}});n.result.then(function(e){var n={Id:e.Id,ClientId:e.ClientId,Name:e.Firstname+" "+e.Surname,Description:e.Email?e.Email:"",Mobile:e.Mobile,ImageUrl:$utilities.formatUrl(e.ImageUrl,e.Name)};t.newBooker=e,t.bookers.push(n),t.item.ClientStaffId=e.Id},function(){t.item.ClientStaffId=null})}}),t.$watchGroup(["item.AsDirected","item.ChauffeurMode","item.EstimatedMins","item.ActualDistance","item.BookingStops.length"],function(n,i){if(void 0!==i[0]&&"VIEW"!=t.viewMode){if(t.item.AsDirected===!0)t.item.BookingStops.length=1;else if(1==t.item.BookingStops.length){var o=new d.BookingStop;o.id=idCounter++,t.item.BookingStops.push(o)}t.canQuote=!0,e.forEach(t.item.BookingStops,function(e,n){e.Latitude&&e.Longitude||(t.canQuote=!1)}),t.item.EstimatedCost=0,t.item.ActualCost=0,t.quote=null,t.directions=null,t.canQuote&&V(t.item)}});var _=!0;t.$watch("item.ClientId",function(n){if(_)setTimeout(function(){_=!1},0);else{if(t.bookers=[{Id:"add-booker",Name:"Add Booker",Description:"Create New Booker",ImageUrl:"/includes/images/add-icon.png"}],t.passengers=[{Id:"add-passenger",Name:"Add Passenger",Description:"Create New Passenger",ImageUrl:"/includes/images/add-icon.png"}],t.externalLocations.knownLocations.length=0,n){t.item.ClientStaffId=null;var i=t.clients.filter(function(e){return e.Id==n})[0];i.AccountPassword&&swal({title:"Account Password",text:"This account is password enabled.",type:"input",showCancelButton:!0,closeOnConfirm:!1,animation:"slide-from-top",inputPlaceholder:"Account Password"},function(e){return e===!1?(t.item.ClientId=null,t.$apply(),!1):""===e?(swal.showInputError("You need to write something!"),!1):e!=i.AccountPassword?(swal.showInputError("Incorrect Password"),!1):void swal("Accepted","The password is valid. Please continue with the booking.","success")}),t.clientReferences=e.copy(i.ClientReferences),t.clientReferences.map(function(e){return"Mask"==e.ReferenceType&&(e.$testReg=P(e.Value)),e}),t.selectedClient=i,i?i.AllVehicleTypeAccess===!1&&d.Client.query().where("Id eq guid'"+n+"'").include("VehicleTypes").select("VehicleTypes").execute().then(function(e){t.vehicleTypes=e[0].VehicleTypes.map(function(e){return e.ImageUrl=null,e}),t.item.VehicleTypeId=t.filteredVehicleTypes[0].Id}):t.vehicleTypes=t._vehicleTypes,d.Client.query().where("Id eq guid'"+n+"'").include("KnownLocations").select("KnownLocations,Address1,Address2,Area,TownCity,County,Postcode,Country,Latitude,Longitude,BillingAddress1,BillingAddress2,BillingArea,BillingTownCity,BillingCounty,BillingPostcode,BillingCountry,BillingLatitude,BillingLongitude").execute().then(function(e){if([].push.apply(t.externalLocations.knownLocations,e[0].KnownLocations),e[0].Latitude&&e[0].Longitude){var n="";e[0].Address1&&e[0].Address1.length>1&&(n+=e[0].Address1),e[0].TownCity?(n.length>0&&(n+=", "),n+=e[0].TownCity):e[0].Area&&(n.length>0&&(n+=", "),n+=e[0].Area),e[0].Postcode&&(n.length>0&&(n+=", "),n+=e[0].Postcode),t.externalLocations.knownLocations.push({Address1:e[0].Address1,Address2:e[0].Address2,Area:e[0].Area,TownCity:e[0].TownCity,County:e[0].County,Postcode:e[0].Postcode,Country:e[0].Country,Latitude:e[0].Latitude,Longitude:e[0].Longitude,Name:"Office Address",StopSummary:n,LocationType:"OFFICE"})}if(e[0].BillingLatitude&&e[0].BillingLongitude&&e[0].BillingLatitude!=e[0].Latitude&&e[0].Longitude!=e[0].BillingLongitude){var n="";e[0].BillingAddress1&&e[0].BillingAddress1.length>1&&(n+=e[0].BillingAddress1),e[0].BillingTownCity?(n.length>0&&(n+=", "),n+=e[0].BillingTownCity):e[0].BillingArea&&(n.length>0&&(n+=", "),n+=e[0].BillingArea),e[0].BillingPostcode&&(n.length>0&&(n+=", "),n+=e[0].BillingPostcode),t.externalLocations.knownLocations.push({Address1:e[0].BillingAddress1,Address2:e[0].BillingAddress2,Area:e[0].BillingArea,TownCity:e[0].BillingTownCity,County:e[0].BillingCounty,Postcode:e[0].BillingPostcode,Country:e[0].BillingCountry,Latitude:e[0].BillingLatitude,Longitude:e[0].BillingLongitude,Name:"Billing Address",StopSummary:n,LocationType:"OFFICE"})}})}else t.item.ClientStaffId=null,t.item.LeadPassengerId=null,t.fetchedClients=[],t.clientReferences.length=0,t.selectedClient=null;if(t.item.ClientId){var o=t.clients.filter(function(e){return e.Id==t.item.ClientId})[0];o&&(t.item.CurrencyId=o.DefaultCurrencyId)}else t.item.CurrencyId=t.COMPANY.DefaultCurrencyId}},!0),t.passengers=m,t.passengers.push({Id:"add-passenger",Name:"Add Passenger",Description:"Create New Passenger",ImageUrl:"/includes/images/add-icon.png"}),t.bookers=O,t.bookers.push({Id:"add-booker",Name:"Add Booker",Description:"Create New Booker",ImageUrl:"/includes/images/add-icon.png"}),t.$watch("selectedPassenger.Mobile",function(e){t.item.PassengerNotificationPhone=e}),t.$watch("item.LeadPassengerId",function(n){if("add-passenger"===n){t.item.LeadPassengerId=null;var i=s.open({templateUrl:"/webapp/common/modals/passenger/create.modal.html",controller:"PassengerItemCreateModalController",resolve:{rClientId:function(){return t.item.ClientId},rNavigateAfterSave:function(){return!1}}});return void i.result.then(function(e){var n={Id:e.Id,ClientId:e.ClientId,Name:e.Firstname+" "+e.Surname,Description:e.Email?e.Email:"",Mobile:e.Mobile,ImageUrl:$utilities.formatUrl(e.ImageUrl,e.Name)};t.passengers.push(n),t.item.ClientId=e.ClientId,t.item.LeadPassengerId=e.Id},function(){})}var o=t.item;if(n){var a=t.passengers.filter(function(e){return e.Id==n})[0];t.selectedPassenger=a,o.ClientId=a.ClientId,o.PassengerNotificationPhone=a.Mobile,e.forEach(a.Addresses,function(e){if(e.Latitude&&e.Longitude){var n="";e.Address1&&e.Address1.length>1&&(n+=e.Address1),e.TownCity?(n.length>0&&(n+=", "),n+=e.TownCity):e.Area&&(n.length>0&&(n+=", "),n+=e.Area),e.Postcode&&(n.length>0&&(n+=", "),n+=e.Postcode),t.externalLocations.knownLocations.push({Address1:e.Address1,Address2:e.Address2,Area:e.Area,TownCity:e.TownCity,County:e.County,Postcode:e.Postcode,Country:e.Country,Latitude:e.Latitude,Longitude:e.Longitude,Name:e.Name,StopSummary:e.StopSummary||n,LocationType:"Passenger Address"})}})}else o.PassengerNotificationPhone=null}),t.$watch("item.VehicleTypeId",function(n,i){void 0!==i&&n!==i&&(t.canQuote=!0,e.forEach(t.item.BookingStops,function(e,n){e.Latitude&&e.Longitude||(t.canQuote=!1)}),t.canQuote?V(t.item):(t.item.EstimatedCost=0,t.item.ActualCost=0,t.quote=null,t.directions=null))})}var n=e.module("cab9.common");n.controller("BookingReuseModalController",t),t.$inject=["$scope","$UI","$q","$modal","$modalInstance","$http","$config","Model","rBooking","rTaxes","rPassengers","rClients","Localisation","$filter"]}(angular);;;;
!function(o){function t(o,t,s,e,n,d){function p(){var t="";o.stop.Address1&&o.stop.Address1.length>1&&(t+=o.stop.Address1),o.stop.Address2&&o.stop.Address2.length>1&&(t+=", "+o.stop.Address2),o.stop.TownCity?(t.length>0&&(t+=", "),t+=o.stop.TownCity):o.stop.Area&&(t.length>0&&(t+=", "),t+=o.stop.Area),o.stop.Postcode&&(t.length>0&&(t+=", "),t+=o.stop.Postcode),o.stop.StopSummary=t,n.close(o.stop)}o.stop=d,o.update=p}var s=o.module("cab9.common");s.controller("BookingStopEditModalController",t),t.$inject=["$scope","$UI","$q","$modal","$modalInstance","rStop"]}(angular);;;;
!function(e){function t(t,s,n,a){return{scope:!0,templateUrl:"/webapp/common/directives/mileagestep/template.html",link:function(s,n,a){function i(){if(s.steps.length){var t=[];e.forEach(s.steps,function(s){t.push(e.copy(s))}),t[t.length-1].max=null,p=JSON.stringify(t||[])}else p="[]";r.assign(s,p),u=!0}var p="[]",r=t(a.value),u=!1;s.steps=[],s.$watch(function(){return r(s)},function(e){if(u)return void(u=!1);if(s.steps=[],e)try{s.steps=JSON.parse(e)}catch(t){p="[]"}else p="[]"}),s.onChange=i,s.getPrevious=function(e){var t=s.steps.indexOf(e);return t<=0?0:(s.steps[t-1].max>=e.max&&(e.max=s.steps[t-1].max+1),s.steps[t-1].max)},s.remove=function(e){var t=s.steps.indexOf(e);s.steps.splice(t,1),s.steps.length>0&&(s.steps[s.steps.length-1].max=null),i()},s.add=function(t){if(s.steps.length>0){s.steps[s.steps.length-1].max=s.getPrevious(s.steps[s.steps.length-1])+1;var n=e.copy(s.steps[s.steps.length-1]);n.max=null,s.steps.push(n)}else s.steps.push({max:1,fare:1});i()}}}}function s(t,s,n,a){return{scope:!0,templateUrl:"/webapp/common/directives/mileagestep/peakstep-template.html",link:function(s,n,a){function i(){if(s.steps.length){var t=[];e.forEach(s.steps,function(s){var n=e.copy(s);delete n.$week,t.push(n)}),r=JSON.stringify(t||[])}else r="[]";u.assign(s,r),o=!0}function p(e,t){return e-t}var r="[]",u=t(a.value),o=!1;s.steps=[],s.week=[{day:"Mo",value:1,selected:!0},{day:"Tu",value:2,selected:!0},{day:"We",value:3,selected:!0},{day:"Th",value:4,selected:!0},{day:"Fr",value:5,selected:!0},{day:"Sa",value:6,selected:!0},{day:"Su",value:0,selected:!0}],s.$watch(function(){return u(s)},function(t){if(o)return void(o=!1);if(s.steps=[],t)try{s.steps=JSON.parse(t),t.weekdays||(t.weekdays=[1,2,3,4,5,6,0]),s.steps.map(function(t){t.$week=e.copy(s.week),t.weekdays&&t.weekdays.length>0&&t.$week.map(function(e){e.selected=t.weekdays.indexOf(e.value)>-1})})}catch(n){r="[]"}else r="[]"}),s.onChange=i,s.remove=function(e){var t=s.steps.indexOf(e);s.steps.splice(t,1),i()},s.toggleDay=function(e,t){1==e.selected?(e.selected=!1,t.weekdays.splice(t.weekdays.indexOf(e.value),1)):(e.selected=!0,t.weekdays.push(e.value),t.weekdays.sort(p)),i()},s.add=function(t){s.steps.push({weekdays:[1,2,3,4,5,6,0],start:"00:00",end:"24:00",multiplier:1,$week:e.copy(s.week)}),i()}}}}function n(t,s,n,a){return{scope:!0,templateUrl:"/webapp/common/directives/mileagestep/peakdaystep-template.html",link:function(s,n,a){function i(){if(s.steps.length){var t=[];e.forEach(s.steps,function(s){var n=new moment(s.startTime).startOf("minute");s.startTime=s.start=new moment(s.start).startOf("minute").hour(n.hour()).minutes(n.minute()).toDate(),n=new moment(s.endTime).startOf("minute"),s.endTime=s.end=new moment(s.end).startOf("minute").hour(n.hour()).minutes(n.minute()).toDate(),delete s.$$from,delete s.$$to,delete s.$$fromTime,delete s.$$toTime,t.push(e.copy(s))}),p=JSON.stringify(t||[])}else p="[]";r.assign(s,p),u=!0}var p="[]",r=t(a.value),u=!1;s.steps=[],s.hideTimes=a.hideTimes,s.$watch(function(){return r(s)},function(t){if(u)return void(u=!1);if(s.steps=[],t)try{s.steps=JSON.parse(t),e.forEach(s.steps,function(e){e.startTime=new moment(e.start).startOf("minute").toDate(),e.endTime=new moment(e.end).startOf("minute").toDate()})}catch(n){p="[]"}else p="[]"}),s.onChange=i,s.remove=function(e){var t=s.steps.indexOf(e);s.steps.splice(t,1),i()},s.add=function(e){s.steps.push({start:new Date,end:new Date,multiplier:1,withpeaks:!0}),i()}}}}var a=e.module("framework.directives.UI");a.directive("mileageStep",t),a.directive("peakStep",s),a.directive("peakDayStep",n),t.$inject=["$parse","$http","$config","$filter"],s.$inject=["$parse","$http","$config","$filter"],n.$inject=["$parse","$http","$config","$filter"]}(angular);;;;
!function(r){function t(r,t){return{restrict:"E",replace:!0,scope:{status:"@",showActions:"@",partner:"="},templateUrl:"/webapp/common/directives/partner-card/template.html",link:function(r){r.partner.LogoUrl=window.formatImage(r.partner.LogoUrl,r.partner.Name)}}}var e=r.module("cab9.common");e.directive("partnerCard",t),t.$inject=["$http","$config"]}(angular);;;;
;;;
!function(e){function t(e,t,n,o,r,l){return{transclude:!0,replace:!0,scope:{data:"=",showOwner:"=","delete":"=",edit:"=",preview:"="},templateUrl:"/webapp/common/directives/document/template.html",link:function(t,n,u){function c(){var e=r.open({templateUrl:"/e9_components/layouts/module/module-document-item.modal.html",controller:"ModuleDocumentItemEditController",resolve:{rDocument:function(){return t.data},rDocumentTypes:function(){return l.DocumentType.query().execute()}}});e.result.then(function(e){swal("Document Updated!","Document has been Updated.","success")},function(){})}function a(){window.open(t.API_ENDPOINT+t.data.FilePath,"_blank")}function i(){swal({title:"Are you sure?",text:"You will not be able to recover the document!",type:"warning",showCancelButton:!0,confirmButtonColor:$UI.COLOURS.brandPrimary,confirmButtonText:"Confirm Delete!",closeOnConfirm:!0},function(){FileUpload["delete"](t.data.Id).then(function(){swal("Deleted!","Document has been deleted.","success"),e.go(e.current,{},{reload:!0}),setupGrid()},function(){swal("Error!","Some Issue while deleting.","error")})})}t.API_ENDPOINT=o.API_ENDPOINT,t.openModalWithDocument=c,t.previewDocument=a,t.deleteDocument=i}}}var n=e.module("cab9.common");n.directive("document",t),t.$inject=["$state","$interval","$parse","$config","$modal","Model"]}(angular);;;;
!function(){function t(t,i,e,o){this.latlng_=t,this.imageSrc=e,this.clickEvent=o,this.setMap(i)}var i=angular.module("cab9.common");i.service("CustomMarker",function(){return t}),t.prototype=new google.maps.OverlayView,t.prototype.hide=function(){this.div_&&(this.div_.style.visibility="hidden")},t.prototype.show=function(){this.div_&&(this.div_.style.visibility="visible")},t.prototype.draw=function(){var t=this.div_;if(!t){t=this.div_=document.createElement("div"),t.className="customMarker";var i=document.createElement("img");i.src=this.imageSrc,t.appendChild(i);var e=this;google.maps.event.addDomListener(t,"click",function(t){google.maps.event.trigger(e.clickEvent(e),"click")});var o=this.getPanes();o.overlayImage.appendChild(t)}var s=this.getProjection().fromLatLngToDivPixel(this.latlng_);s&&(t.style.left=s.x+"px",t.style.top=s.y+"px")},t.prototype.remove=function(){this.div_&&(this.div_.parentNode.removeChild(this.div_),this.div_=null,this.setMap(null))},t.prototype.getPosition=function(){return this.latlng_},t.prototype.setPosition=function(t){this.latlng_=t;var i=this.getProjection().fromLatLngToDivPixel(this.latlng_);i&&this.div_&&(this.div_.style.left=i.x+"px",this.div_.style.top=i.y+"px")}}();;;;
!function(e){var t=angular.module("cab9.widgets",[]);t.directive("bookingReport",["Model","$UI","$config","$http","$q","$filter","$timeout","$rootScope",function(e,t,r,o,n,i,a,l){return{templateUrl:"/webapp/common/widgets/booking-report.tmpl.html",scope:{filters:"="},link:function(t,s,d){function u(){t.deferred=n.defer(),t.bookingGraph.data.length=0,t.totalBookings=0,t.totalAmount=0,t.uniqueDrivers=0,t.uniquePassengers=0;var i=0;o({url:r.API_ENDPOINT+"api/reports/booking",method:"GET",params:{from:t.filters.from,to:t.filters.to}}).then(function(e){t.totalBookings=e.data.Totals.TotalBookings,t.totalAmount=e.data.Totals.TotalActualCost,i+=1,3==i&&t.deferred.resolve(!0)},function(e){t.deferred.reject("An Error Occured")}),o({url:r.API_ENDPOINT+"/api/reports/booking",method:"GET",params:{from:t.filters.from,to:t.filters.to}}).then(function(r){var o=r.data,n={label:"Bookings",data:[]};t.bookingGraph.data.push(n);for(var a=0;a<o.Grouped.length;a++){var l=o.Grouped[a];n.data.push([new moment(l.Period).valueOf(),l.Bookings])}e.Driver.query().select("Id").execute().then(function(r){t.driverCount=r.length,e.Vehicle.query().select("Id").execute().then(function(e){t.vehicleCount=e.length,i+=1,3==i&&t.deferred.resolve(!0)})})},function(e){t.deferred.reject("An Error Occured")}),o({url:r.API_ENDPOINT+"api/reports/booking",method:"GET",params:{from:t.filters.from,to:t.filters.to,groupbyentity:"DriverId"}}).then(function(e){t.uniqueDrivers=e.data.Grouped.length,o({url:r.API_ENDPOINT+"api/reports/booking",method:"GET",params:{from:t.filters.from,to:t.filters.to,groupbyentity:"LeadPassengerId"}}).then(function(e){t.uniquePassengers=e.data.Grouped.length,i+=1,3==i&&t.deferred.resolve(!0)},function(e){t.deferred.reject("An Error Occured")})},function(e){t.deferred.reject("An Error Occured")})}t.deferred=null;var c=null;t.totalBookings=0,t.totalAmount=0,t.uniqueDrivers=0,t.uniquePassengers=0,t.refresh=u,t.USER=l.USER,t.$watchCollection("filters",function(){c&&(a.cancel(c),c=null),c=a(u,500)}),t.bookingGraph={options:{series:{bars:{show:"true"},shadowSize:0,stack:!0},bars:{align:"center",fill:1,barWidth:3456e4},legend:{show:!1},grid:{hoverable:!0,clickable:!0,tickColor:"#1b3952",borderWidth:0,horizontalLines:!1},colors:["#a88adc"],xaxis:{mode:"time",tickFormatter:function(e,r){var o=i("date")(moment(e).toDate(),t.filters.format);return o},minTickSize:[1,"day"],tickLength:0},tooltip:!0,tooltipOpts:{content:function(e,t,r,o){return content=new moment(t).format("ddd")+", <small>%x</small><br/><strong>%s</strong> %y",content},xDateFormat:"%d-%m-%Y",defaultTheme:!1},yaxis:{min:0,position:"right",minTickSize:1}},data:[]}}}}])}(window);;;;
!function(e){var t=angular.module("cab9.widgets");t.directive("bookingClientReport",["Model","$UI","$config","$http","$q","$filter","$timeout","$rootScope",function(e,t,r,o,n,i,a,l){return{templateUrl:"/webapp/common/widgets/booking-client-report.tmpl.html",scope:{filters:"="},link:function(t,d,s){function f(){t.deferred1=n.defer(),t.bookingGraph.data.length=0,o({url:r.API_ENDPOINT+"api/reports/booking",method:"GET",params:{from:t.filters.from,to:t.filters.to}}).then(function(e){t.totalBookings=e.data.Totals.TotalBookings,t.totalAmount=e.data.Totals.TotalActualCost,t.bookingsPerDay=e.data.Totals.TotalBookings/moment(t.filters.from).diff(t.filters.to,"days"),t.deferred1.resolve(!0)},function(e){t.deferred1.reject("An Error Occured")}),t.deferred2=n.defer(),o({url:r.API_ENDPOINT+"/api/reports/booking",method:"GET",params:{from:t.filters.from,to:t.filters.to}}).then(function(r){var o=r.data,n={label:"Bookings",data:[]};t.bookingGraph.data.push(n);for(var i=0;i<o.Grouped.length;i++){var a=o.Grouped[i];n.data.push([new moment(a.Period).valueOf(),a.Bookings])}e.Driver.query().select("Id").execute().then(function(r){t.driverCount=r.length,e.Vehicle.query().select("Id").execute().then(function(e){t.vehicleCount=e.length,t.deferred2.resolve(!0)})})},function(e){t.deferred2.reject("An Error Occured")}),t.deferred3=n.defer(),o({url:r.API_ENDPOINT+"api/reports/booking",method:"GET",params:{from:t.filters.from,to:t.filters.to,groupbyentity:"DriverId"}}).then(function(e){t.uniqueDrivers=e.data.Grouped.length,o({url:r.API_ENDPOINT+"api/reports/booking",method:"GET",params:{from:t.filters.from,to:t.filters.to,groupbyentity:"LeadPassengerId"}}).then(function(e){t.uniquePassengers=e.data.Grouped.length,t.deferred3.resolve(!0)},function(e){t.deferred3.reject("An Error Occured")})},function(e){t.deferred3.reject("An Error Occured")})}t.deferred1=null,t.deferred2=null,t.deferred3=null;var c=null;t.refresh=f,t.USER=l.USER,t.$watchCollection("filters",function(){c&&(a.cancel(c),c=null),c=a(f,500)}),t.bookingGraph={options:{series:{bars:{show:"true"},shadowSize:0,stack:!0},bars:{align:"center",fill:1,barWidth:3456e4},legend:{show:!1},grid:{hoverable:!0,clickable:!0,tickColor:"#1b3952",borderWidth:0,horizontalLines:!1},colors:["#a88adc"],xaxis:{mode:"time",tickFormatter:function(e,r){var o=i("date")(moment(e).toDate(),t.filters.format);return o},minTickSize:[1,"day"],tickLength:0},tooltip:!0,tooltipOpts:{content:function(e,t,r,o){return content=new moment(t).format("ddd")+", <small>%x</small><br/><strong>%s</strong> %y",content},xDateFormat:"%d-%m-%Y",defaultTheme:!1},yaxis:{min:0,position:"right",minTickSize:1}},data:[]}}}}])}(window);;;;
!function(){var o=angular.module("cab9.widgets");o.directive("bookingSourceReport",["$UI","$config","$http","$q","$filter","$timeout",function(o,e,r,t,n,i){return{templateUrl:"/webapp/common/widgets/booking-source.tmpl.html",scope:{filters:"="},link:function(n,a,c){function u(o,e,r,t){var i=n.bookingSourceData.filter(function(e){return e.Name==o})[0];return i?"<div style='font-size:9pt; text-align:center; padding:2px; color:white;'>"+o+"<br/>"+r.toString()+" Bookings<br/><strong>"+i.ActualCost+" </strong></div>":""}function l(){n.deferred=t.defer(),n.bookingSourceData=[],n.bookingSourceChartData=[],r({url:e.API_ENDPOINT+"api/reports/booking",method:"GET",params:{from:n.filters.from,to:n.filters.to,groupbyentity:"BookingSource"}}).then(function(o){n.bookingSourceData=o.data.Grouped,angular.forEach(o.data.Grouped,function(o,e){n.bookingSourceChartData.push({label:o.Name,data:o.Bookings})}),n.deferred.resolve(!0)},function(o){n.deferred.reject("An Error Occured")})}n.deferred=null;var d=null;n.refresh=l,n.bookingSourceData=[],n.bookingSourceChartData=[],n.pieChartOptions={series:{pie:{show:!0,innerRadius:.5,combine:{color:"#999",threshold:.1}}},colors:[o.COLOURS.brandPrimary,o.COLOURS.brandSecondary,o.COLOURS.orange,o.COLOURS.sky,o.COLOURS.grey],tooltip:{show:!0,content:u,shifts:{x:25,y:0},defaultTheme:!1},grid:{hoverable:!0}},n.$watchCollection("filters",function(){d&&(i.cancel(d),d=null),d=i(l,500)})}}}])}();;;;
!function(){var e=angular.module("cab9.widgets");e.directive("bookingRevenue",["$UI","$config","$http","$q","$filter","$timeout",function(e,t,o,r,n,l){return{templateUrl:"/webapp/common/widgets/booking-revenue.tmpl.html",scope:{filters:"="},link:function(e,n,i){function a(){e.deferred=r.defer(),o({url:t.API_ENDPOINT+"api/reports/booking",method:"GET",params:{from:e.filters.from,to:e.filters.to}}).then(function(t){e.totalBookings=t.data.Totals.TotalBookings,e.totalAmount=t.data.Totals.TotalActualCost,e.deferred.resolve(!0)},function(t){e.deferred.reject("An Error Occured")})}e.deferred=null;var f=null;e.refresh=a,e.$watchCollection("filters",function(){f&&(l.cancel(f),f=null),f=l(a,500)})}}}])}();;;;
!function(){var e=angular.module("cab9.widgets");e.directive("bookingsHeatmap",["$UI","$config","$http","$q","$filter","$rootScope","$timeout",function(e,t,o,a,n,l,s){return{templateUrl:"/webapp/common/widgets/bookings-heatmap.tmpl.html",scope:{filters:"="},link:function(e,n,r){function p(){e.deferred=a.defer(),o({url:t.API_ENDPOINT+"api/bookings",method:"GET",params:{$filter:"BookedDateTime ge datetimeoffset'"+e.filters.from+"' and BookedDateTime le datetimeoffset'"+e.filters.to+"'",$select:"BookingStops/Longitude,BookingStops/Latitude",$expand:"BookingStops"}}).then(function(t){var o=[],a=new google.maps.LatLngBounds;for(i=0;i<t.data.length;i++){var n=t.data[i];n.BookingStops[0]&&n.BookingStops[0].Latitude&&n.BookingStops[0].Longitude&&(o.push({location:new google.maps.LatLng(n.BookingStops[0].Latitude,n.BookingStops[0].Longitude),weight:1}),a.extend(new google.maps.LatLng(n.BookingStops[0].Latitude,n.BookingStops[0].Longitude)))}var l=new google.maps.visualization.HeatmapLayer({data:o,dissipating:!0,radius:50,opacity:.75});l.setMap(e.map)}),e.deferred.resolve(!0)}e.deferred=null;var g=null;e.refresh=p,e.map=null,setTimeout(function(){e.map=new google.maps.Map(document.getElementById("heatmap-div"),{center:new google.maps.LatLng(l.COMPANY.BaseLatitude,l.COMPANY.BaseLongitude),zoom:12,zoomControl:!1,streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP},styles:[{featureType:"water",elementType:"geometry",stylers:[{color:"#193341"}]},{featureType:"landscape",elementType:"geometry",stylers:[{color:"#2c5a71"}]},{featureType:"road",elementType:"geometry",stylers:[{color:"#29768a"},{lightness:-37}]},{featureType:"poi",elementType:"geometry",stylers:[{color:"#406d80"}]},{featureType:"transit",elementType:"geometry",stylers:[{color:"#406d80"}]},{elementType:"labels.text.stroke",stylers:[{visibility:"on"},{color:"#3e606f"},{weight:2},{gamma:.84}]},{elementType:"labels.text.fill",stylers:[{color:"#ffffff"}]},{featureType:"administrative",elementType:"geometry",stylers:[{weight:.6},{color:"#1a3541"}]},{elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"poi.park",elementType:"geometry",stylers:[{color:"#2c5a71"}]}]})},1e3),e.$watchCollection("filters",function(){g&&(s.cancel(g),g=null),g=s(p,1e3)})}}}])}();;;;
!function(){var e=angular.module("cab9.widgets");e.directive("uniqueDriverPassenger",["$UI","$config","$http","$q","$filter","$timeout",function(e,r,t,n,o,i){return{templateUrl:"/webapp/common/widgets/unique-driver-passenger.widget.html",scope:{filters:"="},link:function(e,o,u){function d(){e.deferred=n.defer(),t({url:r.API_ENDPOINT+"api/reports/booking",method:"GET",params:{from:e.filters.from,to:e.filters.to,groupbyentity:"DriverId"}}).then(function(n){e.uniqueDrivers=n.data.Grouped.length,t({url:r.API_ENDPOINT+"api/reports/booking",method:"GET",params:{from:e.filters.from,to:e.filters.to,groupbyentity:"LeadPassengerId"}}).then(function(r){e.uniquePassengers=r.data.Grouped.length,e.deferred.resolve(!0)},function(r){e.deferred.reject("An Error Occured")})},function(r){e.deferred.reject("An Error Occured")})}e.deferred=null;var f=null;e.refresh=d,e.$watchCollection("filters",function(){f&&(i.cancel(f),f=null),f=i(d,500)})}}}])}();;;;
!function(){var e=angular.module("cab9.widgets");e.directive("clientReport",["$UI","$config","$http","$q","$filter","$timeout",function(e,t,n,r,l,i){return{templateUrl:"/webapp/common/widgets/client-report.tmpl.html",scope:{filters:"="},link:function(e,l,o){function a(){e.deferred=r.defer(),e.clients.length=0,e.bestClient=null,n({url:t.API_ENDPOINT+"api/reports/booking",method:"GET",params:{from:e.filters.from,to:e.filters.to,groupbyentity:"ClientId"}}).then(function(r){e.clients=r.data.Grouped,e.bestClient=r.data.Grouped[0];for(var l=0;l<e.clients.length;l++)e.clients[l].ImageUrl&&"h"===e.clients[l].ImageUrl[0]||(e.clients[l].ImageUrl=window.formatImage(e.clients[l].ImageUrl,e.clients[l].Name));e.deferred.resolve(!0),e.bestClient&&n({url:t.API_ENDPOINT+"/api/reports/booking",method:"GET",params:{from:e.filters.from,to:e.filters.to,ClientIds:"'"+e.bestClient.ClientId+"'",periodlength:"dd"}}).then(function(e){var t=[];angular.forEach(e.data.Grouped,function(e){t.push(e.Bookings)});var n={type:"line",lineColor:"#8755DE",fillColor:"#8755DE",width:"100%",height:"64px"};$("#client-sparkline").sparkline(t,n)},function(e){})},function(t){e.deferred.reject("An Error Occured")})}e.deferred=null;var c=null;e.refresh=a,e.clients=[],e.$watchCollection("filters",function(){c&&(i.cancel(c),c=null),c=i(a,500)})}}}])}();;;;
!function(){var r=angular.module("cab9.widgets");r.directive("driverReport",["$UI","$config","$http","$q","$filter","$timeout",function(r,e,t,i,o,n){return{templateUrl:"/webapp/common/widgets/driver-report.tmpl.html",scope:{filters:"="},link:function(r,o,l){function d(){r.deferred=i.defer(),r.drivers.length=0,r.bestDriver=null,t({url:e.API_ENDPOINT+"api/reports/booking",method:"GET",params:{from:r.filters.from,to:r.filters.to,groupbyentity:"DriverId"}}).then(function(i){r.drivers=i.data.Grouped,r.bestDriver=i.data.Grouped[0];for(var o=0;o<r.drivers.length;o++)r.drivers[o].ImageUrl&&"h"===r.drivers[o].ImageUrl[0]||(r.drivers[o].ImageUrl=formatImage(r.drivers[o].ImageUrl,r.drivers[o].Callsign));r.deferred.resolve(!0),r.bestDriver&&t({url:e.API_ENDPOINT+"/api/reports/booking",method:"GET",params:{from:r.filters.from,to:r.filters.to,DriverIds:"'"+r.bestDriver.DriverId+"'",periodlength:"dd"}}).then(function(r){var e=[];angular.forEach(r.data.Grouped,function(r){e.push(r.Bookings)});var t={type:"line",lineColor:"#0491F1",fillColor:"#0783d8",width:"100%",height:"64px"};$("#driver-sparkline").sparkline(e,t)},function(r){})},function(e){r.deferred.reject("An Error Occured")})}var a=null;r.refresh=d,r.drivers=[],r.$watchCollection("filters",function(){a&&(n.cancel(a),a=null),a=n(d,500)})}}}])}();;;;
!function(){var e=angular.module("cab9.widgets");e.directive("passengerReport",["$UI","$config","$http","$q","$filter","$timeout",function(e,r,s,n,t,a){return{templateUrl:"/webapp/common/widgets/passenger-report.tmpl.html",scope:{filters:"=",client:"="},link:function(e,t,o){function l(){e.deferred=n.defer(),e.passengers.length=0,e.bestPassenger=null;var t={from:e.filters.from,to:e.filters.to,groupbyentity:"LeadPassengerId"};e.client&&(t.ClientIds="'"+e.client+"'"),s({url:r.API_ENDPOINT+"api/reports/booking",method:"GET",params:t}).then(function(n){e.passengers=n.data.Grouped,e.bestPassenger=n.data.Grouped[0];for(var t=0;t<e.passengers.length;t++)e.passengers[t].ImageUrl&&"h"===e.passengers[t].ImageUrl[0]||(e.passengers[t].ImageUrl=formatImage(e.passengers[t].ImageUrl,e.passengers[t].Name));e.deferred.resolve(!0),e.bestPassenger&&s({url:r.API_ENDPOINT+"/api/reports/booking",method:"GET",params:{from:e.filters.from,to:e.filters.to,PassengerIds:"'"+e.bestPassenger.LeadPassengerId+"'",periodlength:"dd"}}).then(function(r){e.myvalues=[],angular.forEach(r.data.Grouped,function(r){e.myvalues.push(r.Bookings)});var s={type:"line",lineColor:"#D06609",fillColor:"#D06609",width:"100%",height:"64px"};$("#passenger-sparkline").sparkline(e.myvalues,s)},function(e){})},function(r){e.deferred.reject("An Error Occured")})}e.deferred=null;var i=null;e.refresh=l,e.passengers=[],e.$watchCollection("filters",function(){i&&(a.cancel(i),i=null),i=a(l,500)})}}}])}();;;;
!function(){var e=angular.module("cab9.widgets");e.directive("weatherReport",["$UI","$config","$http","$q","$rootScope","$filter","$timeout",function(e,a,t,n,r,o,d){return{templateUrl:"/webapp/common/widgets/weather-report.tmpl.html",scope:{filters:"="},link:function(e,a,t){function o(){e.deferred=n.defer(),e.weather=null;var a="06f9ca9efaeb898189c736f7bbf7edaa",t="https://api.forecast.io/forecast/";$(function(){$.getJSON(t+a+"/"+r.COMPANY.BaseLatitude+","+r.COMPANY.BaseLongitude+"?units=si&callback=?",function(a){var t=new Skycons({color:"#fff"});t.add("canvas-icon-today",a.currently.icon),t.add("canvas-icon-tomorrow",a.daily.data[2].icon),t.add("canvas-icon-dayafter",a.daily.data[3].icon),t.add("canvas-icon-dayafter1",a.daily.data[4].icon),e.weather=a,e.weatherWithFormat=function(e){if(e)return Math.round(e)+"C"},e.weather.now=Math.round(a.currently.temperature)+"C",e.weather.todayMin=Math.round(a.daily.data[0].temperatureMin)+"C",e.weather.daily.data.map(function(e){e._DateTime=new moment("1970-01-01").add(e.time,"seconds").format("dddd")}),t.play()})}),d(function(){e.deferred.resolve(!0)},1e3)}function i(){var a=reports.getFileName(e.filters);CSV.download(dataset.data.map(function(e){return{date:new moment.utc(e[0]).format("DD/MM/YYYY HH:mm"),value:e[1]}}),"user-stats"+a)}e.deferred=null;var c=null;e.refresh=o,e.download=i,e.$watchCollection("filters",function(){c&&(d.cancel(c),c=null),c=d(o,500)})}}}])}();;;;
!function(){var t=angular.module("cab9.widgets");t.directive("twitter",["$UI","$config","$http","$q","$filter","$timeout",function(t,e,i,n,r,l){return{templateUrl:"/webapp/common/widgets/twitter.tmpl.html",scope:{filters:"=",height:"="},link:function(t,e,i){}}}])}();;;;
!function(){var t=angular.module("cab9.widgets");t.directive("staffReport",["$rootScope","$state","$UI","$config","$http","$q","$filter","$timeout",function(t,e,f,r,o,a,n,l){return{templateUrl:"/webapp/common/widgets/staff-report.tmpl.html",scope:{filters:"=",client:"="},link:function(f,n,i){function s(){f.deferred=a.defer(),f.staff.length=0,f.bestStaff=null,o({url:r.API_ENDPOINT+"api/reports/booking",method:"GET",params:{from:f.filters.from,to:f.filters.to,ClientIds:"'"+f.client+"'",groupbyentity:"ClientStaffId"}}).then(function(t){f.staff=t.data.Grouped,f.bestStaff=t.data.Grouped[0];for(var e=0;e<f.staff.length;e++)f.staff[e].ImageUrl&&"h"===f.staff[e].ImageUrl[0]||(f.staff[e].ImageUrl=formatImage(f.staff[e].ImageUrl,f.staff[e].Name));f.deferred.resolve(!0),f.bestStaff&&o({url:r.API_ENDPOINT+"/api/reports/booking",method:"GET",params:{from:f.filters.from,to:f.filters.to,ClientStaffIds:"'"+f.bestStaff.ClientStaffId+"'",periodlength:"dd"}}).then(function(t){var e=[];angular.forEach(t.data.Grouped,function(t){e.push(t.Bookings)});var f={type:"line",lineColor:"#8755DE",fillColor:"#8755DE",width:"100%",height:"64px"};$("#staff-sparkline").sparkline(e,f)},function(t){})},function(t){f.deferred.reject("An Error Occured")})}f.deferred=null;var d=null;f.refresh=s,f.staff=[],openStaff=function(r){t.CLIENTID?e.go("root.bookers.viewer.details",{sId:r.ClientStaffId}):e.go("root.clients.viewer.staff.viewer.details",{Id:f.client,sId:r.ClientStaffId})},f.openStaff=openStaff,f.$watchCollection("filters",function(){d&&(l.cancel(d),d=null),d=l(s,500)})}}}])}();;;;