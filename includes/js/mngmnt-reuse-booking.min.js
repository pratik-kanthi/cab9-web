!function(e){function t(t,n,o,s,a,l,r,d,u,c,m,g,f,h){function p(){"EDIT"==t.viewMode&&(t.item.ChauffeurMode=!0,t.item.EstimatedMins=60)}function C(){"EDIT"==t.viewMode&&(t.item.ChauffeurMode=!1,t.item.EstimatedMins=null)}function I(e){var n=f.timeZone().getTimeZone()||"Europe/London",i=moment(e).toDate(),o=i.getTimezoneOffset(),s=moment.tz.zone(n).offset(i),a=new moment.tz(e,"YYYY-MM-DDTHH:mm",n).add(o-s,"minutes");t.item.Date=a.toDate(),t.item.Time=a.toDate()}function k(){t.item.FlightInfo=null,t.item.FlightInfoId=null,t.flightData.Number=null}function A(){t.item.FlightInfo=null,t.flightData.Number.length>0?l({url:r.API_ENDPOINT+"/api/flightinfo/getflightinfo",method:"GET",params:{flightno:t.flightData.Number,flightDate:M(t.item.Date,t.item.Time)}}).then(function(e){if(e.data){e.data.Id=null,e.data.BookingId=null,e.data.TenantId=null,t.item.FlightInfo=new d.FlightInfo(e.data);var n=f.timeZone().getTimeZone(),i=moment(t.item.FlightInfo.ArrivalTime).toDate(),o=i.getTimezoneOffset(),s=moment.tz.zone(n).offset(i),a=new moment.tz(t.item.FlightInfo.ArrivalTime,n).add(o-s,"minutes");if(t.item.Time=a.toDate(),t.timeSet=!0,e.data.SuggestedAddressId&&t.item.BookingStops[0].$$Id!=e.data.SuggestedAddressId){var l=e.data.SuggestedAddressId;d.Location.query().where("Id eq guid'"+e.data.SuggestedAddressId+"'").execute().then(function(e){var n=new d.BookingStop;n.Address1=e[0].Name?e[0].Name:"",n.StopSummary=e[0].Name?e[0].Name:"",n.Latitude=e[0].Latitude?e[0].Latitude:null,n.Longitude=e[0].Longitude?e[0].Longitude:null,n.$$Id=l,n.WaitTime=t.item.BookingStops[0].WaitTime,center_moved=!1,t.item.BookingStops[0]=n})}}else swal("Flight Not Found","Please check flight number.","warning")},function(e){swal("Incorrect Flight Number","Please check flight number.","warning")}):swal("Incorrect Flight Number","Please check flight number.","warning")}function w(e){t.item.WaitAndReturn&&t.item.BookingStops.length<4?swal("Cannot remove via Stop","WaitAndReturn booking should have a via stop","warning"):t.item.BookingStops.splice(e,1),t.item.BookingStops.length<3&&(t.sortableOptions.disabled=!0)}function B(){if(d.Client.query().select("Id,Name,AccountNo,AccountPassword,DefaultCurrencyId,ImageUrl,ClientType/Name,ClientReferences,AllVehicleTypeAccess,Phone").include("ClientType,ClientReferences").parseAs(function(e){this.Id=e.Id,this.Name=(e.AccountNo?e.AccountNo+" - ":"")+e.Name,this.DefaultCurrencyId=e.DefaultCurrencyId,this.Description=e.ClientType.Name,this.Phone=e.Phone,this.AccountPassword=e.AccountPassword,this.ImageUrl=$utilities.formatUrl(e.ImageUrl,e.Name),this.AllVehicleTypeAccess=e.AllVehicleTypeAccess,this.ClientReferences=e.ClientReferences.map(function(e){return{Id:e.Id,ReferenceName:e.ReferenceName,Mandatory:e.Mandatory,AllowAddToList:e.AllowAddToList,Value:e.Value,ReferenceType:e.ReferenceType}})}).execute().then(function(e){t.clients=e}),d.VehicleType.query().parseAs(function(e){this.Id=e.Id,this.Name=e.Name,this.Description=e.Description,this.IsDefault=e.IsDefault,this.ImageUrl=null}).execute().then(function(e){t.client.AllVehicleTypeAccess?t.vehicleTypes=t._vehicleTypes=e:t.vehicleTypes=t.client.VehicleTypes}),d.BookingRequirement.query().execute().then(function(n){t.bookingRequirements=t.unlinkedRequirements=n,e.forEach(t.item.BookingRequirements,function(e){var n=t.unlinkedRequirements.filter(function(t){return t.Id==e.Id});n[0]&&t.unlinkedRequirements.splice(t.unlinkedRequirements.indexOf(n[0]),1)})}),d.ClientStaff.query().filter("ClientId eq guid'"+t.item.ClientId+"'").parseAs(function(e){this.Id=e.Id,this.ClientId=e.ClientId,this.Name=e.Firstname+" "+e.Surname,this.Mobile=e.Mobile,this.ImageUrl=$utilities.formatUrl(e.ImageUrl,e.Name)}).execute().then(function(e){t.bookers=e,t.bookers.push({Id:"add-booker",Name:"Add Booker",Description:"Create New Booker",ImageUrl:"/includes/images/add-icon.png"})}),[].push.apply(t.externalLocations.knownLocations,t.client.KnownLocations),t.client.Latitude&&t.client.Longitude){var n="";t.client.Address1&&t.client.Address1.length>1&&(n+=t.client.Address1),t.client.TownCity?(n.length>0&&(n+=", "),n+=t.client.TownCity):t.client.Area&&(n.length>0&&(n+=", "),n+=t.client.Area),t.client.Postcode&&(n.length>0&&(n+=", "),n+=t.client.Postcode),t.externalLocations.knownLocations.push({Address1:t.client.Address1,Address2:t.client.Address2,Area:t.client.Area,TownCity:t.client.TownCity,County:t.client.County,Postcode:t.client.Postcode,Country:t.client.Country,Latitude:t.client.Latitude,Longitude:t.client.Longitude,Name:"Office Address",StopSummary:n,LocationType:"OFFICE"})}t.item.CurrencyId=t.client.DefaultCurrencyId,e.forEach(t.item.LeadPassenger.Addresses,function(e){if(e.Latitude&&e.Longitude){var n="";e.Address1&&e.Address1.length>1&&(n+=e.Address1),e.TownCity?(n.length>0&&(n+=", "),n+=e.TownCity):e.Area&&(n.length>0&&(n+=", "),n+=e.Area),e.Postcode&&(n.length>0&&(n+=", "),n+=e.Postcode),t.externalLocations.knownLocations.push({Address1:e.Address1,Address2:e.Address2,Area:e.Area,TownCity:e.TownCity,County:e.County,Postcode:e.Postcode,Country:e.Country,Latitude:e.Latitude,Longitude:e.Longitude,Name:e.Name,StopSummary:e.StopSummary||n,LocationType:"Passenger Address"})}})}function y(e){t.item.BookingRequirements.push(e);var n=t.unlinkedRequirements.filter(function(t){return t.Id==e.Id});n[0]&&t.unlinkedRequirements.splice(t.unlinkedRequirements.indexOf(n[0]),1),t.item.$selectedRequirement=null}function L(e){e?t.fetchedClients=h("filter")(t.clients,{Name:e}):t.fetchedClients=[]}function T(e){var t=c.filter(function(t){return t.Id==e})[0];if(t)return t.Name}function v(e){t.unlinkedRequirements.push(e);var n=t.item.BookingRequirements.filter(function(t){return t.Id==e.Id});n[0]&&t.item.BookingRequirements.splice(t.item.BookingRequirements.indexOf(n[0]),1)}function S(e,t){t?l({method:"GET",url:r.API_ENDPOINT+"/api/ClientReferences/suggest?ClientReferenceId="+e.Id+"&Value="+t}).then(function(t){e.$suggested=t.data.map(function(e){return{custom:!1,text:e}}),e.$originalValue&&e.$suggested.unshift(e.$originalValue),e.AllowAddToList&&e.$suggested.push({custom:!0,text:"Add '{{$select.search}}' to References"})},function(t){e.$suggested=[e.$originalValue]}):e.$suggested=[e.$originalValue]}function P(e){for(var t="[a-z]",n="[A-Z]",i="[0-9]",o="^",s=0,a=!1,l=!1,r=0;r<e.length;r++){var d=e[r];if("'"===d)o+=l?")":"(",l=!l;else if(l)["."].indexOf(d)!=-1&&(d="\\"+d),o+=d;else if(">"===d){if(s++,s>1)throw"Bad Mask - Case blocks have consecutive > without ending previous block"}else if("<"===d){if(s--,s<-1)throw"Bad Mask - Case blocks have consecutive < without ending previous block"}else"0"===d?(a=!0,o+="("+i+")"):"9"===d?o+="("+i+"?)":1===s?"A"===d?(a=!0,o+="("+n+"|"+i+")"):"a"===d?o+="("+n+"?|"+i+"?)":"L"===d?(a=!0,o+="("+n+")"):"l"===d&&(o+="("+n+"?)"):0===s?"A"===d?(a=!0,o+="("+t+"|"+n+"|"+i+")"):"a"===d?o+="("+t+"?|"+n+"?|"+i+"?)":"L"===d?(a=!0,o+="("+t+"|"+n+")"):"l"===d&&(o+="("+t+"?|"+n+"?)"):s===-1&&("A"===d?(a=!0,o+="("+t+"|"+i+")"):"a"===d?o+="("+t+"?|"+i+"?)":"L"===d?(a=!0,o+="("+t+")"):"l"===d&&(o+="("+t+"?)"))}if(l)throw"Bad Mask - Quoted section not terminated";if(!a)throw"Bad Mask - Must contain at least 1 mandatory symbol (A, L, 0)";return o+="$",new RegExp(o)}function R(){if(t.clientReferences.length>0)for(var e=0;e<t.clientReferences.length;e++){var n=t.clientReferences[e];if("Mask"==n.ReferenceType)return!(n.$testReg.test(n.$knownValue)||!n.$knownValue&&!n.Mandatory)}return!1}function N(){window.close()}function D(){var e=t.item.BookingStops[0];t.item.BookingStops[0]=t.item.BookingStops[1],t.item.BookingStops[1]=e}function b(n){t.passengers.length=0,l.get(r.API_ENDPOINT+"api/Passengers/Search",{params:{searchText:n,clientId:t.item.ClientId}}).success(function(n){e.forEach(n,function(e){e.Client&&(e.Client.ImageUrl=$utilities.formatUrl(e.Client.ImageUrl,e.Client.Name)),t.passengers.push({Id:e.Id,ClientId:e.ClientId,Name:e.Firstname+" "+e.Surname,Description:e.Client&&e.Client.Name?e.Client.Name:"No Client",Mobile:e.Mobile,Addresses:e.Addresses,ImageUrl:$utilities.formatUrl(e.ImageUrl,e.Firstname)})}),t.passengers.push({Id:"add-passenger",Name:"Add Passenger",Description:"Create New Passenger",ImageUrl:"/includes/images/add-icon.png"})})}function E(n){t.item.ClientId&&(t.bookers.length=0,l.get(r.API_ENDPOINT+"api/Bookers/Search",{params:{searchText:n,clientId:t.item.ClientId}}).success(function(n){e.forEach(n,function(e){e.Client&&(e.Client.ImageUrl=$utilities.formatUrl(e.Client.ImageUrl,e.Client.Name)),t.bookers.push({Id:e.Id,ClientId:e.ClientId,Name:e.Firstname+" "+e.Surname,Description:e.Client&&e.Client.Name?e.Client.Name:"No Client",Mobile:e.Mobile,ImageUrl:$utilities.formatUrl(e.ImageUrl,e.Firstname)})}),t.bookers.push({Id:"add-booker",Name:"Add Booker",Description:"Create New Booker",ImageUrl:"/includes/images/add-icon.png"})}))}function M(e,t){function n(e,t){var n="000000000"+e;return n.substr(n.length-t)}var i=e.getFullYear(),o=e.getMonth(),s=e.getDate(),a=t.getHours(),l=t.getMinutes(),r=n(i,4)+"-"+n(o+1,2)+"-"+n(s,2)+"T"+n(a,2)+":"+n(l,2)+":00",d=moment.tz(r,"YYYY-MM-DDTHH:mm:ss",f.timeZone().getTimeZone()).format();return d}function V(e){e.BookedDateTime=M(t.item.Date,t.item.Time),e.BookingStatus="Incoming",t.quoting.inprogress=!0;for(var n=0;n<t.item.BookingStops.length;n++)t.item.BookingStops[n].StopOrder=n+1;Q=!0,l.post(r.API_ENDPOINT+"api/quote",e).success(function(n){n.Error?(e.EstimatedCost=0,e.EstimatedDistance=0,e.EstimatedDuration=0,e.ActualCost=0,t.directions=null,e.EncodedRoute=""):(e.EstimatedCost=n.FinalCost,e.EstimatedDistance=n.EstimatedDistance.toFixed(2),e.EstimatedDuration=n.EstimatedMins,e.ActualCost=n.FinalCost,n.Directions?e.EncodedRoute=n.Directions.EncodedRoute:e.EncodedRoute="",t.directions=n.Directions),t.quote=n,t.quoting.inprogress=!1}).error(function(e){t.quoting.inprogress=!1,console.log(e),swal("Could not quote","Could not quote, please manually price and set driver payment amount for this booking.","warning")})}function q(e){var n=new d.BookingStop;n.id=idCounter++,t.item.WaitAndReturn?t.item.BookingStops.splice(e,0,n):t.item.BookingStops.splice(e+1,0,n),t.item.BookingStops.length>2&&(t.sortableOptions.disabled=!1)}function x(e,n){var i=f.timeZone().getTimeZone(),o=(new Date).getTimezoneOffset(),s=moment.tz.zone(i).offset(new Date),a=new moment.tz(i).add(o-s,"minutes");"day"==n?t.item.Date=a.add(e,"minutes").toDate():"time"==n&&(t.item.Time=a.startOf("minute").add(e,"minutes").toDate())}function U(){t.item.BookingStops.reverse()}function F(){$("#bookingsave").prop("disabled",!0);var e=[];t.newBooker&&t.newBooker.Id==t.item.ClientStaffId&&(t.newBooker.Passengers=[],t.newBooker.Passengers.push(t.item.LeadPassenger),l.post(r.API_ENDPOINT+"api/ClientStaff/ManagePassengers",t.newBooker).then(function(e){},function(e){swal({title:"Error adding passenger to booker",text:"Some error has occured.",type:"error",confirmButtonColor:n.COLOURS.brandSecondary})}));var i=t.item;if(t.paxMode.value){if(!i._LeadPassenger)return void swal("Invalid","Please add passenger details.","error");var s=i._LeadPassenger.split(" ");t.item.LeadPassenger={Firstname:s[0],Surname:s.slice(1).join(" "),Mobile:i._LeadPassengerNumber,ClientId:i.ClientId}}if(t.item.BookingValidations=[],t.clientReferences.length>0)for(var a=0;a<t.clientReferences.length;a++){var u=t.clientReferences[a],c=new d.BookingValidation;c.ClientReferenceId=u.Id,"List"==u.ReferenceType?c.Value=u.$knownValue&&u.$knownValue.text:c.Value=u.$knownValue,c.Value&&t.item.BookingValidations.push(c)}t.item.BookedDateTime=M(t.item.Date,t.item.Time),t.item.LeadPassenger=void 0,t.item.Client=void 0,t.item.Driver=void 0,t.item.VehicleType=void 0,t.item.Currency=void 0,e.push(t.item.$save()),o.all(e).then(function(e){var t=e[e.length-1].data.LocalId;swal({title:"Booking Saved.",text:"Booking Reference: #"+t,type:"success",showCancelButton:!1,confirmButtonColor:n.COLOURS.brandPrimary,confirmButtonText:"Okay",closeOnConfirm:!0},function(){window.close()})},function(e){t.dataReady=!0,swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error"})})}var O=[];t.viewMode="EDIT",t.repeat=!0,t.item=e.copy(u[0]),t.item.Id=null,t.item.FlightInfoId=null,t.flightData={Number:""},t.showInactiveReferences=!1;var Q=!1;for(t.item.LocalId=null,t.item.DriverId=null,t.item.VehicleId=null,t.item.DriverPaymentId=null,t.item.BookingStops=t.item.BookingStops.sort(function(e,t){return e.StopOrder-t.StopOrder}),t.item.BookingStops=t.item.BookingStops.map(function(e){return e.Id=null,e.BookingId=null,e}),t.canQuote=!0,t.item.BookingValidations=t.item.BookingValidations.map(function(e){return e.Id=null,e.BookingId=null,e}),t.newBooker=null,t.bookers=[],t.externalLocations={knownLocations:g[0].KnownLocations?g[0].KnownLocations:[]},t.quoting={},t.paxMode={value:!1},t.sortableOptions={stop:function(e,t){},ondragstart:function(e,t){},disabled:!(t.item.BookingStops.length>2)},t.removeStop=w,t.bookingInfo=!0,t.save=F,t.close=N,t.formFor={},t.testMaskReferences=R,t.reverseStops=U,t.suggestReferences=S,t.addRequirement=y,t.removeRequirement=v,t.fetchedClients=[t.item.Client],t.clientReferences=[],t.client=t.item.Client,t.taxes=c,t.searchBookers=E,t.searchPassengers=b,t.searchClients=L,t.flipAddress=D,I(moment().add(15,"minutes").format("YYYY-MM-DDTHH:mm")),t.fetchFlightInformation=A,t.removeFlightInfo=k,t.enableChauffering=p,t.disableChauffering=C,t.item.FlightInfo&&(t.flightData.Number=t.item.FlightInfo.FlightNumber,t.item.FlightInfo.Id=null,A()),t.$watch("item.Date",function(e,n){t.flightData.Number&&e&&e!=n&&A()}),j=0,leng=t.client.ClientReferences.length;j<leng;j++){for(i=0,len=t.item.BookingValidations.length;i<len;i++)if(t.client.ClientReferences[j].Id==t.item.BookingValidations[i].ClientReferenceId&&(t.client.ClientReferences[j].$knownValue=t.item.BookingValidations[i].Value,t.client.ClientReferences[j].$id=t.item.BookingValidations[i].Id,"List"==t.client.ClientReferences[j].ReferenceType)){var Y={custom:!1,text:t.item.BookingValidations[i].Value};t.client.ClientReferences[j].$knownValue=Y,t.client.ClientReferences[j].$originalValue=Y,t.client.ClientReferences[j].$suggested=[Y]}if("Mask"==t.client.ClientReferences[j].ReferenceType&&(t.client.ClientReferences[j].$testReg=P(t.client.ClientReferences[j].Value)),"List"==t.client.ClientReferences[j].ReferenceType&&t.client.ClientReferences[j].ShowList){var z=t.client.ClientReferences[j];l({method:"GET",url:r.API_ENDPOINT+"/api/ClientReferences/list?ClientReferenceId="+t.client.ClientReferences[j].Id}).then(function(e){z.$list=e.data.map(function(e){return{custom:!1,text:e}}),z.AllowAddToList&&z.$list.push({custom:!0,text:"Add '{{$select.search}}' to References"})})}t.clientReferences.push(t.client.ClientReferences[j])}B(),t.getTaxName=T,t.addTime=x,t.addStop=q,t.$watch("item.BookingStops[0]",function(n,i){if(void 0!==i&&n!==i&&t.item.WaitAndReturn){var o=new d.BookingStop(e.copy(t.item.BookingStops[0]));o.id=idCounter++,o.Id=null,t.item.BookingStops.splice(t.item.BookingStops.length-1,1,o)}},!0),t.$watch("item.WaitAndReturn",function(n,i){if(void 0!==i&&n!==i){if(n===!1){t.item.BookingStops.splice(t.item.BookingStops.length-1,1);var o=new d.BookingStop;o.id=idCounter++,t.item.BookingStops.push(o)}else if(n===!0){var o=new d.BookingStop(e.copy(t.item.BookingStops[0]));o.id=idCounter++,o.Id=null,t.item.BookingStops.push(o)}t.canQuote=!0,e.forEach(t.item.BookingStops,function(e,n){e.Latitude&&e.Longitude||(t.canQuote=!1)})}}),t.$watch("item.Date",function(e,n){t.flightData.Number&&e&&e!=n&&A()}),t.$watch("item.BookingStops",function(n,i){void 0!==i&&n!==i&&(t.canQuote=!0,e.forEach(n,function(e,n){e.Latitude&&e.Longitude||(t.canQuote=!1)}),t.canQuote?V(t.item):(t.item.EstimatedCost=0,t.item.ActualCost=0,t.quote=null,t.directions=null))},!0),t.$watchGroup(["item.Date","item.Time"],function(n){var i=M(n[0],n[1]);new moment(i).isSame(t.item.BookedDateTime)||(t.item.BookedDateTime=i,t.canQuote=!0,t.timeSet||(t.item.FlightInfo=null),t.timeSet=!1,e.forEach(t.item.BookingStops,function(e,n){e.Latitude&&e.Longitude||(t.canQuote=!1)}),t.canQuote?V(t.item):(t.item.EstimatedCost=0,t.item.ActualCost=0,t.quote=null,t.directions=null))}),t.$watch("item.ClientStaffId",function(e){if("add-booker"===e){var n=s.open({templateUrl:"/webapp/common/modals/booker/modal.html",controller:"BookerCreateController",resolve:{rBooker:function(){var e=new d.ClientStaff;return e.Phone=t.clients.filter(function(e){return e.Id==t.item.ClientId})[0].Phone,e.ClientId=t.item.ClientId,e}}});n.result.then(function(e){var n={Id:e.Id,ClientId:e.ClientId,Name:e.Firstname+" "+e.Surname,Description:e.Email?e.Email:"",Mobile:e.Mobile,ImageUrl:$utilities.formatUrl(e.ImageUrl,e.Name)};t.newBooker=e,t.bookers.push(n),t.item.ClientStaffId=e.Id},function(){t.item.ClientStaffId=null})}}),t.$watchGroup(["item.AsDirected","item.ChauffeurMode","item.EstimatedMins","item.ActualDistance","item.BookingStops.length"],function(n,i){if(void 0!==i[0]&&"VIEW"!=t.viewMode){if(t.item.AsDirected===!0)t.item.BookingStops.length=1;else if(1==t.item.BookingStops.length){var o=new d.BookingStop;o.id=idCounter++,t.item.BookingStops.push(o)}t.canQuote=!0,e.forEach(t.item.BookingStops,function(e,n){e.Latitude&&e.Longitude||(t.canQuote=!1)}),t.item.EstimatedCost=0,t.item.ActualCost=0,t.quote=null,t.directions=null,t.canQuote&&V(t.item)}});var _=!0;t.$watch("item.ClientId",function(n){if(_)setTimeout(function(){_=!1},0);else{if(t.bookers=[{Id:"add-booker",Name:"Add Booker",Description:"Create New Booker",ImageUrl:"/includes/images/add-icon.png"}],t.passengers=[{Id:"add-passenger",Name:"Add Passenger",Description:"Create New Passenger",ImageUrl:"/includes/images/add-icon.png"}],t.externalLocations.knownLocations.length=0,n){t.item.ClientStaffId=null;var i=t.clients.filter(function(e){return e.Id==n})[0];i.AccountPassword&&swal({title:"Account Password",text:"This account is password enabled.",type:"input",showCancelButton:!0,closeOnConfirm:!1,animation:"slide-from-top",inputPlaceholder:"Account Password"},function(e){return e===!1?(t.item.ClientId=null,t.$apply(),!1):""===e?(swal.showInputError("You need to write something!"),!1):e!=i.AccountPassword?(swal.showInputError("Incorrect Password"),!1):void swal("Accepted","The password is valid. Please continue with the booking.","success")}),t.clientReferences=e.copy(i.ClientReferences),t.clientReferences.map(function(e){return"Mask"==e.ReferenceType&&(e.$testReg=P(e.Value)),e}),t.selectedClient=i,i?i.AllVehicleTypeAccess===!1&&d.Client.query().where("Id eq guid'"+n+"'").include("VehicleTypes").select("VehicleTypes").execute().then(function(e){t.vehicleTypes=e[0].VehicleTypes.map(function(e){return e.ImageUrl=null,e}),t.item.VehicleTypeId=t.filteredVehicleTypes[0].Id}):t.vehicleTypes=t._vehicleTypes,d.Client.query().where("Id eq guid'"+n+"'").include("KnownLocations").select("KnownLocations,Address1,Address2,Area,TownCity,County,Postcode,Country,Latitude,Longitude,BillingAddress1,BillingAddress2,BillingArea,BillingTownCity,BillingCounty,BillingPostcode,BillingCountry,BillingLatitude,BillingLongitude").execute().then(function(e){if([].push.apply(t.externalLocations.knownLocations,e[0].KnownLocations),e[0].Latitude&&e[0].Longitude){var n="";e[0].Address1&&e[0].Address1.length>1&&(n+=e[0].Address1),e[0].TownCity?(n.length>0&&(n+=", "),n+=e[0].TownCity):e[0].Area&&(n.length>0&&(n+=", "),n+=e[0].Area),e[0].Postcode&&(n.length>0&&(n+=", "),n+=e[0].Postcode),t.externalLocations.knownLocations.push({Address1:e[0].Address1,Address2:e[0].Address2,Area:e[0].Area,TownCity:e[0].TownCity,County:e[0].County,Postcode:e[0].Postcode,Country:e[0].Country,Latitude:e[0].Latitude,Longitude:e[0].Longitude,Name:"Office Address",StopSummary:n,LocationType:"OFFICE"})}if(e[0].BillingLatitude&&e[0].BillingLongitude&&e[0].BillingLatitude!=e[0].Latitude&&e[0].Longitude!=e[0].BillingLongitude){var n="";e[0].BillingAddress1&&e[0].BillingAddress1.length>1&&(n+=e[0].BillingAddress1),e[0].BillingTownCity?(n.length>0&&(n+=", "),n+=e[0].BillingTownCity):e[0].BillingArea&&(n.length>0&&(n+=", "),n+=e[0].BillingArea),e[0].BillingPostcode&&(n.length>0&&(n+=", "),n+=e[0].BillingPostcode),t.externalLocations.knownLocations.push({Address1:e[0].BillingAddress1,Address2:e[0].BillingAddress2,Area:e[0].BillingArea,TownCity:e[0].BillingTownCity,County:e[0].BillingCounty,Postcode:e[0].BillingPostcode,Country:e[0].BillingCountry,Latitude:e[0].BillingLatitude,Longitude:e[0].BillingLongitude,Name:"Billing Address",StopSummary:n,LocationType:"OFFICE"})}})}else t.item.ClientStaffId=null,t.item.LeadPassengerId=null,t.fetchedClients=[],t.clientReferences.length=0,t.selectedClient=null;if(t.item.ClientId){var o=t.clients.filter(function(e){return e.Id==t.item.ClientId})[0];o&&(t.item.CurrencyId=o.DefaultCurrencyId)}else t.item.CurrencyId=t.COMPANY.DefaultCurrencyId}},!0),t.passengers=m,t.passengers.push({Id:"add-passenger",Name:"Add Passenger",Description:"Create New Passenger",ImageUrl:"/includes/images/add-icon.png"}),t.bookers=O,t.bookers.push({Id:"add-booker",Name:"Add Booker",Description:"Create New Booker",ImageUrl:"/includes/images/add-icon.png"}),t.$watch("selectedPassenger.Mobile",function(e){t.item.PassengerNotificationPhone=e}),t.$watch("item.LeadPassengerId",function(n){if("add-passenger"===n){t.item.LeadPassengerId=null;var i=s.open({templateUrl:"/webapp/common/modals/passenger/create.modal.html",controller:"PassengerItemCreateModalController",resolve:{rClientId:function(){return t.item.ClientId},rNavigateAfterSave:function(){return!1}}});return void i.result.then(function(e){var n={Id:e.Id,ClientId:e.ClientId,Name:e.Firstname+" "+e.Surname,Description:e.Email?e.Email:"",Mobile:e.Mobile,ImageUrl:$utilities.formatUrl(e.ImageUrl,e.Name)};t.passengers.push(n),t.item.ClientId=e.ClientId,t.item.LeadPassengerId=e.Id},function(){})}var o=t.item;if(n){var a=t.passengers.filter(function(e){return e.Id==n})[0];t.selectedPassenger=a,o.ClientId=a.ClientId,o.PassengerNotificationPhone=a.Mobile,e.forEach(a.Addresses,function(e){if(e.Latitude&&e.Longitude){var n="";e.Address1&&e.Address1.length>1&&(n+=e.Address1),e.TownCity?(n.length>0&&(n+=", "),n+=e.TownCity):e.Area&&(n.length>0&&(n+=", "),n+=e.Area),e.Postcode&&(n.length>0&&(n+=", "),n+=e.Postcode),t.externalLocations.knownLocations.push({Address1:e.Address1,Address2:e.Address2,Area:e.Area,TownCity:e.TownCity,County:e.County,Postcode:e.Postcode,Country:e.Country,Latitude:e.Latitude,Longitude:e.Longitude,Name:e.Name,StopSummary:e.StopSummary||n,LocationType:"Passenger Address"})}})}else o.PassengerNotificationPhone=null}),t.$watch("item.VehicleTypeId",function(n,i){void 0!==i&&n!==i&&(t.canQuote=!0,e.forEach(t.item.BookingStops,function(e,n){e.Latitude&&e.Longitude||(t.canQuote=!1)}),t.canQuote?V(t.item):(t.item.EstimatedCost=0,t.item.ActualCost=0,t.quote=null,t.directions=null))})}var n=e.module("cab9.common");n.controller("BookingReuseModalController",t),t.$inject=["$scope","$UI","$q","$modal","$modalInstance","$http","$config","Model","rBooking","rTaxes","rPassengers","rClients","Localisation","$filter"]}(angular);;;;