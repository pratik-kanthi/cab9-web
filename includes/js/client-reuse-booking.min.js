!function(e){function t(t,n,o,s,r,a,l,d,c,u,m,g,f,p){function h(e){var n=f.timeZone().getTimeZone(),i=moment(e).toDate(),o=i.getTimezoneOffset(),s=moment.tz.zone(n).offset(i),r=new moment.tz(e,"YYYY-MM-DDTHH:mm",n).add(o-s,"minutes");t.item.Date=r.toDate(),t.item.Time=r.toDate()}function C(e){t.item.WaitAndReturn&&t.item.BookingStops.length<4?swal("Cannot remove via Stop","WaitAndReturn booking should have a via stop","warning"):t.item.BookingStops.splice(e,1),t.item.BookingStops.length<3&&(t.sortableOptions.disabled=!0)}function k(){if(c.VehicleType.query().parseAs(function(e){this.Id=e.Id,this.Name=e.Name,this.Description=e.Description,this.IsDefault=e.IsDefault,this.ImageUrl=null}).execute().then(function(e){t.client.AllVehicleTypeAccess?t.vehicleTypes=t._vehicleTypes=e:t.vehicleTypes=t.client.VehicleTypes}),c.BookingRequirement.query().execute().then(function(n){t.bookingRequirements=t.unlinkedRequirements=n,e.forEach(t.item.BookingRequirements,function(e){var n=t.unlinkedRequirements.filter(function(t){return t.Id==e.Id});n[0]&&t.unlinkedRequirements.splice(t.unlinkedRequirements.indexOf(n[0]),1)})}),t.isAdmin?(t.passengers=g,t.fetchedPassengers=t.passengers,c.ClientStaff.query().where("ClientId eq guid'"+t.item.ClientId+"'").select("Id,Firstname,Surname,ImageUrl,Mobile,AllPassengers,Passengers,ClientId,Client/Name").include("Client,Passengers").parseAs(function(e){this.Id=e.Id,this.ClientId=e.ClientId,this.Name=e.Firstname+" "+e.Surname,this.Description=e.Client&&e.Client.Name?e.Client.Name:"No Client",this.AllPassengers=e.AllPassengers,this.Passengers=e.Passengers,this.Mobile=e.Mobile,this.ImageUrl=$utilities.formatUrl(e.ImageUrl,e.Firstname)}).execute().then(function(e){t.bookers=e,t.filteredBookers=t.bookers})):c.ClientStaff.query().filter("Id eq guid'"+t.item.ClientStaffId+"'").include("Passengers/Client").execute().then(function(e){e[0].AllPassengers?(t.passengers=g,t.fetchedPassengers=t.passengers):(t.passengers=e[0].Passengers.map(function(e){var t={};return t.Id=e.Id,t.ClientId=e.ClientId,t.Name=e.Firstname+" "+e.Surname,t.Description=e.Client&&e.Client.Name?e.Client.Name:"No Client",t.Mobile=e.Mobile,t.ImageUrl=$utilities.formatUrl(e.ImageUrl,e.Firstname),t.Addresses=e.Addresses,t}),t.fetchedPassengers=t.passengers)}),[].push.apply(t.externalLocations.knownLocations,t.client.KnownLocations),t.client.Latitude&&t.client.Longitude){var n="";t.client.Address1&&t.client.Address1.length>1&&(n+=t.client.Address1),t.client.TownCity?(n.length>0&&(n+=", "),n+=t.client.TownCity):t.client.Area&&(n.length>0&&(n+=", "),n+=t.client.Area),t.client.Postcode&&(n.length>0&&(n+=", "),n+=t.client.Postcode),t.externalLocations.knownLocations.push({Address1:t.client.Address1,Address2:t.client.Address2,Area:t.client.Area,TownCity:t.client.TownCity,County:t.client.County,Postcode:t.client.Postcode,Country:t.client.Country,Latitude:t.client.Latitude,Longitude:t.client.Longitude,Name:"Office Address",StopSummary:n,LocationType:"OFFICE"})}t.item.CurrencyId=t.client.DefaultCurrencyId,e.forEach(t.item.LeadPassenger.Addresses,function(e){if(e.Latitude&&e.Longitude){var n="";e.Address1&&e.Address1.length>1&&(n+=e.Address1),e.TownCity?(n.length>0&&(n+=", "),n+=e.TownCity):e.Area&&(n.length>0&&(n+=", "),n+=e.Area),e.Postcode&&(n.length>0&&(n+=", "),n+=e.Postcode),t.externalLocations.knownLocations.push({Address1:e.Address1,Address2:e.Address2,Area:e.Area,TownCity:e.TownCity,County:e.County,Postcode:e.Postcode,Country:e.Country,Latitude:e.Latitude,Longitude:e.Longitude,Name:e.Name,StopSummary:e.StopSummary||n,LocationType:"Passenger Address"})}})}function I(e){t.item.BookingRequirements.push(e);var n=t.unlinkedRequirements.filter(function(t){return t.Id==e.Id});n[0]&&t.unlinkedRequirements.splice(t.unlinkedRequirements.indexOf(n[0]),1),t.item.$selectedRequirement=null}function B(e){var t=m.filter(function(t){return t.Id==e})[0];if(t)return t.Name}function S(e){t.unlinkedRequirements.push(e);var n=t.item.BookingRequirements.filter(function(t){return t.Id==e.Id});n[0]&&t.item.BookingRequirements.splice(t.item.BookingRequirements.indexOf(n[0]),1)}function w(e,t){t?l({method:"GET",url:d.API_ENDPOINT+"/api/ClientReferences/suggest?ClientReferenceId="+e.Id+"&Value="+t}).then(function(t){e.$suggested=t.data.map(function(e){return{custom:!1,text:e}}),e.$originalValue&&e.$suggested.unshift(e.$originalValue),e.AllowAddToList&&e.$suggested.push({custom:!0,text:"Add '{{$select.search}}' to References"})},function(t){e.$suggested=[e.$originalValue]}):e.$suggested=[e.$originalValue]}function v(e){for(var t="[a-z]",n="[A-Z]",i="[0-9]",o="^",s=0,r=!1,a=0;a<e.length;a++){var l=e[a];if(">"===l){if(s++,s>1)throw"Bad Mask - Case blocks have consecutive > without ending previous block"}else if("<"===l){if(s--,s<-1)throw"Bad Mask - Case blocks have consecutive < without ending previous block"}else"0"===l?(r=!0,o+="("+i+")"):"9"===l?o+="("+i+"?)":1===s?"A"===l?(r=!0,o+="("+n+"|"+i+")"):"a"===l?o+="("+n+"?|"+i+"?)":"L"===l?(r=!0,o+="("+n+")"):"l"===l&&(o+="("+n+"?)"):0===s?"A"===l?(r=!0,o+="("+t+"|"+n+"|"+i+")"):"a"===l?o+="("+t+"?|"+n+"?|"+i+"?)":"L"===l?(r=!0,o+="("+t+"|"+n+")"):"l"===l&&(o+="("+t+"?|"+n+"?)"):s===-1&&("A"===l?(r=!0,o+="("+t+"|"+i+")"):"a"===l?o+="("+t+"?|"+i+"?)":"L"===l?(r=!0,o+="("+t+")"):"l"===l&&(o+="("+t+"?)"))}if(!r)throw"Bad Mask - Must contain at least 1 mandatory symbol (A, L, 0)";return o+="$",new RegExp(o)}function A(){if(t.clientReferences.length>0)for(var e=0;e<t.clientReferences.length;e++){var n=t.clientReferences[e];if("Mask"==n.ReferenceType)return!(n.$testReg.test(n.$knownValue)||!n.$knownValue&&!n.Mandatory)}return!1}function P(){window.close()}function y(){var e=t.item.BookingStops[0];t.item.BookingStops[0]=t.item.BookingStops[1],t.item.BookingStops[1]=e}function L(e){e?t.fetchedPassengers=p("filter")(t.passengers,{Name:e}):t.fetchedPassengers=[],t.fetchedPassengers.push({Id:"add-passenger",Name:"Add Passenger",Description:"Create New Passenger",ImageUrl:"/includes/images/add-icon.png"})}function R(e){e?t.filteredBookers=p("filter")(t.bookers,{Name:e}):t.filteredBookers=[],t.filteredBookers.push({Id:"add-booker",Name:"Add Booker",Description:"Create New Booker",ImageUrl:"/includes/images/add-icon.png"})}function T(e){e.BookedDateTime=M(t.item.Date,t.item.Time),e.BookingStatus="Incoming",l.post(d.API_ENDPOINT+"api/quote",e).success(function(t){e.EstimatedCost=t.FinalCost,e.EstimatedDistance=t.EstimatedDistance.toFixed(2),e.EstimatedDuration=t.EstimatedMins,e.ActualCost=t.FinalCost}).error(function(e){console.log(e)})}function b(e){var n=new c.BookingStop;n.id=idCounter++,t.item.WaitAndReturn?t.item.BookingStops.splice(e,0,n):t.item.BookingStops.splice(e+1,0,n),t.item.BookingStops.length>2&&(t.sortableOptions.disabled=!1)}function N(e,n){var i=f.timeZone().getTimeZone(),o=(new Date).getTimezoneOffset(),s=moment.tz.zone(i).offset(new Date),r=new moment.tz(i).add(o-s,"minutes");"day"==n?t.item.Date=r.add(e,"minutes").toDate():"time"==n&&(t.item.Time=r.startOf("minute").add(e,"minutes").toDate())}function D(){t.item.BookingStops.reverse()}function M(e,t){function n(e,t){var n="000000000"+e;return n.substr(n.length-t)}var i=e.getFullYear(),o=e.getMonth(),s=e.getDate(),r=t.getHours(),a=t.getMinutes(),l=n(i,4)+"-"+n(o+1,2)+"-"+n(s,2)+"T"+n(r,2)+":"+n(a,2)+":00",d=moment.tz(l,"YYYY-MM-DDTHH:mm:ss",f.timeZone().getTimeZone()).format();return d}function V(){$("#bookingsave").prop("disabled",!0);var e=[];t.newBooker&&t.newBooker.Id==t.item.ClientStaffId?(t.newBooker.Passengers=[],t.newBooker.Passengers.push(t.item.LeadPassenger),l.post(d.API_ENDPOINT+"api/ClientStaff/ManagePassengers",t.newBooker).then(function(e){},function(e){swal({title:"Error adding passenger to booker",text:"Some error has occured.",type:"error",confirmButtonColor:o.COLOURS.brandSecondary})})):t.newPassenger&&t.newPassenger.Id==t.item.LeadPassengerId&&(t.selectedBooker.Passengers.push(t.selectedPassenger),l.post(d.API_ENDPOINT+"api/ClientStaff/ManagePassengers",t.selectedBooker).then(function(e){},function(e){swal({title:"Error adding passenger to booker",text:"Some error has occured.",type:"error",confirmButtonColor:o.COLOURS.brandSecondary})}));var n=t.item;if(t.paxMode.value){if(!n._LeadPassenger)return void swal("Invalid","Please add passenger details.","error");var i=n._LeadPassenger.split(" ");t.item.LeadPassenger={Firstname:i[0],Surname:i.slice(1).join(" "),Mobile:n._LeadPassengerNumber,ClientId:n.ClientId}}if(t.item.BookingValidations=[],t.clientReferences.length>0)for(var r=0;r<t.clientReferences.length;r++){var a=t.clientReferences[r],u=new c.BookingValidation;u.ClientReferenceId=a.Id,"List"==a.ReferenceType?u.Value=a.$knownValue&&a.$knownValue.text:u.Value=a.$knownValue,u.Value&&t.item.BookingValidations.push(u)}t.item.BookedDateTime=M(t.item.Date,t.item.Time),t.item.LeadPassenger=void 0,t.item.Client=void 0,t.item.Driver=void 0,t.item.VehicleType=void 0,t.item.Currency=void 0,t.item.BookingSource="CLIENT_PORTAL",e.push(t.item.$save()),s.all(e).then(function(e){var t=e[e.length-1].data.LocalId;swal({title:"Booking Saved.",text:"Booking Reference: #"+t,type:"success",showCancelButton:!1,confirmButtonColor:o.COLOURS.brandPrimary,confirmButtonText:"Okay",closeOnConfirm:!0},function(){window.close()})},function(e){t.dataReady=!0,swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error"})})}for(t.item=e.copy(u[0]),t.item.FlightInfo=null,t.item.FlightInfoId=null,t.isAdmin="super admin"==n.PERMISSIONS.role.Name.toLowerCase(),t.client=t.item.Client,t.item.BookingStops=t.item.BookingStops.map(function(e){return e.Id=null,e.BookingId=null,e}),t.canQuote=!0,t.item.BookingValidations=t.item.BookingValidations.map(function(e){return e.Id=null,e.BookingId=null,e}),t.newBooker=null,t.bookers=[],t.externalLocations={knownLocations:[]},t.paxMode={value:!1},t.sortableOptions={stop:function(e,t){},ondragstart:function(e,t){},disabled:!(t.item.BookingStops.length>2)},t.removeStop=C,t.bookingInfo=!0,t.save=V,t.close=P,t.formFor={},t.testMaskReferences=A,t.reverseStops=D,t.suggestReferences=w,t.addRequirement=I,t.removeRequirement=S,t.clientReferences=[],t.fetchedPassengers=g,t.taxes=m,t.searchBookers=R,t.searchPassengers=L,t.flipAddress=y,h(moment().add(15,"minutes").format("YYYY-MM-DDTHH:mm")),j=0,leng=t.client.ClientReferences.length;j<leng;j++){for(i=0,len=t.item.BookingValidations.length;i<len;i++)if(t.client.ClientReferences[j].Id==t.item.BookingValidations[i].ClientReferenceId&&(t.client.ClientReferences[j].$knownValue=t.item.BookingValidations[i].Value,t.client.ClientReferences[j].$id=t.item.BookingValidations[i].Id,"List"==t.client.ClientReferences[j].ReferenceType)){var E={custom:!1,text:t.item.BookingValidations[i].Value};t.client.ClientReferences[j].$knownValue=E,t.client.ClientReferences[j].$originalValue=E,t.client.ClientReferences[j].$suggested=[E]}"Mask"==t.client.ClientReferences[j].ReferenceType&&(t.client.ClientReferences[j].$testReg=v(t.client.ClientReferences[j].Value)),t.clientReferences.push(t.client.ClientReferences[j])}k(),t.getTaxName=B,t.addTime=N,t.addStop=b,t.$watch("item.BookingStops[0]",function(n,i){if(void 0!==i&&n!==i&&t.item.WaitAndReturn){var o=new c.BookingStop(e.copy(t.item.BookingStops[0]));o.id=idCounter++,o.Id=null,t.item.BookingStops.splice(t.item.BookingStops.length-1,1,o)}},!0),t.$watchGroup(["item.Date","item.Time"],function(e){t.item.BookedDateTime=M(e[0],e[1])}),t.$watch("item.WaitAndReturn",function(n,i){if(void 0!==i&&n!==i){if(n===!1){t.item.BookingStops.splice(t.item.BookingStops.length-1,1);var o=new c.BookingStop;o.id=idCounter++,t.item.BookingStops.push(o)}else if(n===!0){var o=new c.BookingStop(e.copy(t.item.BookingStops[0]));o.id=idCounter++,o.Id=null,t.item.BookingStops.push(o)}t.canQuote=!0,e.forEach(t.item.BookingStops,function(e,n){e.Latitude&&e.Longitude||(t.canQuote=!1)})}}),t.$watch("item.BookingStops",function(n,i){void 0!==i&&n!==i&&(t.canQuote=!0,e.forEach(n,function(e,n){e.Latitude&&e.Longitude||(t.canQuote=!1)}),t.canQuote?T(t.item):(t.item.EstimatedCost=0,t.item.ActualCost=0))},!0),t.$watch("item.ClientStaffId",function(e){if("add-booker"===e){var n=r.open({templateUrl:"/webapp/common/modals/booker/modal.html",controller:"BookerCreateController",resolve:{rBooker:function(){var e=new c.ClientStaff;return e.Phone=t.clients.filter(function(e){return e.Id==t.item.ClientId})[0].Phone,e.ClientId=t.item.ClientId,e}}});n.result.then(function(e){var n={Id:e.Id,ClientId:e.ClientId,Name:e.Firstname+" "+e.Surname,Description:e.Email?e.Email:"",Mobile:e.Mobile,ImageUrl:$utilities.formatUrl(e.ImageUrl,e.Name)};t.newBooker=e,t.filteredBookers.push(n),t.item.ClientStaffId=e.Id},function(){t.item.ClientStaffId=null})}}),t.$watch("item.AsDirected",function(n,i){if(void 0!==i&&n!==i){if(n===!0)t.item.BookingStops.length=1;else if(n===!1){var o=new c.BookingStop;o.id=idCounter++,t.item.BookingStops.push(o)}t.item.EstimatedCost=0,t.item.ActualCost=0,t.canQuote=!0,e.forEach(t.item.BookingStops,function(e,n){e.Latitude&&e.Longitude||(t.canQuote=!1)}),t.canQuote&&T(t.item)}}),t.$watch("item.LeadPassengerId",function(n){if("add-passenger"===n){t.item.LeadPassengerId=null;var i=r.open({templateUrl:"/webapp/common/modals/passenger/create.modal.html",controller:"PassengerItemCreateModalController",resolve:{rClientId:function(){return t.item.ClientId},rNavigateAfterSave:function(){return!1}}});return void i.result.then(function(e){var n={Id:e.Id,ClientId:e.ClientId,Name:e.Firstname+" "+e.Surname,Description:e.Email?e.Email:"",Mobile:e.Mobile,ImageUrl:$utilities.formatUrl(e.ImageUrl,e.Name)};t.newPassenger=e,t.fetchedPassengers.push(n),t.item.ClientId=e.ClientId,t.item.LeadPassengerId=e.Id},function(){})}var o=t.item;if(n){var s=t.passengers.filter(function(e){return e.Id==n})[0];o.ClientId=s.ClientId,o.PassengerNotificationPhone=s.Mobile,e.forEach(s.Addresses,function(e){if(e.Latitude&&e.Longitude){var n="";e.Address1&&e.Address1.length>1&&(n+=e.Address1),e.TownCity?(n.length>0&&(n+=", "),n+=e.TownCity):e.Area&&(n.length>0&&(n+=", "),n+=e.Area),e.Postcode&&(n.length>0&&(n+=", "),n+=e.Postcode),t.externalLocations.knownLocations.push({Address1:e.Address1,Address2:e.Address2,Area:e.Area,TownCity:e.TownCity,County:e.County,Postcode:e.Postcode,Country:e.Country,Latitude:e.Latitude,Longitude:e.Longitude,Name:e.Name,StopSummary:e.StopSummary||n,LocationType:"Passenger Address"})}})}else o.PassengerNotificationPhone=null}),t.$watch("item.VehicleTypeId",function(n,i){void 0!==i&&n!==i&&(t.canQuote=!0,e.forEach(t.item.BookingStops,function(e,n){e.Latitude&&e.Longitude||(t.canQuote=!1)}),t.canQuote?T(t.item):(t.item.EstimatedCost=0,t.item.ActualCost=0))})}var n=e.module("cab9.common");n.controller("ClientBookingReuseModalController",t),t.$inject=["$scope","$rootScope","$UI","$q","$modal","$modalInstance","$http","$config","Model","rBooking","rTaxes","rPassengers","Localisation","$filter"]}(angular);;;;