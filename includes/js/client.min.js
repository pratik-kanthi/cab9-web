!function(e,t){function n(e,n,o,r,i,a,s,l,c,u,d){if(n.enabled(!1),u.setEndpoint(e.API_ENDPOINT+"signalr/hubs"),u.setHub("locationHub"),item=localStorage.getItem("AUTH_TKN"))try{var g=t.fromJson(item);u.setQueryValue("token",g.access_token)}catch(m){console.log(m)}u.registerEvent("updateDriverLocation"),u.registerEvent("updateDriverStatus"),u.registerEvent("updateBookingStatus"),u.registerEvent("updateBookingOffer"),u.registerEvent("updateBooking"),u.registerEvent("newMessage"),u.registerEvent("newExpenseNotification"),c.showWeeks=!1,c.showButtonBar=!1,s.setGlobalLoggingLevel(5),s.addProvider("ConsoleLoggingProvider"),s.hideCatagory("APP RUN"),r.otherwise("/"),r.when("","/"),o.state("root",{"abstract":!0,onEnter:function(){setTimeout(function(){jQuery(".animation-root").removeClass("animation-root")},1e3)},views:{layout:{templateUrl:"/e9_components/layouts/structure/page.layout.html"},"sidebar-left@root":{templateUrl:"/webapp/client/layout/sidebar-left/sidebar-left.partial.html",controller:"ClientSidebarController"},"topbar@root":{templateUrl:"/webapp/layout/topbar/topbar.partial.html",controller:"TopBarController"},"sidebar-right@root":{templateUrl:"/webapp/layout/sidebar-right/sidebar-right.partial.html"}}}),d.setOptions({delay:3e3,startTop:20,startRight:10,verticalSpacing:20,horizontalSpacing:20,positionX:"right",positionY:"top"})}function o(e,n,o,r,a,s,l,c,u,d,g,m,p,f,C,h){function P(){var a=r.createLogger("ROUTER"),u=C.currency(),p=u.currencies(),P=null;o.$on("$stateChangeStart",function(e,t,n,r,i){e.defaultPrevented||(a.debug("$stateChangeStart triggered"),P=l(function(){o.loading=!0},500))}),o.$on("$stateNotFound",function(e,t,n,r){a.warning("$stateNotFound triggered"),c.go("root"),o.loading=!1}),o.$on("$stateChangeSuccess",function(e,t,n,r,i){a.debug("$stateChangeSuccess triggered"),u.getCurrent()&&o.COMPANY&&u.getCurrent().Id!=o.COMPANY.DefaultCurrencyId&&u.setCurrent(o.COMPANY.DefaultCurrencyId),P&&(l.cancel(P),P=null),o.loading=!1}),o.$on("$stateChangeError",function(e,t,n,o,r,i){a.warning("$stateChangeError triggered"),a.debug("Route Error: Redirecting to Dashboard"),a.debug(i),c.go("root")}),o.$on("$viewContentLoading",function(e,t,n){a.debug("$viewContentLoading triggered")}),o.$on("$viewContentLoaded",function(e,t,n){a.debug("$viewContentLoaded triggered"),$("html,body").animate({scrollTop:0},0,function(){})}),f.get(d.API_ENDPOINT+"api/payments/ispaymentenabled").then(function(e){1==e.data.CreditCardPaymentsActive&&(d.CARD_PAYMENTS_ENABLED=!0,o.CARD_PAYMENTS_ENABLED=!0)}),g.AUTH_TKN&&(n.setQueryValue("token",g.AUTH_TKN.access_token),S(),b(),s.Company.query().include("DefaultDriverPaymentModel").filter("Id eq guid'"+m.getSession().TenantId+"'").execute().then(function(e){o.COMPANY=e[0],p.then(function(t){u.setCurrent(e[0].DefaultCurrencyId),i=u.getCurrent().Prepend}),e[0].DefaultLocale?h.set(e[0].DefaultLocale):h.set(d.DEFAULT_LOCALE),e[0].DefaultTimezone&&(moment.tz.setDefault(e[0].DefaultTimezone),C.timeZone().setTimeZone(e[0].DefaultTimezone)),C.useMetric(e[0].UseMetric)}),m.getSession().Claims.ClientId&&m.getSession().Claims.ClientId[0]?o.CLIENTID=m.getSession().Claims.ClientId[0]:o.$broadcast(e.LOGOUT),s.Client.query().filter("Id eq guid'"+o.CLIENTID+"'").select("ShowPriceInPortal,AllowCashInPortal,ShowVATInPortal").parseAs(t.identity).execute().then(function(e){o.CLIENT=e[0]})),o.$on(e.LOGIN_SUCCESS,function(e,t){n.setQueryValue("token",t.access_token),S(),b(),s.Company.query().filter("Id eq guid'"+t.TenantId+"'").execute().then(function(e){o.COMPANY=e[0]})}),n.start().then(function(){a.info("SignalR Started")})}function S(){}function b(){}r.createLogger("APP RUN");o.COMPANY={},o.CLIENT={},o.CLIENTID=null,o.filters={From:null,To:null,DriverIds:[],ClientIds:[],PassengerIds:[],VehicleTypeIds:[],VehicleClassIds:[],CurrencyIds:[],PaymentMethods:null,BookingSources:null,PeriodLength:""},P(),o.API_ENDPOINT=d.API_ENDPOINT;m.getSession().Claims;m.getSession().Claims.SkipDisclaimer||sessionStorage.getItem("SkipDisclaimer")||a.open({templateUrl:"/webapp/client/disclaimer.modal.html",controller:["$scope","$modalInstance",function(e,n){function o(){e.doNotShow&&f.post(d.API_ENDPOINT+"api/Account/DoNotShowDisclaimer",null).success(function(){var e=m.getSession();e.Claims.SkipDisclaimer=!0;var n=t.toJson(e);localStorage.setItem("AUTH_TKN",n)}),sessionStorage.setItem("SkipDisclaimer",!0),n.close()}e.doNotShow=!1,e.confirm=o}]})}var r=t.module("cab9.permissions",["ui.router"]);r.constant("$permissions",{role:null,permissions:[],cardPaymentsActive:!1,test:function(e,t){var n=!1;void 0==t&&(t="R");var o=this.permissions.filter(function(t){return t.hasOwnProperty(e)})[0],r=this.permissions.indexOf(o);return r!=-1&&(n=this.permissions[r][e][t]),this.permissions.indexOf("superadmin")!=-1||n}}),r.config(["$permissions",function(t){t.role=e.$$permissions,t.permissions=JSON.parse(e.$$permissions.Permissions),t.cardPaymentsActive=e.$$permissions.cardPaymentsActive}]),r.run(["$rootScope","$permissions","$http",function(e,t,n){1==t.cardPaymentsActive&&(e.CARD_PAYMENTS_ENABLED=!0),e.PERMISSIONS=t}]);var i="Â£",a=t.module("cab9.client",["cab9.permissions","cab9.common","cab9.client.dashboard","cab9.client.bookings","cab9.client.staff","cab9.client.passengers","cab9.client.locations","cab9.client.invoices","cab9.client.report","cab9.client.settings","rzModule"]);a.config(n),a.run(o),a.constant("$UI",{COLOURS:{brandPrimary:"#455674",brandSecondary:"#A88ADC",menuLight:"#2B303B",menuDark:"#21252D",blue:"#008FFB",red:"#F55753",orange:"#e67e22",yellow:"#F8D053",cyan:"#10CFBD",sky:"#48B0F7",green:"#64c458",purple:"#6D5CAE",brandGrey:"#3B4752",darkGrey:"#2B303B",lightGrey:"rgba(100,100,100,0.1)",grey:"#788195",lighterGrey:"rgba(0,0,0,0.2)"}}),n.$inject=["$config","$sceProvider","$stateProvider","$urlRouterProvider","$compileProvider","MenuServiceProvider","LoggerProvider","ModelProvider","datepickerConfig","SignalRProvider","NotificationProvider"],o.$inject=["AUTH_EVENTS","SignalR","$rootScope","Logger","$modal","Model","$timeout","$state","LookupCache","$config","$localStorage","Auth","ViewerCache","$http","Localisation","tmhDynamicLocale"]}(window,angular);;;;
!function(r,o){function t(r,o,t){r.state("root.dashboard",{url:"/",showTimeControl:!0,views:{"content-wrapper@root":{controller:"DashboardController",templateUrl:"/webapp/client/dashboard/dashboard.partial.html"}}}),o.registerMenuItem({state:"root.dashboard",icon:"dashboard",title:"Dashboard"})}function e(){}var a=o.module("cab9.client.dashboard",[]);a.config(t),a.run(e),t.$inject=["$stateProvider","MenuServiceProvider","$urlRouterProvider"],e.$inject=[]}(window,angular);;;;
!function(t){function e(t,e,n,o,a,r,u,l){function s(){d=new Packery(c,{itemSelector:".grid-item",isInitLayout:!1,percentPosition:!0,columnWidth:"#width-sizer",gutter:0});var t=JSON.parse(localStorage.getItem("clientDashboardOrder"));if(t){var e=d.items.slice(0);for(i=0;i<e.length;i++){var n=e[i].element.parentElement.getAttributeNode("order").value,o=t.indexOf(n);d.items[o]=e[i]}}d.layout(),d.on("dragItemPositioned",function(t,e){var n=$(d.getItemElements()),o=[];for(i=0;i<n.length;i++)o.push(n[i].parentElement.getAttributeNode("order").value);localStorage.setItem("clientDashboardOrder",JSON.stringify(o))})}"superadmin"!=l.PERMISSIONS.permissions[0]&&(l.reportFilters.ClientStaffId=l.USER.Claims.ClientStaffId[0]),t.dataRequestsCount=null;var d=null,c=document.querySelector(".grid");l.$on("Data Loading",function(){t.dataRequestsCount?t.dataRequestsCount+=1:t.dataRequestsCount=1}),l.$on("Data Loaded",function(){t.dataRequestsCount-=1,0==t.dataRequestsCount&&(u(function(){s()},10),u(function(){t.$apply()},1e3))})}var n=t.module("cab9.client.dashboard");n.controller("DashboardController",e),e.$inject=["$scope","$UI","$config","$http","$q","$filter","$timeout","$rootScope"]}(angular);;;;
!function(e){function i(e,i,t,r){r.test("bookings")&&(e.state("root.bookings",{url:"/bookings",permission:"Bookings Module",views:{"content-wrapper@root":{controller:"BookingsTableController",templateUrl:"/webapp/client/bookings/bookings-table.partial.html",resolve:{rDrivers:["Model","$rootScope",function(e,i){return e.Driver.query().select("Id,Firstname,Surname,Callsign,ImageUrl,Vehicles/Id,Vehicles/Registration").include("Vehicles").parseAs(function(e){this.Id=e.Id,this.Name="("+e.Callsign+") "+e.Firstname+" "+e.Surname,e.Vehicles&&e.Vehicles[0]?(this.DefaultVehicleId=e.Vehicles[0].Id,this.Description=e.Vehicles[0].Registration):(this.DefaultVehicleId=null,this.Description="No Vehicle")}).execute()}],rAllowedPassengers:["Model","Auth",function(e,i){return e.ClientStaff.query().include("Passengers").select("Passengers/Id,AllPassengers").where("Id eq guid'"+i.getSession().Claims.ClientStaffId[0]+"'").execute()}]}}}}),r.test("bookings","W")&&e.state("root.bookings.create",{url:"/create",views:{"content-wrapper@root":{controller:"ClientBookingCreateController",templateUrl:"/webapp/client/bookings/new/partial.html",resolve:{rTags:["Model","Auth",function(e,i){return e.Tag.query().filter("TenantId eq guid'"+i.getSession().TenantId+"'").filter("ClientVisible eq true").execute()}]}}}}),e.state("root.bookings.search",{url:"/:localId",views:{"content-wrapper@root":{controller:"BookingsTableController",templateUrl:"/webapp/client/bookings/bookings-table.partial.html",resolve:{rDrivers:["Model",function(e){return e.Driver.query().select("Id,Firstname,Surname,Callsign,ImageUrl,Vehicles/Id,Vehicles/Registration").include("Vehicles").parseAs(function(e){console.log(e),this.Id=e.Id,this.Name="("+e.Callsign+") "+e.Firstname+" "+e.Surname,e.Vehicles&&e.Vehicles[0]?(this.DefaultVehicleId=e.Vehicles[0].Id,this.Description=e.Vehicles[0].Registration):(this.DefaultVehicleId=null,this.Description="No Vehicle")}).execute()}]}}}}),r.test("bookings.viewer")&&(e.state("root.bookings.viewer",{url:"/:Id","default":"root.bookings.viewer.details",permission:"View Bookings",resolve:{rBooking:["Model","$stateParams",function(e,i){return e.Booking.query().filter("Id","==","guid'"+i.Id+"'").include("Driver,Client,Vehicle,BookingStops,BookingStops/PassengerStops,Passengers,LeadPassenger,Currency,BookingRequirements,Notifications").trackingEnabled().execute().then(function(e){return e[0]})}],rClients:["Model",function(e){return e.Client.query().select("Id,Name,ImageUrl,ClientType/Name, DefaultCurrencyId").include("ClientType").parseAs(function(e){this.Id=e.Id,this.Name=e.Name,this.Description=e.ClientType.Name,this.ImageUrl=window.formatImage(e.ImageUrl,e.Name),this.DefaultCurrencyId=e.DefaultCurrencyId}).execute()}],rVehicleTypes:["Model",function(e){return e.VehicleType.query().select("Id,Name").execute()}],rVehicleClasses:["Model",function(e){return e.VehicleClass.query().select("Id,Name").execute()}],rDrivers:["Model",function(e){return e.Driver.query().select("Id,Firstname,Surname,Callsign,ImageUrl,DriverType/Name").include("DriverType").parseAs(function(e){this.Id=e.Id,this.Name=e.Firstname+" "+e.Surname+" ("+e.Callsign+")",this.Description=e.DriverType.Name,this.ImageUrl=window.formatImage(e.ImageUrl,e.Callsign)}).execute()}],rVehicles:["Model",function(e){return e.Vehicle.query().select("Id,Registration,Colour,Make,Model,Class,Type").include("Class,Type").parseAs(function(e){this.Id=e.Id,this.Name=e.Registration,this.Description=e.Colour+" "+e.Make+" "+e.Model,this.DriverId=e.DriverId,this.ImageUrl=window.formatImage(e.ImageUrl,e.Registration)}).execute()}],rPassengers:["Model",function(e){return e.Passenger.query().select("Id,Firstname,Surname,ClientId,ImageUrl,Client/Name").include("Client").parseAs(function(e){this.Id=e.Id,this.Name=e.Firstname+" "+e.Surname,this.Description=e.Mobile?e.Mobile:"No Mobile",this.ClientId=e.ClientId,this.ImageUrl=window.formatImage(e.ImageUrl,e.Firstname)}).execute()}],rTabs:function(){return[{heading:"Details",route:"root.bookings.viewer.details"}]},rTaxes:["Model",function(e){return e.Tax.query().include("TaxType").execute()}]},views:{"content-wrapper@root":{controller:"BookingsViewerController",templateUrl:"/webapp/client/bookings/bookings-viewer.partial.html"}}}),e.state("root.bookings.viewer.details",{url:"/details",templateUrl:"/webapp/client/bookings/edit/booking-edit.partial.html",controller:"BookingEditController"})),i.registerMenuItem({state:"root.bookings",icon:"event_note",title:"Bookings"}))}function t(){}var r=e.module("cab9.client.bookings",[]);r.config(i),r.run(t),i.$inject=["$stateProvider","MenuServiceProvider","$urlRouterProvider","$permissions"],t.$inject=[]}(angular);;;;
!function(e){function t(t,o,n,r,a,s,l,f,c,u,d,m){function g(e){if(t.bookingGroups=null,t.paging.currentPage=e,t.searchTerm.$.length>0)d.get(l.API_ENDPOINT+"api/search",{params:{searchText:t.searchTerm.$,clientId:t.CLIENTID,top:50,skip:t.paging.resultsPerPage*(t.paging.currentPage-1)}}).success(function(e){var t=[];[].push.apply(t,e.map(function(e){return new a.Booking(e)})),p(t)});else{var o={From:new moment(t.filter.date.from).startOf("day").format(),To:new moment(t.filter.date.to).endOf("day").format(),Page:t.paging.currentPage};if(t.filter.ClientIds.length>0&&(o.ClientIds=t.filter.ClientIds),t.filter.PassengerIds.length>0&&(o.LeadPassengerIds=t.filter.PassengerIds),t.filter.VehicleTypeIds.length>0&&(o.VehicleTypeIds=t.filter.VehicleTypeIds),t.filter.BookingSource&&(o.BookingSource=t.filter.BookingSource),t.filter.PaymentMethod&&(o.PaymentMethod=t.filter.PaymentMethod),t.filter.Amount.from&&(o.AmountFrom=t.filter.Amount.from),t.filter.Amount.to&&(o.AmountTo=t.filter.Amount.to),t.filter.ShowClientServicesBookings&&(o.Dispute=!0),t.filter.Status)for(var n=Object.keys(t.filter.Status),r=0;r<n.length;r++)t.filter.Status[n[r]]&&("InProgress"==n[r]&&(o.Arrived=!0),o[n[r]]=!0);d.post(l.API_ENDPOINT+"api/bookings/filtered",o).success(function(e){var t=[];[].push.apply(t,e.map(function(e){return new a.Booking(e)})),p(t),h()}).error(function(e){swal("Error","Please try again or contact admin","error")})}}function p(e){if(t.bookingGroups=[],e.length>0){for(var o={date:e[0].BookedDateTime,bookings:[]},n=0;n<e.length;n++){var r=e[n];r.FlightInfo&&(moment().diff(moment(r.FlightInfo.LastUpdate),"hours")>10?r.FlightInfo.$Status="No updates yet.":r.FlightInfo.$Status="Last Updated "+moment(r.FlightInfo.LastUpdate).fromNow()),r.BookingStops=f("orderBy")(r.BookingStops,"StopOrder"),new moment(r.BookedDateTime).format("DD/MM/YYYY")==new moment(o.date).format("DD/MM/YYYY")?o.bookings.push(r):(t.bookingGroups.push(o),o={date:r.BookedDateTime,bookings:[]},o.bookings.push(r))}t.bookingGroups.push(o)}}function h(){var e=new moment(t.filter.date.from),o=new moment(t.filter.date.to);t.filterSummary=t.fetchStatus,e.format("DD/MM/YYYY")==o.format("DD/MM/YYYY")?t.filterSummary+=" Bookings for "+f("date")(e.toDate(),"shortDate"):t.filterSummary+=" Bookings from "+f("date")(e.toDate(),"shortDate")+" to "+f("date")(o.toDate(),"shortDate")}function I(){t.showSearch=!t.showSearch,t.showSearch?setTimeout(function(){$("#searchTerm").focus()},500):t.searchTerm.$=""}function S(o){swal({title:"Are You Sure?",text:"This will initiate a booking export and the exported file will be sent to you via email.",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Confirm",cancelButtonText:"Cancel",closeOnConfirm:!1,closeOnCancel:!1},function(n){if(n){if(!t.filter.date.from||!t.filter.date.to)return void swal({title:"Date Range not selected.",text:"Please select date range in filters to export.",type:"warning",confirmButtonColor:r.COLOURS.brandSecondary});var i="from="+moment(t.filter.date.from).startOf("day").format().replace("+","%2B")+"&to="+moment(t.filter.date.to).endOf("day").format().replace("+","%2B");t.filter.VehicleTypeIds.length>0&&(i+="&vehicleTypeIds="+t.filter.VehicleTypeIds.reduce(function(e,t){return e?e+", ''"+t+"''":"''"+t+"''"},null)),t.filter.PassengerIds.length>0&&(i+="&leadPassengerIds="+t.filter.PassengerIds.reduce(function(e,t){return e?e+", ''"+t+"''":"''"+t+"''"},null)),t.filter.Amount&&t.filter.Amount.from>=0&&(i+="&actualCostFrom="+t.filter.Amount.from),t.filter.Amount&&t.filter.Amount.to>=0&&(i+="&actualCostTo="+t.filter.Amount.to),t.filter.ClientServices&&(i+="&clientServices=1"),t.filter.BookingSource&&(i+="&bookingSource="+t.filter.BookingSource),t.filter.PaymentMethod&&(i+="&paymentMethod="+t.filter.PaymentMethod);var a=[];e.forEach(t.filter.Status,function(e,t){if(e)switch(t){case"Cancelled":a.push("-1");break;case"COA":a.push("0");break;case"Incoming":a.push("1");break;case"PreAllocated":a.push("5");break;case"Allocated":a.push("10");break;case"OnRoute":a.push("20");break;case"Arrived":a.push("30,40");break;case"InProgress":a.push("30,40");break;case"Clearing":a.push("80");break;case"Completed":a.push("100");break;case"OpenToBid":a.push("120")}});var s=u.getSession().Claims.TenantId[0];i+="&tenantId="+s+"&management=false&withReferences="+o+"&BookingStatuses="+a.join(","),d.get(l.API_ENDPOINT+"api/bookings/export?"+i,"_blank").then(function(e){swal({title:"Export Initiated",text:"Thank you for your request, The bookings export file will be sent to you via an email in few minutes.",type:"success",confirmButtonColor:r.COLOURS.brandSecondary})},function(e){swal({title:"Some Error Occured",text:e.data.Message,type:"error",confirmButtonColor:r.COLOURS.brandSecondary})})}else swal.close()})}function k(){c.open({templateUrl:"/webapp/client/bookings/modals/filter.modal.partial.html",controller:["$scope","rFilter","$modalInstance","Model",function(t,n,r,i){function a(e,o){t.filterOptions[o]=e}function s(e){e&&(t.loadingPassengers=!0,d.get(l.API_ENDPOINT+"api/Passengers/Search",{params:{searchText:e,clientId:t.filterOptions.ClientIds[0],lite:!0}}).then(function(e){t.passengers=[];for(var o=0;o<e.data.length;o++){var n=e.data[o];t.filterOptions.PassengerIds.indexOf(n.Id)==-1&&t.passengers.push({Id:n.Id,Firstname:n.Firstname,Surname:n.Surname})}t.loadingPassengers=!1}))}function f(e){e&&(t.loadingClientStaff=!0,d.get(l.API_ENDPOINT+"api/Bookers/Search",{params:{searchText:e,clientId:t.filterOptions.ClientIds[0],lite:!0}}).then(function(e){t.clientStaff=[];for(var o=0;o<e.data.length;o++){var n=e.data[o];t.filterOptions.ClientStaffIds.indexOf(n.Id)==-1&&t.clientStaff.push({Id:n.Id,Firstname:n.Firstname,Surname:n.Surname})}t.loadingClientStaff=!1}))}function c(){r.close(t.filterOptions)}t.isAdmin="super admin"==o.PERMISSIONS.role.Name.toLowerCase(),t.filterOptions=e.copy(n),t.passengers=t.filterOptions.Passengers,t.clientStaff=t.filterOptions.ClientStaff,t.vehicleTypes=t.filterOptions.VehicleTypes,t.datePickers={from:!1,to:!1},t.paymentMethods=[{Id:"CASH",Name:"Cash",Description:""},{Id:"CARD",Name:"Card",Description:""},{Id:"ONACCOUNT",Name:"OnAccount",Description:""},{Id:"OTHER",Name:"Other",Description:""}],t.status={},t.searchClientStaff=f,t.searchPassengers=s,t.confirmFilters=c,t.saveSelected=a,t.isAdmin||i.ClientStaff.query().filter("Id eq guid'"+u.getSession().Claims.ClientStaffId[0]+"'").include("Passengers").execute().then(function(e){e[0].AllPassengers?t.allPassengers=!0:t.passengers=e[0].Passengers.map(function(e){var t={};return t.Id=e.Id,t.Name=e.Firstname+" "+e.Surname,t.Mobile=e.Mobile,t})}),i.VehicleType.query().select("Id,Name,Description").execute().then(function(e){t.vehicleTypes=e}),window.setInterval(function(){var e=document.getElementsByClassName(".select2-choices ");e.scrollTop=e.scrollHeight},5e3),setTimeout(function(){$("#daterangepicker_bookings").daterangepicker({locale:{format:"DD/MM/YYYY"},autoApply:!0,startDate:moment(t.filterOptions.date.from).startOf("day"),endDate:moment(t.filterOptions.date.to).endOf("day"),opens:"right",parentEl:"#time-controls",ranges:{Today:[moment().startOf("day"),moment().endOf("day")],"This Week":[moment().startOf("isoweek"),moment().endOf("isoweek")],"This Month":[moment().startOf("month"),moment().endOf("month")]},alwaysShowCalendars:!0}),$("#daterangepicker_bookings").on("apply.daterangepicker",function(e,o){t.filterOptions.date.selectedPeriod=o.chosenLabel,t.filterOptions.date.from=o.startDate.toISOString(),t.filterOptions.date.to=o.endDate.toISOString(),"Custom Range"==t.filterOptions.date.selectedPeriod&&(t.filterOptions.date.selectedPeriod+=" ("+moment(t.filterOptions.date.from).format("DD/MM/YYYY")+" - "+moment(t.filterOptions.date.to).format("DD/MM/YYYY")+")"),t.$apply()})},100),t.openDatePicker=function(e,o){t.datePickers[o]=!t.datePickers[o],event.preventDefault(),event.stopPropagation()}}],resolve:{rFilter:function(){return t.filter}},size:"lg"}).result.then(function(e){t.filter=e,t.filter.$inc++})}function P(e,o){for(i=0;i<t.bookingGroups.length;i++)for(j=0;j<t.bookingGroups[i].bookings.length;j++){var n=t.bookingGroups[i].bookings[j];o[0].Id==n.Id&&(t.bookingGroups[i].bookings.splice(j,1,new a.Booking(o[0])),t.$apply())}}t.isAdmin="super admin"==o.PERMISSIONS.role.Name.toLowerCase(),t.toggleSearch=I,t.searchTerm={$:""},m.localId&&(t.searchTerm.$=m.localId,t.showSearch=!0),t.paging={currentPage:1,resultsPerPage:50,totalResults:null,maxPages:null},t.setPage=g,t.selectedPeriod="Today",t.filter={$inc:0,date:{from:moment().startOf("week"),to:moment().endOf("week"),span:"week",selectedPeriod:"This Week"},Amount:{from:null,to:null},Clients:[],Passengers:[],ClientStaff:[],VehicleTypes:[],ClientIds:[t.CLIENTID],PassengerIds:[],ClientStaffIds:[],VehicleTypeIds:[],Status:null},t.BS=["OnRoute","Arrived","InProgress","Completed","Cancelled","COA"],t.onCompleted=function(e,o){1==t.bookingGroups[e].bookings.length?t.bookingGroups.splice(e,1):t.bookingGroups[e].bookings.splice(o,1)},t.bookingGroups=null,t.showFilterModal=k,t.exportBookings=S,t.$watchGroup(["filter.$inc","filter.date.from.valueOf()","filter.date.to.valueOf()","searchTerm.$","filter.VehicleTypeId","filter.PassengerId","filter.ClientStaffId","filter.Status.Incoming","filter.Status.PreAllocated","filter.Status.Allocated","filter.Status.OnRoute","filter.Status.InProgress","filter.Status.Completed","filter.Status.Cancelled","filter.Status.COA","filter.Amount.from","filter.Amount.to","filter.PaymentMethod"],function(e,o){if(t.bookingGroups=[],t.fetchStatus="Fetching",e[3])t.filterSummary="Searching Bookings for : '"+e[3]+"'",d.get(l.API_ENDPOINT+"api/search/Count",{params:{searchText:e[3],clientId:t.CLIENTID}}).success(function(o){t.paging.totalResults=o.length,t.filterSummary="Showing Bookings for : '"+e[3]+"'",t.paging.maxPages=Math.ceil(t.paging.totalResults/t.paging.resultsPerPage),g(t.paging.maxPages)});else{h();var n={From:new moment(t.filter.date.from).startOf("day").format(),To:new moment(t.filter.date.to).endOf("day").format(),Page:t.paging.currentPage};if(t.filter.ClientIds.length>0&&(n.ClientIds=t.filter.ClientIds),t.filter.PassengerIds.length>0&&(n.LeadPassengerIds=t.filter.PassengerIds),t.filter.VehicleTypeIds.length>0&&(n.VehicleTypeIds=t.filter.VehicleTypeIds),t.filter.BookingSource&&(n.BookingSource=t.filter.BookingSource),t.filter.PaymentMethod&&(n.PaymentMethod=t.filter.PaymentMethod),t.filter.Amount.from&&(n.AmountFrom=t.filter.Amount.from),t.filter.Amount.to&&(n.AmountTo=t.filter.Amount.to),t.filter.ShowClientServicesBookings&&(n.Dispute=!0),t.filter.Status)for(var r=Object.keys(t.filter.Status),i=0;i<r.length;i++)t.filter.Status[r[i]]&&("InProgress"==r[i]&&(n.Arrived=!0),n[r[i]]=!0);d.post(l.API_ENDPOINT+"api/bookings/FilteredCount",n).success(function(e){t.paging.totalResults=e,t.fetchStatus="Showing "+e,h(),t.paging.maxPages=Math.ceil(t.paging.totalResults/t.paging.resultsPerPage),g(1)}).error(function(e){swal("Error","Please try again or contact admin","error")})}}),t.$on("SIGNALR_updateBooking",P)}var o=e.module("cab9.client.bookings");o.controller("BookingsTableController",t),t.$inject=["$scope","$rootScope","CSV","$UI","Model","$q","$config","$filter","$modal","Auth","$http","$stateParams"]}(angular);;;;
!function(){function e(e,o,n,i,t,a,r,l,s,c){function d(o){o.$expanded=!0;var n=[];n.push("(EntityType eq 'Booking' and EntityId eq guid'"+o.Id+"')"),n.push("(BookingId eq guid'"+o.Id+"')");for(var i=0;i<o.BookingStops.length;i++){var l=o.BookingStops[i];n.push("(EntityType eq 'BookingStop' and EntityId eq guid'"+l.Id+"')")}p(o),a.get(t.API_ENDPOINT+"api/bookings/ClientHistory",{params:{bookingId:o.Id}}).then(function(o){e.history={},0==o.data.length&&(e.noHistory=!0),angular.forEach(o.data,function(o){var n=new r.AuditRecord(o),i=moment(n.Timestamp).format("DD MMM");e.history[i]||(e.history[i]=[]),e.history[i].push(n)})})}function g(e){var o=["Incoming","OpenToBid","PreAllocated","Allocated","OnRoute","Arrived"];return o.indexOf(e)>-1}function m(e){a.get(t.API_ENDPOINT+"api/client/check-booking-cancellation",{params:{bookingId:e}}).success(function(o){o&&1==o.COA?swal({title:"Charged Cancellation",text:"This cancellation will be charged based on the cancellation policies set on your account.",type:"warning",showCancelButton:!0,closeOnConfirm:!1},function(){u(e)}):swal({title:"Are you sure?",text:"The booking will be cancelled.",type:"warning",showCancelButton:!0,closeOnConfirm:!1},function(){u(e)})})}function u(e){a.get(t.API_ENDPOINT+"api/client/cancel-booking",{params:{bookingId:e}}).success(function(){swal("Cancelled","Booking has been cancelled.","success")}).error(function(){swal("Cancellation Error","There was an error cancelling the booking.","error")})}function p(o){e.fetchingFinance=!0,a.get(t.API_ENDPOINT+"api/bookings/getbookingfinancedetails",{params:{bookingId:o.Id}}).success(function(n){o.$FinanceInfo=n,e.fetchingFinance=!1})}function k(o){o.$expanded=!1,e.history&&(e.history=null)}function f(e,o){n.open({templateUrl:"/webapp/common/views/conversations/conversations-list.partial.html",controller:"ConversationsModalController",windowClass:"chat",backdropClass:"chatBG",resolve:{rBooking:function(){return e},rType:function(){return o}}})}e.isAdmin="super admin"==o.PERMISSIONS.role.Name.toLowerCase(),e.closeBooking=k,e.expandBooking=d,e.checkCancelBooking=m,e.showCancelButton=g,e.tab={current:"Info"},moment(e.booking.BookedDateTime).diff(moment(),"hours")<2?e.BS="COA":e.BS="Cancelled",e.iconsIndex={"N/A":"assignment","Booking Offer Sent":"assignment","Booking Created":"assignment","Booking Cancelled":"assignment",FlightTrackingStarted:"flight_land",FlightTrackingStopped:"flight_land","SMS Confirmation":"insert_comment","Email Client Confirmation":"email","Email Booker Confirmation":"email","SMS Driver Arrived":"insert_comment","Call Driver Arrived":"phone","Email Manual Confirmation":"email","Driver Read Offer":"person_pin","Driver Accepted":"person_pin","Driver Rejected":"person_pin","Driver Allocated":"person_pin","Driver Unallocated":"person_pin","Booking Offered To Driver":"person_pin","Booking Pre Allocated To Driver":"person_pin","Booking Patched":"assignment","Booking Edited":"assignment",DriverPaymentIssued:"account_balance_wallet",DriverPaymentCancelled:"account_balance_wallet",ClientInvoiceIssued:"check_circle",ClientInvoiceCancelled:"check_circle","Flight Update":"flight_land",Repricing:"border_color","Booking Sent to Bidding Portal":"assignment","Booking Removed from Bidding Portal":"assignment","Driver Bidded for Booking":"person_pin"},e.coloursIndex={"N/A":"orange-bg","Booking Offer Sent":"green-bg","Booking Created":"green-bg",FlightTrackingStarted:"green-bg",FlightTrackingStopped:"red-bg","SMS Confirmation":"green-bg","Email Client Confirmation":"green-bg","Email Booker Confirmation":"green-bg","SMS Driver Arrived":"green-bg","Call Driver Arrived":"green-bg","Email Manual Confirmation":"orange-bg","Driver Read Offer":"green-bg","Driver Accepted":"green-bg","Driver Rejected":"orange-bg","Driver Allocated":"green-bg","Driver Unallocated":"green-bg","Booking Offered To Driver":"green-bg","Booking Pre Allocated To Driver":"green-bg","Booking Patched":"orange-bg","Booking Edited":"orange-bg",DriverPaymentIssued:"green-bg",DriverPaymentCancelled:"red-bg",ClientInvoiceIssued:"green-bg",ClientInvoiceCancelled:"red-bg","Booking Cancelled":"red-bg","Flight Update":"orange-bg",Repricing:"orange-bg","Booking Sent to Bidding Portal":"green-bg","Booking Removed from Bidding Portal":"green-bg","Driver Bidded for Booking":"green-bg"},e.PERMISSIONS=s;var h=l.currency().getCurrent();e.booking.Client?e.CurrencyId=e.booking.Client.DefaultCurrencyId:e.CurrencyId=h.Id,e.assignDriver=function(e,o){e.DriverId=o.Id,e.VehicleId=o.DefaultVehicleId,e.$patch(!0).then(function(){e.$commit(!0)})},e.loading=!1,e.$watch("booking.$expanded",function(o){e.booking.$expanded&&(e.loading=!0,r.Booking.query().select("Id,BookingExpense/Amount,BookingExpense/BookingExpenseType/Name,BookingValidations/Value,BookingValidations/ClientReference/ReferenceName,BookingRequirements/Name").include("BookingExpense,BookingExpense/BookingExpenseType,BookingValidations,BookingValidations/ClientReference,BookingRequirements").filter("Id eq guid'"+e.booking.Id+"'").execute().then(function(o){e.booking.$WaitTime=0,e.booking.BookingValidations=o[0].BookingValidations,e.booking.BookingExpense=o[0].BookingExpense,e.booking.BookingRequirements=o[0].BookingRequirements,e.booking.BookingStops.map(function(o){e.booking.$WaitTime+=o.WaitTime}),e.loading=!1},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:i.COLOURS.brandSecondary})}))}),e.trackBooking=function(e){a({method:"GET",url:window.endpoint+"api/bookingcodes?bookingid="+e.Id}).then(function(e){e.data&&e.data.Code?window.open("/track#?b="+e.data.Code,"_blank","height=870,width=1000,left=0,top=0"):swal({title:"Tracking Not Available.",text:"The tracking information for this booking is not yet available.",type:"warning",confirmButtonColor:i.COLOURS.brandSecondary})},function(e){})},e.updateBookingStatus=function(e,o){var n=new r.Booking(e),i="";return e.$updating=!0,e.DriverPaymentId||e.InvoiceId?(swal("Warning","Booking status cannot be modified as the booking is Invoiced/Driver Paid","warning"),void(e.$updating=!1)):("Cancelled"==o?i="The Booking will be cancelled and not billed to client.":"COA"==o&&(i="You are cancelling the booking after the cut off time. A cancellation fee will be levied."),void swal({title:"Are you sure?",text:i,type:"warning",showCancelButton:!0,confirmButtonText:"Confirm"},function(){n.BookingStatus=o,n.$patch(!0).then(function(){e.$updating=!1,n.$commit(!0)})}))},e.assignVehicle=function(e,o){e.$driverUpdate=!0,e.VehicleId=o.Id,e.$patch(!0).then(function(){e.Vehicle=o,e.$commit(!0),e.$driverUpdate=!1})},e.removeDriver=function(e){e.$driverUpdate=!0,e.DriverId=null,e.VehicleId=null,e.$patch(!0).then(function(){e.Driver=null,e.$commit(!0),e.$driverUpdate=!1})},e.removeVehicle=function(e){e.VehicleId=null,e.$patch(!0).then(function(){e.Vehicle=null,e.$commit(!0)})},e.toggleComplete=function(o,n){"Completed"==o.BookingStatus?(o.BookingStatus="Allocated",$(n.target).removeClass("animated tada")):(o.BookingStatus="Completed",$(n.target).addClass("animated tada")),o.$patch(!0).then(function(){c.success("Booking Saved"),setTimeout(function(){e.onCompleted()},1e3)})},e.getLocation=function(o){var n=[],i=new google.maps.DirectionsService,a={origin:o._FromSummary,destination:o._ToSummary,waypoints:n,optimizeWaypoints:!0,travelMode:google.maps.TravelMode.DRIVING};i.route(a,function(n,i){i==google.maps.DirectionsStatus.OK&&(staticMapUrl=encodeURI(t.GMAPS_STATIC_URL+"&markers=shadow:false|scale:2|icon:http://d1a3f4spazzrp4.cloudfront.net/receipt-new/marker-start@2x.png|"+o._FromSummary+"&markers=shadow:false|scale:2|icon:http://d1a3f4spazzrp4.cloudfront.net/receipt-new/marker-finish@2x.png|"+o._ToSummary+"&path=weight:5|color:0x2dbae4ff|enc:"+n.routes[0].overview_polyline),e.booking.mapUrl=staticMapUrl),e.$apply()})},e.openEditModal=function(e,o){if(o)window.open("/webapp/client/bookings/modals/reuse-booking/window.html#?id="+e.Id+"&clientId="+e.ClientId+"&repeat=true","_blank","height=870,width=1000,left=0,top=0");else{var n=(new moment).add(2,"hours");if("Incoming"!=e.BookingStatus){switch(message="",e.BookingStatus){case"COA":case"Cancelled":message="This booking has already been marked as cancelled";break;case"Allocated":case"PreAllocated":message="This booking has already been allocated";break;case"Completed":message="This booking has already been completed";break;default:message="This booking is already in progress"}swal("Error",message+", editing is no longer available. Please contact office if you need to make any further amendments.","error")}else n.isAfter(e.BookedDateTime)?swal("Error","This booking is due in less then 2 hours, editing is no longer available. Please contact office if you need to make any further amendments.","error"):window.open("/webapp/common/modals/bookings/edit-booking/window.html#?id="+e.Id+"&mode=Client&clientId="+e.ClientId,"EDIT:"+e.Id,"height=870,width=1000,left=0,top=0")}},e.reUse=function(e){window.open("/webapp/common/modals/bookings/reuse-booking/window.html#?id="+e.Id+"&clientId="+e.ClientId,"_blank","height=870,width=1000,left=0,top=0")},e.emailTo=function(e,o){var i=n.open({templateUrl:"/webapp/common/modals/email-to.modal.html",controller:["$scope","emailAddress","$modalInstance",function(e,o,n){null!=o&&(e.email=o),e.sendEmail=function(){n.close(e.email)}}],resolve:{emailAddress:function(){var n=null;switch(e){case"DRIVER":n=o.Driver?o.Driver.Email:null;break;case"PAX":n=o.LeadPassenger?o.LeadPassenger.Email:null;break;case"CLIENT":n=o.Client?o.Client.Email:null}return n}}});i.result.then(function(n){null!=n&&(swal("Success","User will receive the email soon..","success"),"DRIVER"==e?a.post(t.API_ENDPOINT+"api/email",{Type:"DriverConfirmation",BookingId:o.Id,DriverId:o.DriverId,EmailId:n}).success(function(){c.success("Email Sent")}):"PAX"==e?a.post(t.API_ENDPOINT+"api/email",{Type:"PassengerConfirmation",BookingId:o.Id,PassengerId:o.LeadPassengerId,EmailId:n}).success(function(){c.success("Email Sent")}):"CLIENT"==e&&a.get(t.API_ENDPOINT+"api/email/booking",{params:{bookingId:o.Id,email:n}},function(){c.success("Email Sent")}))})};var b={toggle:!1,cancel:function(){e.booking.$rollback(),this.toggle=!1},save:function(){e.booking.$patch(),this.toggle=!1}};e.API_ENDPOINT=t.API_ENDPOINT;var I={toggle:!1,editDestination:function(o,i){this.toggle=!0;var r=n.open({templateUrl:"/webapp/management/bookings/stop-edit.modal.html",controller:"BookingDestinationStopModal",resolve:{dropOffLoc:function(){if(o)return e.booking._ToSummary}}});r.result["finally"](function(){I.toggle=!1}),r.result.then(function(n){if(o){var i=e.booking.BookingStops.length-1,r=e.booking.BookingStops.splice(i,1,n);n.Id=r[0].Id,n.BookingId=e.booking.Id,a({method:"PATCH",url:t.API_ENDPOINT+"api/BookingStops?id="+n.Id,data:n})}else{n.Type="Via";var i=e.booking.BookingStops.length-1;e.booking.BookingStops.splice(i,0,n),n.BookingId=e.booking.Id,a.post(t.API_ENDPOINT+"api/BookingStops",n)}})}};e.stopSummary=function(e){return e.Address1+" "+e.Area+", "+e.TownCity+", "+e.Postcode},e.editing={any:function(){return this.expenses.toggle||this.waiting.toggle||this.notes.toggle||this.stops.toggle},expenses:angular.copy(b),waiting:angular.copy(b),notes:angular.copy(b),stops:I},e.showConversations=f}function o(e,o,n){if(n){var i=new google.maps.Geocoder;i.geocode({address:n},function(o,n){e.choosen=o[0]})}else e.choosen=null;e.destinationValid=!1,e.map={center:{latitude:45,longitude:-73},zoom:17},e.markers=[],e.$watch("choosen",function(o){o&&angular.isObject(o)&&o.geometry?(e.destinationValid=!0,e.map.center={latitude:o.geometry.location.lat(),longitude:o.geometry.location.lng()},e.markers=[{id:"5WnUJbhPEg",coords:{latitude:o.geometry.location.lat(),longitude:o.geometry.location.lng()}}]):e.destinationValid=!1}),e.confirmDestination=function(){var n={};angular.forEach(e.choosen.address_components,function(e){var o=e.types[0];switch(o){case"street_number":n.Address2=e.long_name;break;case"route":n.Address1=e.long_name;break;case"locality":n.Area=e.long_name;break;case"postal_town":n.TownCity=e.long_name;break;case"administrative_area_level_2":n.County=e.long_name;break;case"postal_code":n.Postcode=e.long_name}}),e.choosen.types.filter(function(e){return"airport"===e||"transit_station"===e}).length?n.Alias=e.choosen.name:n.Alias=e.choosen.formatted_address;try{n.Latitude=e.choosen.geometry.lat(),n.Longitude=e.choosen.geometry.lng()}catch(i){}o.close(n)}}var n=angular.module("cab9.client.bookings");n.controller("BookingDestinationStopModal",o),n.directive("bookingStrip",function(){return{restrict:"E",templateUrl:"/webapp/client/bookings/booking-strip.template.html",scope:{booking:"=",drivers:"=",vehicles:"=",onCompleted:"&"},controller:e,link:function(e,o,n){e.$expanded=!1}}}),e.$inject=["$scope","$rootScope","$modal","$UI","$config","$http","Model","Localisation","$permissions","Notification"],o.$inject=["$scope","$modalInstance","dropOffLoc"]}();;;;
!function(){function o(o,n,r,e){o.booking=n,o.tabDefs=r,o.accessors={LogoUrl:function(){return o.booking._ImageUrl}}}var n=angular.module("cab9.client.bookings");n.controller("BookingsViewerController",o),o.$inject=["$scope","rBooking","rTabs","$config"]}();;;;
!function(e){function t(t,o,n,s,i,r,c,l,a,d,u,g,C,k,B,m,p,f,h,I){function v(){t.selectedBooking=new a.Booking,t.selectedBooking.BookingStops.length=0;var e=new a.BookingStop;t.selectedBooking.BookingStops.push(e),t.selectedBooking.Pax=1,t.selectedBooking.Bax=0,t.selectedBooking.TaxId=t.COMPANY.DefaultTaxId,1==t.COMPANY.ChauffeurModeActive&&(t.selectedBooking.ChauffeurMode=!0),t.selectedBooking.VehicleTypeId=l.defaultVehicleType,t.selectedBooking.VehicleClassId=l.defaultVehicleClass;var o=new moment.tz(m.timeZone().getTimeZone());t.selectedBooking.BookedDateTime=o.toDate(),t.selectedBooking.Time=o.startOf("minute").add(15,"minutes").toDate(),t.selectedBooking.CurrencyId=t.COMPANY.DefaultCurrencyId,t.EstimatedCost=0,t.selectedBooking.ClientId=t.CLIENTID.toLowerCase()}function D(e){var o=t.selectedBooking.Passengers.filter(function(t){return t.Id==e})[0];if(o)return o.Firstname+" "+o.Surname}function y(){var e=new a.BookingStop;t.selectedBooking.BookingStops.push(e)}function E(){o.post(n.API_ENDPOINT+"api/quote",t.selectedBooking).success(function(e){e.FinalCost=e.FinalCost.toFixed(2),t.selectedBooking.CurrencyId!=t.COMPANY.DefaultCurrencyId?(t.selectedBooking.EstimatedCost=p("Convert")(e.FinalCost),t.selectedBooking.ActualCost=p("Convert")(e.FinalCost),t.EstimatedCost=e.FinalCost,t.ActualCost=e.FinalCost):(t.selectedBooking.EstimatedMins=e.EstimatedMins,t.selectedBooking.EstimatedCost=e.FinalCost,t.selectedBooking.ActualCost=e.FinalCost,t.EstimatedCost=e.FinalCost,t.ActualCost=e.FinalCost)}).error(function(e){console.log(e)})}function T(e){var i=new moment(t.selectedBooking.Time).add(moment.tz.zone(m.timeZone().getTimeZone()).offset(new Date),"minutes"),r=new moment(t.selectedBooking.BookedDateTime).format("YYYY-MM-DD")+"T"+i.format("HH:mm")+moment.tz(m.timeZone().getTimeZone()).format("Z");if("amount"!=t.discount.type){t.discount.type="amount";var c=t.selectedBooking.ActualCost*t.selectedBooking.Discount/100;t.selectedBooking.Discount=Math.round(100*c)/100}var l=t.selectedBooking,e={BookingStatus:"Confirmed",BookingSource:"Manual",BookedDateTime:r,Bax:l.Bax,Pax:l.Pax,EstimatedCost:l.EstimatedCost,ActualCost:l.ActualCost,DriverCost:l.DriverCost,InvoiceCost:l.InvoiceCost,VehicleClassId:l.VehicleClassId,VehicleTypeId:l.VehicleTypeId,DriverId:l.DriverId,VehicleId:l.VehicleId,ClientId:l.ClientId,BookingStops:t.selectedBooking.BookingStops,PassengerNotes:l.PassengerNotes,DriverNotes:l.DriverNotes,OfficeNotes:l.OfficeNotes,AutoDispatch:!l.DriverId,AsDirected:l.AsDirected,EncodedRoute:l.EncodedRoute,CurrencyId:l.CurrencyId,CurrencyRate:P.getCurrent().CurrentRate,TaxId:l.TaxId,Discount:l.Discount,ChauffeurMode:l.ChauffeurMode,EstimatedMins:l.EstimatedMins,EstimatedDuration:l.EstimatedDuration,EstimatedDistance:l.EstimatedDistance};if(t.paxMode.value){if(!l._LeadPassenger)return void swal("Invalid","Please add passenger details.","error");var a=l._LeadPassenger.split(" ");e.LeadPassenger={Firstname:a[0],Surname:a.slice(1).join(" "),Mobile:l._LeadPassengerNumber,ClientId:l.ClientId}}else{if(!l.LeadPassengerId)return void swal("Invalid","Please add passenger details.","error");e.LeadPassengerId=l.LeadPassengerId}e.CurrencyId&&t.COMPANY.DefaultCurrencyId!=e.CurrencyId&&(e.ActualCost=p("Convert")(e.ActualCost,t.COMPANY.DefaultCurrencyId,e.CurrencyId),e.EstimatedCost=p("Convert")(e.EstimatedCost,t.COMPANY.DefaultCurrencyId,e.CurrencyId),e.DriverCost&&(e.DriverCost=p("Convert")(e.DriverCost,t.COMPANY.DefaultCurrencyId,e.CurrencyId)),e.InvoiceCost&&(e.InvoiceCost=p("Convert")(e.InvoiceCost,t.COMPANY.DefaultCurrencyId,e.CurrencyId))),o.post(n.API_ENDPOINT+"api/bookings",e).success(function(e){swal("Success","Booking Saved","success"),s.go("root.bookings")}).error(function(){swal("Error","Something didn't work, please check input and try again","error")})}function w(e){c.Maps.Directions.route(e).then(function(e){t.directions.setDirections(e)})}function A(e){t.startNew(),P.setCurrent(t.COMPANY.DefaultCurrencyId)}var M=null;t.viewMode="CREATE",t.paxMode={value:!1},t.showTraffic=!1,t.selectedBooking=null,t.clients=d,t.vehicleTypes=g,t.vehicleClasses=C,t.passengers=u,t.drivers=k,t.vehicles=B,t.taxes=h,t.setupComplete=!1,t.startNew=v,t.book=T,t.cancel=A,t.addStop=y,t.getQuote=E,t.getPassengerName=D,t.discount={type:"amount"},t.available=f;var P=m.currency();t.map={center:{latitude:t.COMPANY.BaseLatitude||51.471507,longitude:t.COMPANY.BaseLongitude||-.487904},disableDefaultUI:!0,styles:[{featureType:"landscape",stylers:[{hue:"#FFBB00"},{saturation:43.400000000000006},{lightness:37.599999999999994},{gamma:1}]},{featureType:"road.highway",stylers:[{hue:"#FFC200"},{saturation:-61.8},{lightness:45.599999999999994},{gamma:1}]},{featureType:"road.arterial",stylers:[{hue:"#FF0300"},{saturation:-100},{lightness:51.19999999999999},{gamma:1}]},{featureType:"road.local",stylers:[{hue:"#FF0300"},{saturation:-100},{lightness:52},{gamma:1}]},{featureType:"water",stylers:[{hue:"#0078FF"},{saturation:-13.200000000000003},{lightness:2.4000000000000057},{gamma:1}]},{featureType:"poi",stylers:[{hue:"#00FF6A"},{saturation:-1.0989010989011234},{lightness:11.200000000000017},{gamma:1}]}],zoom:t.COMPANY.BaseZoom||7,traffic:{show:!1,options:{}}},t.paxFilter=function(e){return!t.selectedBooking.ClientId||e.ClientId==t.selectedBooking.ClientId},t.directions={renderer:null,current:null,currentRoute:null,currentStep:null,setRoute:function(e){e!=this.currentRoute&&(this.currentRoute=e,this.currentStep=null,this.renderer.setRouteIndex(this.current.routes.indexOf(e)))},viewStep:function(e){this.currentStep=e,t.map.center.latitude=e.start_point.lat(),t.map.center.longitude=e.start_point.lng()},setDirections:function(e){this.current=e,this.currentStep=null,this.currentRoute=e?e.routes[0]:null,this.options.directions=e,e?(t.selectedBooking.EncodedRoute=this.currentRoute.overview_polyline,this.renderer?(this.renderer.setDirections(e),this.renderer.setMap(t.map.getGMap())):(this.options.map=t.map.getGMap(),this.renderer=new google.maps.DirectionsRenderer(this.options))):(this.current=null,this.options.directions=null,this.renderer&&this.renderer.setMap(null)),this.currentRoute&&this.currentRoute.legs&&this.currentRoute.legs[0]&&(t.selectedBooking.EstimatedDuration=10*Math.ceil(this.currentRoute.legs[0].duration.value/600),t.selectedBooking.EstimatedDistance=this.currentRoute.legs[0].distance.value)},options:{suppressInfoWindows:!0,suppressMarkers:!1,directions:null,panel:document.getElementById("google-directions")}},t.$watch("selectedBooking.AsDirected",function(e){if(e)t.selectedBooking.BookingStops.length--;else{var o=new a.BookingStop;t.selectedBooking.BookingStops.push(o)}}),t.$watch("selectedBooking.BookingStops",function(){if(t.selectedBooking.AsDirected);else if(t.selectedBooking.BookingStops.length<2)return t.selectedBooking.EstimatedCost=0,void(t.selectedBooking.validStops=!1);var o=!0;e.forEach(t.selectedBooking.BookingStops,function(e){e.Latitude&&e.Longitude||(o=!1)}),o?(w(t.selectedBooking.BookingStops.map(function(e){return new google.maps.LatLng(e.Latitude,e.Longitude)})),t.selectedBooking.validStops=!0,E()):(t.directions.setDirections(null),t.selectedBooking.EstimatedCost=0,t.selectedBooking.ActualCost=0,t.selectedBooking.Discount=0,t.selectedBooking.validStops=!1)},!0),t.$watch("selectedBooking.ClientId",function(){if(t.selectedBooking.ClientId){var e=t.clients.filter(function(e){return e.Id==t.selectedBooking.ClientId})[0];e&&(t.selectedBooking.CurrencyId=e.DefaultCurrencyId)}},!0),t.$watchGroup(["selectedBooking.BookingStops.length","selectedBooking.ClientId","selectedBooking.VehicleTypeId","selectedBooking.ChauffeurMode","selectedBooking.EstimatedMins"],function(){M&&(i.cancel(M),M=null),1==t.setupComplete&&(M=i(E,500))}),t.$watch("selectedBooking.VehicleTypeId",function(e){a.Vehicle.query().select("Id,Registration,Colour,Make,Model,Class,Type").where("VehicleTypeId","==","guid'"+e+"'").include("Class,Type").parseAs(function(e){this.Id=e.Id,this.Name=e.Registration,this.Description=e.Colour+" "+e.Make+" "+e.Model,this.DriverId=e.DriverId,this.ImageUrl=window.formatImage(e.ImageUrl,e.Registration)}).execute().then(function(e){t.vehicles=e})}),t.$watch("selectedBooking.Discount",function(){t.selectedBooking.Currency&&(t.Discount=t.selectedBook)}),t.$watch("selectedBooking.DriverCost",function(){t.selectedBooking.Currency&&(t.DriverCost=t.selectedBo)}),t.$watch("selectedBooking.InvoiceCost",function(){t.selectedBooking.Currency&&(t.InvoiceCost=t.selectedB)}),t.$watch("selectedBooking.CurrencyId",function(){P.setCurrent(t.selectedBooking.CurrencyId);var e=t.available.filter(function(e){return e.Id==t.selectedBooking.CurrencyId})[0];t.selectedBooking.CurrencyRate=e.CurrentRate,t.symbol=e.Prepend,t.selectedBooking.Currency=e,t.selectedBooking.ActualCost=((t.ActualCost||0)*e.CurrentRate).toFixed(2),t.selectedBooking.EstimatedCost=((t.EstimatedCost||0)*e.CurrentRate).toFixed(2),t.selectedBooking.DriverCost&&(t.selectedBooking.DriverCost=((t.DriverCost||t.selectedBooking.DriverCost)*e.CurrentRate).toFixed(2)),t.selectedBooking.InvoiceCost&&(t.selectedBooking.InvoiceCost=((t.InvoiceCost||t.selectedBooking.InvoiceCost)*e.CurrentRate).toFixed(2)),"amount"==t.discount.type&&(t.selectedBooking.Discount=((t.Discount||t.selectedBooking.Discount)*e.CurrentRate).toFixed(2)),t.setupComplete=!0}),t.startNew()}function o(t,o,n,s,i,r,c,l,a,d,u,g,C,k,B,m,p,f,h,I,v,D){function y(){var e=I.getSession().access_token,o=window.encodeURIComponent(s.API_ENDPOINT+"Exports/BookingReceipt/template.html#/?token="+e+"&bookingid="+t.selectedBooking.Id);h.open("http://h2p.utilities.e9ine.com/?url="+o+"&filename="+t.selectedBooking.Id,"_blank")}function E(e){r.Maps.Directions.route(e).then(function(e){t.directions.setDirections(e)})}function T(){t.viewMode="EDIT"}function w(){var e={ActualCost:t.selectedBooking.ActualCost,EstimatedCost:t.selectedBooking.EstimatedCost,DriverCost:t.selectedBooking.DriverCost,InvoiceCost:t.selectedBooking.InvoiceCost,DiscountCost:t.selectedBooking.DiscountCost};t.selectedBooking.$rollback(!0),t.selectedBooking.ActualCost=e.ActualCost,t.selectedBooking.EstimatedCost=e.EstimatedCost,t.selectedBooking.DriverCost=e.DriverCost,t.selectedBooking.InvoiceCost=e.InvoiceCost,t.selectedBooking.DiscountCost=e.DiscountCost,t.selectedBooking.Client?N.setCurrent(t.selectedBooking.Client.DefaultCurrencyId):N.setCurrent(t.COMPANY.DefaultCurrencyId),t.viewMode="VIEW"}function A(e){var o=t.selectedBooking.Passengers.filter(function(t){return t.Id==e})[0];if(o)return o.Firstname+" "+o.Surname}function M(){n({url:s.API_ENDPOINT+"api/bookings",params:{Id:t.selectedBooking.Id},method:"PATCH",data:{Id:t.selectedBooking.Id,BookingStatus:"Cancelled"}}).success(function(){t.selectedBooking.BookingStatus="Cancelled",swal("Booking Cancelled","This Booking has been cancelled","success")}).error(function(){swal("Error","Something didn't work, please check input and try again","error")})}function P(){var o=(t.selectedBooking.BookedDateTime,t.selectedBooking.Time),i=new moment(t.selectedBooking.Time).add(moment.tz.zone(m.timeZone().getTimeZone()).offset(new Date),"minutes"),r=new moment(t.selectedBooking.BookedDateTime).format("YYYY-MM-DD")+"T"+i.format("HH:mm")+moment.tz(m.timeZone().getTimeZone()).format("Z");if(t.selectedBooking.BookedDateTime=r,t.selectedBooking.LeadPassenger=null,"amount"!=t.discount.type){t.discount.type="amount";var c=t.selectedBooking.ActualCost*t.selectedBooking.Discount/100;t.selectedBooking.Discount=Math.round(100*c)/100}t.EstimatedCost=t.selectedBooking.EstimatedCost,t.ActualCost=t.selectedBooking.ActualCost,t.DriverCost=t.selectedBooking.DriverCost,t.InvoiceCost=t.selectedBooking.InvoiceCost,t.DiscountCost=t.selectedBooking.Discount,t.selectedBooking.ActualCost=t.selectedBooking.ActualCost/t.selectedBooking.CurrencyRate,t.selectedBooking.DriverCost=t.selectedBooking.DriverCost/t.selectedBooking.CurrencyRate,t.selectedBooking.EstimatedCost=t.selectedBooking.EstimatedCost/t.selectedBooking.CurrencyRate,t.selectedBooking.InvoiceCost=t.selectedBooking.InvoiceCost/t.selectedBooking.CurrencyRate,t.selectedBooking.Discount=t.selectedBooking.Discount/t.selectedBooking.CurrencyRate,delete t.selectedBooking.Time;var l=e.copy(t.selectedBooking);delete l.Currency,delete l.Client,delete l.Time,delete l.Vehicle,delete l.LeadPassenger,n.put(s.API_ENDPOINT+"api/bookings",l,{params:{Id:l.Id}}).success(function(){t.selectedBooking.BookedDateTime=new moment(t.selectedBooking.BookedDateTime).format(),swal("Booking Updated","This Booking has been updated","success"),t.viewMode="VIEW",t.selectedBooking.ActualCost=t.ActualCost,t.selectedBooking.DriverCost=t.DriverCost,t.selectedBooking.EstimatedCost=t.EstimatedCost,t.selectedBooking.InvoiceCost=t.InvoiceCost,t.selectedBooking.Discount=t.DiscountCost,t.selectedBooking.Time=o}).error(function(){t.selectedBooking.BookedDateTime=new moment(t.selectedBooking.BookedDateTime).format(),swal("Error","Something didn't work, please check input and try again","error"),t.selectedBooking.ActualCost=t.ActualCost,t.selectedBooking.DriverCost=t.DriverCost,t.selectedBooking.EstimatedCost=t.EstimatedCost,t.selectedBooking.InvoiceCost=t.InvoiceCost,t.selectedBooking.Discount=t.DiscountCost,t.selectedBooking.Time=o})}function R(){n.post(s.API_ENDPOINT+"api/quote",t.selectedBooking).success(function(e){t.EstimatedCost=e.FinalCost,t.selectedBooking.EstimatedCost=(t.EstimatedCost*t.selectedBooking.CurrencyRate).toFixed(2),t.selectedBooking.EstimatedMins=e.EstimatedMins}).error(function(e){console.log(e)})}t.viewMode="VIEW";var S=null;t.showTraffic=!1,t.setupComplete=!1,t.paxMode={value:!1},t.discount={type:"amount"},t.selectedBooking=a,t.selectedBooking.BookedDateTime=new Date(t.selectedBooking.BookedDateTime);var F=new moment.tz(a.BookedDateTime,m.timeZone().getTimeZone());F.subtract(moment.tz.zone(m.timeZone().getTimeZone()).offset(new Date),"minutes"),t.selectedBooking.Time=F.toDate(),t.selectedBooking.$commit(!0),t.selectedBooking.BookingStops.map(function(e){e.id=idCounter++}),t.clients=d,t.vehicleTypes=u,t.vehicleClasses=g,t.drivers=C,t.vehicles=k,t.passengers=B,t.taxes=f,t.symbol=t.selectedBooking.Currency.Prepend,t.startEdits=T,t.cancel=w,t.save=P,t.cancelBooking=M,t.getPassengerName=A,t.EstimatedCost=t.selectedBooking.EstimatedCost,t.ActualCost=t.selectedBooking.ActualCost,t.DriverCost=t.selectedBooking.DriverCost,t.InvoiceCost=t.selectedBooking.InvoiceCost,t.Discount=t.selectedBooking.Discount,t.selectedBooking.ActualCost=t.ActualCost*t.selectedBooking.CurrencyRate,t.selectedBooking.DriverCost=t.DriverCost*t.selectedBooking.CurrencyRate,t.selectedBooking.EstimatedCost=t.EstimatedCost*t.selectedBooking.CurrencyRate,t.selectedBooking.InvoiceCost=t.InvoiceCost*t.selectedBooking.CurrencyRate,t.selectedBooking.Discount=t.Discount*t.selectedBooking.CurrencyRate,t.selectedBooking.ActualCost&&(t.selectedBooking.ActualCost=t.selectedBooking.ActualCost.toFixed(2)),t.selectedBooking.DriverCost&&(t.selectedBooking.DriverCost=t.selectedBooking.DriverCost.toFixed(2)),t.selectedBooking.EstimatedCost&&(t.selectedBooking.EstimatedCost=t.selectedBooking.EstimatedCost.toFixed(2)),t.selectedBooking.InvoiceCost&&(t.selectedBooking.InvoiceCost=t.selectedBooking.InvoiceCost.toFixed(2)),t.selectedBooking.Discount&&(t.selectedBooking.Discount=t.selectedBooking.Discount.toFixed(2)),t.getQuote=R;var N=m.currency();t.exportReceipt=y,t.paxFilter=function(e){return!t.selectedBooking.ClientId||e.ClientId==t.selectedBooking.ClientId},t.map={center:{latitude:t.COMPANY.BaseLatitude||51.471507,longitude:t.COMPANY.BaseLongitude||-.487904},disableDefaultUI:!0,styles:[{featureType:"landscape",stylers:[{hue:"#FFBB00"},{saturation:43.400000000000006},{lightness:37.599999999999994},{gamma:1}]},{featureType:"road.highway",stylers:[{hue:"#FFC200"},{saturation:-61.8},{lightness:45.599999999999994},{gamma:1}]},{featureType:"road.arterial",stylers:[{hue:"#FF0300"},{saturation:-100},{lightness:51.19999999999999},{gamma:1}]},{featureType:"road.local",stylers:[{hue:"#FF0300"},{saturation:-100},{lightness:52},{gamma:1}]},{featureType:"water",stylers:[{hue:"#0078FF"},{saturation:-13.200000000000003},{lightness:2.4000000000000057},{gamma:1}]},{featureType:"poi",stylers:[{hue:"#00FF6A"},{saturation:-1.0989010989011234},{lightness:11.200000000000017},{gamma:1}]}],zoom:t.COMPANY.BaseZoom||7,traffic:{show:!1,options:{}}},t.directions={renderer:null,current:null,currentRoute:null,currentStep:null,setRoute:function(e){e!=this.currentRoute&&(this.currentRoute=e,this.currentStep=null,this.renderer.setRouteIndex(this.current.routes.indexOf(e)))},viewStep:function(e){this.currentStep=e,t.map.center.latitude=e.start_point.lat(),t.map.center.longitude=e.start_point.lng()},setDirections:function(e){this.current=e,this.currentStep=null,this.currentRoute=e?e.routes[0]:null,this.options.directions=e,e?(t.selectedBooking.EncodedRoute=this.currentRoute.overview_polyline,this.renderer?(this.renderer.setDirections(e),this.renderer.setMap(t.map.getGMap())):(this.options.map=t.map.getGMap(),this.renderer=new google.maps.DirectionsRenderer(this.options))):(this.current=null,this.options.directions=null,this.renderer&&this.renderer.setMap(null))},options:{suppressInfoWindows:!0,suppressMarkers:!1,directions:null,panel:document.getElementById("google-directions")}},t.$watchGroup(["selectedBooking.BookingStops.length","selectedBooking.ClientId","selectedBooking.VehicleTypeId","selectedBooking.ChaffuerMode","selectedBooking.EstimatedMins"],function(){return 0==t.setupComplete?void(t.setupComplete=!0):(S&&(i.cancel(S),S=null),void(S=i(R,500)))}),t.$watch("selectedBooking.BookingStops",function(){if("EDIT"===t.viewMode){if(t.selectedBooking.AsDirected);else if(t.selectedBooking.BookingStops.length<2)return t.selectedBooking.EstimatedCost=0,void(t.selectedBooking.validStops=!1);var o=!0;e.forEach(t.selectedBooking.BookingStops,function(e){e.Latitude&&e.Longitude||(o=!1)}),o?(E(t.selectedBooking.BookingStops.map(function(e){return new google.maps.LatLng(e.Latitude,e.Longitude)})),t.selectedBooking.validStops=!0):(t.directions.setDirections(null),t.selectedBooking.EstimatedCost=0,t.selectedBooking.validStops=!1)}},!0),E(t.selectedBooking.BookingStops.map(function(e){return new google.maps.LatLng(e.Latitude,e.Longitude)})),t.emailTo=function(e,t){var o=D.open({templateUrl:"/webapp/common/modals/email-to.modal.html",controller:["$scope","emailAddress","$modalInstance",function(e,t,o){null!=t&&(e.email=t),e.sendEmail=function(){o.close(e.email)}}],resolve:{emailAddress:function(){var o=null;switch(e){case"DRIVER":o=t.Driver?t.Driver.Email:null;break;case"PAX":o=t.LeadPassenger?t.LeadPassenger.Email:null;break;case"CLIENT":o=t.Client?t.Client.Email:null}return o}}});o.result.then(function(o){null!=o&&(swal("Success","User will receive the email soon..","success"),"DRIVER"==e?n.post(s.API_ENDPOINT+"api/email",{Type:"DriverConfirmation",BookingId:t.Id,DriverId:t.DriverId,EmailId:o}).success(function(){v.success("Email Sent")}):"PAX"==e?n.post(s.API_ENDPOINT+"api/email",{Type:"PassengerConfirmation",BookingId:t.Id,PassengerId:t.LeadPassengerId,EmailId:o}).success(function(){v.success("Email Sent")}):"CLIENT"==e&&n.post(s.API_ENDPOINT+"api/email",{Type:"ClientConfirmation",BookingId:t.Id,ClientId:t.ClientId,EmailId:o}).success(function(){v.success("Email Sent")}))})}}var n=e.module("cab9.client.bookings");n.controller("BookingCreateController",t),n.controller("BookingEditController",o),t.$inject=["$scope","$http","$config","$state","$timeout","Auth","Google","$tenantConfig","Model","rClients","rPassengers","rVehicleTypes","rVehicleClasses","rDrivers","rVehicles","Localisation","$filter","rCurrencies","rTaxes","$window"],o.$inject=["$scope","$q","$http","$config","$timeout","Google","$tenantConfig","Model","rBooking","rClients","rVehicleTypes","rVehicleClasses","rDrivers","rVehicles","rPassengers","Localisation","$filter","rTaxes","$window","Auth","Notification","$modal"]}(angular);;;;
!function(e){function n(n,t,o,a,s,r,l,d,s,g,c,u,m,p,f,h){function k(){n._dbooking.ChauffeurMode=!0,n._dbooking.EstimatedMins="60"}function C(){n._dbooking.ChauffeurMode=!1,n._dbooking.EstimatedMins=null}function b(){var e=o.open({templateUrl:"/webapp/common/modals/add-payment-card/partial.html",controller:"AddPaymentCardController",windowClass:"add-payment-card-modal-wrapper",resolve:{rPassengerId:function(){return n._dbooking.LeadPassengerId},rClientId:function(){return null},rDriverId:function(){return null}}});e.result.then(function(e){n.card={Id:e.Id,Name:e.CardNumber,Description:e.Type.toUpperCase()+" - Expiring "+e.ExpirationMonth+"/"+e.ExpirationYear},n.filteredPaymentCards.push(n.card),n._dbooking.PaymentCardId=e.Id})}function I(){var e=n._dbooking.BookingStops[0];n._dbooking.BookingStops[0]=n._dbooking.BookingStops[1],n._dbooking.BookingStops[1]=e}function A(e){for(var n="[a-z]",t="[A-Z]",o="[0-9]",i="^",a=0,s=!1,r=!1,l=0;l<e.length;l++){var d=e[l];if("'"===d)i+=r?")":"(",r=!r;else if(r)["."].indexOf(d)!=-1&&(d="\\"+d),i+=d;else if(">"===d){if(a++,a>1)throw"Bad Mask - Case blocks have consecutive > without ending previous block"}else if("<"===d){if(a--,a<-1)throw"Bad Mask - Case blocks have consecutive < without ending previous block"}else"0"===d?(s=!0,i+="("+o+")"):"9"===d?i+="("+o+"?)":1===a?"A"===d?(s=!0,i+="("+t+"|"+o+")"):"a"===d?i+="("+t+"?|"+o+"?)":"L"===d?(s=!0,i+="("+t+")"):"l"===d&&(i+="("+t+"?)"):0===a?"A"===d?(s=!0,i+="("+n+"|"+t+"|"+o+")"):"a"===d?i+="("+n+"?|"+t+"?|"+o+"?)":"L"===d?(s=!0,i+="("+n+"|"+t+")"):"l"===d&&(i+="("+n+"?|"+t+"?)"):a===-1&&("A"===d?(s=!0,i+="("+n+"|"+o+")"):"a"===d?i+="("+n+"?|"+o+"?)":"L"===d?(s=!0,i+="("+n+")"):"l"===d&&(i+="("+n+"?)"))}if(r)throw"Bad Mask - Quoted section not terminated";if(!s)throw"Bad Mask - Must contain at least 1 mandatory symbol (A, L, 0)";return i+="$",new RegExp(i)}function T(e){n._dbooking.WaitAndReturn&&n._dbooking.BookingStops.length<4?swal("Cannot remove via Stop","WaitAndReturn booking should have a via stop","warning"):n._dbooking.BookingStops.splice(e,1),n._dbooking.BookingStops.length<3&&(n.sortableOptions.disabled=!0)}function w(e){e?n.fetchedPassengers=n.passengers.filter(function(n){return n.Name.toLowerCase().startsWith(e.toLowerCase())}):n.fetchedPassengers=[],n.fetchedPassengers.push({Id:"add-passenger",Name:"Add Passenger",Description:"Create New Passenger",ImageUrl:"/includes/images/add-icon.png"})}function P(e){e?n.filteredBookers=n.bookers.filter(function(n){return n.Name.toLowerCase().startsWith(e.toLowerCase())}):n.filteredBookers=[],n.filteredBookers.push({Id:"add-booker",Name:"Add Booker",Description:"Create New Booker",ImageUrl:"/includes/images/add-icon.png"})}function _(e,t){var o=g.timeZone().getTimeZone(),i=(new Date).getTimezoneOffset(),a=moment.tz.zone(o).offset(new Date),s=new moment.tz(o).add(i-a,"minutes");"day"==t?n._dbooking.Date=s.add(e,"minutes").toDate():"time"==t&&(n._dbooking.Time=s.startOf("minute").add(e,"minutes").toDate())}function B(e,t){var o=n._dbooking.Tags.find(function(n){return n.Id==e.Id});if(!o){n._dbooking.Tags.push(e);var i=n.unlinkedTags.find(function(n){return n.Id==e.Id});i&&n.unlinkedTags.splice(n.unlinkedTags.indexOf(i),1),n._dbooking.$selectedTag=null,t.selected=null}}function y(e){n.unlinkedTags.push(e);var t=n._dbooking.Tags.find(function(n){return n.Id==e.Id});t&&n._dbooking.Tags.splice(n._dbooking.Tags.indexOf(t),1),n._dbooking.$selectedTag=null}function v(){n.flightData={Number:""};var e=n._dbooking=new r.Booking;n.displayMode="CREATE",e.ClientId=d.CLIENTID,n.isAdmin||(e.ClientStaffId=f.getSession().Claims.ClientStaffId[0]),e.BookingStops=[],e.BookingValidations=[],e.BookingStops.push(new r.BookingStop),e.BookingStops.push(new r.BookingStop),e.TaxId=n.COMPANY.DefaultTaxId,e.AsDirected=!1;var t=g.timeZone().getTimeZone()||"Europe/London",o=(new Date).getTimezoneOffset(),i=moment.tz.zone(t).offset(new Date),a=new moment.tz(t).add(o-i,"minutes");e.Date=a.toDate(),e.Time=new Date(a.startOf("minute").add(15,"minutes").format()),e.CurrencyId=n.COMPANY.DefaultCurrencyId,e.EstimatedCost=0,e.Pax=n.COMPANY.DefaultPax,e.Bax=n.COMPANY.DefaultBax,e.TextConfirmation=n.COMPANY.TextConfirmation,e.EmailConfirmation=n.COMPANY.EmailConfirmation,e.TextOnArrival=n.COMPANY.TextOnArrival,e.CallOnArrival=n.COMPANY.CallOnArrival,e.TextAssigned=n.COMPANY.TextAssigned,e.EmailAssigned=n.COMPANY.EmailAssigned,e.TextOnCompletion=n.COMPANY.TextOnCompletion}function O(){var t=[];n.dataReady=!1;var o=(r.Client.query().select("Id,Name,AccountNo,AccountPassword,OnHold,DefaultCurrencyId,ImageUrl,ClientType/Name,ClientReferences,Tags,AllVehicleTypeAccess,Phone,VehicleTypes,KnownLocations,Address1,Address2,Area,TownCity,County,Postcode,Country,Latitude,Longitude,BillingAddress1,BillingAddress2,BillingArea,BillingTownCity,BillingCounty,BillingPostcode,BillingCountry,BillingLatitude,BillingLongitude,DefaultVehicleTypeId,TextConfirmation,EmailConfirmation,TextOnArrival,CallOnArrival,TextAssigned,EmailAssigned,TextOnCompletion,AutoDispatch").include("ClientType,ClientReferences,VehicleTypes,KnownLocations,Tags").where("Id eq guid'"+d.CLIENTID+"'").execute().then(function(o){if(n.client=o[0],n._dbooking.CurrencyId=n.client.DefaultCurrencyId,n._dbooking.TextConfirmation=null!=n.client.TextConfirmation?n.client.TextConfirmation:n.COMPANY.TextConfirmation,n._dbooking.EmailConfirmation=null!=n.client.EmailConfirmation?n.client.EmailConfirmation:n.COMPANY.EmailConfirmation,n._dbooking.TextOnArrival=null!=n.client.TextOnArrival?n.client.TextOnArrival:n.COMPANY.TextOnArrival,n._dbooking.CallOnArrival=null!=n.client.CallOnArrival?n.client.CallOnArrival:n.COMPANY.CallOnArrival,n._dbooking.TextAssigned=null!=n.client.TextAssigned?n.client.TextAssigned:n.COMPANY.TextAssigned,n._dbooking.EmailAssigned=null!=n.client.EmailAssigned?n.client.EmailAssigned:n.COMPANY.EmailAssigned,n._dbooking.TextOnCompletion=null!=n.client.TextOnCompletion?n.client.TextOnCompletion:n.COMPANY.TextOnCompletion,n._dbooking.AutoDispatch=n.client.AutoDispatch,n.clientReferences=e.copy(n.client.ClientReferences),n.clientReferences=n.clientReferences.filter(function(e){return e.Active}).map(function(e){return"Mask"==e.ReferenceType&&(e.$testReg=A(e.Value)),"List"==e.ReferenceType&&e.ShowList&&u({method:"GET",url:a.API_ENDPOINT+"/api/ClientReferences/list?ClientReferenceId="+e.Id}).then(function(n){e.$list=n.data.map(function(e){return{custom:!1,text:e}}),e.AllowAddToList&&e.$list.push({custom:!0,text:"Add '{{$select.search}}' to References"})}),e}),n.client.Tags)for(var i=0;i<n.client.Tags.length;i++)1==n.client.Tags[i].ClientVisible&&B(n.client.Tags[i]);if(n.client.AllVehicleTypeAccess===!1)n.filteredVehicleTypes=n.client.VehicleTypes.sort(function(e,n){return(e.Order||99)-(n.Order||99)}).map(function(e){return e.ImageUrl=null,e}),n.client.DefaultVehicleTypeId?n._dbooking.VehicleTypeId=n.client.DefaultVehicleTypeId:n._dbooking.VehicleTypeId=n.filteredVehicleTypes[0].Id;else{var s=r.VehicleType.query().parseAs(function(e){this.Id=e.Id,this.Name=e.Name,this.Description=e.Description,this.IsDefault=e.IsDefault,this.Priority=e.Priority,this.Order=e.Order,this.ImageUrl=null}).execute().then(function(e){n.filteredVehicleTypes=n.vehicleTypes=e.sort(function(e,n){return(e.Order||99)-(n.Order||99)})});t.push(s)}if([].push.apply(n.externalLocations.knownLocations,n.client.KnownLocations),n.client.Latitude&&n.client.Longitude){var l="";n.client.Address1&&n.client.Address1.length>1&&(l+=n.client.Address1),n.client.TownCity?(l.length>0&&(l+=", "),l+=n.client.TownCity):n.client.Area&&(l.length>0&&(l+=", "),l+=n.client.Area),n.client.Postcode&&(l.length>0&&(l+=", "),l+=n.client.Postcode),n.externalLocations.knownLocations.push({Address1:n.client.Address1,Address2:n.client.Address2,Area:n.client.Area,TownCity:n.client.TownCity,County:n.client.County,Postcode:n.client.Postcode,Country:n.client.Country,Latitude:n.client.Latitude,Longitude:n.client.Longitude,Name:"Office Address",StopSummary:l,LocationType:"OFFICE"})}if(n.client.BillingLatitude&&n.client.BillingLongitude&&n.client.BillingLatitude!=n.client.Latitude&&n.client.Longitude!=n.client.BillingLongitude){var l="";n.client.BillingAddress1&&n.client.BillingAddress1.length>1&&(l+=n.client.BillingAddress1),n.client.BillingTownCity?(l.length>0&&(l+=", "),l+=n.client.BillingTownCity):n.client.BillingArea&&(l.length>0&&(l+=", "),l+=n.client.BillingArea),n.client.BillingPostcode&&(l.length>0&&(l+=", "),l+=n.client.BillingPostcode),n.externalLocations.knownLocations.push({Address1:n.client.BillingAddress1,Address2:n.client.BillingAddress2,Area:n.client.BillingArea,TownCity:n.client.BillingTownCity,County:n.client.BillingCounty,Postcode:n.client.BillingPostcode,Country:n.client.BillingCountry,Latitude:n.client.BillingLatitude,Longitude:n.client.BillingLongitude,Name:"Billing Address",StopSummary:l,LocationType:"OFFICE"})}m(function(){var e=$("#passenger-info").height()-37;$(".form-control.client-notes").css("height",e+"px")},100),n.client.OnHold&&swal({title:"Account On Hold",text:"This account is currently on hold, new bookings have been disabled.",type:"error",animation:"slide-from-top"}),n.client.AccountPassword&&swal({title:"Account Password",text:"This account is password enabled.",type:"input",showCancelButton:!1,closeOnConfirm:!1,allowEscapeKey:!1,allowOutsideClick:!1,animation:"slide-from-top",inputPlaceholder:"Account Password"},function(e){return e===!1?(n._dbooking.ClientId=null,n.$apply(),!1):""===e?(swal.showInputError("You need to write something!"),!1):e!=n.client.AccountPassword?(swal.showInputError("Incorrect Password"),!1):void swal("Accepted","The password is valid. Please continue with the booking.","success")})}),r.Note.query().where("OwnerType eq 'Client'").where("OwnerId eq guid'"+d.CLIENTID+"'").execute().then(function(e){var t="";for(i=0;i<e.length;i++)t+=e[i].Content+"\r\n\r\n";n.clientNotes=t}));if(n.isAdmin){var l=r.Passenger.query().where("ClientId eq guid'"+d.CLIENTID+"'").select("Id,Firstname,Surname,ImageUrl,Mobile,Phone,ClientId,Client/Name,Addresses").include("Client, Addresses").parseAs(function(e){this.Id=e.Id,this.ClientId=e.ClientId,this.Name=e.Firstname+" "+e.Surname,this.Description=e.Client&&e.Client.Name?e.Client.Name:"No Client",this.Mobile=e.Mobile,this.Phone=e.Phone,this.ImageUrl=c.formatUrl(e.ImageUrl,e.Firstname),this.Addresses=e.Addresses}).execute().then(function(e){n.passengers=e}),g=r.ClientStaff.query().where("ClientId eq guid'"+d.CLIENTID+"'").select("Id,Firstname,Surname,ImageUrl,Mobile,AllPassengers,Passengers,ClientId,Client/Name").include("Client,Passengers").parseAs(function(e){this.Id=e.Id,this.ClientId=e.ClientId,this.Name=e.Firstname+" "+e.Surname,this.AllPassengers=e.AllPassengers,this.Passengers=e.Passengers,this.Description=e.Client&&e.Client.Name?e.Client.Name:"No Client",this.Mobile=e.Mobile,this.ImageUrl=c.formatUrl(e.ImageUrl,e.Firstname)}).execute().then(function(e){n.bookers=e});t.push(l),t.push(g)}else{var p=r.ClientStaff.query().filter("Id eq guid'"+f.getSession().Claims.ClientStaffId[0]+"'").select("Id,Firstname,Surname,ImageUrl,Mobile,AllPassengers,Passengers,ClientId,Client/Name, Passengers/Client/Name").include("Client, Passengers/Addresses, Passengers/Client").execute().then(function(e){n.selectedBooker=e[0],e[0].AllPassengers?(l=r.Passenger.query().filter("ClientId eq guid'"+f.getSession().Claims.ClientId[0]+"'").select("Id,Firstname,Surname,ImageUrl,Mobile,Phone,ClientId,Client/Name, Addresses").include("Client, Addresses").parseAs(function(e){this.Id=e.Id,this.ClientId=e.ClientId,this.Name=e.Firstname+" "+e.Surname,this.Description=e.Client&&e.Client.Name?e.Client.Name:"No Client",this.Mobile=e.Mobile,this.Phone=e.Phone,this.ImageUrl=c.formatUrl(e.ImageUrl,e.Firstname),this.Addresses=e.Addresses}).execute().then(function(e){n.passengers=e}),t.push(l)):n.passengers=e[0].Passengers.map(function(e){var n={};return n.Id=e.Id,n.ClientId=e.ClientId,n.Name=e.Firstname+" "+e.Surname,n.Description=e.Client&&e.Client.Name?e.Client.Name:"No Client",n.Mobile=e.Mobile,n.Phone=e.Phone,n.ImageUrl=c.formatUrl(e.ImageUrl,e.Firstname),n.Addresses=e.Addresses,n})});t.push(p)}var h=r.BookingRequirement.query().execute().then(function(e){n.bookingRequirements=n.unlinkedRequirements=e});t.push(o),t.push(h),s.all(t).then(function(){n.dataReady=!0})}function S(e,n){n?u({method:"GET",url:a.API_ENDPOINT+"/api/ClientReferences/suggest?ClientReferenceId="+e.Id+"&Value="+n}).then(function(n){e.$suggested=n.data.map(function(e){return{custom:!1,text:e}}),e.AllowAddToList&&e.$suggested.push({custom:!0,text:"Add '{{$select.search}}' to References"})},function(n){e.$suggested=[]}):e.$suggested=[]}function L(e,o,i){e.custom&&(e.text=o,swal({title:"Add New Reference?",text:"Are you sure you want to add '"+o+"' to the list of known '"+i.ReferenceName+"' references?",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, Add it!",cancelButtonText:"Cancel",closeOnConfirm:!1,closeOnCancel:!1},function(e){e?u.post(a.API_ENDPOINT+"/api/clientreferences/add?ClientReferenceId="+i.Id+"&ClientReferenceKnownValue="+o).then(function(e){swal({title:"Client Reference Updated.",text:"Changes have been updated.",type:"success",confirmButtonColor:t.COLOURS.brandSecondary})},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:t.COLOURS.brandSecondary}),i.$knownValue=null}):(i.$knownValue=null,swal.close(),n.$apply())}))}function N(e){n._dbooking.BookingRequirements.push(e);var t=n.unlinkedRequirements.filter(function(n){return n.Id==e.Id});t[0]&&n.unlinkedRequirements.splice(n.unlinkedRequirements.indexOf(t[0]),1),n._dbooking.$selectedRequirement=null}function x(e){n.unlinkedRequirements.push(e);var t=n._dbooking.BookingRequirements.filter(function(n){return n.Id==e.Id});t[0]&&n._dbooking.BookingRequirements.splice(n._dbooking.BookingRequirements.indexOf(t[0]),1)}function E(){if(n.clientReferences.length>0)for(var e=0;e<n.clientReferences.length;e++){var t=n.clientReferences[e];if("Mask"==t.ReferenceType)return!(t.$testReg.test(t.$knownValue)||!t.$knownValue&&!t.Mandatory)}return!1}function D(){n._dbooking.BookingStops.reverse()}function R(e){moment(n._dbooking.BookedDateTime).isBefore(moment.utc(),"minute")?swal({title:"Booking in the Past",text:"The booking date & time are in the past.",type:"error",closeOnConfirm:!0}):M(e)}function M(e){$("#bookingsave").prop("disabled",!0),$("#bookingrepeat").prop("disabled",!0),e?$("#bookingrepeat").html("<i class='fa fa-circle-o-notch fa-spin'></i> Saving..."):$("#bookingsave").html("<i class='fa fa-circle-o-notch fa-spin'></i> Saving..."),n.dataReady=!1;var o=[];n.dataReady=!0,n.newBooker&&n.newBooker.Id==n._dbooking.ClientStaffId?(n.newBooker.Passengers=[],n.newBooker.Passengers.push(n.selectedPassenger),u.post(a.API_ENDPOINT+"api/ClientStaff/ManagePassengers",n.newBooker).then(function(e){},function(e){swal({title:"Error adding passenger to booker",text:"Some error has occured.",type:"error",confirmButtonColor:t.COLOURS.brandSecondary})})):n.newPassenger&&n.newPassenger.Id==n._dbooking.LeadPassengerId&&(n.selectedBooker.Passengers.push(n.selectedPassenger),u.post(a.API_ENDPOINT+"api/ClientStaff/ManagePassengers",n.selectedBooker).then(function(e){},function(e){swal({title:"Error adding passenger to booker",text:"Some error has occured.",type:"error",confirmButtonColor:t.COLOURS.brandSecondary})}));var i=n._dbooking;if(i.$$originalValues.Id=null,n.paxMode.value){if(!i._LeadPassenger)return void swal("Invalid","Please add passenger details.","error");var l=i._LeadPassenger.split(" ");n._dbooking.LeadPassenger={Firstname:l[0],Surname:l.slice(1).join(" "),Mobile:i._LeadPassengerNumber,ClientId:i.ClientId}}if(n._dbooking.BookingValidations=[],n.clientReferences.length>0)for(var d=0;d<n.clientReferences.length;d++){var g=n.clientReferences[d],c=new r.BookingValidation;c.ClientReferenceId=g.Id,"List"==g.ReferenceType?c.Value=g.$knownValue&&g.$knownValue.text:c.Value=g.$knownValue,c.Value&&n._dbooking.BookingValidations.push(c)}n._dbooking.BookingTags=[],n._dbooking.Tags&&n._dbooking.Tags.length>0&&n._dbooking.Tags.forEach(function(e){var t={TagId:e.Id,Type:e.Type};n._dbooking.BookingTags.push(t)}),n._dbooking.BookedDateTime=q(n._dbooking.Date,n._dbooking.Time),n._dbooking.BookingSource="CLIENT_PORTAL",o.push(n._dbooking.$save()),s.all(o).then(function(o){var i=o[o.length-1].data.LocalId;swal({title:"Booking Saved.",text:"Booking Reference: #"+i,type:"success",confirmButtonColor:t.COLOURS.brandSecondary}),$("#bookingsave").prop("disabled",!1),$("#bookingrepeat").prop("disabled",!1),e?(n.flightData={Number:""},n._dbooking.FlightInfo=null,n.dataReady=!0,$("#bookingrepeat").html("<i class='material-icons'>repeat_one</i> Save &amp; Repeat")):(U(),n.dataReady=!0,$("#bookingsave").html("<i class='material-icons'>send</i> Save"))},function(e){n.dataReady=!0,e.data&&e.data.Message?swal({title:"Some Error Occured.",text:e.data.Message,type:"error"}):swal({title:"Some Error Occured.",text:"Something went wrong. Cab9 team have been alrerted.",type:"error"}),$("#bookingsave").prop("disabled",!1),$("#bookingrepeat").prop("disabled",!1),$("#bookingsave").html("<i class='material-icons'>send</i>Save"),$("#bookingrepeat").html("<i class='material-icons'>repeat_one</i>Save &amp; Repeat")})}function q(e,n){function t(e,n){var t="000000000"+e;return t.substr(t.length-n)}var o=e.getFullYear(),i=e.getMonth(),a=e.getDate(),s=n.getHours(),r=n.getMinutes(),l=t(o,4)+"-"+t(i+1,2)+"-"+t(a,2)+"T"+t(s,2)+":"+t(r,2)+":00",d=moment.tz(l,"YYYY-MM-DDTHH:mm:ss",g.timeZone().getTimeZone()).format();return d}function U(){Y(),v(),G=null,n.paxMode.value=!1,n.paxHistory=null,n.quote=null}function V(e){var t=new r.BookingStop;t.id=idCounter++,n._dbooking.WaitAndReturn?n._dbooking.BookingStops.splice(e,0,t):n._dbooking.BookingStops.splice(e+1,0,t),n._dbooking.BookingStops.length>2&&(n.sortableOptions.disabled=!1)}function F(){n._dbooking.FlightInfo=null,n.flightData.Number.length>0?u({url:a.API_ENDPOINT+"/api/flightinfo/getflightinfo",method:"GET",params:{flightno:n.flightData.Number,flightDate:q(n._dbooking.Date,n._dbooking.Time)}}).then(function(e){if(e.data){e.data.Id=null,e.data.BookingId=null,e.data.TenantId=null,n._dbooking.FlightInfo=new r.FlightInfo(e.data);var t=g.timeZone().getTimeZone(),o=moment(n._dbooking.FlightInfo.ArrivalTime).toDate().getTimezoneOffset(),i=moment.tz.zone(t).offset(n._dbooking.FlightInfo.ArrivalTime),a=new moment.tz(n._dbooking.FlightInfo.ArrivalTime,t).add(o-i,"minutes");if(n._dbooking.Time=a.toDate(),n.timeSet=!0,e.data.SuggestedAddressId&&n._dbooking.BookingStops[0].$$Id!=e.data.SuggestedAddressId){var s=e.data.SuggestedAddressId;r.Location.query().where("Id eq guid'"+e.data.SuggestedAddressId+"'").execute().then(function(e){var t=new r.BookingStop;t.Address1=e[0].Name?e[0].Name:"",t.StopSummary=e[0].Name?e[0].Name:"",t.Latitude=e[0].Latitude?e[0].Latitude:null,t.Longitude=e[0].Longitude?e[0].Longitude:null,t.$$Id=s,center_moved=!1,n._dbooking.BookingStops[0]=t})}}else swal("Flight Not Found","Please check flight number.","warning")},function(e){swal("Incorrect Flight Number","Please check flight number.","warning")}):swal("Incorrect Flight Number","Please check flight number.","warning")}function Y(){K&&(K.setMap(null),K=null),e.forEach(W,function(e){e.setMap(null)}),W.length=0}function j(e){n.dataReady=!1,n.quoting=!0;for(var t=0;t<n._dbooking.BookingStops.length;t++)n._dbooking.BookingStops[t].StopOrder=t+1;e.BookedDateTime=q(n._dbooking.Date,n._dbooking.Time),e.BookingStatus="Incoming",u.post(a.API_ENDPOINT+"api/quote",e).success(function(o){if(o.Error?(n.quote=o,e.EstimatedCost=0,e.EstimatedDistance=0,e.EstimatedDuration=0,e.ActualCost=0,n.dataReady=!0,n.directions=null):(e.EstimatedCost=o.FinalCost,e.EstimatedDistance=o.EstimatedDistance.toFixed(2),e.EstimatedDuration=o.EstimatedMins,e.ActualCost=o.FinalCost,n.dataReady=!0,n.directions=o.Directions,n.quote=o),n.quoting=!1,o.Directions&&o.Directions.EncodedRoute){var i=google.maps.geometry.encoding.decodePath(o.Directions.EncodedRoute);K=new google.maps.Polyline({map:n.dispatchObj.map.mapObject,path:i,geodesic:!0,strokeColor:"#63C4E1",strokeOpacity:.8,strokeWeight:6});var a=new google.maps.LatLngBounds;for(t=0;t<i.length;t++)a.extend(i[t]);m(function(){n.dispatchObj.map.mapObject.fitBounds(a)},500)}}).error(function(e){console.log(e),n.quoting=!1,n.dataReady=!0})}function z(t){n.journeyCopied=!1,n._dbooking.BookingStops=[],n._dbooking.BookingStops=e.copy(t.BookingStops).map(function(e){return e.Id=null,e.BookingId=null,e.Booking=null,e}),n.journeyCopied=!0,n._dbooking.BookingStops.length>2?n.sortableOptions.disabled=!1:n.sortableOptions.disabled=!0}function Q(e){u.post(a.API_ENDPOINT+"api/clientreferences/validate?ClientReferenceId="+e.Id+"&ReferenceValue="+e.$knownValue).then(function(t){e.$valid=!0,n.validReference=!0},function(o){return 404==o.status?(n.validReference=!1,void(e.$valid=!1)):void swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:t.COLOURS.brandSecondary})})}function H(){var e=new google.maps.LatLng(51.49638419822335,(-.12875142186092203));n.dispatchObj.map.mapObject=new google.maps.Map(document.getElementById("dispatch-map"),{center:e,zoom:11,maxZoom:16,zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_CENTER},panControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},mapTypeControlOptions:{position:google.maps.ControlPosition.TOP_CENTER}})}n.isAdmin="super admin"==d.PERMISSIONS.role.Name.toLowerCase(),n.bookingTags=n.unlinkedTags=h,v(),O(),n.paxMode={value:!1},n.newBooker=null,n.flightData={Number:""},n.addCard=b,n.showPaymentCards=!1,n.sortableOptions={stop:function(e,n){},ondragstart:function(e,n){},disabled:!0};var Z=$(window).height();$("#new-booking").css("height",Z-90),n.selectedPassenger=null,n.flightInfoAvailable=!1,n.save=M,n.flipAddress=I,n.repeatBooking=z,n.cancel=U,n.addTime=_,n.validateClientRef=Q,n.searchPassengers=w,n.searchBookers=P,n.testMaskReferences=E,n.fetchedPassengers=[],n.fetchedClients=[],n.filteredBookers=[],n.vehicleTypes=[],n.enableChauffering=k,n.disableChauffering=C,n.validateBooking=R,n.suggestReferences=S,n.refSelected=L,n.addStop=V,n.removeStop=T,n.reverseStops=D,n.fetchFlightInformation=F,n.externalLocations={knownLocations:[],historic:[]};var W=[],G=null,K=null;n.formatErrorName=function(e){return e.replace("Input","").replace("Id","")},n.$watchGroup(["_dbooking.Date","_dbooking.Time"],function(t){n._dbooking.BookedDateTime=q(t[0],t[1]),n.canQuote=!0,n.timeSet||(n._dbooking.FlightInfo=null),n.timeSet=!1,e.forEach(n._dbooking.BookingStops,function(e,t){e.Latitude&&e.Longitude||(n.canQuote=!1)}),n.canQuote?j(n._dbooking):(n._dbooking.EstimatedCost=0,n._dbooking.ActualCost=0)}),n.addTag=B,n.removeTag=y,n.addRequirement=N,n.removeRequirement=x,n.$watch("_dbooking.ClientStaffId",function(e){if("add-booker"===e){var t=o.open({templateUrl:"/webapp/common/modals/booker/modal.html",controller:"BookerCreateController",resolve:{rBooker:function(){var e=new r.ClientStaff;return e.Phone=n.client.Phone,e.ClientId=n._dbooking.ClientId,e}}});t.result.then(function(e){var t={Id:e.Id,ClientId:e.ClientId,Name:e.Firstname+" "+e.Surname,Description:e.Email?e.Email:"",Mobile:e.Mobile,ImageUrl:c.formatUrl(e.ImageUrl,e.Name)};n.newBooker=e,n.filteredBookers.push(t),n._dbooking.ClientStaffId=e.Id},function(){n._dbooking.ClientStaffId=null})}e?n.selectedBooker=n.filteredBookers.filter(function(n){return n.Id==e})[0]:n.selectedBooker=null}),n.$watch("_dbooking.PaymentMethod",function(t){"Card"==t&&(n._dbooking.TaxId=n.COMPANY.DefaultCardTaxId||n.COMPANY.DefaultTaxId),"Cash"==t?n._dbooking.TaxId=n.COMPANY.DefaultCashTaxId||n.COMPANY.DefaultTaxId:n._dbooking.TaxId=n.COMPANY.DefaultTaxId,n.canQuote=!0,"Card"==t&&void 0!=n._dbooking.LeadPassengerId&&a.CARD_PAYMENTS_ENABLED?(n.filteredPaymentCards=[],u.get(a.API_ENDPOINT+"api/payments/getcardsforpassenger",{params:{passengerId:n._dbooking.LeadPassengerId}}).success(function(t){n.showPaymentCards=!0,e.forEach(t,function(e){n.filteredPaymentCards.push({Id:e.Id,Name:e.CardNumber,Description:e.Type.toUpperCase()+" - Expiring "+e.ExpirationMonth+"/"+e.ExpirationYear})})})):(n.showPaymentCards=!1,n._dbooking.PaymentCard=null,n._dbooking.PaymentCardId=null),e.forEach(n._dbooking.BookingStops,function(e,t){e.Latitude&&e.Longitude||(n.canQuote=!1)}),n.canQuote?j(n._dbooking):(K&&(K.setMap(null),K=null),n.quote=null,n.directions=null,n._dbooking.EstimatedCost=0,n._dbooking.ActualCost=0)}),n.$watch("_dbooking.LeadPassengerId",function(t){function i(){r.Passenger.query().filter("Id","eq","guid'"+t+"'").include("Tags").select("Tags").execute().then(function(e){d.Tags=e[0].Tags,n.passengerTags=d.Tags;for(var t=0;t<d.Tags.length;t++)1==d.Tags[t].ClientVisible&&B(d.Tags[t])})}if("add-passenger"===t){var s=o.open({templateUrl:"/webapp/common/modals/passenger/create.modal.html",controller:"PassengerItemCreateModalController",resolve:{rClientId:function(){return n._dbooking.ClientId},rNavigateAfterSave:function(){return!1}}});return void s.result.then(function(e){var t={Id:e.Id,ClientId:e.ClientId,Name:e.Firstname+" "+e.Surname,Description:e.Email?e.Email:"",Mobile:e.Mobile,Phone:e.Phone,ImageUrl:c.formatUrl(e.ImageUrl,e.Name)};n.newPassenger=e,n.fetchedPassengers.push(t),n._dbooking.ClientId=e.ClientId,n._dbooking.LeadPassengerId=e.Id},function(){})}var l=n._dbooking;if(t){var d=n.fetchedPassengers.filter(function(e){return e.Id==t})[0];n.selectedPassenger=d,l.PassengerNotificationPhone=d.Mobile?d.Mobile:d.Phone,e.forEach(d.Addresses,function(e){if(e.Latitude&&e.Longitude){var t="";e.Address1&&e.Address1.length>1&&(t+=e.Address1),e.TownCity?(t.length>0&&(t+=", "),t+=e.TownCity):e.Area&&(t.length>0&&(t+=", "),t+=e.Area),e.Postcode&&(t.length>0&&(t+=", "),t+=e.Postcode),n.externalLocations.knownLocations.push({Address1:e.Address1,Address2:e.Address2,Area:e.Area,TownCity:e.TownCity,County:e.County,Postcode:e.Postcode,Country:e.Country,Latitude:e.Latitude,Longitude:e.Longitude,Name:e.Name,StopSummary:e.StopSummary||t,LocationType:"Passenger Address"})}}),r.Booking.query().where("LeadPassengerId","eq","guid'"+t+"'").include("BookingStops").orderBy("BookedDateTime desc").top(5).execute().then(function(e){n.paxHistory=e,n.currentTab="HISTORY"}),n.externalLocations.historic.length=0,r.BookingStop.query().where("Booking/LeadPassengerId","eq","guid'"+t+"'").execute().then(function(e){var t={};uniqueResults=e.filter(function(e){return!t[e.Address1]&&(t[e.Address1]=!0,!0)}),[].push.apply(n.externalLocations.historic,uniqueResults)}),d.Tags||i(),"Card"==n._dbooking.PaymentMethod&&a.CARD_PAYMENTS_ENABLED&&(n.filteredPaymentCards=[],u.get(a.API_ENDPOINT+"api/payments/getcardsforpassenger",{params:{passengerId:n._dbooking.LeadPassengerId}}).success(function(t){n.showPaymentCards=!0,e.forEach(t,function(e){n.filteredPaymentCards.push({Id:e.Id,Name:e.CardNumber,Description:e.Type.toUpperCase()+" - Expiring "+e.ExpirationMonth+"/"+e.ExpirationYear})})}))}else if(G||(G=!0,n.filteredPassengers=n.passengers),n.selectedPassenger=null,l.PassengerNotificationPhone=null,n.passengerTags)for(var g=0;g<n.passengerTags.length;g++)y(n.passengerTags[g])}),n.$watch("_dbooking.Date",function(e,t){n.flightData.Number&&e&&e!=t&&F()}),n.$watch("_dbooking.BookingStops[0]",function(t){if(n._dbooking.WaitAndReturn){var o=new r.BookingStop(e.copy(n._dbooking.BookingStops[0]));o.id=idCounter++,n._dbooking.BookingStops.splice(n._dbooking.BookingStops.length-1,1,o)}},!0),n.$watch("_dbooking.WaitAndReturn",function(t){if(t===!1)n._dbooking.BookingStops.splice(n._dbooking.BookingStops.length-1,1);else if(t===!0){var o=new r.BookingStop(e.copy(n._dbooking.BookingStops[0]));o.id=idCounter++,n._dbooking.BookingStops.push(o)}n.canQuote=!0;var i=new google.maps.LatLngBounds,a=0;Y(),e.forEach(n._dbooking.BookingStops,function(e,t){if(e.Latitude&&e.Longitude){a++;var o=new google.maps.LatLng(e.Latitude,e.Longitude);W.push(new google.maps.Marker({position:o,visible:!0,icon:0==t?"/includes/images/user.png":"/includes/images/userTo.png",map:n.dispatchObj.map.mapObject,zIndex:1e3})),i.extend(o)}else n.canQuote=!1}),a>0&&n.dispatchObj.map.mapObject.fitBounds(i)}),n.$watch("_dbooking.BookingStops",function(t){n.canQuote=!0;var o=new google.maps.LatLngBounds,i=0;Y(),e.forEach(t,function(e,t){if(e.Latitude&&e.Longitude){i++;var a=new google.maps.LatLng(e.Latitude,e.Longitude);W.push(new google.maps.Marker({position:a,visible:!0,icon:0==t?"/includes/images/user.png":"/includes/images/userTo.png",map:n.dispatchObj.map.mapObject,zIndex:1e3})),o.extend(a)}else n.canQuote=!1}),i>0&&n.dispatchObj.map.mapObject.fitBounds(o),n.canQuote?j(n._dbooking):(n._dbooking.EstimatedCost=0,n._dbooking.ActualCost=0,n.quote=null,n.directions=null)},!0),n.$watchGroup(["_dbooking.AsDirected","_dbooking.ChauffeurMode","_dbooking.EstimatedMins","_dbooking.ActualDistance","_dbooking.BookingStops.length"],function(t,o){if(n._dbooking.AsDirected===!0)n._dbooking.BookingStops.length=1;else if(1==n._dbooking.BookingStops.length){var i=new r.BookingStop;i.id=idCounter++,n._dbooking.BookingStops.push(i)}n.canQuote=!0;var a=new google.maps.LatLngBounds,s=0;Y(),e.forEach(n._dbooking.BookingStops,function(e,t){if(e.Latitude&&e.Longitude){s++;var o=new google.maps.LatLng(e.Latitude,e.Longitude);W.push(new google.maps.Marker({position:o,visible:!0,icon:0==t?"/includes/images/user.png":"/includes/images/userTo.png",map:n.dispatchObj.map.mapObject,zIndex:1e3})),a.extend(o)}else n.canQuote=!1}),0==s&&(n.canQuote=!1),s>0&&n.dispatchObj.map.mapObject.fitBounds(a),n.canQuote?j(n._dbooking):(n._dbooking.EstimatedCost=0,n._dbooking.ActualCost=0,n.quote=null,n.directions=null)}),n.$watch("_dbooking.VehicleTypeId",function(t){n.canQuote=!0;var o=new google.maps.LatLngBounds,i=0;Y(),e.forEach(n._dbooking.BookingStops,function(e,t){if(e.Latitude&&e.Longitude){i++;var a=new google.maps.LatLng(e.Latitude,e.Longitude);W.push(new google.maps.Marker({position:a,visible:!0,icon:0==t?"/includes/images/user.png":"/includes/images/userTo.png",map:n.dispatchObj.map.mapObject,zIndex:1e3})),o.extend(a)}else n.canQuote=!1}),i>0&&n.dispatchObj.map.mapObject.fitBounds(o),n.canQuote?j(n._dbooking):(n._dbooking.EstimatedCost=0,n._dbooking.ActualCost=0,n.quote=null,n.directions=null)}),n.dispatchObj={map:{mapObject:null}},H()}var t=e.module("cab9.client.bookings");t.controller("ClientBookingCreateController",n),n.$inject=["$scope","$UI","$modal","$config","$q","Model","$stateParams","$rootScope","$q","Localisation","$utilities","$http","$timeout","$filter","Auth","rTags"]}(angular);;;;
!function(e){function r(e,r,a,t,d,n,c,s,o,l,u,p){function f(r){e.view.current=r}function m(r,d){e.showLoader=!0,r.DefaultCard=d;var c=r.ExpirationMonth;e.cardList.some(function(e){return e.CardNumber.split(" ")[3]==r.CardNumber.split(" ")[3]})?(e.card.ExpirationMonth=c,e.showLoader=!1,e.card=null,swal("Error","Card details entered already exists. Please check saved cards.","error")):(r.ExpirationYear=r.ExpirationMonth.split("/")[1].trim().slice(-2),r.ExpirationMonth=r.ExpirationMonth.split("/")[0].trim(),r.Type=j(r.CardNumber),void 0!=u?r.ClientId=n.Id:void 0!=l&&(r.PassengerId=n.Id),a.post(t.API_ENDPOINT+"api/Payments/addcard",r).then(function(r){if(swal("Success","Card added successfully","success"),d)for(i=0;i<e.cardList.length;i++)e.cardList[i].DefaultCard=!1;e.cardList.push(r.data.Card),e.showLoader=!1,e.card=null},function(r){void 0!=r.data&&void 0!=r.data.Message?swal("Error",r.data.Message,"error"):swal("Error","Something didn't work, please try again","error"),e.card.ExpirationMonth=c,e.showLoader=!1}))}function h(r){swal({title:"Confirm Delete",text:"Are you sure you want to delete this card?",type:"warning",showCancelButton:!0,confirmButtonText:"Confirm Delete!"},function(){a["delete"](t.API_ENDPOINT+"api/Payments/deletecard?cardId="+r).then(function(a){swal("Success","Card deleted successfully","success"),e.cardList=e.cardList.filter(function(e){return e.Id!=r})},function(e){void 0!=e.ExceptionMessage?swal("Error",e.ExceptionMessage,"error"):swal("Error","Something didn't work, please try again","error")})})}function w(r){swal({title:"Are you sure?",text:"Are you sure you want to make this card as default card?",type:"warning",showCancelButton:!0,confirmButtonText:"Confirm!"},function(){a.patch(t.API_ENDPOINT+"api/Payments/makedefault",r).then(function(a){for(swal("Success","Card made as your default card successfully","success"),i=0;i<e.cardList.length;i++)e.cardList[i].Id==r.Id?e.cardList[i].DefaultCard=!0:e.cardList[i].DefaultCard=!1},function(e){swal("Error","Something didn't work, please try again","error")})})}function j(e){var r=new RegExp("^4");return null!=e.match(r)?"visa":/^(5[1-5][0-9]{14}|2(22[1-9][0-9]{12}|2[3-9][0-9]{13}|[3-6][0-9]{14}|7[0-1][0-9]{13}|720[0-9]{12}))$/.test(e)?"mastercard":/^(5[1-5]\d{2})[\s\-]?(\d{4})[\s\-]?(\d{4})[\s\-]?(\d{4})$/.test(e)?"mastercard":(r=new RegExp("^3[47]"),null!=e.match(r)?"amex":(r=new RegExp("^(6011|622(12[6-9]|1[3-9][0-9]|[2-8][0-9]{2}|9[0-1][0-9]|92[0-5]|64[4-9])|65)"),null!=e.match(r)?"discover":(r=new RegExp("^36"),null!=e.match(r)?"diners":(r=new RegExp("^30[0-5]"),null!=e.match(r)?"diners-carteblanche":(r=new RegExp("^35(2[89]|[3-8][0-9])"),null!=e.match(r)?"jcb":(r=new RegExp("^(4026|417500|4508|4844|491(3|7))"),null!=e.match(r)?"visaelectron":(r=new RegExp("^(40117[8-9]|431274|438935|451416|457393|45763[1-2]|506(699|7[0-6][0-9]|77[0-8])|509d{3}|504175|627780|636297|636368|65003[1-3]|6500(3[5-9]|4[0-9]|5[0-1])|6504(0[5-9]|[1-3][0-9])|650(4[8-9][0-9]|5[0-2][0-9]|53[0-8])|6505(4[1-9]|[5-8][0-9]|9[0-8])|6507(0[0-9]|1[0-8])|65072[0-7]|6509(0[1-9]|1[0-9]|20)|6516(5[2-9]|[6-7][0-9])|6550([0-1][0-9]|2[1-9]|[3-4][0-9]|5[0-8]))"),null!=e.match(r)?"elo":(r=new RegExp("^(5018|5020|5038|6304|6759|6761|6763)[0-9]{8,15}$"),null!=e.match(r)?"maestro":""))))))))}function C(e){var r=e.toLowerCase().replace(/\s/g,"");return"mastercard"==r?"jp-card jp-card-identified jp-card-mastercard":"visa"==r?"jp-card jp-card-identified jp-card-visa":"visaelectron"==r?"jp-card jp-card-identified jp-card-visaelectron":"discover"==r?"jp-card jp-card-identified jp-card-discover":"amex"==r?"jp-card jp-card-identified jp-card-amex":"diners"==r||"diners-carteblanche"==r?"jp-card jp-card-identified jp-card-dinersclub":"jcb"==r?"jp-card jp-card-identified jp-card-jcb":"elo"==r?"jp-card jp-card-identified jp-card-elo":"maestro"==r?"jp-card jp-card-identified jp-card-maestro":"jp-card jp-card-identified"}e.showLoader=!1,e.cardList=s,e.view={current:"SAVED",switchTo:f},e.addCard=m,e.deleteCard=h,e.makeDefault=w,e.getCardTypeClass=C}var a=e.module("cab9.common");a.controller("ClientItemCreditCardController",r),r.$inject=["$scope","$state","$http","$config","Model","$stateParams","$q","rSavedCards","rData","rPassenger","rClient","CSV"]}(angular);;;;
!function(e){function r(e,r,s,t){t.test("passengers")&&(s.when("/passengers","/passengers/cards"),e.state("root.passengers",{url:"/passengers","abstract":!0,"default":"root.passengers.cards",hasHelp:"/webapp/client/passengers/all/brands-help.modal.html",permission:"Passengers Module",resolve:{rNavTo:function(){return"root.passengers.viewer.dashboard"},rId:function(){return"Id"},rData:["Model","Auth","$rootScope",function(e,r,s){return"superadmin"!=s.PERMISSIONS.permissions[0]?e.ClientStaff.query().filter("Id eq guid'"+r.getSession().Claims.ClientStaffId[0]+"'").include("Passengers/Client").execute().then(function(s){return s[0].AllPassengers?e.Passenger.query().filter("ClientId eq guid'"+r.getSession().Claims.ClientId[0]+"'").include("Client").execute():s[0].Passengers.map(function(r){return new e.Passenger(r)})},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:$UI.COLOURS.brandSecondary})}):e.Passenger.query().filter("ClientId eq guid'"+r.getSession().Claims.ClientId[0]+"'").include("Client").execute()}],rQuery:["Model","Auth","$rootScope",function(e,r,s){return"superadmin"!=s.PERMISSIONS.permissions[0]?e.ClientStaff.query().filter("Id eq guid'"+r.getSession().Claims.ClientStaffId[0]+"'").include("Passengers/Client").execute().then(function(s){return s[0].AllPassengers?e.Passenger.query().filter("ClientId eq guid'"+r.getSession().Claims.ClientId[0]+"'").include("Client").parseAs(e.Passenger):s[0].Passengers.map(function(r){return new e.Passenger(r)})},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:$UI.COLOURS.brandSecondary})}):e.Passenger.query().filter("ClientId eq guid'"+r.getSession().Claims.ClientId[0]+"'").include("Client").parseAs(e.Passenger)}],rServerSearch:function(){return function(e,r){return r.$&&e.where("(substringof('"+r.$+"', Firstname) or substringof('"+r.$+"', Surname) or substringof('"+r.$+"', Phone))"),e.clone()}}},views:{"content-wrapper@root":{templateUrl:"/e9_components/layouts/module/module-base.layout.html",controller:["$scope","rData",function(e,r){e.searchTerm={},e.serverSearchTerm={}}]},"options-area@root.passengers":{templateUrl:"/webapp/client/passengers/all/passengers-module-options.partial.html",controller:"PassengersModuleOptionsController"},"stats-area@root.passengers":{templateUrl:"/webapp/client/passengers/all/passengers-module-stats.partial.html",controller:"PassengersModuleStatsController"}}}),e.state("root.passengers.cards",{url:"/cards",resolve:{rAccessors:["$config",function(e){return{Id:function(e){return e.Id},Title:function(e){return e.Firstname+" "+e.Surname},SubTitle:function(e){return e.HomeAddress?e.HomeAddress.Area:null},LogoUrl:function(e){return e._ImageUrl},Group:function(e){return e&&e.Active.toString()},Score:function(e){return e.ScoreOverall}}}]},views:{"view-area@root.passengers":{templateUrl:"/e9_components/layouts/module/module-cards.partial.html",controller:"ModuleCardsController"}}}),e.state("root.passengers.table",{url:"/table",resolve:{rSchema:function(){return"Passenger"},rColumns:function(){return null}},views:{"options-area@root.passengers":{templateUrl:"/webapp/client/passengers/all/passengers-module-table-options.partial.html",controller:"PassengersModuleOptionsController"},"view-area@root.passengers":{templateUrl:"/e9_components/layouts/module/module-paged-table.partial.html",controller:"ModulePagedTableController"}}}),t.test("passengers.viewer")&&(e.state("root.passengers.viewer",{url:"/{Id:[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}}","default":"root.passengers.viewer.dashboard",viewerType:"Passenger",permission:"View Passenger",resolve:{rTabs:["$stateParams",function(e){var r=[{heading:"Dashboard",route:"root.passengers.viewer.dashboard",params:{passengerId:e.Id}}];return r.push({heading:"Info",route:"root.passengers.viewer.info",params:{passengerId:e.Id}}),r.push({heading:"Addresses",route:"root.passengers.viewer.addresses",params:{passengerId:e.Id}}),r}],rData:["Model","$stateParams",function(e,r){return e.Passenger.query().include("Client").where("Id","==","guid'"+r.Id+"'").trackingEnabled().execute()}],rAccessors:["$config",function(e){return{Id:function(e){return e.Id},Title:function(e){return e.Firstname+" "+e.Surname},SubTitle:function(e){return e.HomeAddress?e.HomeAddress.Area:null},LogoUrl:function(e){return e._ImageUrl}}}]},views:{"content-wrapper@root":{controller:"ModuleItemViewController",templateUrl:"/e9_components/layouts/module/module-item.layout.html"}}}),e.state("root.passengers.viewer.dashboard",{url:"/dashboard",viewerType:"Passenger",templateUrl:"/webapp/client/passengers/item/passenger-item-dashboard.partial.html",controller:"PassengerItemDashboardController"}),e.state("root.passengers.viewer.info",{url:"/info",viewerType:"Passenger",templateUrl:"/webapp/client/passengers/item/passenger-item-info.partial.html",controller:"PassengerItemInfoController",resolve:{rPassengerTags:["Model",function(e){return e.Tag.query().execute().then(function(e){return e.filter(function(e){return e.EntityType.indexOf("Passenger")!=-1})})}]}})),e.state("root.passengers.viewer.notes",{url:"/notes",viewerType:"Notes",permission:"Notes",controller:"PassengerItemNotesController",templateUrl:"/webapp/client/passengers/item/passenger-item-notes.partial.html",resolve:{rNotes:["$stateParams","Model","$q",function(e,r,s){return r.Note.query().where("OwnerType eq 'PASSENGER'").where("OwnerId eq guid'"+e.Id+"'").execute()}],rStaffs:["Model",function(e){return e.Staff.query().select("Id, Firstname, Surname").parseAs(function(e){this.Name=e.Firstname+" "+e.Surname,this.Id=e.Id}).execute()}],rUsers:["Model",function(e){return e.User.query().include("Claims").execute()}]}}),e.state("root.passengers.viewer.addresses",{url:"/addresses",viewerType:"Addresses",permission:"Addresses",controller:"PassengerItemAddressesController",templateUrl:"/webapp/common/views/passenger-address/partial.html",resolve:{rAddresses:["Model","$stateParams",function(e,r){return e.PassengerAddress.query().filter().where("PassengerId","==","guid'"+r.Id+"'").trackingEnabled().execute()}]}}),t.test("passengers","W")&&e.state("root.passengers.create",{url:"/create",views:{"content-wrapper@root":{controller:"PassengerItemCreateController",templateUrl:"/webapp/client/passengers/item/passenger-item-info.partial.html",resolve:{rPassengerTags:["Model",function(e){return e.PassengerTag.query().execute()}]}}}}),r.registerMenuItem({state:"root.passengers.cards",icon:"people_outline",title:"Passengers"}))}function s(){}var t=e.module("cab9.client.passengers",[]);t.config(r),t.run(s),r.$inject=["$stateProvider","MenuServiceProvider","$urlRouterProvider","$permissions"],s.$inject=[]}(angular);;;;
!function(e){function t(e,t,o,n){function s(){o.open({templateUrl:"/webapp/common/modals/passenger/create.modal.html",controller:"PassengerItemCreateModalController",resolve:{rClientId:function(){return t.CLIENTID},rNavigateAfterSave:function(){return!0}}})}function a(){e.showSearch=!e.showSearch,e.showSearch?setTimeout(function(){$("#searchTerm").focus()},500):e.searchTerm.$=""}function l(){o.open({template:'<div class="modal-header"><button class="close" type="button" ng-click="$close()"><i class="material-icons">close</i></button><h3 class="modal-title">Client Stats</h3></div><div class="modal-body"><div ng-include="\'/webapp/client/passengers/all/passengers-module-stats.partial.html\'"></div></div>',controller:"PassengersModuleStatsController",size:"sm",resolve:{rData:function(){return n}}}).result.then(function(e){})}e.showStatsModal=l,e.toggleSearch=a,e.newPassenger=s}var o=e.module("cab9.client.passengers");o.controller("PassengersModuleOptionsController",t),t.$inject=["$scope","$rootScope","$modal","rData"]}(angular);;;;
!function(e){function t(e,t,n,r,s,a){var c=(new moment).subtract(2,"weeks");e.recentPassengers=a.filter(function(e){return new moment(e.CreationTime).isAfter(c)}),e.quickStats={total:a.length,active:a.filter(function(e){return e.Active}).length,recent:e.recentPassengers.length}}var n=e.module("cab9.client.passengers");n.controller("PassengersModuleStatsController",t),t.$inject=["$scope","$UI","Model","$config","$http","rData"]}(angular);;;;
!function(t){function a(t,a,e,o,s,r,n){t.passenger=n[0];var i=t.DATETIME_FORMAT.replace(/[.|/|-][y|Y][y|Y]*/g,"");t.quickStats={today:"-",week:"-",month:"-"},t.bookingGraph={options:{series:{lines:{show:!0,lineWidth:2,fill:!0,fillColor:{colors:[{opacity:.4},{opacity:.4}]}},points:{show:!0,lineWidth:2},shadowSize:0},grid:{hoverable:!0,clickable:!0,tickColor:"#eee",borderWidth:0},colors:[a.COLOURS.lighterGrey,a.COLOURS.brandPrimary],xaxis:{mode:"time",tickFormatter:function(t,a){var e=r("date")(moment(t).toDate(),i);return e},minTickSize:[1,"day"]},yaxis:{ticks:3,tickDecimals:0}},data:[]};var m=(o({url:e.API_ENDPOINT+"/api/stats",method:"GET",params:{passengerId:t.item.Id,from:(new moment).startOf("isoweek").format(),to:(new moment).startOf("day").format(),totalsOnly:!0}}).success(function(a){t.quickStats.week=a.Totals.CountBookings}),o({url:e.API_ENDPOINT+"/api/stats",method:"GET",params:{passengerId:t.item.Id,from:(new moment).startOf("month").format(),to:(new moment).startOf("day").format(),totalsOnly:!0}}).success(function(a){t.quickStats.month=a.Totals.CountBookings}),o({url:e.API_ENDPOINT+"/api/stats",method:"GET",params:{passengerId:t.item.Id,from:(new moment).subtract(2,"weeks").startOf("day").format(),to:(new moment).startOf("day").format(),fillNulls:!0}})),l=o({url:e.API_ENDPOINT+"/api/stats",method:"GET",params:{from:(new moment).subtract(2,"weeks").startOf("day").format(),to:(new moment).startOf("day").format(),fillNulls:!0}});s.all([m,l]).then(function(a){var e=a[0].data,o=a[1].data,s={label:"Avg Passenger",data:[]},r={label:t.item.Firstname+" "+t.item.Surname,data:[]};t.bookingGraph.data.push(s),t.bookingGraph.data.push(r);for(var n=0;n<e.Periods.length;n++){var i=e.Periods[n];r.data.push([new moment(i.Date).valueOf(),i.CountBookings])}for(var n=0;n<o.Periods.length;n++){var m=o.Periods[n];s.data.push([new moment(m.Date).valueOf(),m.CountAssignedBookings/m.UniquePassengers])}t.lastWeekData=a[0].data.Periods.reverse().slice(0,7),t.quickStats.today=t.lastWeekData[0].CountBookings},function(t){})}var e=t.module("cab9.client.passengers");e.controller("PassengerItemDashboardController",a),a.$inject=["$scope","$UI","$config","$http","$q","$filter","rData"]}(angular);;;;
!function(e){function n(e,n,r,s,a,t,o,g,c){function i(){a.openPicker({type:"Passenger",id:e.passenger.Id,searchTerm:e.passenger._Fullname}).then(function(n){e.passenger.ImageUrl=n,u()},function(e){})}function d(){e.viewMode="EDIT"}function l(){e.passenger.$rollback(!0),e.viewMode="VIEW"}function u(){e.passenger.$patch().then(function(r){n.go(n.current,{Id:e.passenger.Id},{reload:!0}),swal({title:"Passenger Saved.",text:"Changes have been updated.",type:"success",confirmButtonColor:g.COLOURS.brandSecondary})},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:g.COLOURS.brandSecondary})})}e.passenger=t[0],e.passengerTags=o,e.viewMode="VIEW";for(var p=0;p<e.passenger.PassengerTags.length;p++){var f=e.passenger.PassengerTags[p],I=e.passengerTags.filter(function(e){return e.Id==f.Id});1==I.length&&(e.passenger.PassengerTags[p]=I[0])}e.chooseImage=i,e.startEditing=d,e.cancelEditing=l,e.saveEdits=u}var r=e.module("cab9.client.passengers");r.controller("PassengerItemInfoController",n),n.$inject=["$scope","$state","$q","Model","ImageUpload","rData","rPassengerTags","$UI","$config"]}(angular);;;;
!function(e){function t(e,t,o,r,n,l,c,i,a,u,s){function d(t){var o=e.notes.indexOf(t),n=r.open({templateUrl:"/webapp/common/modals/notes.modal.html",controller:"NoteEditController",size:"lg",resolve:{rNote:function(){return new c.Note(t)}}});n.result.then(function(t){c.Note.query().where("Id","==","guid'"+t.Id+"'").execute().then(function(t){e.notes[o]=t[0]},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:a.COLOURS.brandSecondary})})},function(){})}function f(){var t=r.open({templateUrl:"/webapp/common/modals/notes.modal.html",controller:"NoteCreateController",size:"lg",resolve:{rOwner:function(){return"PASSENGER"}}});t.result.then(function(t){c.Note.query().where("Id","==","guid'"+t.Id+"'").execute().then(function(t){e.notes.push(t[0])},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:a.COLOURS.brandSecondary})})})}function m(t){swal({title:"Are you sure?",text:"Note will be deleted",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, delete it!",closeOnConfirm:!1},function(){var o=e.notes.indexOf(t);new c.Note(t).$delete().then(function(t){swal({title:"Note Deleted.",text:"Note has been deleted.",type:"success",confirmButtonColor:a.COLOURS.brandSecondary}),e.notes.splice(o,1)})},function(e){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:a.COLOURS.brandSecondary})})}function p(e){var t=null,o=s.filter(function(t){return t.Id==e})[0];if(o)switch(o.UserType){case"Staff ":var r=o.Claims.filter(function(e){return"StaffId"==e.ClaimType})[0];if(r){var n=u.filter(function(e){return e.Id==r.ClaimValue})[0];t=n?n.Name:null}}return t}e.notes=t,e.displayMode="VIEW",e.addNote=f,e.editNote=d,e.deleteNote=m,e.getUserName=p}var o=e.module("cab9.client.passengers");o.controller("PassengerItemNotesController",t),t.$inject=["$scope","rNotes","$state","$modal","$stateParams","$q","Model","$config","$UI","rStaffs","rUsers"]}(angular);;;;
!function(o){function e(o,e,t,n){o.state("root.locations",{url:"/locations",viewerType:"Client",permission:"Client Locations",views:{"content-wrapper@root":{templateUrl:"/webapp/client/locations/partial.html",controller:"ClientLocationsController"}},resolve:{rLocations:["Model","$rootScope",function(o,e){return console.log(e.CLIENTID),o.Client.query().select("Id,Latitude,Longitude,KnownLocations").include("KnownLocations").filter("Id eq guid'"+e.CLIENTID+"'").execute()}]}}),o.state("root.locations.create",{url:"/locations",viewerType:"Client",permission:"Client Locations",views:{"content-wrapper@root":{templateUrl:"/webapp/common/views/locations/create.partial.html",controller:"ClientLocationCreateController"}},resolve:{rLocations:["Model","$rootScope",function(o,e){return console.log(e.CLIENTID),o.Client.query().select("Id,Latitude,Longitude,KnownLocations").include("KnownLocations").filter("Id eq guid'"+e.CLIENTID+"'").execute()}]}}),e.registerMenuItem({state:"root.locations",icon:"location_on",title:"Locations"})}var t=o.module("cab9.client.locations",[]);t.config(e),e.$inject=["$stateProvider","MenuServiceProvider","$urlRouterProvider","$permissions"]}(angular);;;;
!function(t){function n(t,n,e,i,a,c){function r(n){swal({title:"Are you sure?",text:"Location will be unliked.",type:"warning",showCancelButton:!0,confirmButtonColor:i.COLOURS.brandPrimary,confirmButtonText:"Confirm Delete!",closeOnConfirm:!1},function(){a.$dissociate("Client","Location",t.client.Id,n.Id).then(function(){var o=t.existingLocations.indexOf(n);t.existingLocations.splice(o,1),swal({title:"Location removed.",text:"Changes have been updated.",type:"success",confirmButtonColor:i.COLOURS.brandSecondary})})})}console.log("obj"),t.displayMode="VIEW",t.client=c[0],t.existingLocations=c[0].KnownLocations.map(function(n){return n.$distance=parseFloat(o(t.client.Latitude,t.client.Longitude,n.Latitude,n.Longitude).toFixed(2)),n}),t.removeLocation=r}function o(t,n,o,i){var a=6371,c=e(o-t),r=e(i-n),s=Math.sin(c/2)*Math.sin(c/2)+Math.cos(e(t))*Math.cos(e(o))*Math.sin(r/2)*Math.sin(r/2),l=2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s)),u=a*l;return u}function e(t){return t*(Math.PI/180)}var i=t.module("cab9.client.locations");i.controller("ClientLocationsController",n),n.$inject=["$scope","$filter","$q","$UI","Model","rLocations"]}(angular);;;;
!function(o){function t(o,t,e,n){function c(){o.item.StopSummary=window.$utilities.formatAddress(o.item),o.item.$save().then(function(o){t.$associate("Client","Location",n.CLIENTID,o.data.Id).then(function(o){swal("Success","The location saved successfully","success"),e.go("root.locations",null,{reload:!0})},function(o){swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:$UI.COLOURS.brandSecondary})})},function(){swal("Error","The location failed to save.","error")})}function i(){e.go("root.locations")}o.item=new t.KnownLocation,o.displayMode="CREATE",o.saveEdits=c,o.cancelEditing=i}var e=o.module("cab9.client.locations");e.controller("ClientLocationCreateController",t),t.$inject=["$scope","Model","$state","$rootScope"]}(angular);;;;
!function(e,n){function t(e,n,t,i){i.test("invoices")&&(e.state("root.invoices",{url:"/invoices",views:{"content-wrapper@root":{templateUrl:"/webapp/client/invoices/all/table.partial.html",controller:"InvoicesModuleTableController"}},permission:"Invoices Module",resolve:{rInvoices:["Model","Auth",function(e,n){var t=n.getSession().Claims.ClientId?n.getSession().Claims.ClientId[0]:null;return e.Invoice.query().include("Client,Payments").filter("InvoiceType","eq","'Client'").filter("ClientId","==","guid'"+t+"'").filter("CreationTime","ge","datetimeoffset'"+(new moment).startOf("month").format()+"'").filter("CreationTime","le","datetimeoffset'"+(new moment).endOf("month").format()+"'").execute()}]}}),i.test("invoices.viewer")&&e.state("root.invoices.viewer",{url:"/{Id:[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}}",permission:"View Invoice",views:{"content-wrapper@root":{templateUrl:"/webapp/client/invoices/item/invoice-viewer.partial.html",controller:"InvoiceItemEditController"}},resolve:{rInvoice:["Model","$stateParams",function(e,n){return e.Invoice.query().include("Client").where("Id","==","guid'"+n.Id+"'").trackingEnabled().execute()}],rAdjustments:["Model","$stateParams","rInvoice",function(e,n,t){return e.ClientInvoiceAdjustment.query().where("InvoiceId","==","guid'"+n.Id+"'").include("ClientAdjustment").include("ClientPricingModelAdjustment").trackingEnabled().execute().then(function(e){t[0].Adjustments=e})}],InvoiceDetails:["Model","$stateParams","rInvoice",function(e,n,t){return e.InvoiceDetail.query().include("Tax/TaxComponents").where("InvoiceId","==","guid'"+n.Id+"'").trackingEnabled().execute().then(function(e){t[0].InvoiceDetails=e})}],rBookings:["Model","$stateParams","rInvoice",function(e,n,t){return e.Booking.query().include("LeadPassenger, Tax/TaxComponents, BookingStops, VehicleType, BookingExpense/BookingExpenseType, ClientStaff, BookingValidations/ClientReference").trackingEnabled().where("InvoiceId","==","guid'"+n.Id+"'").execute().then(function(e){t[0].Bookings=e})}],rPayments:["Model","$stateParams",function(e,n){return e.Payment.query().where("InvoiceId","==","guid'"+n.Id+"'").execute()}],rTaxes:["Model",function(e){return e.Tax.query().include("TaxType").include("TaxComponents").execute()}]}}),n.registerMenuItem({state:"root.invoices",icon:"receipt",title:"Invoices"}))}function i(){}var o=n.module("cab9.client.invoices",[]);o.config(t),o.run(i),t.$inject=["$stateProvider","MenuServiceProvider","$urlRouterProvider","$permissions"],i.$inject=[]}(window,angular);;;;
!function(){function e(e,t,n,o){function i(){e.showSearch=!e.showSearch,e.showSearch?setTimeout(function(){$("#searchTerm").focus()},500):e.searchTerm.$=""}e.invoices=t,e.start=(new moment).subtract(1,"year"),e.end=(new moment).add(1,"year"),e.selected={from:(new moment).startOf("month"),to:(new moment).endOf("month"),span:"month"},e.toggleSearch=i,e.$watch("selected",function(t){e.invoices=o.Invoice.query().include("Payments").include("Client").filter("InvoiceType","eq","'Client'").filter("ClientId","==","guid'"+e.CLIENTID+"'").filter("CreationTime","ge","datetimeoffset'"+e.selected.from.format()+"'").filter("CreationTime","le","datetimeoffset'"+e.selected.to.format()+"'").execute().then(function(t){e.invoices=t})},!0),e.viewItem=function(e){n.go("root.invoices.viewer",{Id:e.Id})}}var t=angular.module("cab9.client.invoices");t.controller("InvoicesModuleTableController",e),e.$inject=["$scope","rInvoices","$state","Model"]}();;;;
!function(){function e(e,n,i,o,t,a,c,r,l,u,s,v,d,f,m,I,g){function p(){angular.forEach(e.invoice.Bookings,function(n){var i=new moment(n.BookedDateTime).startOf("day"),o=e.days.filter(function(e){return e.date.isSame(i,"day")})[0];o?o.bookings.push(n):e.days.push({date:i,bookings:[n]})})}function y(){e.invoice.Bookings.length!=Q.length&&(e.invoice.Bookings=[],[].push.apply(e.invoice.Bookings,Q)),angular.forEach(e.invoice.Bookings,function(e){e.$selected=!0}),e.allSelected=!0,e.displayMode="EDIT"}function h(){var n=_();null!=n?swal({title:"Error",text:n,type:"error"}):("Client"!=e.invoice.InvoiceType&&(e.invoice.InvoiceType="Client"),e.invoice.Reference||(e.invoice.Reference="AUTO"),e.invoice.Bookings=e.getSelectedBookings(),e.invoice.InvoiceDetails=e.invoice.InvoiceDetails,e.invoice.$patch(!0).success(function(e){swal({title:"Invoice Updated.",text:"Invoice has been updated.",type:"success",confirmButtonColor:c.COLOURS.brandSecondary}),r.go("root.invoices",null,{reload:!0})}).error(function(e){var n=null;e&&"INVALID REFERENCE"==e.Message&&(n="Reference already exists!"),swal({title:"Error Occured",text:n,type:"error"})}))}function T(){var n=0;return angular.forEach(e.payments,function(e){n+=parseFloat(e.AmountPaid)}),n}function x(){swal({title:"Are you sure?",text:"This invoice will be deleted permanentaly",type:"warning",showCancelButton:!0,confirmButtonText:"Yes, delete it!",closeOnConfirm:!0},function(){e.invoice.$delete().success(function(){r.go("root.invoices",null,{reload:!0})})})}function k(){e.invoice.$rollback(!1),angular.forEach(e.invoice.Bookings,function(e){e.$rollback(!1)}),e.invoice.Bookings=n[0].Bookings,e.displayMode="VIEW"}function B(){e.invoice.Bookings.length!=Q.length&&(e.invoice.Bookings=[],[].push.apply(e.invoice.Bookings,Q),angular.forEach(e.invoice.Bookings,function(e){e.$selected=!0})),u.Booking.query().filter("BookedDateTime","ge","datetimeoffset'"+new moment(e.range.From).startOf("day").format()+"'").filter("BookedDateTime","le","datetimeoffset'"+new moment(e.range.To).endOf("day").format()+"'").filter("BookingStatus","==","'Completed'").filter("InvoiceId","==",null).filter("ClientId","==","guid'"+e.invoice.ClientId+"'").include("LeadPassenger, BookingStops, Tax/TaxComponents").orderBy("BookedDateTime").execute().then(function(n){angular.forEach(n,function(e){e.BookingStops=o("orderBy")(e.BookingStops,"StopOrder"),e.$commit()}),[].push.apply(e.invoice.Bookings,n)})}function E(n,i){i.Tax=e.taxes.filter(function(e){return e.Id==n})[0]}function D(n,i){e.opened[i]=!0,n.preventDefault(),n.stopPropagation()}function S(){e.allSelected=!e.allSelected,angular.forEach(e.invoice.Bookings,function(n){e.allSelected?n.$selected=!0:n.$selected=!1})}function P(){var n=0,i=e.getSelectedBookings();return angular.forEach(i,function(e){""==e.Discount||null==e.Discount?n+=parseFloat(e.InvoiceCost):n=n+parseFloat(e.InvoiceCost)-parseFloat(e.Discount)}),n}function C(){var n=0;return angular.forEach(e.getSelectedBookings(),function(e){var i=0;i=""==e.Discount||null==e.Discount?e.Tax?e.InvoiceCost*e.Tax._TaxAmount:0:e.Tax?(e.InvoiceCost-e.Discount)*e.Tax._TaxAmount:0,n+=i}),angular.forEach(e.invoice.InvoiceDetails,function(e){var i=0;e.UnitPrice&&e.Quantity&&(i=e.Tax?e.UnitPrice*e.Quantity*e.Tax._TaxAmount:0),n+=i}),n}function w(){var n=v.open({templateUrl:"/webapp/client/invoices/modals/payments-modal.partial.html",controller:"PaymentsModalCtrl",size:"lg",resolve:{rInvoiceSummary:function(){var n={InvoiceRef:e.invoice.Reference,SubTotal:e.invoice.SubTotal,TaxAmount:e.invoice.TaxAmount,TotalAmount:e.invoice.TotalAmount};return n},rPayments:["Model",function(e){return e.Payment.query().trackingEnabled().where("InvoiceId","==","guid'"+s.Id+"'").execute()}]}});n.result.then(function(){l.all([n,i]).then(function(){d.success("Invoice Refreshed")});var n=u.Payment.query().where("InvoiceId","==","guid'"+s.Id+"'").execute().then(function(n){e.payments=n}),i=u.Invoice.query().select("Status").where("Id","==","guid'"+s.Id+"'").execute().then(function(n){e.invoice.Status=n[0].Status})},function(){})}function $(){e.invoice.$patch(!0).success(function(e){})}function A(){I.open(m.API_ENDPOINT+"api/Invoice/pdf?invoiceId="+e.invoice.Id,"_blank")}function b(){I.open(m.API_ENDPOINT+"api/Invoice/excel?invoiceId="+e.invoice.Id,"_blank")}function U(){v.open({templateUrl:"/webapp/common/modals/email-to-sent.modal.html",controller:["$scope","emailAddress","$modalInstance",function(e,n,i){null!=n&&(e.email=n),e.markSent=!0,e.sendEmail=function(){i.close({email:e.email,markSent:e.markSent})}}],resolve:{emailAddress:function(){return e.invoice.Client.BillingEmail||e.invoice.Client.Email}}}).result.then(function(n){null!=n.email&&g.post(m.API_ENDPOINT+"api/email",{Type:"ClientInvoiceConfirmation",InvoiceId:e.invoice.Id,ClientId:e.invoice.ClientId,EmailId:n.email}).success(function(){var i=new u.Invoice({Id:e.invoice.Id,Status:"Something"});d.success("Email Sent"),n.markSent&&(i.Status="Sent",i.$patch())})})}function O(e){var n=0,i=0;return e.UnitPrice&&e.Quantity&&(i=e.UnitPrice*e.Quantity,n=i+(e.Tax?e.Tax._TaxAmount*i:0)),n}function N(){e.newItem=new u.InvoiceDetail,e.newItem.Quantity=1,e.newItem.UnitPrice=0,e.newItem.InvoiceId=e.invoice.Id,e.invoice.InvoiceDetails.push(e.newItem)}function R(n){var i=e.invoice.InvoiceDetails.indexOf(n);e.invoice.InvoiceDetails.splice(i,1)}function M(){var n=0;return angular.forEach(e.invoice.InvoiceDetails,function(e){e.UnitPrice&&e.Quantity&&(n+=e.UnitPrice*e.Quantity)}),n}function _(){if(e.invoice.InvoiceDetails.length>0)for(var n=0;n<e.invoice.InvoiceDetails.length;n++){if(!e.invoice.InvoiceDetails[n].ItemName)return"Please enter name for extra # "+(n+1);if(!(e.invoice.InvoiceDetails[n].UnitPrice>=0))return"Please enter price for extra # "+(n+1);if(!(e.invoice.InvoiceDetails[n].Quantity>0))return"Please enter quantity for extra # "+(n+1);if(!e.invoice.InvoiceDetails[n].TaxId)return"Select VAT rate for extra # "+(n+1)}return null}e.invoice=n[0],e.invoice.$commit();var Q=angular.copy(e.invoice.Bookings);e.displayMode="VIEW",e.payments=i,e.days=[],e.taxes=t,e.currency=a.currency().getCurrent().Prepend,e.opened={},e.invoice.InvoiceDetails||(e.invoice.InvoiceDetails=[]),e.accessors={LogoUrl:function(n){return e.COMPANY?e.COMPANY._ImageUrl:""}};new Date;e.range={From:(new moment).subtract(1,"month").toDate(),To:(new moment).toDate()},e.startEditing=y,e.saveEdits=h,e.cancelEditing=k,e.fetchBookings=B,e.setTax=E,e.openCalendar=D,e.toggleSelectAll=S,e.BookingsTotal=P,e.TaxesTotal=C,p(),e.logPayments=w,e.markStatus=$,e.calculatePaidAmount=T,e.exportReceipt=A,e.exportReceiptExcel=b,e.emailTo=U,e.deleteInvoice=x,e.calculateExtrasCost=O,e.addExtras=N,e.deleteItem=R,e.ExtrasTotal=M,e.round=function(e){return Math.round(100*e)/100},e.getSelectedBookings=function(){var n=[];return angular.forEach(e.invoice.Bookings,function(e){e.$selected&&n.push(e)}),n}}var n=angular.module("cab9.client.invoices");n.controller("InvoiceItemEditController",e),e.$inject=["$scope","rInvoice","rPayments","$filter","rTaxes","Localisation","$UI","$state","$q","Model","$stateParams","$modal","Notification","Auth","$config","$window","$http"]}();;;;
!function(){function n(n,e,a,t,o){function l(n){n.preventDefault(),n.stopPropagation()}function r(){var e=0;return angular.forEach(n.payments,function(n){e+=parseFloat(n.AmountPaid)}),e}n.payments=a,n.summary=e,n.opened={},n.selected=null,n.openCalendar=l,n.calculatePaidAmount=r,n.paymentTypes=null,n.paymentTypes=(new t.Payment).$$schema.PaymentType["enum"]}var e=angular.module("cab9.client.invoices");e.controller("PaymentsModalCtrl",n),n.$inject=["$scope","rInvoiceSummary","rPayments","Model","$stateParams"]}();;;;
!function(e){function t(t,r,s,n){if(n.test("settings")){var o=[];t.state("root.settings",{url:"/settings",permission:"Settings Module",resolve:{rMenu:[function(){return[]}]},views:{"content-wrapper@root":{templateUrl:"/webapp/client/settings/settings.layout.html",controller:"SettingsController"}}}),s.when("/settings","/settings/details"),n.test("settings.details")&&(o.push({title:"Details",state:"root.settings.details",icon:"icon-equalizer22"}),t.state("root.settings.details",{url:"/details",views:{"settings-content@root.settings":{templateUrl:"/webapp/client/settings/details/details-config.partial.html",controller:"SettingsDetailsController"}},resolve:{rData:["Model","$stateParams","Auth","$q",function(e,t,r,s){var n=s.defer();return e.User.query().where("Id","==","'"+r.getSession().UserId+"'").include("Claims").trackingEnabled().execute().then(function(t){var r=t[0].Claims.filter(function(e){return"ClientId"==e.ClaimType})[0];r&&e.Client.query().where("Id","==","guid'"+r.ClaimValue+"'").trackingEnabled().include("DefaultCurrency").execute().then(function(e){n.resolve(e)})}),n.promise}]}})),o.push({title:"Password",state:"root.settings.profile",icon:"icon-lock"}),t.state("root.settings.profile",{url:"/profile",views:{"settings-content@root.settings":{templateUrl:"/webapp/client/settings/profile/profile-config.partial.html",controller:"SettingsProfileController"}},resolve:{rData:["Model","$stateParams","Auth","$q",function(e,t,r,s){var n=s.defer();return e.User.query().where("Id","==","'"+r.getSession().UserId+"'").include("Claims").trackingEnabled().execute().then(function(t){var r=t[0].Claims.filter(function(e){return"ClientId"==e.ClaimType})[0];r&&e.Client.query().where("Id","==","guid'"+r.ClaimValue+"'").trackingEnabled().execute().then(function(e){n.resolve(e)})}),n.promise}]}}),n.test("settings.webbooker")&&(o.push({title:"Web Booker",state:"root.settings.webbookersettings",icon:"icon-lock"}),t.state("root.settings.webbookersettings",{url:"/webbookersettings",viewerType:"WebBookerSettings",permission:"webbookersettings",views:{"settings-content@root.settings":{controller:"ClientItemWebBookerSettingsController",templateUrl:"/webapp/common/views/clients/webBookerSettings/partial.html"}},resolve:{rSettings:["$rootScope","Model","$q",function(e,t,r){return t.ClientWebBookerSetting.query().where("ClientId eq guid'"+e.CLIENTID+"'").trackingEnabled().execute()}]}})),n.test("settings.references")&&(o.push({title:"References",state:"root.settings.references",icon:"icon-equalizer22"}),t.state("root.settings.references",{url:"/references",views:{"settings-content@root.settings":{controller:"ClientItemReferencesController",templateUrl:"/webapp/common/views/clients/references/partial.html"}},resolve:{rReferences:["$rootScope","Model","$q",function(e,t,r){return t.ClientReference.query().where("ClientId eq guid'"+e.CLIENTID+"'").execute()}]}})),o.push({title:"Profiles",state:"root.settings.profiles",icon:"icon-equalizer22"}),t.state("root.settings.profiles",{url:"/profiles",views:{"settings-content@root.settings":{templateUrl:"/webapp/management/clients/item/client-item-profiles.partial.html",controller:["$scope","rPassengers","$stateParams","$modal","$http","$config",function(t,r,s,n,o,i){function a(e,r){swal({title:"Are you sure?",text:"This will merge all bookings to target passenger and remove duplicate passenger.",type:"warning",showCancelButton:!0,confirmButtonText:"Yes, merge!",closeOnConfirm:!0},function(s){s&&o.get(i.API_ENDPOINT+"api/client/merge",{params:{targetPassengerId:e.Id,mergePassengerId:r.Id}}).then(function(s){o.get(i.API_ENDPOINT+"api/client/duplicates",{params:{passengerId:e.Id}}).then(function(s){e.dupes=s.data;var n=t.passengers.filter(function(e){return e.Id==r.Id})[0];if(n){e.Bookings+=n.Bookings;var o=t.passengers.indexOf(n);t.passengers.splice(o,1)}})})})}function l(e){e.$expand=!e.$expand,e.$expand?o.get(i.API_ENDPOINT+"api/client/duplicates",{params:{passengerId:e.Id}}).then(function(t){e.dupes=t.data}):e.dupes=null}function c(){t.showSearch=!t.showSearch,t.showSearch?setTimeout(function(){$("#searchTerm").focus()},500):t.searchTerm.$=""}t.passengers=r,t.toggleSearch=c,t.toggleRow=l,t.merge=a,t.$watch("searchTerm.$",function(s,n){s&&""!=s.trim()?t.passengers=r.filter(function(e){return(e._Fullname+e.Phone+e.Mobile+e.Email+e._Addresses).toLowerCase().indexOf(s.toLowerCase())!=-1}):t.passengers=e.copy(r)})}]}},resolve:{rPassengers:["$http","Model","$rootScope",function(e,t,r){return e.get($config.API_ENDPOINT+"api/client/profiles",{params:{clientId:r.CLIENTID}}).then(function(e){return e.data.map(function(e){return new t.PassengerProfile(e)})})}]}}),n.test("settings.creditcards")&&1==n.cardPaymentsActive&&(o.push({title:"Credit Cards",state:"root.settings.creditcards.cards",icon:"credit_card"}),t.state("root.settings.creditcards",{url:"/creditcards",viewerType:"CreditCard","default":"root.settings.creditcards.cards",views:{"settings-content@root.settings":{templateUrl:"/webapp/client/settings/creditcards/partial.html",controller:["$scope","rTabs",function(e,t){e.tabDefs=t}]}},resolve:{rTabs:[function(){return[{heading:"Credit Cards",route:"root.settings.creditcards.cards"},{heading:"Transactions",route:"root.settings.creditcards.transactions"}]}]}}),t.state("root.settings.creditcards.cards",{url:"/cards",templateUrl:"/webapp/common/views/clients/creditcards/cards/partial.html",controller:"CreditCardsCardsController",resolve:{rCards:["Model","$rootScope",function(e,t){return e.PaymentCard.query().where("ClientId eq guid'"+t.CLIENTID+"'").where("Active eq true").execute()}],rClientId:["$rootScope",function(e){return e.CLIENTID}],rPassengerId:["$stateParams",function(e){return null}],rDriverId:["$stateParams",function(e){return null}]}}),t.state("root.settings.creditcards.transactions",{url:"/transactions",templateUrl:"/webapp/common/views/clients/creditcards/transactions/partial.html",controller:"CreditCardsTransactionsController",resolve:{rClientId:["$rootScope",function(e){return e.CLIENTID}],rPassengerId:["$stateParams",function(e){return null}]}})),n.test("settings.googlemapsconfig")&&(o.push({title:"Google Config",state:"root.settings.googlemapsconfig",icon:"icon-map"}),t.state("root.settings.googlemapsconfig",{url:"/googlemapsconfig",permission:"Settings - Google Config",views:{"settings-content@root.settings":{templateUrl:"/webapp/common/views/googlemapsconfig/partial.html",controller:"GoogleMapsConfigController"}},resolve:{rIntegration:["Model",function(e){return e.GoogleMapsConfig.query().execute()}]}}));var i=o;r.registerMenuItem({state:i.length>0?i[0].state:"root.settings.profile",icon:"settings",title:"Settings",subMenus:i})}}function r(t,r,s){function n(e){var t='<a ui-sref="'+e.state+'" ui-sref-opts="{reload: true}" style="color:white;width:100%;display:inline-block;"><i class="'+e.icon+'"></i>'+e.title+"</a>";return t}t.menu=r,e.forEach(r,function(e){e.$html=n(e)})}var s=e.module("cab9.client.settings",[]);s.config(t),s.controller("SettingsController",r),t.$inject=["$stateProvider","MenuServiceProvider","$urlRouterProvider","$permissions"],r.$inject=["$scope","rMenu","$rootScope"]}(angular);;;;
!function(e){function n(e,n,t,i,o,c,l){function a(){i.openPicker({type:"Client",id:e.client.Id,searchTerm:e.client.Name}).then(function(n){e.client.ImageUrl=n,d()},function(e){})}function r(){e.displayMode="EDIT"}function s(){e.client.$rollback(!0),e.displayMode="VIEW"}function d(){var t=[];t.push(e.client.$patch()),n.all(t).then(function(){swal({title:"Client Saved.",text:"Changes have been updated.",type:"success",confirmButtonColor:c.COLOURS.brandSecondary}),e.displayMode="VIEW",e.$emit("ITEM_UPDATED",e.client)},function(){alert("Error"),console.log(arguments)})}e.client=o[0],e.displayMode="VIEW",e.chooseImage=a,e.startEditing=r,e.cancelEditing=s,e.saveEdits=d,e.accessors={LogoUrl:function(){return o[0]._ImageUrl}}}var t=e.module("cab9.client.settings");t.controller("SettingsDetailsController",n),n.$inject=["$scope","$q","Model","ImageUpload","rData","$UI","$config"]}(angular);;;;
!function(e){function t(e,t,n,o,r,s){function a(){e.viewMode="EDIT",e.user={UserName:n.getSession().UserName}}function c(){o.put($config.API_ENDPOINT+"api/account",e.user).success(function(e){swal({title:"Password updated",text:"Try login using new password!",type:"success"},function(e){s.$broadcast(t.LOGOUT)})}).error(function(e){swal("Error","Something didn't work, please check input and try again","error")})}e.accessors={LogoUrl:function(){return r[0]._ImageUrl}},e.Name=r[0].Name,e.viewMode="EDIT",e.cancelEdit=a,e.saveEdits=c,e.user={UserName:n.getSession().UserName}}var n=e.module("cab9.client.settings");n.controller("SettingsProfileController",t),t.$inject=["$scope","AUTH_EVENTS","Auth","$http","rData","$rootScope"]}(angular);;;;
!function(e,t){function r(e,t,r,o){o.test("staff")&&(e.state("root.bookers",{url:"/bookers","abstract":!0,"default":"root.bookers.cards",viewerType:"Client",permission:"Client Staff",resolve:{rData:["Model","$rootScope",function(e,t){return e.ClientStaff.query().filter("ClientId eq guid'"+t.CLIENTID+"'").include("ClientStaffRole").top(100).execute().then(function(r){return r.pullMore=e.ClientStaff.query().filter("ClientId eq guid'"+t.CLIENTID+"'").include("ClientStaffRole"),r})}],rQuery:["Model","$rootScope",function(e,t){return e.ClientStaff.query().filter("ClientId eq guid'"+t.CLIENTID+"'").include("ClientStaffRole").parseAs(e.ClientStaff)}],rServerSearch:function(){return function(e,t){return t.$&&e.where("(substringof('"+t.$+"', Firstname) or substringof('"+t.$+"', Surname) or substringof('"+t.$+"', ClientStaffRole/Name) or substringof('"+t.$+"', TownCity) or substringof('"+t.$+"', Phone))"),e.clone()}},rNavTo:function(){return"root.bookers.viewer.details"},rId:function(){return"sId"},rNavCards:function(){return"root.bookers.cards"},rNavTable:function(){return"root.bookers.table"},rCreateState:function(){return"root.bookers.create"},rAccessors:["$config",function(e){return{Id:function(e){return e.Id},Title:function(e){return e.Firstname+" "+e.Surname},LogoUrl:function(e){return e&&e._ImageUrl},Group:function(e){return e&&e.Active.toString()}}}]},views:{"content-wrapper@root":{templateUrl:"/e9_components/layouts/module/module-base.layout.html",controller:["$scope",function(e){e.searchTerm={},e.serverSearchTerm={}}]},"options-area@root.bookers":{templateUrl:"/webapp/common/views/clients/staff/options.partial.html",controller:"ClientStaffOptionsController"},"stats-area@root.bookers":{templateUrl:"/webapp/common/views/clients/staff/all/staff-module-stats.partial.html",controller:"ClientStaffModuleStatsController"}}}),o.test("staff","W")&&e.state("root.bookers.create",{url:"/create",resolve:{rAccessors:["$config",function(e){return{Id:function(e){return e.Id},Title:function(e){return e.Firstname+" "+e.Surname},LogoUrl:function(e){return e._ImageUrl}}}],rClientId:function(){return null},rRoles:["Model",function(e){return e.ClientStaffRole.query().execute()}],rNav:function(){return"'root.bookers.cards'"}},views:{"content-wrapper@root":{controller:"ClientStaffItemCreateController",templateUrl:"/webapp/common/views/clients/staff/details/partial.html"}}}),e.state("root.bookers.cards",{url:"/cards",views:{"view-area@root.bookers":{templateUrl:"/e9_components/layouts/module/module-secondary-cards.partial.html",controller:"ModuleSecondaryCardsController"}}}),e.state("root.bookers.table",{url:"/table",resolve:{rSchema:function(){return"Staff"},rColumns:function(){return null}},views:{"options-area@root.bookers":{templateUrl:"/webapp/common/views/clients/staff/table-options.partial.html",controller:"ClientStaffOptionsController"},"view-area@root.bookers":{templateUrl:"/e9_components/layouts/module/module-paged-table.partial.html",controller:"ModulePagedTableController"}}}),o.test("staff.viewer")&&(e.state("root.bookers.viewer",{url:"/:sId","default":"root.bookers.viewer.details",resolve:{rData:["Model","$stateParams","$rootScope",function(e,t,r){return e.ClientStaff.query().where("Id eq guid'"+t.sId+"'").include("Passengers,ClientStaffRole").trackingEnabled().execute()}],rTabs:["$stateParams","rData",function(e,t){var r=[{heading:"Details",route:"root.bookers.viewer.details"},{heading:"User",route:"root.bookers.viewer.user"}];return t[0].AllPassengers||r.push({heading:"Passengers",route:"root.bookers.viewer.passengers"}),r}],rAccessors:["$config",function(e){return{Id:function(e){return e.Id},Title:function(e){return e._Fullname},LogoUrl:function(e){return e._ImageUrl}}}]},views:{"content-wrapper@root":{controller:"ModuleItemViewController",templateUrl:"/e9_components/layouts/module/module-item.layout.html"}}}),e.state("root.bookers.viewer.details",{url:"/details",controller:"ClientStaffItemDetailController",templateUrl:"/webapp/common/views/clients/staff/details/partial.html",resolve:{rRoles:["Model",function(e){return e.ClientStaffRole.query().execute()}]}}),e.state("root.bookers.viewer.user",{url:"/user",controller:"ClientStaffItemUserController",templateUrl:"/webapp/common/views/clients/staff/user/partial.html",resolve:{rUser:["$http","$stateParams","$config","$q",function(e,t,r,o){var n=o.defer();return e.get(r.API_ENDPOINT+"api/account/UserForOwner?ownerType=ClientStaffId&OwnerId="+t.sId).then(function(e){n.resolve(e.data)},function(e){n.resolve({Message:"User Not Found"})}),n.promise}]}}),e.state("root.bookers.viewer.passengers",{url:"/passengers",controller:"ClientStaffItemPassengerController",templateUrl:"/webapp/common/views/clients/staff/passengers/partial.html"})),t.registerMenuItem({state:"root.bookers.cards",icon:"group",title:"Bookers"}))}function o(){}var n=t.module("cab9.client.staff",[]);n.config(r),n.run(o),r.$inject=["$stateProvider","MenuServiceProvider","$urlRouterProvider","$permissions"],o.$inject=[]}(window,angular);;;;
!function(){var e=angular.module("cab9.widgets");e.directive("clientBookingReport",["Model","$UI","$config","$http","$q","$filter","$timeout","$rootScope",function(e,t,o,n,r,i,l,a){return{templateUrl:"/webapp/client/widgets/client-booking-report.tmpl.html",scope:{filters:"="},link:function(t,d,f){function s(){t.deferred=r.defer(),t.bookingGraph.data.length=0;var i={from:t.filters.from,to:t.filters.to};t.filters.ClientStaffIds&&t.filters.ClientStaffIds.length>0&&(i.ClientStaffIds=t.filters.ClientStaffIds),n({url:o.API_ENDPOINT+"/api/reports/booking",method:"GET",params:i}).then(function(o){var n=o.data,r={label:"Bookings",data:[]};t.bookingGraph.data.push(r);for(var i=0;i<n.Grouped.length;i++){var l=n.Grouped[i];r.data.push([new moment(l.Period).valueOf(),l.Bookings])}e.ClientStaff.query().where("ClientId eq guid'"+a.CLIENTID+"'").select("Id").execute().then(function(o){t.bookerCount=o.length,e.Passenger.query().where("ClientId eq guid'"+a.CLIENTID+"'").select("Id").execute().then(function(e){t.passengerCount=e.length,t.deferred.resolve(!0)})})},function(e){t.deferred.reject("An Error Occured")})}t.deferred=null;var c=null;t.refresh=s,t.$watchCollection("filters",function(){c&&(l.cancel(c),c=null),c=l(s,500)}),t.bookingGraph={options:{series:{lines:{show:!0,lineWidth:2,fill:!0,fillColor:{colors:[{opacity:.2},{opacity:.2}]}},points:{show:!0,lineWidth:2},shadowSize:0},legend:{show:!1},grid:{hoverable:!0,clickable:!0,tickColor:"#1BA0FC",borderWidth:0},colors:["#fff"],xaxis:{mode:"time",tickFormatter:function(e,o){var n=i("date")(moment(e).toDate(),t.filters.format);return n},minTickSize:[1,"day"]},tooltip:!0,tooltipOpts:{content:function(e,t,o,n){return content=new moment(t).format("ddd")+", <small>%x</small><br/><strong>%s</strong> %y",content},xDateFormat:"%d-%m-%Y",defaultTheme:!1},yaxis:{min:0,position:"right",minTickSize:1}},data:[]}}}}])}();;;;
!function(o){function t(t,i,n,e,a,r,g,s){function u(){var o=t.booking;"OnRoute"==o.BookingStatus?g.get("http://directions.cab9.co/route?point="+o.Driver.LastKnownLatitude+","+o.Driver.LastKnownLongitude+"&point="+o.BookingStops[0].Latitude+","+o.BookingStops[0].Longitude+"&vehicle=car").then(function(o){t.eta=Math.round(1.1*o.data.paths[0].time/1e3/60)}):"Arrived"==o.BookingStatus?t.eta="0":"InProgress"==o.BookingStatus?o.AsDirected||g.get("http://directions.cab9.co/route?point="+o.Driver.LastKnownLatitude+","+o.Driver.LastKnownLongitude+"&point="+o.BookingStops[o.BoookingStops.length-1].Latitude+","+o.BookingStops[o.BoookingStops.length-1].Longitude+"&vehicle=car").then(function(o){t.eta=Math.round(1.1*o.data.paths[0].time/1e3/60)}):"Completed"==o.BookingStatus&&(t.eta="0")}function d(){l=L.map("mapid").setView([51.49638419822335,-.12875142186092203],11),L.tileLayer("https://api.mapbox.com/styles/v1/mapbox/streets-v10/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1Ijoic291bXlha2FudGhpIiwiYSI6ImNpdHdsMnQyMjAwOHQydG84endtZDE5N28ifQ.7eTer7TOkCSNj_M3Qaehfw",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',maxZoom:18,id:"256",accessToken:"pk.eyJ1Ijoic291bXlha2FudGhpIiwiYSI6ImNpdHdsMnQyMjAwOHQydG84endtZDE5N28ifQ.7eTer7TOkCSNj_M3Qaehfw"}).addTo(l),p(t.booking)}function p(t){var i=[];o.forEach(t.BookingStops,function(o,n){if(o.Latitude&&o.Longitude)if(0==n){var e=L.icon({iconUrl:"/includes/images/pickup@1x.png",iconRetinaUrl:"/includes/images/pickup@2x.png",iconSize:[50,50]});L.marker([o.Latitude,o.Longitude],{icon:e}).addTo(l).bindPopup("<p>"+o.StopSummary+"</p>")}else if(n==t.BookingStops.length-1){var a=L.icon({iconUrl:"/includes/images/dropoff@1x.png",iconRetinaUrl:"/includes/images/dropoff@2x.png",iconSize:[50,50]});L.marker([o.Latitude,o.Longitude],{icon:a}).addTo(l).bindPopup("<p>"+o.StopSummary+"</p>")}else{var r=L.icon({iconUrl:"/includes/images/stop@1x.png",iconRetinaUrl:"/includes/images/stop@2x.png",iconSize:[50,50]});L.marker([o.Latitude,o.Longitude],{icon:r}).addTo(l).bindPopup("<p>"+o.StopSummary+"</p>")}i.push([o.Latitude,o.Longitude]),l.fitBounds(i,{animate:!0})})}function c(o){if(o&&o.LastKnownLatitude&&o.LastKnownLongitude){var t=L.icon({iconUrl:"/includes/images/file.svg",iconRetinaUrl:"/includes/images/file.svg",iconSize:[38,95]});return m?u():m=!1,L.marker([o.LastKnownLatitude,o.LastKnownLongitude],{icon:t}).addTo(l)}return null}function k(i,n){var e=n[0];e.DriverId==t.booking.DriverId&&"Offline"!=t.booking.Driver.DriverStatus&&(t.booking.Driver.LastKnownLatitude=o.copy(e.Latitude),t.booking.Driver.LastKnownLongitude=o.copy(e.Longitude),t.booking.Driver.$marker?(t.booking.Driver.$marker.on("move",function(o){var i=google.maps.geometry.spherical.computeHeading(new google.maps.LatLng(o.oldLatLng.lat,o.oldLatLng.lng),new google.maps.LatLng(o.latlng.lat,o.latlng.lng));t.booking.Driver.$marker.setRotationAngle(i)}),t.booking.Driver.$marker.setLatLng([e.Latitude,e.Longitude])):t.booking.Driver.$marker=c(t.booking.Driver),l.setView([e.Latitude,e.Longitude],16,{animate:!0}))}t.booking=s[0];var l=null;r(u,6e4),a(function(){e.server.startLocations()},1e3),t.$on("$destroy",function(){e.server.stopLocations()}),t.$on("SIGNALR_updateDriverLocation",k);a(function(){d()},0);var m=!0;t.showDriverDetails=function(){$("#driverDetails").toggle()},t.$watch("booking.BookingStatus",function(){"OnRoute"==t.booking.BookingStatus?t.driverStatus="Driver onroute to "+t.booking.BookingStops[0].StopSummary:"Arrived"==t.booking.BookingStatus?t.driverStatus="Driver arrived at "+t.booking.BookingStops[0].StopSummary:"InProgress"==t.booking.BookingStatus?t.booking.AsDirected?t.driverStatus="Driver on trip":t.driverStatus="Driver on trip to "+t.booking.BookingStops[t.booking.BookingStops.length-1].StopSummary:"Completed"==t.booking.BookingStatus&&(t.driverStatus="Driver has arrived at the destination "+t.booking.BookingStops[t.booking.BookingStops.length-1].StopSummary)})}var i=o.module("cab9.common");i.controller("DriverTrackingController",t),t.$inject=["$scope","$config","Google","SignalR","$timeout","$interval","$http","rBooking"]}(angular);;;;
!function(e,r){function t(e,r,t,o){o.test("superadmin")&&(e.state("root.reports",{url:"/reports",permission:"Reports",views:{"content-wrapper@root":{templateUrl:"/webapp/client/reports/all/reports.partial.html",controller:"ReportsController"}},resolve:{rPassengers:["Model",function(e){return[]}],rVehicleTypes:["Model",function(e){return e.VehicleType.query().execute()}]}}),r.registerMenuItem({state:"root.reports",icon:"assessment",title:"Reports"}))}function o(){}var n=r.module("cab9.client.report",[]);n.config(t),n.run(o),t.$inject=["$stateProvider","MenuServiceProvider","$urlRouterProvider","$permissions"],o.$inject=[]}(window,angular);;;;
!function(){function e(e,t,n,r,s,a,i){function o(t){e.fetchedPassengers.length=0,t&&r.Passenger.query().include("Client").where("substringof('"+t+"', concat(concat(Firstname, ' '), Surname))").where("ClientId eq guid'"+e.CLIENTID+"'").select("Id,Firstname,Surname,Client/Name").top(50).parseAs(function(e){this.Id=e.Id,this.Name=e.Firstname+" "+e.Surname,this.Description=e.Client&&e.Client.Name,this.ImageUrl=window.formatImage(e.ImageUrl,e.Firstname)}).execute().then(function(t){[].push.apply(e.fetchedPassengers,t)})}function l(){var e="";for(var t in s.filters)s.filters.hasOwnProperty(t)&&s.filters[t]&&("From"==t||"To"==t?e+="&"+t+"="+s.filters[t]:s.filters[t].length>0&&(e+="PassengerIds"==t||"VehicleTypeIds"==t?"&"+t+"="+s.filters[t].map(function(e){return"'"+e.replace(/ /g,"")+"'"})+"&":t+"="+s.filters[t]+"&"));window.open("/print-reports.html#?t="+s.$$access_token+e,"_blank","width=600,height=800;")}function c(){var e=a.getQuery();e=e.substr(0,e.length-1),console.log(e);var t=i.getSession();currentRequest=window.open($config.API_ENDPOINT+"api/reports/excel?ClientReport=true&TenantId="+t.TenantId+"&"+e)}e.passengers=t,e.vehicleTypes=n,e.printReport=l,e.opened={},s.filters.From=moment().subtract(30,"days").format("YYYY-MM-DD"),s.filters.To=moment().subtract(1,"days").format("YYYY-MM-DD"),s.filters.ClientId=e.CLIENTID,s.filters.ClientIds=[e.CLIENTID],e.PeriodLength=[{id:"dd",value:"Days"},{id:"ww",value:"Week"},{id:"mm",value:"Months"},{id:"qq",value:"Quarters"},{id:"yy",value:"Years"}],e.openCalendar=function(t,n){e.opened[n]=!0,t.preventDefault(),t.stopPropagation()},e.fetchData=function(){e.fetched=!0,s.$broadcast("fetchData")},e.fetchedPassengers=[],e.searchPassengers=o,e.downloadExcel=c}var t=angular.module("cab9.client.report");t.controller("ReportsController",e),e.$inject=["$scope","rPassengers","rVehicleTypes","Model","$rootScope","reports","Auth"]}();;;;