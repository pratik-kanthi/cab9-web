!function(e){function t(t,i,n,o,r,s,a,d,u,l,m,g,c,f,p,k,h,I,B){function v(){"EDIT"==t.viewMode&&(t.item.ChauffeurMode=!0,t.item.EstimatedMins=60)}function T(){"EDIT"==t.viewMode&&(t.item.ChauffeurMode=!1,t.item.EstimatedMins=null)}function D(i){var n=10,o=(i-1)*n;r.get(s.API_ENDPOINT+"api/Audit/ForBooking",{params:{bookingId:t.item.Id,top:n,skip:o}}).success(function(o){1==i&&0==o.length&&(t.noHistory=!0),(o.length<n||"Booking Created"==o[o.length-1].BookingEvent)&&(t.noMoreHistory=!0),e.forEach(o,function(e){var i=moment(e.Timestamp).format("DD MMM");t.events[i]||(t.events[i]=[]),t.events[i].push(new u.AuditRecord(e))})})}function S(){t.historyPage++,D(t.historyPage)}function P(e){var i=h.timeZone().getTimeZone()||"Europe/London",n=moment(e).toDate(),o=n.getTimezoneOffset(),r=moment.tz.zone(i).offset(n),s=new moment.tz(e,i).add(o-r,"minutes");t.item.FlightInfo?t.item.Date=new moment(t.item.FlightInfo.ScheduledArrivalTime).toDate():t.item.Date=s.toDate(),t.item.Time=s.toDate()}function C(i){e.forEach(i,function(e){var i=t.unlinkedTags.find(function(t){return t.Id==e.TagId});i&&(i.Type=e.Type),t.Tags.push(i),t.unlinkedTags.splice(t.unlinkedTags.indexOf(i),1)})}function E(e){var i=t.Tags.find(function(t){return t.Id==e.Id});if(!i){t.Tags.push(e);var n=t.unlinkedTags.find(function(t){return t.Id==e.Id});if(n){var o={BookingId:t.item.Id,TagId:e.Id,Type:e.Type};t.item.BookingTags.push(o),t.unlinkedTags.splice(t.unlinkedTags.indexOf(n),1)}t.item.$selectedTag=null}}function y(e){t.unlinkedTags.push(e);var i=t.Tags.find(function(t){return t.Id==e.Id});i&&(t.Tags.splice(t.Tags.indexOf(i),1),t.item.BookingTags=t.item.BookingTags.filter(function(e){return e.TagId!=i.Id})),t.item.$selectedTag=null}function b(){t.item.FlightInfo=null,t.item.FlightInfoId=null,t.flightData.Number=null}function w(e){t.item.BookingRequirements.push(e);var i=t.unlinkedRequirements.filter(function(t){return t.Id==e.Id});i[0]&&t.unlinkedRequirements.splice(t.unlinkedRequirements.indexOf(i[0]),1),t.item.$selectedRequirement=null}function A(e,t,i){function n(e,t){var i="000000000"+e;return i.substr(i.length-t)}var o=e.getFullYear(),r=e.getMonth(),s=e.getDate(),a=t.getHours(),d=t.getMinutes(),u=n(o,4)+"-"+n(r+1,2)+"-"+n(s,2)+"T"+n(a,2)+":"+n(d,2)+":00",l=moment.tz(u,"YYYY-MM-DDTHH:mm:ss",h.timeZone().getTimeZone()).subtract(i||0,"minutes").format();return l}function x(){t.flightData.Number.length>0?r({url:s.API_ENDPOINT+"/api/flightinfo/getflightinfo",method:"GET",params:{flightno:t.flightData.Number,flightDate:A(t.item.Date,t.item.Time)}}).then(function(e){if(e.data){if(e.data.Id=null,e.data.BookingId=null,e.data.TenantId=null,e.data.MinsAfterLanding=t.flightData.MinsAfterLanding,t.item.FlightInfo=new u.FlightInfo(e.data),"Completed"!==t.item.BookingStatus&&"Cancelled"!==t.item.BookingStatus&&"COA"!==t.item.BookingStatus){var i=h.timeZone().getTimeZone()||"Europe/London",n=moment(t.item.FlightInfo.ArrivalTime).toDate(),o=n.getTimezoneOffset(),r=moment.tz.zone(i).offset(n),s=new moment.tz(t.item.FlightInfo.ArrivalTime,i).add(o-r,"minutes");if(t.flightData.DateTime=s,t.item.Time=s.toDate(),t.timeSet=!0,e.data.SuggestedAddressId&&t.item.BookingStops[0].$$Id!=e.data.SuggestedAddressId){var a=e.data.SuggestedAddressId;u.Location.query().where("Id eq guid'"+e.data.SuggestedAddressId+"'").execute().then(function(e){var i=new u.BookingStop;i.Address1=e[0].Name?e[0].Name:"",i.StopSummary=e[0].Name?e[0].Name:"",i.Latitude=e[0].Latitude?e[0].Latitude:null,i.Longitude=e[0].Longitude?e[0].Longitude:null,i.$$Id=a,i.WaitTime=t.item.BookingStops[0].WaitTime,center_moved=!1,t.item.BookingStops[0]=i})}}}else t.item.FlightInfo=null,swal("Flight Not Found","Please check flight number.","warning")},function(e){t.item.FlightInfo=null,swal("Incorrect Flight Number","Please check flight number.","warning")}):(t.item.FlightInfo=null,swal("Incorrect Flight Number","Please check flight number.","warning"))}function N(e){var t=c.filter(function(t){return t.Id==e})[0];if(t)return t.Name}function L(e){var t=g.filter(function(t){return t.Id==e})[0];if(t)return t._TaxRate}function R(){t.expenses.adding=new u.BookingExpense}function O(e){t.expenses.editing=e}function q(e){var i=t.item.BookingExpense.indexOf(e);t.item.BookingExpense.splice(i,1)}function F(){t.expenses.editing=null}function M(){t.expenses.editing.$rollback(),t.expenses.editing=null}function _(){t.expenses.adding.BookingId=t.item.Id,t.item.BookingExpense.push(t.expenses.adding),t.expenses.adding=null}function V(){t.expenses.adding=null}function U(e){t.unlinkedRequirements.push(e);var i=t.item.BookingRequirements.filter(function(t){return t.Id==e.Id});i[0]&&t.item.BookingRequirements.splice(t.item.BookingRequirements.indexOf(i[0]),1)}function Q(e,t){t?r({method:"GET",url:s.API_ENDPOINT+"/api/ClientReferences/suggest?ClientReferenceId="+e.Id+"&Value="+t}).then(function(t){e.$suggested=t.data.map(function(e){return{custom:!1,text:e}}),e.$originalValue&&e.$suggested.unshift(e.$originalValue),e.AllowAddToList&&e.$suggested.push({custom:!0,text:"Add '{{$select.search}}' to References"})},function(t){e.$suggested=[e.$originalValue]}):e.$suggested=[e.$originalValue]}function W(e){for(var t="[a-z]",i="[A-Z]",n="[0-9]",o="^",r=0,s=!1,a=!1,d=0;d<e.length;d++){var u=e[d];if("'"===u)o+=a?")":"(",a=!a;else if(a)["."].indexOf(u)!=-1&&(u="\\"+u),o+=u;else if(">"===u){if(r++,r>1)throw"Bad Mask - Case blocks have consecutive > without ending previous block"}else if("<"===u){if(r--,r<-1)throw"Bad Mask - Case blocks have consecutive < without ending previous block"}else"0"===u?(s=!0,o+="("+n+")"):"9"===u?o+="("+n+"?)":1===r?"A"===u?(s=!0,o+="("+i+"|"+n+")"):"a"===u?o+="("+i+"?|"+n+"?)":"L"===u?(s=!0,o+="("+i+")"):"l"===u&&(o+="("+i+"?)"):0===r?"A"===u?(s=!0,o+="("+t+"|"+i+"|"+n+")"):"a"===u?o+="("+t+"?|"+i+"?|"+n+"?)":"L"===u?(s=!0,o+="("+t+"|"+i+")"):"l"===u&&(o+="("+t+"?|"+i+"?)"):r===-1&&("A"===u?(s=!0,o+="("+t+"|"+n+")"):"a"===u?o+="("+t+"?|"+n+"?)":"L"===u?(s=!0,o+="("+t+")"):"l"===u&&(o+="("+t+"?)"))}if(a)throw"Bad Mask - Quoted section not terminated";if(!s)throw"Bad Mask - Must contain at least 1 mandatory symbol (A, L, 0)";return o+="$",new RegExp(o)}function z(){if(t.clientReferences.length>0)for(var e=0;e<t.clientReferences.length;e++){var i=t.clientReferences[e];if("Mask"==i.ReferenceType)return!(i.$testReg.test(i.$knownValue)||!(i.$knownValue||i.Mandatory&&i.Active))}return!1}function G(){window.close()}function H(){var e=t.item.BookingStops[0];t.item.BookingStops[0]=t.item.BookingStops[1],t.item.BookingStops[1]=e}function Z(i){t.passengers.length=0,r.get(s.API_ENDPOINT+"api/Passengers/Search",{params:{searchText:i,clientId:t.item.ClientId}}).success(function(i){e.forEach(i,function(e){e.Client&&(e.Client.ImageUrl=$utilities.formatUrl(e.Client.ImageUrl,e.Client.Name)),t.passengers.push({Id:e.Id,ClientId:e.ClientId,Name:e.Firstname+" "+e.Surname,Description:e.Client&&e.Client.Name?e.Client.Name:"No Client",Mobile:e.Mobile,Addresses:e.Addresses,ImageUrl:$utilities.formatUrl(e.ImageUrl,e.Firstname)})}),t.passengers.push({Id:"add-passenger",Name:"Add Passenger",Description:"Create New Passenger",ImageUrl:"/includes/images/add-icon.png"})})}function Y(i){t.item.ClientId&&(t.bookers.length=0,r.get(s.API_ENDPOINT+"api/Bookers/Search",{params:{searchText:i,clientId:t.item.ClientId}}).success(function(i){e.forEach(i,function(e){e.Client&&(e.Client.ImageUrl=$utilities.formatUrl(e.Client.ImageUrl,e.Client.Name)),t.bookers.push({Id:e.Id,ClientId:e.ClientId,Name:e.Firstname+" "+e.Surname,Description:e.Client&&e.Client.Name?e.Client.Name:"No Client",Mobile:e.Mobile,ImageUrl:$utilities.formatUrl(e.ImageUrl,e.Firstname)})}),t.bookers.push({Id:"add-booker",Name:"Add Booker",Description:"Create New Booker",ImageUrl:"/includes/images/add-icon.png"})}))}function j(e){if("VIEW"!=t.viewMode){t.quoting.inprogress=!0,e.BookedDateTime=A(t.item.Date,t.item.Time);for(var i=0;i<t.item.BookingStops.length;i++)t.item.BookingStops[i].StopOrder=i+1;re=!0,r.post(s.API_ENDPOINT+"api/quote",e).success(function(i){re=!1,t.quote=i,i.Error?e.OneTransportReference||e.CityFleetReference||(t.directions=null,"Client"==t.mode&&(e.ActualCost=null)):e.OneTransportReference||e.CityFleetReference||(e.EstimatedCost=i.FinalCost,e.EstimatedDistance=i.EstimatedDistance.toFixed(2),e.EstimatedDuration=i.EstimatedMins,e.WaitingCost=i.WaitingCharge,"Client"==t.mode&&(e.ActualCost=i.FinalCost),t.directions=i.Directions,i.Directions?e.EncodedRoute=i.Directions.EncodedRoute:e.EncodedRoute="",e._AutoDispatchOffset=Math.max(15,i.DispatchOffset||15)),t.quoting.inprogress=!1}).error(function(e){t.quoting.inprogress=!1,swal("Could not quote","Could not quote, please manually price and set driver payment amount for this booking.","warning"),re=!1})}}function K(){t.item.ActualCost=t.quote.FinalCost}function X(){t.item.Coupon=t.item.$Coupon,j(t.item)}function J(e){t.item.WaitAndReturn&&t.item.BookingStops.length<4?swal("Cannot remove via Stop","WaitAndReturn booking should have a via stop","warning"):t.item.BookingStops.splice(e,1),t.item.BookingStops.length<3&&(t.sortableOptions.disabled=!0)}function ee(e){var i=new u.BookingStop;i.id=idCounter++,t.item.WaitAndReturn?t.item.BookingStops.splice(e,0,i):t.item.BookingStops.splice(e+1,0,i),t.item.BookingStops.length>2&&(t.sortableOptions.disabled=!1)}function te(e,i){var n=h.timeZone().getTimeZone(),o=(new Date).getTimezoneOffset(),r=moment.tz.zone(n).offset(new Date),s=new moment.tz(n).add(o-r,"minutes");"day"==i?t.item.Date=s.add(e,"minutes").toDate():"time"==i&&(t.item.Time=s.startOf("minute").add(e,"minutes").toDate())}function ie(){t.item.BookingStops.reverse()}function ne(){if($("#bookingsave").prop("disabled",!0),t.item.FlightInfo){t.item.FlightInfo.MinsAfterLanding=t.flightData.MinsAfterLanding;var n=t.flightData.GetDate().toDate();t.item.BookedDateTime=A(n,n)}else t.item.BookedDateTime=A(t.item.Date,t.item.Time);t.item.AutoDispatch&&(t.item.DispatchDateTime=A(t.item.Date,t.item.Time,t.item._AutoDispatchOffset)),t.item.AsDirected&&(t.item.BookingStops=[t.item.BookingStops[0]]);var o=e.copy(t.item);if(o.Currency=void 0,o.Client=void 0,o.Time=void 0,o.Vehicle=void 0,o.Driver=void 0,o.LeadPassenger=void 0,o.VehicleType=void 0,o.BookingValidations=[],t.clientReferences.length>0)for(var a=0;a<t.clientReferences.length;a++){var d=t.clientReferences[a],l=new u.BookingValidation;l.ClientReferenceId=d.Id,l.BookingId=o.Id,l.Id=d.$id,"List"==d.ReferenceType?l.Value=d.$knownValue&&d.$knownValue.text:l.Value=d.$knownValue,l.Value&&o.BookingValidations.push(l)}e.forEach(o.BookingStops,function(e,i){e.BookingId=t.item.Id,e.Id=ae[i],e.StopOrder=i+1}),o.BookingTags.map(function(e){var i=t.Tags.find(function(t){return t.Id==e.TagId});return i&&(e.Type=i.Type),e}),t.lock.saved=!0,r.put(s.API_ENDPOINT+"api/bookings",o,{params:{Id:o.Id}}).then(function(e){swal({title:"Booking Updated",text:"Changes have been updated.",type:"success",confirmButtonColor:i.COLOURS.brandSecondary});var n=[];n.push("(EntityType eq 'Booking' and EntityId eq guid'"+t.item.Id+"')"),n.push("(BookingId eq guid'"+t.item.Id+"')");for(var o=0;o<t.item.BookingStops.length;o++){var a=t.item.BookingStops[o];n.push("(EntityType eq 'BookingStop' and EntityId eq guid'"+a.Id+"')")}t.events={},D(1),t.viewMode="VIEW",t.lock.current=null,r.get(s.API_ENDPOINT+"api/DriverPayments/breakdown",{params:{bookingId:t.item.Id}}).success(function(e){t.driverPayment=e,$("#bookingsave").prop("disabled",!1)})},function(e){t.lock.saved=!0,swal({title:"Some Error Occured.",text:"Some error has occured.",type:"error",confirmButtonColor:i.COLOURS.brandSecondary})})}if(t.item=l[0],t.item.BookingStops=t.item.BookingStops.sort(function(e,t){return e.StopOrder-t.StopOrder}),t.bookingTags=t.unlinkedTags=B,t.Tags=[],C(t.item.BookingTags),t.item.Priority){var oe=["P1","P2","P3","P4","P5"].indexOf("P"+t.item.Priority)+1;t.item.Priority=oe.toFixed(0)}else t.item.Priority="P1";r.get(s.API_ENDPOINT+"api/DispatchSettings").then(function(e){e.data[0]&&(t.dispatchSettings=e.data[0])}),t.item.DispatchDateTime?t.item._AutoDispatchOffset=moment(t.item.BookedDateTime).diff(moment(t.item.DispatchDateTime),"minutes"):t.item._AutoDispatchOffset=15,t.mode=m,t.showInactiveReferences=!1;var re=!1;t.lock={current:null},t.quoting={},t.events={},t.noHistory=!1,t.noMoreHistory=!1,t.historyPage=1,t.fetchMoreHistory=S,t.enableChauffering=v,t.disableChauffering=T,t.updateCost=K,t.applyCoupon=X,t.iconsIndex={"N/A":"assignment","Booking Offer Sent":"assignment","Booking Created":"assignment",FlightTrackingStarted:"flight_land",FlightTrackingStopped:"flight_land","SMS Confirmation":"insert_comment","Email Client Confirmation":"email","Email Booker Confirmation":"email","SMS Driver Arrived":"insert_comment","Call Driver Arrived":"phone","Email Manual Confirmation":"email","Driver Read Offer":"person_pin","Driver Accepted":"person_pin",DriverUpdate:"person_pin","Driver Rejected":"person_pin","Driver Allocated":"person_pin","Booking Offered To Driver":"person_pin","Booking Pre Allocated To Driver":"person_pin","Booking Patched":"assignment","Booking Edited":"assignment",DriverPaymentIssued:"account_balance_wallet",DriverPaymentGenerated:"account_balance_wallet",DriverPaymentCancelled:"account_balance_wallet",ClientInvoiceIssued:"check_circle",ClientInvoiceCancelled:"check_circle","Flight Update":"flight_land",Repricing:"border_color"},t.coloursIndex={"N/A":"orange-bg","Booking Offer Sent":"green-bg","Booking Created":"green-bg",FlightTrackingStarted:"green-bg",FlightTrackingStopped:"red-bg","SMS Confirmation":"green-bg","Email Client Confirmation":"green-bg","Email Booker Confirmation":"green-bg","SMS Driver Arrived":"green-bg","Call Driver Arrived":"green-bg","Email Manual Confirmation":"orange-bg","Driver Read Offer":"green-bg","Driver Accepted":"green-bg",DriverUpdate:"green-bg","Driver Rejected":"orange-bg","Driver Allocated":"green-bg","Booking Offered To Driver":"green-bg","Booking Pre Allocated To Driver":"green-bg","Booking Patched":"orange-bg","Booking Edited":"orange-bg",DriverPaymentIssued:"green-bg",DriverPaymentGenerated:"green-bg",DriverPaymentCancelled:"red-bg",ClientInvoiceIssued:"green-bg",ClientInvoiceCancelled:"red-bg","Flight Update":"orange-bg",Repricing:"orange-bg"},t.item.BookingExpense=t.item.BookingExpense.map(function(e){return new u.BookingExpense(e)}),D(1);var se=d.getSession(),ae=t.item.BookingStops.map(function(e){return e.Id});r.get(s.API_ENDPOINT+"api/bookings/IsLocked",{params:{bookingId:t.item.Id}}).success(function(e){"LockOwned"==e.status?(t.viewMode="EDIT",t.lock.current={self:!0,expires:e.expires}):"Locked"==e.status?t.lock.current={self:!1,user:e.user,expires:e.expires}:t.lock.current=null}).error(function(){swal("Error!","Unknown error occured.","error")}),t.$on("SIGNALR_updateBooking",function(e,i){var n=i[0];t.item.BookingStatus=n.BookingStatus,t.$apply()}),t.$on("SIGNALR_lockCleared",function(e,i){var n=i[0];t.lock.saved?(t.lock.saved=!1,t.lock.current=null):n.BookingId==t.item.Id&&(t.lock.current=null,"EDIT"==t.viewMode?(t.viewMode="VIEW",swal("Lock Expired!","Booking Lock has expired.","error"),u.Booking.query().include("Driver,Client,Vehicle,FlightInfo,BookingStops,Invoice,BookingStops/PassengerStops,Passengers,BookingValidations,LeadPassenger,Currency,BookingRequirements,BookingExpense,BookingExpense/BookingExpenseType,BookingExpense/Tax").where("Id eq guid'"+t.item.Id+"'").trackingEnabled().execute().then(function(e){if(t.item=e[0],t.item.BookingStops=t.item.BookingStops.sort(function(e,t){return e.StopOrder-t.StopOrder}),t.item.BookingExpense=t.item.BookingExpense.map(function(e){return new u.BookingExpense(e)}),P(t.item.BookedDateTime),t.item.FlightInfo&&(t.flightData.Number=t.item.FlightInfo.FlightNumber),t.item.Priority){var i=["P1","P2","P3","P4","P5"].indexOf("P"+t.item.Priority)+1;t.item.Priority=i.toFixed(0)}else t.item.Priority="P1";t.item.DispatchDateTime?t.item._AutoDispatchOffset=moment(t.item.BookedDateTime).diff(moment(t.item.DispatchDateTime),"minutes"):t.item._AutoDispatchOffset=15})):u.Booking.query().include("Driver,Client,Vehicle,FlightInfo,BookingStops,Invoice,BookingStops/PassengerStops,Passengers,BookingValidations,LeadPassenger,Currency,BookingRequirements,BookingExpense,BookingExpense/BookingExpenseType,BookingExpense/Tax").where("Id eq guid'"+t.item.Id+"'").trackingEnabled().execute().then(function(e){if(t.item=e[0],t.item.BookingStops=t.item.BookingStops.sort(function(e,t){return e.StopOrder-t.StopOrder}),t.item.BookingExpense=t.item.BookingExpense.map(function(e){return new u.BookingExpense(e)}),P(t.item.BookedDateTime),t.item.FlightInfo&&(t.flightData.Number=t.item.FlightInfo.FlightNumber),t.item.Priority){var i=["P1","P2","P3","P4","P5"].indexOf("P"+t.item.Priority)+1;t.item.Priority=i.toFixed(0)}else t.item.Priority="P1";t.item.DispatchDateTime?t.item._AutoDispatchOffset=moment(t.item.BookedDateTime).diff(moment(t.item.DispatchDateTime),"minutes"):t.item._AutoDispatchOffset=15})),t.$apply()}),t.$on("SIGNALR_bookingLocked",function(e,i){var n=i[0];n.BookingId==t.item.Id&&(n.UserId==se.UserId?t.lock.current={self:!0,expires:n.LockTime}:t.lock.current={self:!1,user:n.User.Name,expires:n.LockTime}),t.$apply()}),t.startEditing=function(){r.get(s.API_ENDPOINT+"api/bookings/RequestLock",{params:{bookingId:t.item.Id}}).success(function(e){"LockGranted"==e.status?u.Booking.query().include("Driver,Client,Vehicle,FlightInfo,BookingStops,Invoice,BookingStops/PassengerStops,Passengers,BookingValidations,BookingTags,LeadPassenger,Currency,BookingRequirements,BookingExpense,BookingExpense/BookingExpenseType,BookingExpense/Tax").where("Id eq guid'"+t.item.Id+"'").trackingEnabled().execute().then(function(e){if(t.item=e[0],t.item.$Coupon=t.item.Coupon,t.item.BookingStops=t.item.BookingStops.sort(function(e,t){return e.StopOrder-t.StopOrder}),t.item.BookingExpense=t.item.BookingExpense.map(function(e){return new u.BookingExpense(e)}),P(t.item.BookedDateTime),t.item.FlightInfo&&(t.flightData.Number=t.item.FlightInfo.FlightNumber),t.item.Priority){var i=["P1","P2","P3","P4","P5"].indexOf("P"+t.item.Priority)+1;t.item.Priority=i.toFixed(0)}else t.item.Priority="P1";t.item.DispatchDateTime?t.item._AutoDispatchOffset=moment(t.item.BookedDateTime).diff(moment(t.item.DispatchDateTime),"minutes"):t.item._AutoDispatchOffset=15,t.viewMode="EDIT"}):swal("Booking Locked!","This booking is currently being edited by: "+e.user,"error")}).error(function(){swal("Error!","Unknown error occured.","error")})},t.cancelEditing=function(){t.lock.saved=!0,t.expenses.editing&&M(),t.expenses.adding&&V(),r.get(s.API_ENDPOINT+"api/bookings/RemoveLock",{params:{bookingId:t.item.Id}}).success(function(i){var n=e.copy(t.Tags);u.Booking.query().include("Driver,Client,Vehicle,FlightInfo,BookingStops,Invoice,BookingStops/PassengerStops,Passengers,BookingValidations,LeadPassenger,Currency,BookingRequirements,BookingTags,BookingExpense,BookingExpense/BookingExpenseType,BookingExpense/Tax").where("Id eq guid'"+t.item.Id+"'").trackingEnabled().execute().then(function(e){if(t.item=e[0],t.item.BookingStops=t.item.BookingStops.sort(function(e,t){return e.StopOrder-t.StopOrder}),t.item.BookingExpense=t.item.BookingExpense.map(function(e){return new u.BookingExpense(e)}),t.item.Tags=n,t.viewMode="VIEW",P(t.item.BookedDateTime),t.tags=n,t.item.FlightInfo&&(t.flightData.Number=t.item.FlightInfo.FlightNumber),t.item.Priority){var i=["P1","P2","P3","P4","P5"].indexOf("P"+t.item.Priority)+1;t.item.Priority=i.toFixed(0)}else t.item.Priority="P1";t.item.DispatchDateTime?t.item._AutoDispatchOffset=moment(t.item.BookedDateTime).diff(moment(t.item.DispatchDateTime),"minutes"):t.item._AutoDispatchOffset=15});var o=[];o.push("(EntityType eq 'Booking' and EntityId eq guid'"+t.item.Id+"')"),o.push("(BookingId eq guid'"+t.item.Id+"')");for(var r=0;r<t.item.BookingStops.length;r++){var s=t.item.BookingStops[r];o.push("(EntityType eq 'BookingStop' and EntityId eq guid'"+s.Id+"')")}}).error(function(){swal("Error!","Unknown error occured.","error")})},window.onbeforeunload=function(){t.lock.saved=!0;var e=new XMLHttpRequest;e.open("GET",s.API_ENDPOINT+"api/bookings/RemoveLock?bookingId="+t.item.Id,!1),e.setRequestHeader("Content-type","application/json"),e.setRequestHeader("Authorization","bearer "+d.getSession().access_token),e.send()},"true"==I.search().editnow&&t.startEditing(),t.canQuote=!0,t.item.BookingExpense=t.item.BookingExpense.map(function(e){return new u.BookingExpense(e)}),t.bookingInfo=!0,t.externalLocations={knownLocations:f[0]&&f[0].KnownLocations?f[0].KnownLocations:[],historic:[]},t.sortableOptions={stop:function(e,t){},ondragstart:function(e,t){},disabled:!(t.item.BookingStops.length>2)},t.bookers=[],t.save=ne,t.close=G,t.formFor={},t.testMaskReferences=z,t.reverseStops=ie,t.suggestReferences=Q,t.addRequirement=w,t.removeRequirement=U,t.clients=f,t.openInvoice=function(e){(window.opener||window).open("/webapp/management/index.html#/invoices/"+e,"_blank")},P(t.item.BookedDateTime),t.client=f[0],t.client&&(t.client.Name=t.client.AccountNo+" "+t.client.Name),t.clientReferences=[],t.booking=l,t.expenseTypes=c,t.taxes=g,t.searchBookers=Y,t.searchPassengers=Z,t.fetchFlightInformation=x,t.removeFlightInfo=b,t.expenses={editing:null},t.addTag=E,t.removeTag=y,t.flightData={Number:"",DateTime:null,MinsAfterLanding:0,GetDate:function(e){var t=this.DateTime&&new moment(this.DateTime).add(this.MinsAfterLanding||0,"minute");return e?t.format(e):t}},t.item.FlightInfo&&(t.flightData.Number=t.item.FlightInfo.FlightNumber,t.flightData.DateTime=new moment(t.item.FlightInfo.ScheduledArrivalTime),t.flightData.MinsAfterLanding=t.item.FlightInfo.MinsAfterLanding||0),t.driverPayment=null,r.get(s.API_ENDPOINT+"api/DriverPayments/breakdown",{params:{bookingId:t.item.Id}}).success(function(e){t.driverPayment=e}),f[0]&&e.forEach(f[0].ClientReferences,function(i){if(e.forEach(t.item.BookingValidations,function(e){if(i.Id==e.ClientReferenceId&&(i.$knownValue=e.Value,i.$id=e.Id,"List"==i.ReferenceType)){var t={custom:!1,text:e.Value};i.$knownValue=t,i.$originalValue=t,i.$suggested=[t]}}),"Mask"==i.ReferenceType&&(i.$testReg=W(i.Value)),"List"==i.ReferenceType&&i.ShowList){var n=i;r({method:"GET",url:s.API_ENDPOINT+"/api/ClientReferences/list?ClientReferenceId="+i.Id}).then(function(e){n.$list=e.data.map(function(e){return{custom:!1,text:e}}),n.AllowAddToList&&n.$list.push({custom:!0,text:"Add '{{$select.search}}' to References"})})}t.clientReferences.push(i)}),!t.client||t.client.AllVehicleTypeAccess?u.VehicleType.query().parseAs(function(e){this.Id=e.Id,this.Name=e.Name,this.Description=e.Description,this.IsDefault=e.IsDefault,this.Priority=e.Priority,this.Order=e.Order,this.IsDefault=e.IsDefault,this.ImageUrl=null}).execute().then(function(e){t.vehicleTypes=t.vehicleTypes=e.sort(function(e,t){return(e.Order||99)-(t.Order||99)})}):t.vehicleTypes=t.client.VehicleTypes.sort(function(e,t){return(e.Order||99)-(t.Order||99)}),u.BookingRequirement.query().execute().then(function(i){t.bookingRequirements=t.unlinkedRequirements=i,e.forEach(t.item.BookingRequirements,function(e){var i=t.unlinkedRequirements.filter(function(t){return t.Id==e.Id});i[0]&&t.unlinkedRequirements.splice(t.unlinkedRequirements.indexOf(i[0]),1)})}),t.$watch("item.Date",function(e,i){return t.dateSet?void(t.dateSet=!1):void(t.flightData.Number&&e&&e!=i&&x())}),t.addExpense=R,t.editExpense=O,t.removeExpense=q,t.saveEditedExpense=F,t.cancelEditedExpense=M,t.saveNewExpense=_,t.cancelNewExpense=V,t.getExpenseTypeName=N,t.getTaxName=L,t.flipAddress=H,t.passengers=p,t.passengers.push({Id:"add-passenger",Name:"Add Passenger",Description:"Create New Passenger",ImageUrl:"/includes/images/add-icon.png"}),t.bookers=k,t.bookers.push({Id:"add-booker",Name:"Add Booker",Description:"Create New Booker",ImageUrl:"/includes/images/add-icon.png"}),t.addTime=te,t.addStop=ee,t.removeStop=J,t.$watch("item.BookingStops[0]",function(i,n){if(void 0!==n&&i!==n&&t.item.WaitAndReturn){var o=new u.BookingStop(e.copy(t.item.BookingStops[0]));o.id=idCounter++,o.Id=null,o.WaitTime=null,t.item.BookingStops.splice(t.item.BookingStops.length-1,1,o)}},!0),t.$watch("item.WaitAndReturn",function(i,n){if(void 0!==n&&i!==n){if(i===!1)t.item.BookingStops.splice(t.item.BookingStops.length-1,1);else if(i===!0){var o=new u.BookingStop(e.copy(t.item.BookingStops[0]));o.id=idCounter++,o.Id=null,o.WaitTime=null,t.item.BookingStops.push(o)}t.canQuote=!0,t.item.AsDirected?t.canQuote=t.item.BookingStops[0].Latitude&&t.item.BookingStops[0].Longitude:e.forEach(t.item.BookingStops,function(e,i){e.Latitude&&e.Longitude||(t.canQuote=!1)})}}),t.$watch(function(){return(t.item.BookingStops||[]).map(function(e){return{Address1:e.Address1,Address2:e.Address2,Area:e.Area,TownCity:e.TownCity,Postcode:e.Postcode,Latitude:e.Latitude,Longitude:e.Longitude}})},function(i,n){if(void 0!==n){if(re)return void(re=!1);t.canQuote=!0,t.item.AsDirected?t.canQuote=t.item.BookingStops[0].Latitude&&t.item.BookingStops[0].Longitude:e.forEach(t.item.BookingStops,function(e,i){e.Latitude&&e.Longitude||(t.canQuote=!1)}),t.canQuote?j(t.item):(t.item.EstimatedCost=0,t.quote=null,t.directions=null)}},!0),t.$watchGroup(["item.Date","item.Time"],function(i){var n=A(i[0],i[1]);new moment(n).isSame(t.item.BookedDateTime)||(t.item.BookedDateTime=n,t.canQuote=!0,t.timeSet=!1,e.forEach(t.item.BookingStops,function(e,i){e.Latitude&&e.Longitude||(t.canQuote=!1)}),t.canQuote?j(t.item):(t.item.EstimatedCost=0,t.quote=null,t.directions=null))}),t.$watch("item.ClientStaffId",function(e){if("add-booker"===e){var i=n.open({templateUrl:"/webapp/common/modals/booker/modal.html",controller:"BookerCreateController",resolve:{rBooker:function(){var e=new u.ClientStaff;return e.Phone=t.clients.filter(function(e){return e.Id==t.item.ClientId})[0].Phone,e.ClientId=t.item.ClientId,e}}});i.result.then(function(e){var i={Id:e.Id,ClientId:e.ClientId,Name:e.Firstname+" "+e.Surname,Description:e.Email?e.Email:"",Mobile:e.Mobile,ImageUrl:$utilities.formatUrl(e.ImageUrl,e.Name)};t.newBooker=e,t.bookers.push(i),t.item.ClientStaffId=e.Id},function(){t.item.ClientStaffId=null})}}),t.$watchGroup(["item.AsDirected","item.ChauffeurMode","item.EstimatedMins","item.ActualDistance","item.BookingStops.length"],function(i,n){if(void 0!==n[0]&&"VIEW"!=t.viewMode){if(t.item.AsDirected===!0)t.item.BookingStops.length=1;else if(1==t.item.BookingStops.length){var o=new u.BookingStop;o.id=idCounter++,t.item.BookingStops.push(o)}t.canQuote=!0,t.item.AsDirected?t.canQuote=t.item.BookingStops[0].Latitude&&t.item.BookingStops[0].Longitude:e.forEach(t.item.BookingStops,function(e,i){e.Latitude&&e.Longitude||(t.canQuote=!1)}),t.item.EstimatedCost=0,t.quote=null,t.directions=null,t.canQuote&&j(t.item)}}),t.$watch("selectedPassenger.Mobile",function(e,i){e!=i&&void 0!==i&&(t.item.PassengerNotificationPhone=e)}),t.$watch("item.LeadPassengerId",function(i,o){function r(){u.Passenger.query().where("Id","eq","guid'"+i+"'").include("Tags").select("Tags").execute().then(function(e){d.Tags=e[0].Tags;for(var t=0;t<d.Tags.length;t++)E(d.Tags[t])})}if("add-passenger"===i){t.item.LeadPassengerId=null;var s=n.open({templateUrl:"/webapp/common/modals/passenger/create.modal.html",controller:"PassengerItemCreateModalController",resolve:{rClientId:function(){return t.item.ClientId},rNavigateAfterSave:function(){return!1}}});return void s.result.then(function(e){var i={Id:e.Id,ClientId:e.ClientId,Name:e.Firstname+" "+e.Surname,Description:e.Email?e.Email:"",Mobile:e.Mobile,ImageUrl:$utilities.formatUrl(e.ImageUrl,e.Name)};t.passengers.push(i),t.item.ClientId=e.ClientId,t.item.LeadPassengerId=e.Id},function(){})}var a=t.item;if(i){var d=t.passengers.filter(function(e){return e.Id==i})[0];t.selectedPassenger=d,a.ClientId=d.ClientId,i!==o&&(a.PassengerNotificationPhone=d.Mobile),e.forEach(d.Addresses,function(e){if(e.Latitude&&e.Longitude){var i="";e.Address1&&e.Address1.length>1&&(i+=e.Address1),e.TownCity?(i.length>0&&(i+=", "),i+=e.TownCity):e.Area&&(i.length>0&&(i+=", "),i+=e.Area),e.Postcode&&(i.length>0&&(i+=", "),i+=e.Postcode),t.externalLocations.knownLocations.push({Address1:e.Address1,Address2:e.Address2,Area:e.Area,TownCity:e.TownCity,County:e.County,Postcode:e.Postcode,Country:e.Country,Latitude:e.Latitude,Longitude:e.Longitude,Name:e.Name,StopSummary:e.StopSummary||i,LocationType:"Passenger Address"})}});var l=t.clients.filter(function(e){return e.Id==d.ClientId})[0];l?t.fetchedClients=[l]:t.fetchedClients=[],u.Booking.query().where("LeadPassengerId","eq","guid'"+i+"'").include("BookingStops").orderBy("BookedDateTime desc").top(5).execute().then(function(e){t.paxHistory=e,t.currentTab="HISTORY"}),t.externalLocations.historic.length=0,u.BookingStop.query().where("Booking/LeadPassengerId","eq","guid'"+i+"'").top(10).execute().then(function(e){var i={};uniqueResults=e.filter(function(e){return!i[e.Address1]&&(i[e.Address1]=!0,!0)}),[].push.apply(t.externalLocations.historic,uniqueResults)}),d.Tags||r()}else watchPassenger||(watchPassenger=!0,t.filteredPassengers=t.passengers),a.PassengerNotificationPhone=null}),t.$watch("item.VehicleTypeId",function(i,n){void 0!==n&&i!==n&&(t.canQuote=!0,t.item.AsDirected?t.canQuote=t.item.BookingStops[0].Latitude&&t.item.BookingStops[0].Longitude:e.forEach(t.item.BookingStops,function(e,i){e.Latitude&&e.Longitude||(t.canQuote=!1)}),t.canQuote?j(t.item):(t.item.EstimatedCost=0,t.quote=null,t.directions=null))})}var i=e.module("cab9.common");i.controller("BookingEditModalController",t),t.$inject=["$scope","$UI","$modal","$modalInstance","$http","$config","$rootScope","Auth","Model","rBooking","rMode","rTaxes","rExpenseTypes","rClients","rPassengers","rClientStaff","Localisation","$location","rTags"]}(angular);;;;