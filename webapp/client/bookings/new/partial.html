<div id="new-booking">
    <div id="booking-form">
        <div class="wrapper">
            <div id="dispatch-new-booking" style="overflow-y:auto;">
                <div class="overlay loading-div" ng-if="!dataReady">
                    <div class="loader">
                        <div class="loader-inner ball-clip-rotate-multiple">
                            <div></div>
                            <div></div>
                        </div>
                    </div>
                </div>
                <div name="dispatchBookingForm" form-for="_dbooking" schema="Booking" mode="CREATE">
                    <div class="form-section">
                        <div class="passenger-info">
                            <div class="header mb5">Passenger Information</div>
                            <div class="half-column">
                                <div class="block">
                                    <div ng-show="!paxMode.value">
                                        <div class="" id="passenger-info">
                                            <div class="half-column" ng-if="isAdmin">
                                                <div class="form-group">
                                                    <label class="control-label" for="Booker">Booker</label>
                                                    <div class="form-edit">
                                                        <ui-select class="edit" ng-model="_dbooking.ClientStaffId" name="BookerInput" theme="selectize" required tabindex="2">
                                                            <ui-select-match allow-clear="true" placeholder="Start typing to search...">
                                                                <div class="select-text"><img class="img-responsive img-circle" ng-if="$select.selected.ImageUrl" ng-src="{{$select.selected.ImageUrl}}" />{{$select.selected.Name}}</div>
                                                                <edit-modal ng-click="$event.stopPropagation()" type="Booker" class="pull-right edit-modal" data="selectedBooker" selected="$select.selected"></edit-modal>
                                                            </ui-select-match>
                                                            <ui-select-choices refresh="searchBookers($select.search)" refresh-delay="500" repeat="item.Id as item in filteredBookers">
                                                                <div class="select-text-option">
                                                                    <img class="img-responsive img-circle" ng-src="{{::item.ImageUrl}}" ng-if="::item.ImageUrl" />
                                                                    <div ng-bind-html="::item.Name | highlight: $select.search"></div>
                                                                    <small class="text-muted" ng-show="::item.Description">{{::item.Description}}</small>
                                                                    <small class="ml40" ng-show="::(item.Mobile.length > 0)"><strong>{{::item.Mobile}}</strong></small>
                                                                </div>
                                                            </ui-select-choices>
                                                        </ui-select>
                                                        <a ng-click="_dbooking.ClientStaffId = null;" style="position:absolute;right:0px;top:2px;font-size:11px;" ng-show="_dbooking.ClientStaffId" class="red">Clear</a>
                                                    </div>
                                                </div>
                                            </div>
                                            <br class="clearfix" />
                                            <div class="half-column">
                                                <div field-for="Reference" display="General Reference" tab-index="3"></div>
                                            </div>
                                            <div ng-repeat="item in clientReferences" class="half-column" ng-if="_dbooking.ClientId && clientReferences.length>0">
                                                <div class="form-group" ng-if="item.ReferenceType=='FreeText'">
                                                    <label for="" class="control-label">{{item.ReferenceName}}<span ng-if="item.Mandatory">*</span></label>
                                                    <div class="form-edit">
                                                        <input type="text" tabindex="4" class="form-control" name="{{item.ReferenceName}}" ng-model="item.$knownValue" ng-required="item.Mandatory">
                                                    </div>
                                                    <div class="help-block" ng-if="item.Mandatory">{{item.ReferenceName}} is required.</div>
                                                </div>
                                                <div class="form-group" ng-if="item.ReferenceType=='List' && !item.ShowList">
                                                    <label for="" class="control-label">{{item.ReferenceName}}</label>
                                                    <div class="form-edit input_group">
                                                        <ui-select tabindex="4" class="edit" ng-model="item.$knownValue" name="{{item.ReferenceName}}" theme="selectize" ng-required="item.Mandatory" on-select="refSelected($item, $search, item)">
                                                            <ui-select-match allow-clear="true" placeholder="Start typing to search...">
                                                                <div class="select-text">{{$select.selected.text}}</div>
                                                            </ui-select-match>
                                                            <ui-select-choices refresh="suggestReferences(item,$select.search)" refresh-delay="500" repeat="i as i in item.$suggested track by $index">
                                                                <div class="select-text-option reference-ui">
                                                                    <div bind-html-compile="::i.text"></div>
                                                                </div>
                                                            </ui-select-choices>
                                                        </ui-select>
                                                        <a ng-click="item.$knownValue = null;" style="position:absolute;right:0px;top:2px;font-size:11px;" ng-show="item.$knownValue" class="red">Clear</a>
                                                    </div>
                                                    <div class="help-block" ng-if="item.Mandatory">{{item.ReferenceName}} is required.</div>

                                                </div>
                                                <div class="form-group" ng-if="item.ReferenceType=='List' && item.ShowList">
                                                    <label for="" class="control-label">{{item.ReferenceName}}</label>
                                                    <div class="form-edit input_group">
                                                        <ui-select tabindex="4" class="edit" ng-model="item.$knownValue" theme="selectize" ng-required="item.Mandatory" name="{{item.ReferenceName}}" on-select="refSelected($item, $search, item)">
                                                            <ui-select-match allow-clear="true" placeholder="Start typing to search...">
                                                                <div class="select-text">{{$select.selected.text}}</div>
                                                            </ui-select-match>
                                                            <ui-select-choices repeat="i as i in item.$list track by $index">
                                                                <div class="select-text-option reference-ui">
                                                                    <div bind-html-compile="::i.text"></div>
                                                                </div>
                                                            </ui-select-choices>
                                                        </ui-select>
                                                        <a ng-click="item.$knownValue = null;" style="position:absolute;right:0px;top:2px;font-size:11px;" ng-show="item.$knownValue" class="red">Clear</a>
                                                    </div>
                                                    <div class="help-block" ng-if="item.Mandatory">{{item.ReferenceName}} is required.</div>
                                                </div>
                                                <div class="form-group" ng-if="item.ReferenceType=='Mask'">
                                                    <label for="" class="control-label">{{item.ReferenceName + ' (mask: ' + item.Value + ')'}}</label>
                                                    <div class="form-edit input-group">
                                                        <input tabindex="4" type="text" class="form-control" ng-model="item.$knownValue" name="{{item.ReferenceName}}" ng-required="item.Mandatory">
                                                        <span class="input-group-btn">
                                                            <button class="btn btn-danger" ng-show="item.$knownValue && !item.$testReg.test(item.$knownValue)">
                                                                <i class="material-icons">close</i>
                                                            </button>
                                                            <button class="btn btn-success" ng-show="item.$knownValue && item.$testReg.test(item.$knownValue)">
                                                                <i class="material-icons">check</i>
                                                            </button>
                                                            <button class="btn btn-warning" ng-show="!item.$knownValue">
                                                                <i class="material-icons">help_outline</i>
                                                            </button>
                                                        </span>
                                                    </div>
                                                    <div class="help-block" ng-if="item.Mandatory">{{item.ReferenceName}} is required.</div>
                                                </div>
                                            </div>
                                            <div style="clear: both"></div>
                                            <div class="half-column">
                                                <div class="form-group">
                                                    <label class="control-label" for="LeadPassengerIdInput">Passenger</label>
                                                    <div class="form-edit">
                                                        <ui-select tabindex="5" class="edit" ng-model="_dbooking.LeadPassengerId" theme="selectize" ng-disabled="false" required name="PassengerInput">
                                                            <ui-select-match allow-clear="true" placeholder="Start typing to search...">
                                                                <div class="select-text"><img class="img-responsive img-circle" ng-if="$select.selected.ImageUrl" ng-src="{{$select.selected.ImageUrl}}" />{{$select.selected.Name}}</div>
                                                                <edit-modal ng-click="$event.stopPropagation()" type="Passenger" data="selectedPassenger" class="pull-right edit-modal" selected="$select.selected"></edit-modal>
                                                            </ui-select-match>
                                                            <ui-select-choices refresh="searchPassengers($select.search)" refresh-delay="500" repeat="item.Id as item in fetchedPassengers">
                                                                <div class="select-text-option">
                                                                    <img class="img-responsive img-circle" ng-src="{{::item.ImageUrl}}" ng-if="::item.ImageUrl" />
                                                                    <div ng-bind-html="::item.Name | highlight: $select.search"></div>
                                                                    <small class="text-muted" ng-show="::item.Description">{{::item.Description}}</small>
                                                                    <small class="ml40" ng-show="::(item.Mobile.length > 0 || item.Phone.length > 0)" ng-bind="(item.Mobile ? item.Mobile : item.Phone)"><strong></strong></small>
                                                                </div>
                                                            </ui-select-choices>
                                                        </ui-select>
                                                        <a ng-click="_dbooking.LeadPassengerId = null;" style="position:absolute;right:0px;top:2px;font-size:11px;" ng-show="_dbooking.LeadPassengerId" class="red">Clear</a>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="half-column">
                                                <div tab-index="5" field-for="PassengerNotificationPhone" display="Contact Number" required="{{COMPANY.RequiresContactNumber}}"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <br class="clearfix" />
                                </div>
                            </div>
                            <div class="half-column client-info">
                                <div class="special-requirements block">
                                    <h3 class="section-title">
                                        <i class="material-icons">label_important</i> Tags
                                    </h3>
                                    <table class="table table-condensed table-hover mb10 table-bordered">
                                        <tbody>
                                            <tr ng-if="_dbooking.Tags.length==0">
                                                <td>
                                                    <span class="text-muted">No Tags has been added.</span>
                                                </td>
                                            </tr>
                                            <tr ng-if="_dbooking.Tags.length !== 0">
                                                <td>
                                                    <div class="row">
                                                        <div class="col-xs-5">
                                                            <strong class="brand-primary">Name</strong>
                                                        </div>
                                                        <div class="col-xs-3">
                                                            <strong class="brand-primary">Mandatory</strong>
                                                        </div>
                                                        <div class="col-xs-3">
                                                            <strong class="brand-primary">Preferred</strong>
                                                        </div>
                                                        <div class="col-xs-1">
                                                            <!-- <a href="" class="red pull-right ml8" ng-click="removeTag(item)" ng-show="viewMode!='VIEW'">
                                                                <i class="material-icons">remove_circle</i>
                                                            </a> -->
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr ng-repeat="item in _dbooking.Tags">
                                                <td>
                                                    <div class="row">
                                                        <div class="col-xs-5">
                                                            <strong class="brand-primary">{{item.Name}}</strong>
                                                        </div>
                                                        <div class="col-xs-3">
                                                            <label class="check-container" style="margin-top: 0px !important; font-size: 15px; margin-left: 15px;">
                                                                &nbsp;
                                                                <input type="radio" ng-model="item.Type" value="Mandatory" />
                                                                <span class="checkmark"></span>
                                                            </label>
                                                        </div>
                                                        <div class="col-xs-3">
                                                            <label class="check-container" style="margin-top: 0px !important; font-size: 15px; margin-left: 15px;">
                                                                &nbsp;
                                                                <input type="radio" ng-model="item.Type" value="Preferred" />
                                                                <span class="checkmark"></span>
                                                            </label>
                                                        </div>
                                                        <div class="col-xs-1">
                                                            <a href="" class="red pull-right ml8" ng-click="removeTag(item)" ng-show="viewMode!='VIEW'">
                                                                <i class="material-icons">remove_circle</i>
                                                            </a>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div class="row">
                                        <div class="col-sm-6" ng-show="viewMode != 'VIEW'">
                                            <div class="form-group" ng-show="unlinkedTags.length>0">
                                                <label for="">Add Tag</label>
                                                <div class="form-edit">
                                                    <ui-select ng-model="_dbooking.$selectedTag" theme="selectize" title="Add Tags" ng-change="addTag($select.selected)" class="edit">
                                                        <ui-select-match placeholder="Select from list...">
                                                        </ui-select-match>
                                                        <ui-select-choices repeat="item in unlinkedTags | filter: $select.search | orderBy: 'Name'">
                                                            <div class="select-text-option">
                                                                <div ng-bind-html="item.Name | highlight: $select.search"></div>
                                                            </div>
                                                        </ui-select-choices>
                                                    </ui-select>
                                                </div>
                                            </div>
                                            <span ng-show="unlinkedTags.length==0">No tags available to add.</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <br class="clearfix" />
                        </div>
                        <div class="journey-info">
                            <div class="header mb5">Journey Information</div>
                            <div class="half-column pr5">
                                <div class="block">
                                    <h3 class="section-title">
                                        <i class="material-icons">near_me</i> Pickup/Dropoff
                                    </h3>
                                    <small class="text-muted">Please enter the journey information below. You can add multiple stops or make this an As Directed booking.</small>
                                    <div class="tabs">
                                        <ul class="nav nav-tabs">
                                            <li ng-class="{'active': !_dbooking.ChauffeurMode }"><a ng-click="disableChauffering()">Journey</a></li>
                                            <li ng-if="COMPANY.ChauffeurModeActive" ng-class="{'active': _dbooking.ChauffeurMode }"><a ng-click="enableChauffering()">Hourly</a></li>
                                        </ul>
                                    </div>
                                    <ul ui-sortable="sortableOptions" ng-model="_dbooking.BookingStops" class="sortable-list">
                                        <li ng-repeat="stop in _dbooking.BookingStops">
                                            <div ng-if="$first">
                                                <div class="three-fourth-column">
                                                    <div class="form-group">
                                                        <label class="control-label" for="stop{{$index}}">
                                                            Pickup
                                                        </label>
                                                        <div class="form-edit booking-stop">
                                                            <div tab-index="6" stop-edit name="stop{{$index}}" map="map" required="$first" model="stop" known="externalLocations.knownLocations" external="externalLocations.historic"></div>
                                                        </div>
                                                    </div>
                                                    <div class="flip pointer" ng-if="_dbooking.BookingStops.length==2" ng-click="flipAddress()">
                                                        <i class="material-icons">import_export</i>
                                                    </div>
                                                </div>
                                                <div class="fourth-column pl20">
                                                    <div class="form-group">
                                                        <label class="control-label">As Directed</label>
                                                        <input class="check" type="checkbox" id="AsDirectedCheck" ng-model="_dbooking.AsDirected" ng-disabled="_dbooking.WaitAndReturn" />
                                                        <label class="check-label" for="AsDirectedCheck"></label>
                                                    </div>
                                                </div>
                                                <br class="clearfix" />
                                            </div>
                                            <div ng-if="!$first && !_dbooking.AsDirected">
                                                <div class="full-column" ng-if="$middle">
                                                    <div class="form-group">
                                                        <label class="control-label" for="stop{{$index}}">
                                                            Via
                                                        </label>
                                                        <div class="form-edit input-group booking-stop">
                                                            <div tab-index="7" stop-edit name="stop{{$index}}" map="map" required="$first" model="stop" known="externalLocations.knownLocations" external="externalLocations.historic"></div>
                                                            <span class="input-group-btn"><button class="btn btn-danger" ng-click="removeStop($index)"><i class="material-icons">remove_circle</i></button></span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div ng-if="$last">
                                                    <div class="three-fourth-column">
                                                        <div class="form-group">
                                                            <label class="control-label" for="stop{{$index}}">
                                                                {{ _dbooking.WaitAndReturn ? 'Return To' : 'Drop Off' }}
                                                            </label>
                                                            <div class="form-edit booking-stop" ng-if="!_dbooking.WaitAndReturn">
                                                                <div tab-index="8" stop-edit name="stop{{$index}}" map="map" required="$first" model="stop" known="externalLocations.knownLocations" external="externalLocations.historic"></div>
                                                            </div>
                                                            <div class="form-edit booking-stop" ng-if="_dbooking.WaitAndReturn">
                                                                <input type="text" class="form-control" ng-model="stop.StopSummary" disabled />
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="fourth-column add-stop pl20">
                                                        <a href="" class="link" ng-click="addStop($index)"><i class="material-icons">add_circle</i>Add Stop</a>
                                                    </div>
                                                </div>
                                                <br class="clearfix" />
                                            </div>
                                        </li>
                                    </ul>
                                    <div ng-show="!_dbooking.ChauffeurMode">
                                        <div class="half-column">
                                            <div class="form-group">
                                                <label class="control-label">
                                                    Wait & Return
                                                </label>
                                                <input class="check" type="checkbox" id="check-waitreturn" ng-model="_dbooking.WaitAndReturn" ng-disabled="_dbooking.AsDirected" />
                                                <label class="check-label" for="check-waitreturn"></label>
                                            </div>
                                        </div>
                                        <div class="half-column">
                                            <button class="btn btn-xs btn-primary mt10" ng-if="_dbooking.BookingStops.length>2" ng-click="reverseStops()"><i class="material-icons" style="font-size:20px">import_export</i>Flip Journey</button>
                                        </div>
                                    </div>
                                    <div ng-show="_dbooking.ChauffeurMode">
                                        <div class="half-column">
                                            <div class="form-group">
                                                <label class="control-label">
                                                    Duration
                                                </label>
                                                <div class="form-edit">
                                                    <select class="form-control" ng-model="_dbooking.EstimatedMins">
                                                        <option value="60">1 hour</option>
                                                        <option value="120">2 hours</option>
                                                        <option value="180">3 hours</option>
                                                        <option value="240">4 hours</option>
                                                        <option value="300">5 hours</option>
                                                        <option value="360">6 hours</option>
                                                        <option value="420">7 hours</option>
                                                        <option value="480">8 hours</option>
                                                        <option value="540">9 hours</option>
                                                        <option value="600">10 hours</option>
                                                        <option value="660">11 hours</option>
                                                        <option value="720">12 hours</option>
                                                        <option value="780">13 hours</option>
                                                        <option value="840">14 hours</option>
                                                        <option value="900">15 hours</option>
                                                        <option value="960">16 hours</option>
                                                        <option value="1020">17 hours</option>
                                                        <option value="1080">18 hours</option>
                                                        <option value="1140">19 hours</option>
                                                        <option value="1200">20 hours</option>
                                                        <option value="1260">21 hours</option>
                                                        <option value="1320">22 hours</option>
                                                        <option value="1380">23 hours</option>
                                                        <option value="1440">24 hours</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="half-column" ng-show="_dbooking.AsDirected">
                                            <div class="form-group">
                                                <label class="control-label">
                                                    Expected Mileage
                                                </label>
                                                <div class="form-edit">
                                                    <input class="form-control" type="number" ng-model="_dbooking.ActualDistance" min="0" max="10000" ng-model-options="{ debounce: 350 }" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <br class="clearfix" />
                                    <div class="half-column">
                                        <div tab-index="9" field-for="Date" display="Date" required="true" ng-model-options="{ debounce: 500 }"></div>
                                        <div class="quick-links">
                                            <a href="" class="linked" ng-click="addTime(0,'day')">Today</a>
                                            <a href="" class="linked" ng-click="addTime(1440,'day')">Tomorrow</a>
                                        </div>
                                    </div>
                                    <div class="half-column">
                                        <div tab-index="10" field-for="Time" display="Time" step="300" required="true" ng-model-options="{ debounce: 500 }"></div>
                                        <div class="quick-links">
                                            <a href="" class="linked" ng-click="addTime(0,'time')">Now</a>
                                            <a href="" class="linked" ng-click="addTime(15,'time')">+15m</a>
                                            <a href="" class="linked" ng-click="addTime(30,'time')">+30m</a>
                                            <a href="" class="linked" ng-click="addTime(60,'time')">+60m</a>
                                        </div>
                                    </div>
                                    <br class="clearfix" />
                                </div>
                                <div class="block">
                                    <h3 class="section-title">
                                        <i class="material-icons">directions_car</i> Vehicle Info
                                    </h3>
                                    <small class="text-muted">Vehicle type will depend upon the number of passengers chosen. Journey quote will appear in the cost box.</small>
                                    <div class="half-column">
                                        <div tab-index="11" field-for="Pax" display="Passengers" required="true"></div>
                                    </div>
                                    <div class="half-column">
                                        <div tab-index="12" field-for="Bax" display="Bags" required="true"></div>
                                    </div>
                                    <div class="half-column">
                                        <div tab-index="13" field-for="VehicleTypeId" select-from="filteredVehicleTypes" display="Vehicle"></div>
                                    </div>
                                    <br class="clearfix">
                                    <div class="half-column">
                                        <div class="form-group">
                                            <label class="control-label">Payment Method</label>
                                            <select class="form-control" tab-index="15" ng-model="_dbooking.PaymentMethod" name="PaymentMethod" required>
                                                <option value="Cash" ng-if="$root.CLIENT.AllowCashInPortal">Cash</option>
                                                <option value="Card">Card</option>
                                                <option value="OnAccount" ng-if="!!_dbooking.ClientId">OnAccount</option>
                                            </select>
                                        </div>
                                    </div>
                                    <br class="clearfix">
                                    <div class="half-column" ng-show="showPaymentCards">
                                        <div tab-index="17" field-for="PaymentCardId" select-from="filteredPaymentCards" display="Payment Cards"></div>
                                    </div>
                                    <div class="half-column pt25" ng-show="showPaymentCards">
                                        <div tab-index="18" display="Add Payment Cards">
                                            <a href="" class="link brand-primary" ng-click="addCard()"><i class="material-icons">add_circle</i>Add New Card</a>
                                        </div>
                                    </div>
                                    <br class="clearfix" ng-show="showPaymentCards">
                                </div>
                                <div class="special-requirements block">
                                    <h3 class="section-title">
                                        <i class="material-icons">accessible</i> Special Requirements
                                    </h3>
                                    <table class="table table-condensed table-hover mb10 table-bordered">
                                        <thead>
                                            <tr>
                                                <th><strong class="brand-secondary">Special Requirements</strong></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr ng-if="staff.BookingRequirements.length==0">
                                                <td>
                                                    <span class="text-muted">No Special Requirements added.</span>
                                                </td>
                                            </tr>
                                            <tr ng-repeat="item in _dbooking.BookingRequirements">
                                                <td>
                                                    <strong class="brand-primary">{{item.Name}}</strong>
                                                    <a href="" class="red pull-right ml8" ng-click="removeRequirement(item)" ng-show="viewMode!='VIEW'">
                                                        <i class="material-icons">remove_circle</i>
                                                    </a>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div class="row">
                                        <div class="col-sm-6" ng-show="viewMode != 'VIEW'">
                                            <div class="form-group" ng-show="unlinkedRequirements.length>0">
                                                <label for="">Add Special Requirements</label>
                                                <div class="form-edit">
                                                    <ui-select ng-model="_dbooking.$selectedRequirement" theme="selectize" title="Add Special Requirements" ng-change="addRequirement($select.selected)" class="edit">
                                                        <ui-select-match placeholder="Select from list...">
                                                        </ui-select-match>
                                                        <ui-select-choices repeat="item in unlinkedRequirements | filter: $select.search | orderBy: 'Name'">
                                                            <div class="select-text-option">
                                                                <div ng-bind-html="item.Name | highlight: $select.search"></div>
                                                            </div>
                                                        </ui-select-choices>
                                                    </ui-select>
                                                </div>
                                            </div>
                                            <span ng-show="unlinkedRequirements.length==0">No requirements available to add.</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="half-column pr0">
                                <div class="passenger-history block">
                                    <h3 class="section-title"><i class="material-icons">person</i>Passenger History</h3>
                                    <small class="text-muted" ng-if="!_dbooking.LeadPassengerId">Once a passenger is selected their history will appear here. You can copy a journey by click the copy icon on the left.</small>
                                    <small class="text-muted" ng-if="_dbooking.LeadPassengerId && paxHistory.length > 0">Please click the copy icon on the left to repeat passenger's previous booking.</small>
                                    <div class="table-wrapper" ng-if="_dbooking.LeadPassengerId && paxHistory.length > 0">
                                        <table class="table table-condensed mb20">
                                            <thead>
                                                <tr>
                                                    <th style="width:15%">Copy</th>
                                                    <th style="width:85%">Last 5 Bookings</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr ng-repeat="item in paxHistory">
                                                    <td class="text-center"><a href="" ng-click="repeatBooking(item)"><i class="material-icons">note_add</i></a></td>
                                                    <td>
                                                        <strong class="brand-primary">{{item._FromSummary}}</strong>
                                                        <span>{{item._ToSummary}}</span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                            <tbody ng-if="_dbooking.LeadPassengerId && paxHistory.length == 0">
                                                <tr>
                                                    <td colspan="3" class="text-center">
                                                        No Booking Added
                                                    </td>
                                                </tr>
                                            </tbody>
                                            <tbody ng-if="!_dbooking.LeadPassengerId && !paxMode.value">
                                                <tr>
                                                    <td colspan="3" class="text-center">
                                                        No Passenger Selected
                                                    </td>
                                                </tr>
                                            </tbody>
                                            <tbody ng-if="paxMode.value">
                                                <tr>
                                                    <td colspan="3" class="text-center">
                                                        No Booking Added
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="flight-information block">
                                    <h3 class="section-title"><i class="material-icons">flight</i>Arriving Flight Information</h3>
                                    <a ng-click="flightData.Number = null;_dbooking.FlightInfo = null;" ng-show="_dbooking.FlightInfo" class="red pull-right" href="" style="margin-top:-38px;font-size:11px;">Remove Flight Info</a>
                                    <small class="text-muted">
                                        Please enter your flight number and click on the right button. The arrival time and the pickup airport/terminal will be added on to the journey.
                                    </small>
                                    <div class="alert alert-sm alert-warning" style="padding:6px 14px;">
                                        This is for <b>Airport Pickups</b> meeting <b>Arriving</b> flights only, Pickup location will be set to appropriate Airport/Terminal where known.
                                    </div>
                                    <div class="mt10">
                                        <div class="half-column">
                                            <div class="form-group">
                                                <label for="" class="control-label">Flight No</label>
                                                <div class="form-edit input-group">
                                                    <input type="text" class="form-control" ng-model="flightData.Number" placeholder="e.g. EK5" />
                                                    <span class="input-group-btn"><button type="button" class="btn btn-primary" ng-click="fetchFlightInformation()"><i class="material-icons">assignment</i></button></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="half-column">

                                        </div>
                                    </div>
                                    <br class="clearfix" />
                                    <div class="mt10" ng-show="_dbooking.FlightInfo">
                                        <b>Departs:</b> ({{_dbooking.FlightInfo.OriginCode}}) {{_dbooking.FlightInfo.Origin}}
                                        <br />
                                        <b>Arrives:</b> ({{_dbooking.FlightInfo.DestinationCode}}) {{_dbooking.FlightInfo.Destination}} <span ng-if="_dbooking.FlightInfo.Terminal">Terminal: {{_dbooking.FlightInfo.Terminal}}</span>
                                        <br />
                                        <b>Scheduled Arrival Time:</b> {{_dbooking.FlightInfo.ArrivalTime | companyDate:'DD/MM/YYYY HH:mm'}}
                                    </div>
                                    <br class="clearfix" />
                                </div>
                                <div class="block quote-breakdown" ng-show="quote && $root.CLIENT.ShowPriceInPortal">
                                    <h3 class="section-title">
                                        <i class="material-icons">settings</i> Quote Breakdown
                                    </h3>
                                    <div class="row mt5 mb5" ng-show="quote.Error">
                                        <div class="col-xs-12">
                                            <div class="alert alert-danger">
                                                <b>Invalid Quote:</b> {{quote.ErrorMessage}}
                                            </div>
                                        </div>
                                    </div>
                                    <div ng-show="!quote.Error">
                                        <div class="row mt5 mb15">
                                            <div class="col-xs-6 col-xs-offset-3">
                                                <div class="text-center">
                                                    <span class="form-contorl-static t-xl">Quote: {{_dbooking.EstimatedCost + quote.TotalCharges | currency}}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mt5 mb15">
                                            <div ng-class="($root.CLIENT.ShowVATInPortal===true)? 'col-xs-4':'col-xs-6'">
                                                <div class="form-group mt10 mb10">
                                                    <label class="control-label">Journey Quote:</label>
                                                    <br />
                                                    <span class="form-contorl-static">{{_dbooking.EstimatedCost | currency}}</span>
                                                </div>
                                                <div ng-show="quote.IsFixed || quote.IsPeakDate || quote.IsPeakTime">
                                                    <span class="label label-info" ng-show="quote.IsFixed">Fixed Price</span>
                                                    <span class="label label-info" ng-show="quote.IsPeakDate">Peak Date (x{{quote.PeakDateMultiplier}})</span>
                                                    <span class="label label-info" ng-show="quote.IsPeakTime">Peak Time (x{{quote.PeakTimeMultiplier}})</span>
                                                </div>
                                                <div class="form-group mt10 mb10">
                                                    <label class="control-label">Distance (miles):</label>
                                                    <br />
                                                    <span class="form-contorl-static">{{quote.Directions.Distance * 0.000621371 | number:1}} miles</span>
                                                    <div ng-show="quote.IncludedMiles">
                                                        <small>{{quote.IncludedMiles | number:1}} Included</small>
                                                    </div>
                                                </div>
                                                <div class="form-group mt10 mb10">
                                                    <label class="control-label">Time (without traffic):</label>
                                                    <br />
                                                    <span class="form-contorl-static">{{quote.Directions.Time * 1.2 / 1000 / 60 | number:0}} mins</span>
                                                </div>
                                            </div>
                                            <div ng-class="($root.CLIENT.ShowVATInPortal===true)? 'col-xs-4':'col-xs-6'">
                                                <div class="form-group mt10 mb10">
                                                    <label class="control-label">Charges:</label>
                                                    <br />
                                                    <span class="form-contorl-static">{{quote.TotalCharges | currency}}</span>
                                                </div>
                                                <div>
                                                    <span class="brand-secondary bold" ng-show="quote.Charges">Included Charges:</span>
                                                    <div ng-repeat="charge in quote.Charges" class="mt5">
                                                        <div class="lh15">
                                                            <small class="brand-primary bold">{{charge.Name}}:</small> <small>{{charge.Amount | currency}}</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-xs-4" ng-show="$root.CLIENT.ShowVATInPortal">
                                                <div class="form-group mt10 mb10">
                                                    <label class="control-label">Taxes:</label>
                                                    <br />
                                                    <span class="form-contorl-static">{{(quote.TotalTaxAmount + quote.TotalChargesTaxAmount) | currency}}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="notes block">
                                    <h3 class="section-title"><i class="material-icons">assignment</i> Other Information</h3>
                                    <div class="form-group mt10 mb10">
                                        <label class="control-label">Client Services</label>
                                        <input class="check" type="checkbox" id="ClientServicesCheck" ng-model="_dbooking.Dispute" />
                                        <label class="check-label" for="ClientServicesCheck"></label>
                                    </div>
                                    <br class="clearfix" />
                                    <div class="tabs">
                                        <tabset class="notes-tab">
                                            <tab>
                                                <tab-heading>
                                                    Driver
                                                </tab-heading>
                                                <div class="form-group mt10">
                                                    <small class="text-muted">These notes will be visible for the driver on his mobile app and will be sent alongside the booking.</small>
                                                    <label class="control-label mt10">Driver Notes</label>
                                                    <div class="form-edit">
                                                        <textarea rows="5" class="form-control" ng-model="_dbooking.DriverNotes"></textarea>
                                                    </div>
                                                </div>
                                            </tab>
                                            <tab>
                                                <tab-heading>
                                                    Office
                                                </tab-heading>
                                                <div class="form-group mt10">
                                                    <small class="text-muted">These notes will be shared withing the company. No visibility for drivers or passengers.</small>
                                                    <label class="control-label mt10">Office Notes</label>
                                                    <div class="form-edit">
                                                        <textarea rows="5" class="form-control" ng-model="_dbooking.OfficeNotes"></textarea>
                                                    </div>
                                                </div>
                                            </tab>
                                        </tabset>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <br class="clearfix">
                        <div class="booking-confirmation">
                            <div class="header mb5">Booking Summary</div>
                            <div class="block">
                                <div class="fourth-column" ng-if="isAdmin">
                                    <div class="form-group">
                                        <label class="control-label">Booker</label>
                                        <small class="text-muted">{{selectedBooker.Name}}</small>
                                    </div>
                                </div>
                                <div class="fourth-column">
                                    <div class="form-group">
                                        <label class="control-label">Passenger</label>
                                        <small class="text-muted">{{selectedPassenger.Name}}</small>
                                    </div>
                                </div>
                                <div class="fourth-column">
                                    <div class="form-group">
                                        <label class="control-label">Contact Number</label>
                                        <small class="text-muted">{{_dbooking.PassengerNotificationPhone}}</small>
                                    </div>
                                </div>
                                <br class="clearfix">
                                <div class="full-column">
                                    <div ng-repeat="stop in _dbooking.BookingStops">
                                        <div ng-if="$first">
                                            <div class="form-group">
                                                <label class="control-label" for="stop{{$index}}">
                                                    Pickup
                                                </label>
                                                <small>{{stop.StopSummary}}</small>
                                            </div>
                                        </div>
                                        <div ng-if="!$first && !_dbooking.AsDirected">
                                            <div class="form-group" ng-if="$middle">
                                                <label class=" control-label " for="stop{{$index}} ">
                                                    Via
                                                </label>
                                                <small>{{stop.StopSummary}}</small>
                                            </div>
                                            <div class="form-group" ng-if="$last">
                                                <label class="control-label " for="stop{{$index}} ">
                                                    {{ _dbooking.WaitAndReturn ? 'Return To' : 'Drop Off' }}
                                                </label>
                                                <small>{{stop.StopSummary}}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <br class="clearfix">
                                <div class="fourth-column">
                                    <div class="form-group">
                                        <label class="control-label">Pickup Time</label>
                                        <small>{{_dbooking.BookedDateTime|companyDate:'DD/MM/YYYY HH:mm'}}</small>
                                    </div>
                                </div>
                                <div class="fourth-column">
                                    <div class="form-group ">
                                        <label class="control-label">As Directed</label>
                                        <input class="check" type="checkbox" id="AsDirectedCheckConfirm" ng-model="_dbooking.AsDirected" ng-disabled="true" />
                                        <label class="check-label" for="AsDirectedCheckConfirm"></label>
                                    </div>
                                </div>
                                <div class="fourth-column">
                                    <div class="form-group ">
                                        <label class="control-label">Special Requirements</label>
                                        <small ng-bind="_dbooking.BookingRequirements.length"></small>
                                    </div>
                                </div>
                                <div class="fourth-column">
                                    <div class="form-group ">
                                        <label class="control-label">Notifications on Arrival</label>
                                        <small>
                                            <span>{{_dbooking.TextOnArrival?'SMS Message':''}}</span>
                                            <span ng-show="_dbooking.TextOnArrival && _dbooking.CallOnArrival">, </span>
                                            <span>{{_dbooking.CallOnArrival?'Phone Call':''}}</span>
                                        </small>
                                    </div>
                                </div>
                                <br class="clearfix">
                            </div>
                        </div>
                        <div class="booking-confirmation" ng-show="formFor.form.$invalid">
                            <div class="header mb5">Booking Validations</div>
                            <div class="block">
                                <div class="row mb10">
                                    <div ng-repeat="(key, value) in formFor.form.$error">
                                        <div class="col-md-4" ng-repeat="e in value">
                                            <span>*{{formatErrorName(e.$name)}} is <span class="red">{{key == 'required' ? key : 'Invalid Value'}}</span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <br class="clearfix ">
                        <div class="actions mt20 mb20 ">
                            <button href=" " class="btn btn-warning " ng-click="cancel() "><i class="material-icons ">undo</i>Cancel</button>
                            <button href=" " tabindex="14" id="bookingsave" class="btn btn-success " ng-disabled="client.OnHold || !formFor.form.$valid || !canQuote|| testMaskReferences() || quoting || quote.Error" ng-click="validateBooking()"><i class="material-icons ">send</i>Save</button>
                            <button href=" " tabindex="15" id="bookingrepeat" class="btn btn-success " ng-disabled="client.OnHold || !formFor.form.$valid || !canQuote|| testMaskReferences() || quoting || quote.Error " ng-click="validateBooking(true)"><i class="material-icons ">send</i>Save &amp; Repeat</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="dispatch-map"></div>
</div>
