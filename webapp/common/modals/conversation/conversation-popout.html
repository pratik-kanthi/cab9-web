<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" ng-app="editbooking">

<head>
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />
    <title></title>
    <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/select2/3.4.5/select2.css">
    <link href="/includes/css/style.min.css" rel="stylesheet" />
    <style>
        .loading-background {
            background: rgba(255, 255, 255, 0.9);
            /*background: #777;*/
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }

            .loading-background .loading-panel {
                position: absolute;
                top: 50%;
                left: 50%;
                background-color: #fff;
                padding: 40px;
                text-align: center;
                width: 150px;
                height: 150px;
                border-radius: 75px;
                -webkit-transform: translate(-50%, -50%);
                -moz-transform: translate(-50%, -50%);
                -ms-transform: translate(-50%, -50%);
                -o-transform: translate(-50%, -50%);
                transform: translate(-50%, -50%);
            }

                .loading-background .loading-panel img {
                    width: 70px;
                    margin-bottom: 0px;
                }

        #dispatch-booking-edit .body {
            padding: 5px;
            padding-bottom: 0;
            min-height: 225px;
        }

            #dispatch-booking-edit .body h3 .section-title {
                font-size: 16px;
                margin-bottom: 8px;
            }

            #dispatch-booking-edit .body nav ul {
                padding-left: 0;
                margin-top: 0px;
                border-bottom: 3px solid gray;
                list-style: none !important;
                margin-bottom: 5px;
            }

            #dispatch-booking-edit .body nav li {
                display: inline-block;
                border-right: 1px solid #ddd;
                border: 0;
            }

                #dispatch-booking-edit .body nav li a {
                    padding: 8px 16px;
                    position: relative;
                    font-size: 14px;
                    text-transform: uppercase;
                    font-weight: 600;
                    display: block;
                }

            #dispatch-booking-edit .body nav ul li:last-child {
                border-right: 0;
            }

            #dispatch-booking-edit .body nav ul li.active {
                background: #788195;
            }

                #dispatch-booking-edit .body nav ul li.active a {
                    color: #fff;
                }

            #dispatch-booking-edit .body .table-wrapper thead tr th {
                color: #455674;
            }

            #dispatch-booking-edit .body .table-wrapper i {
                color: #455674;
            }

        #dispatch-booking-edit .add-stop {
            padding-top: 25px;
        }

            #dispatch-booking-edit .add-stop a {
                color: #455674 !important;
            }

        #dispatch-booking-edit .header {
            background-color: #788195;
            margin-bottom: 16px;
            padding-left: 8px;
            text-transform: uppercase;
            color: #fff;
            font-weight: 600;
        }

        #dispatch-booking-edit .selectize-dropdown small.text-muted {
            margin-bottom: 0 !important;
        }

        #dispatch-booking-edit .client-info img {
            width: 100px;
            height: 100px;
            border-radius: 50px;
            box-shadow: 2px 3px 7px -3px rgba(0, 0, 0, .5);
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        #dispatch-booking-edit .client-info .info-wrapper {
            height: 120px;
            display: -webkit-box;
            display: -webkit-flex;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            -ms-flex-align: center;
            align-items: center;
            -webkit-box-pack: center;
            -webkit-justify-content: center;
            -ms-flex-pack: center;
            justify-content: center;
        }

            #dispatch-booking-edit .client-info .info-wrapper .info {
                width: 100%;
                text-align: left;
            }

            #dispatch-booking-edit .client-info .info-wrapper h4 {
                font-size: 16px;
                color: #455674;
            }

            #dispatch-booking-edit .client-info .info-wrapper h6 {
                font-size: 14px;
                color: #A88ADC;
            }

        #dispatch-booking-edit .verification .references {
            position: absolute;
            z-index: 1000;
            max-height: 300px;
            box-shadow: 0 4px 100px -12px #858585;
            left: 0;
            top: 35px;
            background-color: #fff;
            right: 40px;
            padding: 0;
        }

            #dispatch-booking-edit .verification .references ul {
                list-style: none;
                padding-left: 0;
            }

                #dispatch-booking-edit .verification .references ul li {
                    border-bottom: 1px solid #eee;
                    padding: 4px 8px;
                }

        #dispatch-booking-edit .notes-tab {
            margin: 10px 0 15px;
        }

            #dispatch-booking-edit .notes-tab li {
                border: 0;
                background: 0 0;
                border-radius: 2px;
                padding: 0 8px;
                width: auto;
                font-size: 12px !important;
                text-transform: uppercase !important;
                cursor: pointer;
                color: #777;
            }

                #dispatch-booking-edit .notes-tab li a {
                    padding: 5px;
                }

                    #dispatch-booking-edit .notes-tab li a::after,
                    .booking-edit-modal #dispatch-booking-edit .notes-tab li a::before {
                        display: none;
                    }

                #dispatch-booking-edit .notes-tab li.active {
                    background-color: #788195;
                    color: #fff;
                }

                    #dispatch-booking-edit .notes-tab li.active a {
                        color: #fff;
                    }

        #dispatch-booking-edit .block {
            background-color: #f4f4f4;
            border: 1px solid #ddd;
            padding: 16px 16px 5px 16px;
            margin-bottom: 5px;
        }

            #dispatch-booking-edit .block h3 {
                margin-top: 0;
            }

                #dispatch-booking-edit .block h3 i {
                    font-size: 36px;
                    margin-top: -6px;
                    color: #788195;
                }

            #dispatch-booking-edit .block .check + label.check-label {
                background-color: #b1b6c2;
            }

            #dispatch-booking-edit .block .flip {
                position: absolute;
                right: -24px;
                bottom: -34px;
                padding: 8px;
                z-index: 1;
            }

                #dispatch-booking-edit .block .flip i {
                    font-size: 34px;
                    color: #455674 !important;
                    font-weight: 700;
                }

            #dispatch-booking-edit .block small.text-muted {
                display: block;
                margin-bottom: 8px;
            }

            #dispatch-booking-edit .block .table-wrapper {
                margin: 0 -16px !important;
            }

                #dispatch-booking-edit .block .table-wrapper table {
                    margin-bottom: -18px;
                }

                    #dispatch-booking-edit .block .table-wrapper table td {
                        padding: 2px 8px;
                    }

            #dispatch-booking-edit .block.passenger-history {
                max-height: 350px;
                overflow: auto;
            }

        #dispatch-booking-edit .quick-links {
            margin-top: -12px;
            margin-bottom: 16px;
        }

            #dispatch-booking-edit .quick-links a.linked {
                opacity: 40;
                filter: alpha(opacity=4000);
                opacity: .4;
                filter: alpha(opacity=40);
                color: #00b300;
                font-weight: 600;
                text-transform: uppercase;
                font-size: 11px;
                margin-right: 5px;
                padding: 2px 5px;
                border-radius: 2px;
                background-color: #fff;
                cursor: pointer;
                border: 1px solid #00b300;
                -webkit-transition: all 1s;
                transition: all 1s;
            }

                #dispatch-booking-edit .quick-links a.linked:hover {
                    opacity: 100;
                    filter: alpha(opacity=10000);
                    opacity: 1;
                    filter: alpha(opacity=100);
                    color: #fff;
                    background-color: #00b300;
                }

        #dispatch-booking-edit .add-passenger {
            font-size: 18px;
            position: relative;
            top: 3px;
            margin-right: 2px;
        }

        #dispatch-booking-edit .overlay {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background-color: rgba(255, 255, 255, .7);
        }

        #dispatch-booking-edit .form-section .full-column {
            width: 100%;
            padding-right: 15px;
            float: left;
            position: relative;
        }

        #dispatch-booking-edit .form-section .half-column {
            width: 50%;
            padding-right: 15px;
            float: left;
            position: relative;
        }

        #dispatch-booking-edit .form-section .three-fourth-column {
            width: 75%;
            padding-right: 15px;
            float: left;
            position: relative;
        }

        #dispatch-booking-edit .form-section .third-column {
            width: 33.33%;
            padding-right: 15px;
            float: left;
            position: relative;
        }

        #dispatch-booking-edit .form-section .fourth-column {
            width: 25%;
            padding-right: 15px;
            float: left;
            position: relative;
        }

        #dispatch-booking-edit .form-section::after {
            clear: both;
        }

        #dispatch-booking-edit .form-section .location-suggestions {
            width: 280px;
        }
    </style>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script>
        window.endpoint = 'http://api.cab9.co/';
    </script>
    <script>
        var token = localStorage.getItem('AUTH_TKN');
        var parsed = JSON.parse(token);
        document.write('<scr' + 'ipt type="text/javascript" src="http://maps.googleapis.com/maps/api/js?' + (parsed.GoogleApiKey ? ('key=' + parsed.GoogleApiKey + '&') : '') + 'libraries=weather,visualization,places,drawing,geometry&sensor=false&language=en&v=3.13"><' + '/scr' + 'ipt>')
    </script>

    <!-- build:bower -->
    <script src="/includes/js/dependencies.min.js?ver=v0.9a315"></script>
    <!-- endbuild -->
    <!-- build:model -->
    <script src="/includes/js/models.min.js?ver=v0.9a315"></script>
    <!-- endbuild -->

    <script src="https://code.angularjs.org/1.4.6/i18n/angular-locale_en-gb.js"></script>
    <script src="http://api.cab9.co/signalr/hubs"></script>
    <!-- build:components -->
    <script src="/includes/js/components.min.js?ver=v0.9a315"></script>
    <!-- endbuild -->
    <!-- build:app -->
    <script src="/includes/js/app.min.js?ver=v0.9a315"></script>
    <!-- endbuild -->
    <!-- build:individual -->
    <script src="/includes/js/management.min.js?ver=v0.9a315"></script>
    <!-- endbuild -->

</head>
<body ng-controller="EditBookingController">
    <div ng-if="loading" class="loading-background" style="z-index:10000000">
        <div class="loading-panel">
            <img src="/includes/images/preloader.gif" />
        </div>
    </div>
    <form name="bookingForm" id="dispatch-booking-edit" form-for="item" schema="Booking" mode="EDIT">
        <div class="booking-payment-calculation">
            <div class="body">
                <div class="row">
                    <div class="col-md-4">

                    </div>
                    <div class="col-md-8">

                    </div>
                </div>
                <nav>
                    <ul>
                        <li ng-click="bookingInfo=true;finance=false" ng-class="(bookingInfo==true)?'active':''"><a href=""><span>Booking Information</span></a></li>
                        <li ng-click="finance=true;bookingInfo=false" ng-class="(finance==true)?'active':''"><a href=""><span>Finance</span></a></li>
                    </ul>
                </nav>
                <form name="dispatchBookingForm" form-for="item" schema="Booking" mode="CREATE">
                    <div ng-include="'/webapp/common/modals/bookings/edit-booking/booking-info.partial.html'"></div>
                    <div ng-include="'/webapp/common/modals/bookings/edit-booking/booking-finance.partial.html'"></div>
                    <div class="mt10">
                        <button ng-if="!repeat" class="btn btn-xl btn-success ml15 mr5" id="bookingsave" ng-click="save()" ng-disabled="formFor.form.$invalid ||!canQuote|| testMaskReferences() || expenses.adding || expenses.editing"><i class="material-icons">update</i>Update</button>
                        <button class="btn btn-xl btn-warning" ng-click="close()"><i class="material-icons">close</i>Close</button>
                    </div>
                </form>
            </div>
        </div>
    </form>
    <script>
        window.idCounter = 10000;
        var baseUrl = "http://api.cab9.co/";

        (function (window, angular, baseUrl, undefined) {
            var app = angular.module('editbooking', ['ngSanitize', "cab9.common"]);

            app.run(runFn);

            runFn.$inject = ['Localisation', 'tmhDynamicLocale', 'Model', 'Auth'];

            function runFn(Localisation, tmhDynamicLocale, Model, Auth) {

                var currencyObj = Localisation.currency();
                var currencies = currencyObj.currencies();

                Model.Company
                    .query()
                    .include('DefaultDriverPaymentModel')
                    .filter("Id eq guid'" + Auth.getSession().TenantId + "'")
                    .execute().then(function (c) {
                        //Localisation set functions
                        currencies.then(function (res) {
                            currencyObj.setCurrent(c[0].DefaultCurrencyId);
                            currencyIcon = currencyObj.getCurrent().Prepend;
                        });
                        if (c[0].DefaultLocale)
                            tmhDynamicLocale.set(c[0].DefaultLocale);
                        else
                            tmhDynamicLocale.set($config.DEFAULT_LOCALE);

                        if (c[0].DefaultTimezone) {
                            moment.tz.setDefault(c[0].DefaultTimezone);
                            Localisation.timeZone().setTimeZone(c[0].DefaultTimezone);
                        }
                        Localisation.useMetric(c[0].UseMetric);
                    });
            }
            app.filter('PassengerFilter', passengerFilter);
            app.filter('BookerFilter', bookerFilter);
            app.controller('EditBookingController', function ($scope, $http, $location, Model, Localisation, $UI, $controller, $q) {
                $scope.loading = true;
                $scope.bookingInfo = true;
                var searchParams = $location.search();
                var id = searchParams.id;
                var clientid = searchParams.clientId;
                var repeat = searchParams.repeat;


                var setupPromises = [];
                var bookingPromise = Model.Booking.query()
                    .include('Driver,Client,Vehicle,FlightInfo,BookingStops,BookingStops/PassengerStops,Passengers,BookingValidations,LeadPassenger,Currency,BookingRequirements,BookingExpense,BookingExpense/BookingExpenseType,BookingExpense/Tax') //Notifications
                    .where("Id eq guid'" + id + "'")
                    .trackingEnabled()
                    .execute();
                setupPromises.push(bookingPromise);

                var clientsPromise = Model.Client.query().filter("Id eq guid'" + clientid + "'")
                    .select('Id,AccountNo,Name,AllVehicleTypeAccess,VehicleTypes,ClientReferences,KnownLocations')
                    .include('VehicleTypes,ClientReferences,KnownLocations').execute();
                setupPromises.push(clientsPromise);

                var passengersPromise = Model.Passenger.query()
                    .select('Id,Firstname,Surname,Addresses,ImageUrl,Mobile,ClientId,Client/Name,Client/AccountNo')
                    .filter("ClientId eq guid'" + clientid + "'")
                    .include('Client,Addresses').parseAs(function (item) {
                        this.Id = item.Id;
                        this.ClientId = item.ClientId;
                        this.Name = item.Firstname + ' ' + item.Surname;
                        this.Addresses = item.Addresses;
                        this.Description = ((item.Client && item.Client.Name) ? "(" + item.Client.AccountNo + ") " + item.Client.Name : 'No Client');
                        this.Mobile = item.Mobile;
                        this.ImageUrl = $utilities.formatUrl(item.ImageUrl, item.Name);
                    }).execute()
                setupPromises.push(passengersPromise);

                var expenseTypesPromise = Model.BookingExpenseType.query().execute();
                setupPromises.push(expenseTypesPromise);

                var taxesPromise = Model.Tax.query().execute();
                setupPromises.push(taxesPromise);

                $q.all(setupPromises).then(function (results) {
                    if (repeat) {
                        var c = $controller('BookingReuseModalController', {
                            $scope: $scope,
                            scope: $scope,
                            $UI: $UI,
                            $modalInstance: dummyInstance,
                            $http: $http,
                            $config: $config,
                            Model: Model,
                            Localisation: Localisation,
                            rBooking: results[0],
                            rClients: results[1],
                            rPassengers: results[2],
                            rExpenseTypes: results[3],
                            rTaxes: results[4],
                        });
                    } else {
                        var c = $controller('BookingEditModalController', {
                            $scope: $scope,
                            scope: $scope,
                            $UI: $UI,
                            $modalInstance: dummyInstance,
                            $http: $http,
                            $config: $config,
                            Model: Model,
                            Localisation: Localisation,
                            rBooking: results[0],
                            rClients: results[1],
                            rPassengers: results[2],
                            rExpenseTypes: results[3],
                            rTaxes: results[4],
                        });
                    }
                    $scope.loading = false;
                }, function () {
                    window.alert("An error occured!");
                });

                var dummyInstance = {
                    dismiss: function () {},
                    close: function () {
                        //window.close();
                    }
                };

                return;
            });

            function passengerFilter() {
                return function (input, searchText) {
                    if (searchText.trim().length > 0) {
                        input = input.filter(function (item) {
                            return ((item.Name + item.Mobile + item.Description) + "").toLowerCase().indexOf(searchText.toLowerCase()) > -1 || item.Id == "add-passenger"
                        })
                    }
                    return input;
                }
            }

            function bookerFilter() {
                return function (input, searchText) {
                    if (searchText.trim().length > 0) {
                        input = input.filter(function (item) {
                            return ((item.Name + item.Mobile + item.Description) + "").toLowerCase().indexOf(searchText.toLowerCase()) > -1 || item.Id == "add-booker"
                        })

                    }
                    return input;
                }
            }
        }(window, angular, baseUrl));
    </script>
</body>

</html>